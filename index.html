<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamTodo - 검증 시스템 통합</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .validation-error {
            animation: shake 0.3s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .validation-success {
            animation: pulse 0.5s ease-in-out;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 로딩 상태 -->
    <div id="loading" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white text-lg">시스템 초기화 중...</p>
        </div>
    </div>

    <!-- 로그인/회원가입 화면 -->
    <div id="authScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">TeamTodo</h1>
                <p class="text-gray-600">통합 검증 시스템이 적용된 협업 도구</p>
            </div>

            <!-- 탭 버튼 -->
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button id="loginTab" class="flex-1 py-2 text-center rounded-md bg-white shadow-sm font-medium text-blue-600 transition-all">
                    로그인
                </button>
                <button id="signupTab" class="flex-1 py-2 text-center rounded-md font-medium text-gray-600 transition-all">
                    회원가입
                </button>
            </div>

            <!-- 로그인 폼 -->
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="example@email.com"
                        required
                    >
                    <div id="loginEmailError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="비밀번호를 입력하세요"
                        required
                    >
                    <div id="loginPasswordError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
                    id="loginBtn"
                >
                    로그인
                </button>
            </form>

            <!-- 회원가입 폼 -->
            <form id="signupForm" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input 
                        type="email" 
                        id="signupEmail" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="example@email.com"
                    >
                    <div id="signupEmailError" class="text-red-500 text-sm mt-1 hidden"></div>
                    <div id="signupEmailSuccess" class="text-green-500 text-sm mt-1 hidden">✓ 사용 가능한 이메일입니다</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">사용자명</label>
                    <input 
                        type="text" 
                        id="signupUsername" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="username"
                    >
                    <div id="signupUsernameError" class="text-red-500 text-sm mt-1 hidden"></div>
                    <div id="signupUsernameSuccess" class="text-green-500 text-sm mt-1 hidden">✓ 사용 가능한 사용자명입니다</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">전체 이름</label>
                    <input 
                        type="text" 
                        id="signupFullName" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="홍길동"
                    >
                    <div id="signupFullNameError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                    <input 
                        type="password" 
                        id="signupPassword" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="비밀번호를 입력하세요"
                    >
                    <div id="signupPasswordError" class="text-red-500 text-sm mt-1 hidden"></div>
                    <div class="text-xs text-gray-600 mt-1">
                        8자 이상, 대소문자, 숫자, 특수문자 포함
                    </div>
                    <!-- 비밀번호 강도 표시 -->
                    <div class="mt-2">
                        <div class="flex space-x-1">
                            <div id="strengthBar1" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                            <div id="strengthBar2" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                            <div id="strengthBar3" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                            <div id="strengthBar4" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                        </div>
                        <div id="strengthText" class="text-xs mt-1 text-gray-600"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호 확인</label>
                    <input 
                        type="password" 
                        id="signupPasswordConfirm" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="비밀번호를 다시 입력하세요"
                    >
                    <div id="signupPasswordConfirmError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
                    id="signupBtn"
                    disabled
                >
                    회원가입
                </button>
            </form>

            <!-- 검증 통계 -->
            <div id="validationStats" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="text-sm font-medium text-gray-700 mb-2">실시간 검증 통계</h3>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="text-center">
                        <div id="totalValidations" class="font-bold text-blue-600">0</div>
                        <div class="text-gray-600">전체</div>
                    </div>
                    <div class="text-center">
                        <div id="successValidations" class="font-bold text-green-600">0</div>
                        <div class="text-gray-600">성공</div>
                    </div>
                    <div class="text-center">
                        <div id="failedValidations" class="font-bold text-red-600">0</div>
                        <div class="text-gray-600">실패</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div id="mainApp" class="hidden min-h-screen bg-gray-50">
        <!-- 헤더 -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">TeamTodo</h1>
                        <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">검증 시스템 통합</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm text-gray-600"></span>
                        <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">로그아웃</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 할 일 추가 섹션 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">새 할 일 추가</h2>
                <form id="todoForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">제목 *</label>
                            <input 
                                type="text" 
                                id="todoTitle" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="할 일 제목을 입력하세요"
                                required
                            >
                            <div id="todoTitleError" class="text-red-500 text-sm mt-1 hidden"></div>
                            <div id="todoTitleSuccess" class="text-green-500 text-sm mt-1 hidden">✓ 유효한 제목입니다</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">우선순위</label>
                            <select 
                                id="todoPriority" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="low">낮음</option>
                                <option value="medium" selected>보통</option>
                                <option value="high">높음</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                        <textarea 
                            id="todoDescription" 
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="할 일에 대한 자세한 설명을 입력하세요"
                        ></textarea>
                        <div id="todoDescriptionError" class="text-red-500 text-sm mt-1 hidden"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">시작 날짜</label>
                            <input 
                                type="date" 
                                id="todoStartDate" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">마감 날짜</label>
                            <input 
                                type="date" 
                                id="todoDueDate" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <div id="todoDateError" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full md:w-auto px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
                        id="todoSubmitBtn"
                        disabled
                    >
                        할 일 추가
                    </button>
                </form>
            </div>

            <!-- 검증 시스템 대시보드 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">검증 시스템 대시보드</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="dashTotalValidations">0</div>
                        <div class="text-sm text-blue-600">총 검증 횟수</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="dashSuccessValidations">0</div>
                        <div class="text-sm text-green-600">성공한 검증</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="dashFailedValidations">0</div>
                        <div class="text-sm text-red-600">실패한 검증</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="dashSuccessRate">0%</div>
                        <div class="text-sm text-purple-600">성공률</div>
                    </div>
                </div>
            </div>

            <!-- 할 일 목록 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">할 일 목록</h2>
                <div id="todoList" class="space-y-3">
                    <!-- 할 일 항목들이 여기에 동적으로 추가됩니다 -->
                </div>
                <div id="emptyState" class="text-center py-8 text-gray-500">
                    아직 등록된 할 일이 없습니다. 새로운 할 일을 추가해보세요!
                </div>
            </div>
        </main>
    </div>

    <script>
        // Supabase 초기화
        const supabaseUrl = 'https://nlywtmsbkvaggfvezonj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5seXd0bXNia3ZhZ2dmdmV6b25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzOTAzMDEsImV4cCI6MjA2NTk2NjMwMX0.FMyZENGZkUHJEp6YFe-VdYT-L3b49si1yu6EvWun01Y';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 통합 검증 시스템 클래스
        class ValidationSystem {
            constructor() {
                this.rules = new Map();
                this.stats = {
                    total: 0,
                    success: 0,
                    failed: 0
                };
                this.debounceTimers = new Map();
                this.loadValidationRules();
            }

            // 검증 규칙 로드
            async loadValidationRules() {
                try {
                    const { data: rules, error } = await supabase
                        .from('validation_rules')
                        .select('*')
                        .eq('is_active', true);
                    
                    if (error) throw error;
                    
                    rules.forEach(rule => {
                        this.rules.set(rule.name, rule);
                    });
                } catch (error) {
                    console.error('검증 규칙 로드 실패:', error);
                }
            }

            // 실시간 검증 (디바운싱 적용)
            validateField(fieldName, value, callback, delay = 300) {
                // 기존 타이머 취소
                if (this.debounceTimers.has(fieldName)) {
                    clearTimeout(this.debounceTimers.get(fieldName));
                }

                // 새 타이머 설정
                const timer = setTimeout(async () => {
                    const result = await this.performValidation(fieldName, value);
                    callback(result);
                    this.updateStats(result.isValid);
                    await this.logValidation(fieldName, value, result);
                }, delay);

                this.debounceTimers.set(fieldName, timer);
            }

            // 검증 수행
            async performValidation(fieldName, value) {
                const rules = this.getValidationRules(fieldName);
                const errors = [];

                for (const rule of rules) {
                    const result = await this.applyRule(rule, value);
                    if (!result.isValid) {
                        errors.push(result.message);
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors: errors,
                    fieldName: fieldName,
                    value: value
                };
            }

            // 필드별 검증 규칙 반환
            getValidationRules(fieldName) {
                const ruleMap = {
                    'email': ['email_format'],
                    'password': ['password_strength'],
                    'username': ['username_format'],
                    'todoTitle': ['todo_title'],
                    'workspaceName': ['workspace_name']
                };

                const ruleNames = ruleMap[fieldName] || [];
                return ruleNames.map(name => this.rules.get(name)).filter(Boolean);
            }

            // 개별 규칙 적용
            async applyRule(rule, value) {
                switch (rule.type) {
                    case 'email':
                        return this.validateEmail(value, rule);
                    case 'password':
                        return this.validatePassword(value, rule);
                    case 'username':
                        return this.validateUsername(value, rule);
                    case 'text':
                        return this.validateText(value, rule);
                    default:
                        return { isValid: true, message: '' };
                }
            }

            // 이메일 검증
            validateEmail(email, rule) {
                const pattern = new RegExp(rule.pattern);
                const isValid = pattern.test(email);
                return {
                    isValid: isValid,
                    message: isValid ? '' : rule.error_message
                };
            }

            // 비밀번호 검증
            validatePassword(password, rule) {
                const checks = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                const isValid = Object.values(checks).every(check => check);
                return {
                    isValid: isValid,
                    message: isValid ? '' : rule.error_message,
                    strength: this.calculatePasswordStrength(checks)
                };
            }

            // 비밀번호 강도 계산
            calculatePasswordStrength(checks) {
                const score = Object.values(checks).filter(check => check).length;
                if (score === 5) return { level: 4, text: '매우 강함', color: 'green' };
                if (score === 4) return { level: 3, text: '강함', color: 'blue' };
                if (score === 3) return { level: 2, text: '보통', color: 'yellow' };
                if (score >= 1) return { level: 1, text: '약함', color: 'red' };
                return { level: 0, text: '매우 약함', color: 'red' };
            }

            // 사용자명 검증
            validateUsername(username, rule) {
                const pattern = new RegExp(rule.pattern);
                const isValid = pattern.test(username);
                return {
                    isValid: isValid,
                    message: isValid ? '' : rule.error_message
                };
            }

            // 텍스트 검증
            validateText(text, rule) {
                let isValid = true;
                let message = '';

                if (rule.name === 'todo_title') {
                    isValid = text.length >= 2 && text.length <= 100;
                    message = isValid ? '' : rule.error_message;
                } else if (rule.name === 'workspace_name') {
                    isValid = text.length >= 2 && text.length <= 50;
                    message = isValid ? '' : rule.error_message;
                }

                return { isValid, message };
            }

            // 중복 확인
            async checkDuplicate(fieldName, value) {
                try {
                    // 캐시 확인
                    const { data: cached } = await supabase
                        .from('duplicate_check_cache')
                        .select('*')
                        .eq('field_name', fieldName)
                        .eq('field_value', value)
                        .gt('expires_at', new Date().toISOString())
                        .single();

                    if (cached) {
                        return { isAvailable: cached.is_available };
                    }

                    // 실제 중복 확인
                    let query = supabase.from('users').select('id');
                    if (fieldName === 'email') {
                        query = query.eq('email', value);
                    } else if (fieldName === 'username') {
                        query = query.eq('nickname', value);
                    }

                    const { data, error } = await query;
                    if (error) throw error;

                    const isAvailable = data.length === 0;

                    // 캐시에 저장
                    await supabase.from('duplicate_check_cache').upsert({
                        field_name: fieldName,
                        field_value: value,
                        is_available: isAvailable,
                        expires_at: new Date(Date.now() + 60 * 60 * 1000).toISOString() // 1시간 후 만료
                    });

                    return { isAvailable };
                } catch (error) {
                    console.error('중복 확인 실패:', error);
                    return { isAvailable: false };
                }
            }

            // 검증 로그 저장
            async logValidation(fieldName, value, result) {
                try {
                    const user = await supabase.auth.getUser();
                    if (!user.data.user) return;

                    await supabase.from('validation_logs').insert({
                        user_id: user.data.user.id,
                        field_name: fieldName,
                        field_value: value,
                        is_valid: result.isValid,
                        error_message: result.errors?.join(', ') || null,
                        request_ip: null, // 클라이언트에서는 IP를 얻기 어려움
                        user_agent: navigator.userAgent
                    });
                } catch (error) {
                    console.error('검증 로그 저장 실패:', error);
                }
            }

            // 통계 업데이트
            updateStats(isValid) {
                this.stats.total++;
                if (isValid) {
                    this.stats.success++;
                } else {
                    this.stats.failed++;
                }

                // UI 업데이트
                this.updateStatsUI();
            }

            // 통계 UI 업데이트
            updateStatsUI() {
                const successRate = this.stats.total > 0 ? 
                    Math.round((this.stats.success / this.stats.total) * 100) : 0;

                // 인증 화면 통계
                document.getElementById('totalValidations').textContent = this.stats.total;
                document.getElementById('successValidations').textContent = this.stats.success;
                document.getElementById('failedValidations').textContent = this.stats.failed;

                // 대시보드 통계
                document.getElementById('dashTotalValidations').textContent = this.stats.total;
                document.getElementById('dashSuccessValidations').textContent = this.stats.success;
                document.getElementById('dashFailedValidations').textContent = this.stats.failed;
                document.getElementById('dashSuccessRate').textContent = successRate + '%';

                // 통계 섹션 표시
                document.getElementById('validationStats').classList.remove('hidden');
            }

            // 사용자 검증 통계 로드
            async loadUserStats() {
                try {
                    const user = await supabase.auth.getUser();
                    if (!user.data.user) return;

                    const { data, error } = await supabase
                        .from('user_validation_stats')
                        .select('*')
                        .eq('user_id', user.data.user.id)
                        .single();

                    if (error && error.code !== 'PGRST116') throw error;

                    if (data) {
                        this.stats = {
                            total: data.total_validations,
                            success: data.successful_validations,
                            failed: data.failed_validations
                        };
                        this.updateStatsUI();
                    }
                } catch (error) {
                    console.error('사용자 통계 로드 실패:', error);
                }
            }
        }

        // 전역 검증 시스템 인스턴스
        const validationSystem = new ValidationSystem();

        // UI 컨트롤러
        class UIController {
            constructor() {
                this.currentUser = null;
                this.todos = [];
                this.initializeEventListeners();
                this.checkAuthState();
            }

            // 이벤트 리스너 초기화
            initializeEventListeners() {
                // 탭 전환
                document.getElementById('loginTab').addEventListener('click', () => this.switchTab('login'));
                document.getElementById('signupTab').addEventListener('click', () => this.switchTab('signup'));

                // 폼 제출
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('signupForm').addEventListener('submit', (e) => this.handleSignup(e));
                document.getElementById('todoForm').addEventListener('submit', (e) => this.handleTodoSubmit(e));

                // 로그아웃
                document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());

                // 실시간 검증
                this.setupRealTimeValidation();
            }

            // 실시간 검증 설정
            setupRealTimeValidation() {
                // 회원가입 필드 검증
                document.getElementById('signupEmail').addEventListener('input', (e) => {
                    this.validateFieldWithUI('email', e.target.value, 'signupEmailError', 'signupEmailSuccess');
                });

                document.getElementById('signupUsername').addEventListener('input', (e) => {
                    this.validateFieldWithUI('username', e.target.value, 'signupUsernameError', 'signupUsernameSuccess');
                });

                document.getElementById('signupPassword').addEventListener('input', (e) => {
                    this.validatePasswordWithUI(e.target.value);
                });

                document.getElementById('signupPasswordConfirm').addEventListener('input', (e) => {
                    this.validatePasswordConfirm(e.target.value);
                });

                document.getElementById('signupFullName').addEventListener('input', (e) => {
                    this.validateRequiredField(e.target.value, 'signupFullNameError', '이름을 입력해주세요');
                });

                // 로그인 필드 검증
                document.getElementById('loginEmail').addEventListener('input', (e) => {
                    this.validateFieldWithUI('email', e.target.value, 'loginEmailError');
                });

                // 할 일 필드 검증
                document.getElementById('todoTitle').addEventListener('input', (e) => {
                    this.validateFieldWithUI('todoTitle', e.target.value, 'todoTitleError', 'todoTitleSuccess');
                });

                document.getElementById('todoDescription').addEventListener('input', (e) => {
                    this.validateDescriptionLength(e.target.value);
                });

                // 날짜 검증
                document.getElementById('todoStartDate').addEventListener('change', () => this.validateDates());
                document.getElementById('todoDueDate').addEventListener('change', () => this.validateDates());
            }

            // 필드 검증 with UI 업데이트
            validateFieldWithUI(fieldName, value, errorElementId, successElementId = null) {
                if (!value.trim()) {
                    this.hideValidationMessage(errorElementId);
                    if (successElementId) this.hideValidationMessage(successElementId);
                    return;
                }

                validationSystem.validateField(fieldName, value, async (result) => {
                    if (result.isValid) {
                        this.hideValidationMessage(errorElementId);
                        
                        // 중복 확인이 필요한 필드
                        if ((fieldName === 'email' || fieldName === 'username') && successElementId) {
                            const duplicateResult = await validationSystem.checkDuplicate(fieldName, value);
                            if (duplicateResult.isAvailable) {
                                this.showValidationSuccess(successElementId);
                            } else {
                                this.showValidationError(errorElementId, `이미 사용 중인 ${fieldName === 'email' ? '이메일' : '사용자명'}입니다`);
                            }
                        } else if (successElementId) {
                            this.showValidationSuccess(successElementId);
                        }
                    } else {
                        if (successElementId) this.hideValidationMessage(successElementId);
                        this.showValidationError(errorElementId, result.errors[0]);
                    }
                    
                    this.updateSubmitButtonState();
                });
            }

            // 비밀번호 검증 with 강도 표시
            validatePasswordWithUI(password) {
                if (!password) {
                    this.hideValidationMessage('signupPasswordError');
                    this.updatePasswordStrength(null);
                    return;
                }

                validationSystem.validateField('password', password, (result) => {
                    if (result.isValid) {
                        this.hideValidationMessage('signupPasswordError');
                    } else {
                        this.showValidationError('signupPasswordError', result.errors[0]);
                    }
                    
                    // 비밀번호 강도 업데이트
                    if (result.strength) {
                        this.updatePasswordStrength(result.strength);
                    }
                    
                    this.updateSubmitButtonState();
                });
            }

            // 비밀번호 강도 UI 업데이트
            updatePasswordStrength(strength) {
                const bars = ['strengthBar1', 'strengthBar2', 'strengthBar3', 'strengthBar4'];
                const strengthText = document.getElementById('strengthText');

                if (!strength) {
                    bars.forEach(barId => {
                        document.getElementById(barId).className = 'h-2 w-1/4 bg-gray-200 rounded';
                    });
                    strengthText.textContent = '';
                    return;
                }

                const colors = {
                    red: 'bg-red-500',
                    yellow: 'bg-yellow-500',
                    blue: 'bg-blue-500',
                    green: 'bg-green-500'
                };

                bars.forEach((barId, index) => {
                    const bar = document.getElementById(barId);
                    if (index < strength.level) {
                        bar.className = `h-2 w-1/4 ${colors[strength.color]} rounded`;
                    } else {
                        bar.className = 'h-2 w-1/4 bg-gray-200 rounded';
                    }
                });

                strengthText.textContent = strength.text;
                strengthText.className = `text-xs mt-1 text-${strength.color}-600`;
            }

            // 비밀번호 확인 검증
            validatePasswordConfirm(confirmPassword) {
                const password = document.getElementById('signupPassword').value;
                const errorElement = 'signupPasswordConfirmError';

                if (!confirmPassword) {
                    this.hideValidationMessage(errorElement);
                    return;
                }

                if (password !== confirmPassword) {
                    this.showValidationError(errorElement, '비밀번호가 일치하지 않습니다');
                } else {
                    this.hideValidationMessage(errorElement);
                }

                this.updateSubmitButtonState();
            }

            // 필수 필드 검증
            validateRequiredField(value, errorElementId, message) {
                if (!value.trim()) {
                    this.showValidationError(errorElementId, message);
                } else {
                    this.hideValidationMessage(errorElementId);
                }
                this.updateSubmitButtonState();
            }

            // 설명 길이 검증
            validateDescriptionLength(description) {
                const maxLength = 500;
                const errorElement = 'todoDescriptionError';

                if (description.length > maxLength) {
                    this.showValidationError(errorElement, `설명은 ${maxLength}자 이하여야 합니다 (현재: ${description.length}자)`);
                } else {
                    this.hideValidationMessage(errorElement);
                }
            }

            // 날짜 검증
            validateDates() {
                const startDate = document.getElementById('todoStartDate').value;
                const dueDate = document.getElementById('todoDueDate').value;
                const errorElement = 'todoDateError';

                if (startDate && dueDate && new Date(startDate) > new Date(dueDate)) {
                    this.showValidationError(errorElement, '시작 날짜는 마감 날짜보다 이전이어야 합니다');
                } else {
                    this.hideValidationMessage(errorElement);
                }
            }

            // 검증 에러 표시
            showValidationError(elementId, message) {
                const element = document.getElementById(elementId);
                const input = element.previousElementSibling;
                
                element.textContent = message;
                element.classList.remove('hidden');
                input.classList.add('border-red-500', 'validation-error');
                
                setTimeout(() => input.classList.remove('validation-error'), 300);
            }

            // 검증 성공 표시
            showValidationSuccess(elementId) {
                const element = document.getElementById(elementId);
                const input = element.parentElement.querySelector('input');
                
                element.classList.remove('hidden');
                input.classList.add('border-green-500', 'validation-success');
                input.classList.remove('border-red-500');
                
                setTimeout(() => input.classList.remove('validation-success'), 500);
            }

            // 검증 메시지 숨기기
            hideValidationMessage(elementId) {
                const element = document.getElementById(elementId);
                const input = element.previousElementSibling || element.parentElement.querySelector('input');
                
                element.classList.add('hidden');
                if (input) {
                    input.classList.remove('border-red-500', 'border-green-500');
                }
            }

            // 제출 버튼 상태 업데이트
            updateSubmitButtonState() {
                // 회원가입 버튼
                const signupBtn = document.getElementById('signupBtn');
                const isSignupValid = this.isSignupFormValid();
                signupBtn.disabled = !isSignupValid;

                // 할 일 추가 버튼
                const todoBtn = document.getElementById('todoSubmitBtn');
                const isTodoValid = this.isTodoFormValid();
                todoBtn.disabled = !isTodoValid;
            }

            // 회원가입 폼 유효성 검사
            isSignupFormValid() {
                const email = document.getElementById('signupEmail').value;
                const username = document.getElementById('signupUsername').value;
                const fullName = document.getElementById('signupFullName').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupPasswordConfirm').value;

                const hasErrors = document.querySelectorAll('#signupForm .text-red-500:not(.hidden)').length > 0;

                return email && username && fullName && password && confirmPassword && 
                       password === confirmPassword && !hasErrors;
            }

            // 할 일 폼 유효성 검사
            isTodoFormValid() {
                const title = document.getElementById('todoTitle').value;
                const hasErrors = document.querySelectorAll('#todoForm .text-red-500:not(.hidden)').length > 0;

                return title.trim() && !hasErrors;
            }

            // 탭 전환
            switchTab(tab) {
                const loginTab = document.getElementById('loginTab');
                const signupTab = document.getElementById('signupTab');
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');

                if (tab === 'login') {
                    loginTab.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    loginTab.classList.remove('text-gray-600');
                    signupTab.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                    signupTab.classList.add('text-gray-600');
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                } else {
                    signupTab.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    signupTab.classList.remove('text-gray-600');
                    loginTab.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                    loginTab.classList.add('text-gray-600');
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                }
            }

            // 인증 상태 확인
            async checkAuthState() {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        this.currentUser = user;
                        await validationSystem.loadUserStats();
                        this.showMainApp();
                        this.loadTodos();
                    } else {
                        this.showAuthScreen();
                    }
                } catch (error) {
                    console.error('인증 상태 확인 실패:', error);
                    this.showAuthScreen();
                } finally {
                    this.hideLoading();
                }
            }

            // 로그인 처리
            async handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const loginBtn = document.getElementById('loginBtn');

                loginBtn.disabled = true;
                loginBtn.textContent = '로그인 중...';

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    this.currentUser = data.user;
                    await validationSystem.loadUserStats();
                    this.showMainApp();
                    this.loadTodos();
                } catch (error) {
                    console.error('로그인 실패:', error);
                    this.showValidationError('loginPasswordError', '이메일 또는 비밀번호가 잘못되었습니다');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = '로그인';
                }
            }

            // 회원가입 처리
            async handleSignup(e) {
                e.preventDefault();
                if (!this.isSignupFormValid()) return;

                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const fullName = document.getElementById('signupFullName').value;
                const username = document.getElementById('signupUsername').value;
                const signupBtn = document.getElementById('signupBtn');

                signupBtn.disabled = true;
                signupBtn.textContent = '가입 중...';

                try {
                    // Supabase 회원가입
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: fullName,
                                nickname: username
                            }
                        }
                    });

                    if (error) throw error;

                    // 사용자 프로필 생성
                    if (data.user) {
                        const { error: profileError } = await supabase
                            .from('users')
                            .insert({
                                id: data.user.id,
                                email: email,
                                full_name: fullName,
                                nickname: username
                            });

                        if (profileError) console.error('프로필 생성 실패:', profileError);
                    }

                    alert('회원가입이 완료되었습니다! 이메일을 확인해주세요.');
                    this.switchTab('login');
                } catch (error) {
                    console.error('회원가입 실패:', error);
                    if (error.message.includes('already registered')) {
                        this.showValidationError('signupEmailError', '이미 등록된 이메일입니다');
                    } else {
                        alert('회원가입 중 오류가 발생했습니다: ' + error.message);
                    }
                } finally {
                    signupBtn.disabled = false;
                    signupBtn.textContent = '회원가입';
                }
            }

            // 할 일 추가 처리
            async handleTodoSubmit(e) {
                e.preventDefault();
                if (!this.isTodoFormValid()) return;

                const title = document.getElementById('todoTitle').value;
                const description = document.getElementById('todoDescription').value;
                const priority = document.getElementById('todoPriority').value;
                const startDate = document.getElementById('todoStartDate').value || null;
                const dueDate = document.getElementById('todoDueDate').value || null;
                const submitBtn = document.getElementById('todoSubmitBtn');

                submitBtn.disabled = true;
                submitBtn.textContent = '추가 중...';

                try {
                    const { data, error } = await supabase
                        .from('todos')
                        .insert({
                            title: title,
                            description: description,
                            priority: priority,
                            start_date: startDate,
                            due_date: dueDate,
                            created_by: this.currentUser.id,
                            status: 'pending'
                        })
                        .select();

                    if (error) throw error;

                    // 폼 초기화
                    document.getElementById('todoForm').reset();
                    this.hideValidationMessage('todoTitleSuccess');
                    this.updateSubmitButtonState();

                    // 할 일 목록 새로고침
                    this.loadTodos();

                    alert('할 일이 성공적으로 추가되었습니다!');
                } catch (error) {
                    console.error('할 일 추가 실패:', error);
                    alert('할 일 추가 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '할 일 추가';
                }
            }

            // 할 일 목록 로드
            async loadTodos() {
                try {
                    const { data, error } = await supabase
                        .from('todos')
                        .select(`
                            *,
                            assigned_user:users!todos_assigned_to_fkey(full_name),
                            creator:users!todos_created_by_fkey(full_name)
                        `)
                        .eq('created_by', this.currentUser.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.todos = data;
                    this.renderTodos();
                } catch (error) {
                    console.error('할 일 로드 실패:', error);
                }
            }

            // 할 일 목록 렌더링
            renderTodos() {
                const todoList = document.getElementById('todoList');
                const emptyState = document.getElementById('emptyState');

                if (this.todos.length === 0) {
                    todoList.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                todoList.classList.remove('hidden');
                emptyState.classList.add('hidden');

                todoList.innerHTML = this.todos.map(todo => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-1">${todo.title}</h3>
                                ${todo.description ? `<p class="text-gray-600 text-sm mb-2">${todo.description}</p>` : ''}
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="px-2 py-1 rounded-full ${this.getPriorityClass(todo.priority)}">${this.getPriorityText(todo.priority)}</span>
                                    <span class="px-2 py-1 rounded-full ${this.getStatusClass(todo.status)}">${this.getStatusText(todo.status)}</span>
                                    ${todo.due_date ? `<span>마감: ${todo.due_date}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="uiController.updateTodoStatus('${todo.id}', '${todo.status === 'completed' ? 'pending' : 'completed'}')" 
                                        class="px-3 py-1 text-xs rounded-md ${todo.status === 'completed' ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-600'} hover:opacity-80">
                                    ${todo.status === 'completed' ? '미완료' : '완료'}
                                </button>
                                <button onclick="uiController.deleteTodo('${todo.id}')" 
                                        class="px-3 py-1 text-xs rounded-md bg-red-100 text-red-600 hover:opacity-80">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // 우선순위 클래스
            getPriorityClass(priority) {
                const classes = {
                    high: 'bg-red-100 text-red-600',
                    medium: 'bg-yellow-100 text-yellow-600',
                    low: 'bg-green-100 text-green-600'
                };
                return classes[priority] || classes.medium;
            }

            // 우선순위 텍스트
            getPriorityText(priority) {
                const texts = {
                    high: '높음',
                    medium: '보통',
                    low: '낮음'
                };
                return texts[priority] || texts.medium;
            }

            // 상태 클래스
            getStatusClass(status) {
                const classes = {
                    pending: 'bg-gray-100 text-gray-600',
                    in_progress: 'bg-blue-100 text-blue-600',
                    completed: 'bg-green-100 text-green-600'
                };
                return classes[status] || classes.pending;
            }

            // 상태 텍스트
            getStatusText(status) {
                const texts = {
                    pending: '대기',
                    in_progress: '진행중',
                    completed: '완료'
                };
                return texts[status] || texts.pending;
            }

            // 할 일 상태 업데이트
            async updateTodoStatus(todoId, newStatus) {
                try {
                    const { error } = await supabase
                        .from('todos')
                        .update({ 
                            status: newStatus,
                            completed_at: newStatus === 'completed' ? new Date().toISOString() : null
                        })
                        .eq('id', todoId);

                    if (error) throw error;

                    this.loadTodos();
                } catch (error) {
                    console.error('할 일 상태 업데이트 실패:', error);
                    alert('상태 변경 중 오류가 발생했습니다');
                }
            }

            // 할 일 삭제
            async deleteTodo(todoId) {
                if (!confirm('정말로 이 할 일을 삭제하시겠습니까?')) return;

                try {
                    const { error } = await supabase
                        .from('todos')
                        .delete()
                        .eq('id', todoId);

                    if (error) throw error;

                    this.loadTodos();
                } catch (error) {
                    console.error('할 일 삭제 실패:', error);
                    alert('삭제 중 오류가 발생했습니다');
                }
            }

            // 로그아웃 처리
            async handleLogout() {
                try {
                    await supabase.auth.signOut();
                    this.currentUser = null;
                    this.showAuthScreen();
                } catch (error) {
                    console.error('로그아웃 실패:', error);
                }
            }

            // 화면 전환
            showLoading() {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }

            showAuthScreen() {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // 사용자 정보 표시
                document.getElementById('userInfo').textContent = 
                    `${this.currentUser.user_metadata?.full_name || this.currentUser.email}님 환영합니다!`;
            }
        }

        // 전역 UI 컨트롤러 인스턴스
        const uiController = new UIController();

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 인증 상태 변화 리스너
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    uiController.currentUser = session.user;
                    validationSystem.loadUserStats();
                    uiController.showMainApp();
                    uiController.loadTodos();
                } else if (event === 'SIGNED_OUT') {
                    uiController.currentUser = null;
                    uiController.showAuthScreen();
                }
            });
        });
    </script>
</body>
</html>