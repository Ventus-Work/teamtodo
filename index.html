<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamTodo - 통합 검증 시스템</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .validation-error {
            animation: shake 0.3s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .validation-success {
            animation: pulse 0.5s ease-in-out;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-connected {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .status-demo {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .status-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 연결 상태 표시 -->
    <div id="connectionStatus" class="connection-status status-demo">
        <div class="status-indicator"></div>
        <span id="statusText">연결 확인 중...</span>
    </div>

    <!-- 로딩 상태 -->
    <div id="loading" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white text-lg" id="loadingText">시스템 초기화 중...</p>
            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-4 max-w-md">
                <div class="text-white text-sm" id="loadingSteps">
                    <div id="step1" class="opacity-50">✓ Supabase 연결 확인</div>
                    <div id="step2" class="opacity-50">○ 데이터베이스 상태 확인</div>
                    <div id="step3" class="opacity-50">○ 인증 시스템 초기화</div>
                    <div id="step4" class="opacity-50">○ 검증 시스템 로드</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 로그인/회원가입 화면 -->
    <div id="authScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">TeamTodo</h1>
                <p class="text-gray-600">통합 검증 시스템이 적용된 협업 도구</p>
                <div id="supabaseStatus" class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <div class="text-sm font-medium text-gray-700">연결 상태</div>
                    <div id="statusDetails" class="text-xs text-gray-500 mt-1">확인 중...</div>
                </div>
            </div>

            <!-- 탭 버튼 -->
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button id="loginTab" class="flex-1 py-2 text-center rounded-md bg-white shadow-sm font-medium text-blue-600 transition-all">
                    로그인
                </button>
                <button id="signupTab" class="flex-1 py-2 text-center rounded-md font-medium text-gray-600 transition-all">
                    회원가입
                </button>
            </div>

            <!-- 소셜 로그인 섹션 -->
            <div class="space-y-3 mb-6">
                <!-- 구글 로그인 버튼 -->
                <button 
                    id="googleLoginBtn"
                    class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors"
                >
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google로 로그인
                </button>

                <!-- 데모 로그인 버튼 (데모 모드일 때만 표시) -->
                <button 
                    id="demoLoginBtn"
                    class="w-full flex items-center justify-center px-4 py-2 border border-blue-300 rounded-md shadow-sm bg-blue-50 text-sm font-medium text-blue-600 hover:bg-blue-100 transition-colors hidden"
                >
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                    데모 계정으로 로그인
                </button>

                <!-- 구분선 -->
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">또는</span>
                    </div>
                </div>
            </div>

            <!-- 로그인 폼 -->
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="example@email.com"
                        required
                    >
                    <div id="loginEmailError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="비밀번호를 입력하세요"
                        required
                    >
                    <div id="loginPasswordError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
                    id="loginBtn"
                >
                    이메일로 로그인
                </button>
            </form>

            <!-- 회원가입 폼 -->
            <form id="signupForm" class="space-y-4 hidden">
                <!-- 소셜 회원가입 섹션 -->
                <div class="space-y-3 mb-6">
                    <!-- 구글 회원가입 버튼 -->
                    <button 
                        type="button"
                        id="googleSignupBtn"
                        class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors"
                    >
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google로 회원가입
                    </button>

                    <!-- 구분선 -->
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">또는 이메일로 가입</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input 
                        type="email" 
                        id="signupEmail" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="example@email.com"
                    >
                    <div id="signupEmailError" class="text-red-500 text-sm mt-1 hidden"></div>
                    <div id="signupEmailSuccess" class="text-green-500 text-sm mt-1 hidden">✓ 사용 가능한 이메일입니다</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">사용자명</label>
                    <input 
                        type="text" 
                        id="signupUsername" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="username"
                    >
                    <div id="signupUsernameError" class="text-red-500 text-sm mt-1 hidden"></div>
                    <div id="signupUsernameSuccess" class="text-green-500 text-sm mt-1 hidden">✓ 사용 가능한 사용자명입니다</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">전체 이름</label>
                    <input 
                        type="text" 
                        id="signupFullName" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="홍길동"
                    >
                    <div id="signupFullNameError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                    <input 
                        type="password" 
                        id="signupPassword" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="비밀번호를 입력하세요"
                    >
                    <div id="signupPasswordError" class="text-red-500 text-sm mt-1 hidden"></div>
                    <div class="text-xs text-gray-600 mt-1">
                        8자 이상, 대소문자, 숫자, 특수문자 포함
                    </div>
                    <!-- 비밀번호 강도 표시 -->
                    <div class="mt-2">
                        <div class="flex space-x-1">
                            <div id="strengthBar1" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                            <div id="strengthBar2" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                            <div id="strengthBar3" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                            <div id="strengthBar4" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                        </div>
                        <div id="strengthText" class="text-xs mt-1 text-gray-600"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호 확인</label>
                    <input 
                        type="password" 
                        id="signupPasswordConfirm" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="비밀번호를 다시 입력하세요"
                    >
                    <div id="signupPasswordConfirmError" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
                    id="signupBtn"
                    disabled
                >
                    이메일로 회원가입
                </button>
            </form>

            <!-- 검증 통계 -->
            <div id="validationStats" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="text-sm font-medium text-gray-700 mb-2">실시간 검증 통계</h3>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="text-center">
                        <div id="totalValidations" class="font-bold text-blue-600">0</div>
                        <div class="text-gray-600">전체</div>
                    </div>
                    <div class="text-center">
                        <div id="successValidations" class="font-bold text-green-600">0</div>
                        <div class="text-gray-600">성공</div>
                    </div>
                    <div class="text-center">
                        <div id="failedValidations" class="font-bold text-red-600">0</div>
                        <div class="text-gray-600">실패</div>
                    </div>
                </div>
            </div>

            <!-- 데모 모드 안내 -->
            <div id="demoModeNotice" class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">데모 모드 실행 중</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p>Supabase 연결에 실패하여 데모 모드로 실행됩니다. 모든 기능을 체험할 수 있지만 데이터는 브라우저에만 저장됩니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div id="mainApp" class="hidden min-h-screen bg-gray-50">
        <!-- 헤더 -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">TeamTodo</h1>
                        <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">검증 시스템 통합</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm text-gray-600"></span>
                        <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">로그아웃</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 할 일 추가 섹션 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">새 할 일 추가</h2>
                <form id="todoForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">제목 *</label>
                            <input 
                                type="text" 
                                id="todoTitle" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="할 일 제목을 입력하세요"
                                required
                            >
                            <div id="todoTitleError" class="text-red-500 text-sm mt-1 hidden"></div>
                            <div id="todoTitleSuccess" class="text-green-500 text-sm mt-1 hidden">✓ 유효한 제목입니다</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">우선순위</label>
                            <select 
                                id="todoPriority" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="low">낮음</option>
                                <option value="medium" selected>보통</option>
                                <option value="high">높음</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                        <textarea 
                            id="todoDescription" 
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="할 일에 대한 자세한 설명을 입력하세요"
                        ></textarea>
                        <div id="todoDescriptionError" class="text-red-500 text-sm mt-1 hidden"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">시작 날짜</label>
                            <input 
                                type="date" 
                                id="todoStartDate" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">마감 날짜</label>
                            <input 
                                type="date" 
                                id="todoDueDate" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <div id="todoDateError" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full md:w-auto px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
                        id="todoSubmitBtn"
                        disabled
                    >
                        할 일 추가
                    </button>
                </form>
            </div>

            <!-- 검증 시스템 대시보드 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">검증 시스템 대시보드</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="dashTotalValidations">0</div>
                        <div class="text-sm text-blue-600">총 검증 횟수</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="dashSuccessValidations">0</div>
                        <div class="text-sm text-green-600">성공한 검증</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="dashFailedValidations">0</div>
                        <div class="text-sm text-red-600">실패한 검증</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="dashSuccessRate">0%</div>
                        <div class="text-sm text-purple-600">성공률</div>
                    </div>
                </div>
            </div>

            <!-- 할 일 목록 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">할 일 목록</h2>
                <div id="todoList" class="space-y-3">
                    <!-- 할 일 항목들이 여기에 동적으로 추가됩니다 -->
                </div>
                <div id="emptyState" class="text-center py-8 text-gray-500">
                    아직 등록된 할 일이 없습니다. 새로운 할 일을 추가해보세요!
                </div>
            </div>
        </main>
    </div>

    <script>
        // === 1단계: 환경 준비 및 연결 설정 ===
        
        // Supabase 설정 (실제 프로젝트 정보로 교체됨)
        const SUPABASE_CONFIG = {
            url: 'https://nlywtmsbkvaggfvezonj.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5seXd0bXNia3ZhZ2dmdmV6b25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzOTAzMDEsImV4cCI6MjA2NTk2NjMwMX0.FMyZENGZkUHJEp6YFe-VdYT-L3b49si1yu6EvWun01Y'
        };

        // 전역 변수
        let supabase = null;
        let isSupabaseConnected = false;
        let connectionMode = 'checking'; // 'checking', 'connected', 'demo', 'error'

        // 시스템 초기화
        class SystemInitializer {
            constructor() {
                this.initSteps = [
                    { id: 'step1', text: '✓ Supabase 연결 확인', status: 'pending' },
                    { id: 'step2', text: '✓ 데이터베이스 상태 확인', status: 'pending' },
                    { id: 'step3', text: '✓ 인증 시스템 초기화', status: 'pending' },
                    { id: 'step4', text: '✓ 검증 시스템 로드', status: 'pending' }
                ];
            }

            async initialize() {
                try {
                    // 1단계: Supabase 연결 확인
                    await this.updateStep(0, 'processing', 'Supabase 연결 중...');
                    await this.connectSupabase();
                    
                    // 2단계: 데이터베이스 상태 확인
                    await this.updateStep(1, 'processing', '데이터베이스 확인 중...');
                    await this.checkDatabase();
                    
                    // 3단계: 인증 시스템 초기화
                    await this.updateStep(2, 'processing', '인증 시스템 초기화 중...');
                    await this.initializeAuth();
                    
                    // 4단계: 검증 시스템 로드
                    await this.updateStep(3, 'processing', '검증 시스템 로드 중...');
                    await this.loadValidationSystem();
                    
                    // 완료
                    this.showSuccess();
                    
                } catch (error) {
                    console.error('시스템 초기화 실패:', error);
                    this.showError(error);
                }
            }

            async connectSupabase() {
                try {
                    // Supabase 클라이언트 초기화
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    
                    // 연결 테스트
                    const { data, error } = await supabase.from('validation_rules').select('count').limit(1);
                    
                    if (error) {
                        throw new Error(`데이터베이스 연결 실패: ${error.message}`);
                    }
                    
                    isSupabaseConnected = true;
                    connectionMode = 'connected';
                    this.updateConnectionStatus('connected', 'Supabase 연결됨');
                    await this.updateStep(0, 'completed', '✓ Supabase 연결 완료');
                    
                } catch (error) {
                    console.warn('Supabase 연결 실패, 데모 모드로 전환:', error);
                    connectionMode = 'demo';
                    this.updateConnectionStatus('demo', '데모 모드');
                    await this.updateStep(0, 'completed', '✓ 데모 모드로 연결');
                }
            }

            async checkDatabase() {
                if (!isSupabaseConnected) {
                    await this.updateStep(1, 'completed', '✓ 로컬 데이터베이스 확인');
                    return;
                }

                try {
                    // 주요 테이블 존재 확인
                    const tables = ['users', 'todos', 'validation_rules', 'validation_logs'];
                    for (const table of tables) {
                        const { error } = await supabase.from(table).select('count').limit(1);
                        if (error) {
                            throw new Error(`테이블 ${table} 접근 실패: ${error.message}`);
                        }
                    }
                    
                    await this.updateStep(1, 'completed', '✓ 데이터베이스 상태 확인 완료');
                    
                } catch (error) {
                    throw new Error(`데이터베이스 확인 실패: ${error.message}`);
                }
            }

            async initializeAuth() {
                if (isSupabaseConnected) {
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        await this.updateStep(2, 'completed', '✓ 인증 시스템 초기화 완료');
                    } catch (error) {
                        throw new Error(`인증 시스템 초기화 실패: ${error.message}`);
                    }
                } else {
                    await this.updateStep(2, 'completed', '✓ 데모 인증 시스템 준비');
                }
            }

            async loadValidationSystem() {
                try {
                    // 검증 시스템 초기화
                    validationSystem = new ValidationSystem();
                    await validationSystem.loadValidationRules();
                    
                    await this.updateStep(3, 'completed', '✓ 검증 시스템 로드 완료');
                    
                } catch (error) {
                    throw new Error(`검증 시스템 로드 실패: ${error.message}`);
                }
            }

            async updateStep(stepIndex, status, text) {
                const step = this.initSteps[stepIndex];
                step.status = status;
                step.text = text;
                
                const element = document.getElementById(step.id);
                if (element) {
                    element.textContent = text;
                    element.className = this.getStepClass(status);
                }
                
                // 애니메이션을 위한 지연
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            getStepClass(status) {
                switch (status) {
                    case 'processing': return 'opacity-100 text-yellow-300';
                    case 'completed': return 'opacity-100 text-green-300';
                    case 'error': return 'opacity-100 text-red-300';
                    default: return 'opacity-50';
                }
            }

            updateConnectionStatus(mode, text) {
                const statusElement = document.getElementById('connectionStatus');
                const textElement = document.getElementById('statusText');
                
                if (statusElement && textElement) {
                    statusElement.className = `connection-status status-${mode}`;
                    textElement.textContent = text;
                }

                // 상세 상태 업데이트
                this.updateStatusDetails(mode, text);
            }

            updateStatusDetails(mode, text) {
                const detailsElement = document.getElementById('statusDetails');
                if (detailsElement) {
                    const details = {
                        connected: `✅ ${SUPABASE_CONFIG.url.replace('https://', '')} 연결됨`,
                        demo: '⚠️ 오프라인 모드 - 데이터는 브라우저에만 저장됩니다',
                        error: '❌ 연결 실패 - 네트워크를 확인해주세요'
                    };
                    detailsElement.textContent = details[mode] || text;
                }

                // 데모 모드 안내 및 버튼 표시
                const demoNotice = document.getElementById('demoModeNotice');
                const demoLoginBtn = document.getElementById('demoLoginBtn');
                
                if (demoNotice && demoLoginBtn) {
                    if (mode === 'demo') {
                        demoNotice.classList.remove('hidden');
                        demoLoginBtn.classList.remove('hidden');
                    } else {
                        demoNotice.classList.add('hidden');
                        demoLoginBtn.classList.add('hidden');
                    }
                }
            }

            showSuccess() {
                document.getElementById('loadingText').textContent = '초기화 완료!';
                setTimeout(() => {
                    this.hideLoading();
                    this.initializeUI();
                }, 1000);
            }

            showError(error) {
                document.getElementById('loadingText').textContent = '초기화 실패';
                const stepsElement = document.getElementById('loadingSteps');
                stepsElement.innerHTML = `
                    <div class="text-red-300">❌ 오류: ${error.message}</div>
                    <div class="mt-2 text-yellow-300">데모 모드로 전환합니다...</div>
                `;
                
                // 데모 모드로 폴백
                connectionMode = 'demo';
                this.updateConnectionStatus('demo', '데모 모드');
                
                setTimeout(() => {
                    this.hideLoading();
                    this.initializeUI();
                }, 2000);
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }

            initializeUI() {
                if (isSupabaseConnected) {
                    // Supabase 연결된 경우 인증 상태 확인
                    this.checkAuthState();
                } else {
                    // 데모 모드인 경우 바로 메인 앱 표시
                    this.showDemoMode();
                }
            }

            async checkAuthState() {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        // 로그인된 사용자가 있는 경우
                        await uiController.handleAuthenticatedUser(user);
                    } else {
                        // 로그인되지 않은 경우
                        uiController.showAuthScreen();
                    }
                } catch (error) {
                    console.error('인증 상태 확인 실패:', error);
                    uiController.showAuthScreen();
                }
            }

            showDemoMode() {
                // 데모 모드: 자동 로그인
                uiController.currentUser = { 
                    email: 'demo@example.com', 
                    user_metadata: { full_name: '데모 사용자' } 
                };
                uiController.showMainApp();
                uiController.loadTodos();
            }
        }

        // 통합 검증 시스템 클래스 (기존 코드 유지하되 연결 상태에 따라 동작)
        class ValidationSystem {
            constructor() {
                this.rules = new Map();
                this.stats = {
                    total: 0,
                    success: 0,
                    failed: 0
                };
                this.debounceTimers = new Map();
            }

            // 검증 규칙 로드
            async loadValidationRules() {
                // 기본 규칙 설정
                this.rules.set('email_format', {
                    name: 'email_format',
                    type: 'email',
                    pattern: '^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$',
                    error_message: '올바른 이메일 형식이 아닙니다'
                });
                this.rules.set('password_strength', {
                    name: 'password_strength',
                    type: 'password',
                    pattern: '',
                    error_message: '비밀번호는 8자 이상이며, 대소문자, 숫자, 특수문자를 포함해야 합니다'
                });
                this.rules.set('username_format', {
                    name: 'username_format',
                    type: 'username',
                    pattern: '^[a-zA-Z][a-zA-Z0-9_]{2,19}$',
                    error_message: '사용자명은 영문으로 시작하며, 3-20자의 영문, 숫자, 언더스코어만 가능합니다'
                });
                this.rules.set('todo_title', {
                    name: 'todo_title',
                    type: 'text',
                    pattern: '',
                    error_message: '할 일 제목은 2자 이상 100자 이하여야 합니다'
                });

                // Supabase에서 추가 규칙 로드 (연결된 경우만)
                if (isSupabaseConnected) {
                    try {
                        const { data: rules, error } = await supabase
                            .from('validation_rules')
                            .select('*')
                            .eq('is_active', true);
                        
                        if (!error && rules) {
                            rules.forEach(rule => {
                                this.rules.set(rule.name, rule);
                            });
                        }
                    } catch (error) {
                        console.warn('Supabase 검증 규칙 로드 실패:', error);
                    }
                }
            }

            // 실시간 검증 (디바운싱 적용)
            validateField(fieldName, value, callback, delay = 300) {
                // 기존 타이머 취소
                if (this.debounceTimers.has(fieldName)) {
                    clearTimeout(this.debounceTimers.get(fieldName));
                }

                // 새 타이머 설정
                const timer = setTimeout(async () => {
                    const result = await this.performValidation(fieldName, value);
                    callback(result);
                    this.updateStats(result.isValid);
                    await this.logValidation(fieldName, value, result);
                }, delay);

                this.debounceTimers.set(fieldName, timer);
            }

            // 검증 수행
            async performValidation(fieldName, value) {
                const rules = this.getValidationRules(fieldName);
                const errors = [];

                for (const rule of rules) {
                    const result = await this.applyRule(rule, value);
                    if (!result.isValid) {
                        errors.push(result.message);
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors: errors,
                    fieldName: fieldName,
                    value: value
                };
            }

            // 필드별 검증 규칙 반환
            getValidationRules(fieldName) {
                const ruleMap = {
                    'email': ['email_format'],
                    'password': ['password_strength'],
                    'username': ['username_format'],
                    'todoTitle': ['todo_title']
                };

                const ruleNames = ruleMap[fieldName] || [];
                return ruleNames.map(name => this.rules.get(name)).filter(Boolean);
            }

            // 개별 규칙 적용
            async applyRule(rule, value) {
                switch (rule.type) {
                    case 'email':
                        return this.validateEmail(value, rule);
                    case 'password':
                        return this.validatePassword(value, rule);
                    case 'username':
                        return this.validateUsername(value, rule);
                    case 'text':
                        return this.validateText(value, rule);
                    default:
                        return { isValid: true, message: '' };
                }
            }

            // 이메일 검증
            validateEmail(email, rule) {
                const pattern = new RegExp(rule.pattern);
                const isValid = pattern.test(email);
                return {
                    isValid: isValid,
                    message: isValid ? '' : rule.error_message
                };
            }

            // 비밀번호 검증
            validatePassword(password, rule) {
                const checks = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                const isValid = Object.values(checks).every(check => check);
                return {
                    isValid: isValid,
                    message: isValid ? '' : rule.error_message,
                    strength: this.calculatePasswordStrength(checks)
                };
            }

            // 비밀번호 강도 계산
            calculatePasswordStrength(checks) {
                const score = Object.values(checks).filter(check => check).length;
                if (score === 5) return { level: 4, text: '매우 강함', color: 'green' };
                if (score === 4) return { level: 3, text: '강함', color: 'blue' };
                if (score === 3) return { level: 2, text: '보통', color: 'yellow' };
                if (score >= 1) return { level: 1, text: '약함', color: 'red' };
                return { level: 0, text: '매우 약함', color: 'red' };
            }

            // 사용자명 검증
            validateUsername(username, rule) {
                const pattern = new RegExp(rule.pattern);
                const isValid = pattern.test(username);
                return {
                    isValid: isValid,
                    message: isValid ? '' : rule.error_message
                };
            }

            // 텍스트 검증
            validateText(text, rule) {
                let isValid = true;
                let message = '';

                if (rule.name === 'todo_title') {
                    isValid = text.length >= 2 && text.length <= 100;
                    message = isValid ? '' : rule.error_message;
                }

                return { isValid, message };
            }

            // 중복 확인
            async checkDuplicate(fieldName, value) {
                if (!isSupabaseConnected) {
                    // 데모 모드: 항상 사용 가능으로 반환
                    return { isAvailable: true };
                }

                try {
                    // 캐시 확인
                    const { data: cached } = await supabase
                        .from('duplicate_check_cache')
                        .select('*')
                        .eq('field_name', fieldName)
                        .eq('field_value', value)
                        .gt('expires_at', new Date().toISOString())
                        .single();

                    if (cached) {
                        return { isAvailable: cached.is_available };
                    }

                    // 실제 중복 확인
                    let query = supabase.from('users').select('id');
                    if (fieldName === 'email') {
                        query = query.eq('email', value);
                    } else if (fieldName === 'username') {
                        query = query.eq('nickname', value);
                    }

                    const { data, error } = await query;
                    if (error) throw error;

                    const isAvailable = data.length === 0;

                    // 캐시에 저장
                    await supabase.from('duplicate_check_cache').upsert({
                        field_name: fieldName,
                        field_value: value,
                        is_available: isAvailable,
                        expires_at: new Date(Date.now() + 60 * 60 * 1000).toISOString()
                    });

                    return { isAvailable };
                } catch (error) {
                    console.error('중복 확인 실패:', error);
                    return { isAvailable: false };
                }
            }

            // 검증 로그 저장
            async logValidation(fieldName, value, result) {
                if (!isSupabaseConnected) return;

                try {
                    const user = await supabase.auth.getUser();
                    if (!user.data.user) return;

                    await supabase.from('validation_logs').insert({
                        user_id: user.data.user.id,
                        field_name: fieldName,
                        field_value: value,
                        is_valid: result.isValid,
                        error_message: result.errors?.join(', ') || null,
                        user_agent: navigator.userAgent
                    });
                } catch (error) {
                    console.error('검증 로그 저장 실패:', error);
                }
            }

            // 통계 업데이트
            updateStats(isValid) {
                this.stats.total++;
                if (isValid) {
                    this.stats.success++;
                } else {
                    this.stats.failed++;
                }

                // UI 업데이트
                this.updateStatsUI();
            }

            // 통계 UI 업데이트
            updateStatsUI() {
                const successRate = this.stats.total > 0 ? 
                    Math.round((this.stats.success / this.stats.total) * 100) : 0;

                // 인증 화면 통계
                const totalElement = document.getElementById('totalValidations');
                const successElement = document.getElementById('successValidations');
                const failedElement = document.getElementById('failedValidations');
                
                if (totalElement) totalElement.textContent = this.stats.total;
                if (successElement) successElement.textContent = this.stats.success;
                if (failedElement) failedElement.textContent = this.stats.failed;

                // 대시보드 통계
                const dashTotalElement = document.getElementById('dashTotalValidations');
                const dashSuccessElement = document.getElementById('dashSuccessValidations');
                const dashFailedElement = document.getElementById('dashFailedValidations');
                const dashSuccessRateElement = document.getElementById('dashSuccessRate');

                if (dashTotalElement) dashTotalElement.textContent = this.stats.total;
                if (dashSuccessElement) dashSuccessElement.textContent = this.stats.success;
                if (dashFailedElement) dashFailedElement.textContent = this.stats.failed;
                if (dashSuccessRateElement) dashSuccessRateElement.textContent = successRate + '%';

                // 통계 섹션 표시
                const statsElement = document.getElementById('validationStats');
                if (statsElement) statsElement.classList.remove('hidden');
            }

            // 사용자 검증 통계 로드
            async loadUserStats() {
                if (!isSupabaseConnected) return;

                try {
                    const user = await supabase.auth.getUser();
                    if (!user.data.user) return;

                    const { data, error } = await supabase
                        .from('user_validation_stats')
                        .select('*')
                        .eq('user_id', user.data.user.id)
                        .single();

                    if (error && error.code !== 'PGRST116') throw error;

                    if (data) {
                        this.stats = {
                            total: data.total_validations,
                            success: data.successful_validations,
                            failed: data.failed_validations
                        };
                        this.updateStatsUI();
                    }
                } catch (error) {
                    console.error('사용자 통계 로드 실패:', error);
                }
            }
        }

        // 사용자 권한 관리 클래스
        class UserPermissionManager {
            constructor() {
                this.userStatus = null;
                this.userRole = null;
                this.permissions = {};
            }

            // 사용자 상태 및 권한 확인
            async checkUserPermissions(user) {
                if (!isSupabaseConnected) {
                    // 데모 모드: 기본 권한 부여
                    return {
                        status: 'approved',
                        role: 'user',
                        isApproved: true,
                        isAdmin: false,
                        permissions: {
                            dashboard: true,
                            projects: true,
                            todos: true,
                            calendar: true,
                            admin: false
                        }
                    };
                }

                try {
                    // Supabase에서 사용자 정보 조회
                    const { data, error } = await supabase
                        .from('users')
                        .select('account_status, global_role, approved_by, approved_at')
                        .eq('id', user.id)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        throw error;
                    }

                    // 새 사용자인 경우 기본 프로필 생성
                    if (!data) {
                        await this.createUserProfile(user);
                        return {
                            status: 'pending',
                            role: 'user',
                            isApproved: false,
                            isAdmin: false,
                            permissions: {
                                dashboard: false,
                                projects: false,
                                todos: false,
                                calendar: false,
                                admin: false
                            },
                            isNewUser: true
                        };
                    }

                    const isApproved = data.account_status === 'approved';
                    const isAdmin = data.global_role === 'admin' || data.global_role === 'super_admin';

                    return {
                        status: data.account_status,
                        role: data.global_role,
                        isApproved: isApproved,
                        isAdmin: isAdmin,
                        permissions: this.calculatePermissions(data.account_status, data.global_role)
                    };

                } catch (error) {
                    console.error('권한 확인 실패:', error);
                    throw error;
                }
            }

            // 새 사용자 프로필 생성
            async createUserProfile(user) {
                const userData = {
                    id: user.id,
                    email: user.email,
                    full_name: user.user_metadata?.full_name || user.user_metadata?.name || '사용자',
                    avatar_url: user.user_metadata?.avatar_url || null,
                    account_status: 'pending',
                    global_role: 'user'
                };

                const { error } = await supabase
                    .from('users')
                    .insert(userData);

                if (error) {
                    console.error('사용자 프로필 생성 실패:', error);
                    throw error;
                }

                console.log('새 사용자 프로필 생성 완료');
            }

            // 권한 계산
            calculatePermissions(status, role) {
                const isApproved = status === 'approved';
                const isAdmin = role === 'admin' || role === 'super_admin';

                return {
                    dashboard: isApproved,
                    projects: isApproved,
                    todos: isApproved,
                    calendar: isApproved,
                    admin: isAdmin
                };
            }

            // 승인 대기 상태 처리
            showPendingApproval(user) {
                const pendingContainer = `
                    <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8 text-center">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">승인 대기 중</h2>
                            <p class="text-gray-600 mb-4">
                                계정이 관리자 승인을 기다리고 있습니다.<br>
                                승인이 완료되면 모든 기능을 이용하실 수 있습니다.
                            </p>
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <div class="text-sm text-gray-700">
                                    <div class="flex justify-between mb-2">
                                        <span>이메일:</span>
                                        <span class="font-medium">${user.email}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>이름:</span>
                                        <span class="font-medium">${user.user_metadata?.full_name || '사용자'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <button onclick="uiController.refreshUserStatus()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                    상태 새로고침
                                </button>
                                <button onclick="uiController.handleLogout()" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">
                                    다른 계정으로 로그인
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.innerHTML = pendingContainer;
            }
        }

        // UI 컨트롤러 (Google OAuth 통합)
        class UIController {
            constructor() {
                this.currentUser = null;
                this.todos = [];
                this.permissionManager = new UserPermissionManager();
                this.initializeEventListeners();
            }

            // 이벤트 리스너 초기화
            initializeEventListeners() {
                // 탭 전환
                document.getElementById('loginTab').addEventListener('click', () => this.switchTab('login'));
                document.getElementById('signupTab').addEventListener('click', () => this.switchTab('signup'));

                // 소셜 로그인
                document.getElementById('googleLoginBtn').addEventListener('click', () => this.handleGoogleLogin());
                document.getElementById('googleSignupBtn').addEventListener('click', () => this.handleGoogleSignup());
                document.getElementById('demoLoginBtn').addEventListener('click', () => this.handleDemoLogin());

                // 폼 제출
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('signupForm').addEventListener('submit', (e) => this.handleSignup(e));
                document.getElementById('todoForm').addEventListener('submit', (e) => this.handleTodoSubmit(e));

                // 로그아웃
                document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());

                // 실시간 검증
                this.setupRealTimeValidation();
            }

            // 실시간 검증 설정 (기존 코드 유지)
            setupRealTimeValidation() {
                // 회원가입 필드 검증
                document.getElementById('signupEmail').addEventListener('input', (e) => {
                    this.validateFieldWithUI('email', e.target.value, 'signupEmailError', 'signupEmailSuccess');
                });

                document.getElementById('signupUsername').addEventListener('input', (e) => {
                    this.validateFieldWithUI('username', e.target.value, 'signupUsernameError', 'signupUsernameSuccess');
                });

                document.getElementById('signupPassword').addEventListener('input', (e) => {
                    this.validatePasswordWithUI(e.target.value);
                });

                document.getElementById('signupPasswordConfirm').addEventListener('input', (e) => {
                    this.validatePasswordConfirm(e.target.value);
                });

                document.getElementById('signupFullName').addEventListener('input', (e) => {
                    this.validateRequiredField(e.target.value, 'signupFullNameError', '이름을 입력해주세요');
                });

                // 로그인 필드 검증
                document.getElementById('loginEmail').addEventListener('input', (e) => {
                    this.validateFieldWithUI('email', e.target.value, 'loginEmailError');
                });

                // 할 일 필드 검증
                document.getElementById('todoTitle').addEventListener('input', (e) => {
                    this.validateFieldWithUI('todoTitle', e.target.value, 'todoTitleError', 'todoTitleSuccess');
                });

                document.getElementById('todoDescription').addEventListener('input', (e) => {
                    this.validateDescriptionLength(e.target.value);
                });

                // 날짜 검증
                document.getElementById('todoStartDate').addEventListener('change', () => this.validateDates());
                document.getElementById('todoDueDate').addEventListener('change', () => this.validateDates());
            }

            // 필드 검증 with UI 업데이트 (기존 코드 유지)
            validateFieldWithUI(fieldName, value, errorElementId, successElementId = null) {
                if (!value.trim()) {
                    this.hideValidationMessage(errorElementId);
                    if (successElementId) this.hideValidationMessage(successElementId);
                    return;
                }

                validationSystem.validateField(fieldName, value, async (result) => {
                    if (result.isValid) {
                        this.hideValidationMessage(errorElementId);
                        
                        // 중복 확인이 필요한 필드
                        if ((fieldName === 'email' || fieldName === 'username') && successElementId) {
                            const duplicateResult = await validationSystem.checkDuplicate(fieldName, value);
                            if (duplicateResult.isAvailable) {
                                this.showValidationSuccess(successElementId);
                            } else {
                                this.showValidationError(errorElementId, `이미 사용 중인 ${fieldName === 'email' ? '이메일' : '사용자명'}입니다`);
                            }
                        } else if (successElementId) {
                            this.showValidationSuccess(successElementId);
                        }
                    } else {
                        if (successElementId) this.hideValidationMessage(successElementId);
                        this.showValidationError(errorElementId, result.errors[0]);
                    }
                    
                    this.updateSubmitButtonState();
                });
            }

            // 비밀번호 검증 with 강도 표시 (기존 코드 유지)
            validatePasswordWithUI(password) {
                if (!password) {
                    this.hideValidationMessage('signupPasswordError');
                    this.updatePasswordStrength(null);
                    return;
                }

                validationSystem.validateField('password', password, (result) => {
                    if (result.isValid) {
                        this.hideValidationMessage('signupPasswordError');
                    } else {
                        this.showValidationError('signupPasswordError', result.errors[0]);
                    }
                    
                    // 비밀번호 강도 업데이트
                    if (result.strength) {
                        this.updatePasswordStrength(result.strength);
                    }
                    
                    this.updateSubmitButtonState();
                });
            }

            // 비밀번호 강도 UI 업데이트 (기존 코드 유지)
            updatePasswordStrength(strength) {
                const bars = ['strengthBar1', 'strengthBar2', 'strengthBar3', 'strengthBar4'];
                const strengthText = document.getElementById('strengthText');

                if (!strength) {
                    bars.forEach(barId => {
                        const bar = document.getElementById(barId);
                        if (bar) bar.className = 'h-2 w-1/4 bg-gray-200 rounded';
                    });
                    if (strengthText) strengthText.textContent = '';
                    return;
                }

                const colors = {
                    red: 'bg-red-500',
                    yellow: 'bg-yellow-500',
                    blue: 'bg-blue-500',
                    green: 'bg-green-500'
                };

                bars.forEach((barId, index) => {
                    const bar = document.getElementById(barId);
                    if (bar) {
                        if (index < strength.level) {
                            bar.className = `h-2 w-1/4 ${colors[strength.color]} rounded`;
                        } else {
                            bar.className = 'h-2 w-1/4 bg-gray-200 rounded';
                        }
                    }
                });

                if (strengthText) {
                    strengthText.textContent = strength.text;
                    strengthText.className = `text-xs mt-1 text-${strength.color}-600`;
                }
            }

            // 나머지 검증 메서드들 (기존 코드 유지)
            validatePasswordConfirm(confirmPassword) {
                const password = document.getElementById('signupPassword').value;
                const errorElement = 'signupPasswordConfirmError';

                if (!confirmPassword) {
                    this.hideValidationMessage(errorElement);
                    return;
                }

                if (password !== confirmPassword) {
                    this.showValidationError(errorElement, '비밀번호가 일치하지 않습니다');
                } else {
                    this.hideValidationMessage(errorElement);
                }

                this.updateSubmitButtonState();
            }

            validateRequiredField(value, errorElementId, message) {
                if (!value.trim()) {
                    this.showValidationError(errorElementId, message);
                } else {
                    this.hideValidationMessage(errorElementId);
                }
                this.updateSubmitButtonState();
            }

            validateDescriptionLength(description) {
                const maxLength = 500;
                const errorElement = 'todoDescriptionError';

                if (description.length > maxLength) {
                    this.showValidationError(errorElement, `설명은 ${maxLength}자 이하여야 합니다 (현재: ${description.length}자)`);
                } else {
                    this.hideValidationMessage(errorElement);
                }
            }

            validateDates() {
                const startDate = document.getElementById('todoStartDate').value;
                const dueDate = document.getElementById('todoDueDate').value;
                const errorElement = 'todoDateError';

                if (startDate && dueDate && new Date(startDate) > new Date(dueDate)) {
                    this.showValidationError(errorElement, '시작 날짜는 마감 날짜보다 이전이어야 합니다');
                } else {
                    this.hideValidationMessage(errorElement);
                }
            }

            // UI 헬퍼 메서드들 (기존 코드 유지)
            showValidationError(elementId, message) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const input = element.previousElementSibling;
                
                element.textContent = message;
                element.classList.remove('hidden');
                if (input) {
                    input.classList.add('border-red-500', 'validation-error');
                    setTimeout(() => input.classList.remove('validation-error'), 300);
                }
            }

            showValidationSuccess(elementId) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const input = element.parentElement.querySelector('input');
                
                element.classList.remove('hidden');
                if (input) {
                    input.classList.add('border-green-500', 'validation-success');
                    input.classList.remove('border-red-500');
                    setTimeout(() => input.classList.remove('validation-success'), 500);
                }
            }

            hideValidationMessage(elementId) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const input = element.previousElementSibling || element.parentElement.querySelector('input');
                
                element.classList.add('hidden');
                if (input) {
                    input.classList.remove('border-red-500', 'border-green-500');
                }
            }

            updateSubmitButtonState() {
                // 회원가입 버튼
                const signupBtn = document.getElementById('signupBtn');
                if (signupBtn) {
                    const isSignupValid = this.isSignupFormValid();
                    signupBtn.disabled = !isSignupValid;
                }

                // 할 일 추가 버튼
                const todoBtn = document.getElementById('todoSubmitBtn');
                if (todoBtn) {
                    const isTodoValid = this.isTodoFormValid();
                    todoBtn.disabled = !isTodoValid;
                }
            }

            isSignupFormValid() {
                const email = document.getElementById('signupEmail').value;
                const username = document.getElementById('signupUsername').value;
                const fullName = document.getElementById('signupFullName').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupPasswordConfirm').value;

                const hasErrors = document.querySelectorAll('#signupForm .text-red-500:not(.hidden)').length > 0;

                return email && username && fullName && password && confirmPassword && 
                       password === confirmPassword && !hasErrors;
            }

            isTodoFormValid() {
                const title = document.getElementById('todoTitle').value;
                const hasErrors = document.querySelectorAll('#todoForm .text-red-500:not(.hidden)').length > 0;

                return title.trim() && !hasErrors;
            }

            // 탭 전환 (기존 코드 유지)
            switchTab(tab) {
                const loginTab = document.getElementById('loginTab');
                const signupTab = document.getElementById('signupTab');
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');

                if (tab === 'login') {
                    loginTab.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    loginTab.classList.remove('text-gray-600');
                    signupTab.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                    signupTab.classList.add('text-gray-600');
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                } else {
                    signupTab.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
                    signupTab.classList.remove('text-gray-600');
                    loginTab.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                    loginTab.classList.add('text-gray-600');
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                }
            }

            // Google 로그인 처리
            async handleGoogleLogin() {
                if (!isSupabaseConnected) {
                    alert('데모 모드에서는 Google 로그인이 지원되지 않습니다. 데모 계정으로 로그인해주세요.');
                    return;
                }

                const googleBtn = document.getElementById('googleLoginBtn');
                const originalText = googleBtn.innerHTML;
                
                googleBtn.disabled = true;
                googleBtn.innerHTML = `
                    <div class="flex items-center justify-center">
                        <div class="w-5 h-5 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin mr-2"></div>
                        Google 로그인 중...
                    </div>
                `;

                try {
                    const { data, error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.origin
                        }
                    });

                    if (error) throw error;

                    // OAuth 리다이렉트가 진행되므로 여기서는 추가 처리 불필요
                } catch (error) {
                    console.error('Google 로그인 실패:', error);
                    alert('Google 로그인 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    googleBtn.disabled = false;
                    googleBtn.innerHTML = originalText;
                }
            }

            // Google 회원가입 처리 (로그인과 동일)
            async handleGoogleSignup() {
                return this.handleGoogleLogin();
            }

            // 데모 로그인 처리
            async handleDemoLogin() {
                this.currentUser = { 
                    id: 'demo-user',
                    email: 'demo@example.com', 
                    user_metadata: { full_name: '데모 사용자' } 
                };
                
                await validationSystem.loadUserStats();
                this.showMainApp();
                this.loadTodos();
            }

            // 사용자 상태 새로고침
            async refreshUserStatus() {
                if (!isSupabaseConnected || !this.currentUser) return;

                try {
                    const permissions = await this.permissionManager.checkUserPermissions(this.currentUser);
                    
                    if (permissions.isApproved) {
                        // 승인됨: 메인 앱으로 이동
                        await validationSystem.loadUserStats();
                        this.showMainApp();
                        this.loadTodos();
                    } else {
                        // 여전히 대기 중
                        alert('아직 승인되지 않았습니다. 잠시 후 다시 시도해주세요.');
                    }
                } catch (error) {
                    console.error('상태 새로고침 실패:', error);
                    alert('상태 확인 중 오류가 발생했습니다.');
                }
            }

            // 인증된 사용자 처리
            async handleAuthenticatedUser(user) {
                this.currentUser = user;

                try {
                    // 사용자 권한 확인
                    const permissions = await this.permissionManager.checkUserPermissions(user);
                    
                    if (permissions.isNewUser) {
                        // 새 사용자: 환영 메시지와 승인 대기 안내
                        alert(`환영합니다! ${user.user_metadata?.full_name || user.email}님\n관리자 승인 후 모든 기능을 이용하실 수 있습니다.`);
                    }

                    if (permissions.isApproved) {
                        // 승인된 사용자: 메인 앱으로 이동
                        await validationSystem.loadUserStats();
                        this.showMainApp();
                        this.loadTodos();
                    } else {
                        // 승인 대기 중: 대기 화면 표시
                        this.permissionManager.showPendingApproval(user);
                    }

                } catch (error) {
                    console.error('사용자 처리 실패:', error);
                    alert('사용자 정보 처리 중 오류가 발생했습니다: ' + error.message);
                    this.handleLogout();
                }
            }

            // 이메일 로그인 처리 (기존 로직 유지)
            async handleLogin(e) {
                e.preventDefault();
                
                if (!isSupabaseConnected) {
                    // 데모 모드: 자동 로그인
                    this.handleDemoLogin();
                    return;
                }

                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const loginBtn = document.getElementById('loginBtn');

                loginBtn.disabled = true;
                loginBtn.textContent = '로그인 중...';

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    await this.handleAuthenticatedUser(data.user);
                } catch (error) {
                    console.error('로그인 실패:', error);
                    this.showValidationError('loginPasswordError', '이메일 또는 비밀번호가 잘못되었습니다');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = '이메일로 로그인';
                }
            }

            // 이메일 회원가입 처리
            async handleSignup(e) {
                e.preventDefault();
                
                if (!isSupabaseConnected) {
                    alert('데모 모드에서는 회원가입이 지원되지 않습니다. 로그인 탭에서 데모 계정으로 로그인해주세요.');
                    return;
                }

                if (!this.isSignupFormValid()) return;

                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const fullName = document.getElementById('signupFullName').value;
                const username = document.getElementById('signupUsername').value;
                const signupBtn = document.getElementById('signupBtn');

                signupBtn.disabled = true;
                signupBtn.textContent = '가입 중...';

                try {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: fullName,
                                nickname: username
                            }
                        }
                    });

                    if (error) throw error;

                    // 사용자 프로필은 인증 후 자동으로 생성됨
                    if (data.user && !data.user.email_confirmed_at) {
                        alert('회원가입이 완료되었습니다! 이메일을 확인하여 계정을 활성화해주세요.');
                        this.switchTab('login');
                    } else if (data.user) {
                        // 이메일 확인이 필요 없는 경우 바로 처리
                        await this.handleAuthenticatedUser(data.user);
                    }
                } catch (error) {
                    console.error('회원가입 실패:', error);
                    if (error.message.includes('already registered')) {
                        this.showValidationError('signupEmailError', '이미 등록된 이메일입니다');
                    } else {
                        alert('회원가입 중 오류가 발생했습니다: ' + error.message);
                    }
                } finally {
                    signupBtn.disabled = false;
                    signupBtn.textContent = '이메일로 회원가입';
                }
            }

            // 할 일 추가 처리 (연결 상태에 따라 분기)
            async handleTodoSubmit(e) {
                e.preventDefault();
                if (!this.isTodoFormValid()) return;

                const title = document.getElementById('todoTitle').value;
                const description = document.getElementById('todoDescription').value;
                const priority = document.getElementById('todoPriority').value;
                const startDate = document.getElementById('todoStartDate').value || null;
                const dueDate = document.getElementById('todoDueDate').value || null;
                const submitBtn = document.getElementById('todoSubmitBtn');

                submitBtn.disabled = true;
                submitBtn.textContent = '추가 중...';

                try {
                    if (!isSupabaseConnected) {
                        // 데모 모드: 로컬 저장소에 저장
                        const newTodo = {
                            id: Date.now().toString(),
                            title,
                            description,
                            priority,
                            start_date: startDate,
                            due_date: dueDate,
                            status: 'pending',
                            created_at: new Date().toISOString(),
                            creator: { full_name: '데모 사용자' }
                        };
                        
                        this.todos.unshift(newTodo);
                        localStorage.setItem('demo_todos', JSON.stringify(this.todos));
                    } else {
                        const { data, error } = await supabase
                            .from('todos')
                            .insert({
                                title: title,
                                description: description,
                                priority: priority,
                                start_date: startDate,
                                due_date: dueDate,
                                created_by: this.currentUser.id,
                                status: 'pending'
                            })
                            .select();

                        if (error) throw error;
                    }

                    // 폼 초기화
                    document.getElementById('todoForm').reset();
                    this.hideValidationMessage('todoTitleSuccess');
                    this.updateSubmitButtonState();

                    // 할 일 목록 새로고침
                    this.loadTodos();

                    alert('할 일이 성공적으로 추가되었습니다!');
                } catch (error) {
                    console.error('할 일 추가 실패:', error);
                    alert('할 일 추가 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '할 일 추가';
                }
            }

            // 할 일 목록 로드 (연결 상태에 따라 분기)
            async loadTodos() {
                try {
                    if (!isSupabaseConnected) {
                        // 데모 모드: 로컬 저장소에서 로드
                        const savedTodos = localStorage.getItem('demo_todos');
                        this.todos = savedTodos ? JSON.parse(savedTodos) : [];
                    } else {
                        const { data, error } = await supabase
                            .from('todos')
                            .select(`
                                *,
                                assigned_user:users!todos_assigned_to_fkey(full_name),
                                creator:users!todos_created_by_fkey(full_name)
                            `)
                            .eq('created_by', this.currentUser.id)
                            .order('created_at', { ascending: false });

                        if (error) throw error;
                        this.todos = data;
                    }

                    this.renderTodos();
                } catch (error) {
                    console.error('할 일 로드 실패:', error);
                }
            }

            // 할 일 목록 렌더링 (기존 코드 유지)
            renderTodos() {
                const todoList = document.getElementById('todoList');
                const emptyState = document.getElementById('emptyState');

                if (this.todos.length === 0) {
                    todoList.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                todoList.classList.remove('hidden');
                emptyState.classList.add('hidden');

                todoList.innerHTML = this.todos.map(todo => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-1">${todo.title}</h3>
                                ${todo.description ? `<p class="text-gray-600 text-sm mb-2">${todo.description}</p>` : ''}
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="px-2 py-1 rounded-full ${this.getPriorityClass(todo.priority)}">${this.getPriorityText(todo.priority)}</span>
                                    <span class="px-2 py-1 rounded-full ${this.getStatusClass(todo.status)}">${this.getStatusText(todo.status)}</span>
                                    ${todo.due_date ? `<span>마감: ${todo.due_date}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="uiController.updateTodoStatus('${todo.id}', '${todo.status === 'completed' ? 'pending' : 'completed'}')" 
                                        class="px-3 py-1 text-xs rounded-md ${todo.status === 'completed' ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-600'} hover:opacity-80">
                                    ${todo.status === 'completed' ? '미완료' : '완료'}
                                </button>
                                <button onclick="uiController.deleteTodo('${todo.id}')" 
                                        class="px-3 py-1 text-xs rounded-md bg-red-100 text-red-600 hover:opacity-80">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // 우선순위/상태 관련 헬퍼 메서드들 (기존 코드 유지)
            getPriorityClass(priority) {
                const classes = {
                    high: 'bg-red-100 text-red-600',
                    medium: 'bg-yellow-100 text-yellow-600',
                    low: 'bg-green-100 text-green-600'
                };
                return classes[priority] || classes.medium;
            }

            getPriorityText(priority) {
                const texts = {
                    high: '높음',
                    medium: '보통',
                    low: '낮음'
                };
                return texts[priority] || texts.medium;
            }

            getStatusClass(status) {
                const classes = {
                    pending: 'bg-gray-100 text-gray-600',
                    in_progress: 'bg-blue-100 text-blue-600',
                    completed: 'bg-green-100 text-green-600'
                };
                return classes[status] || classes.pending;
            }

            getStatusText(status) {
                const texts = {
                    pending: '대기',
                    in_progress: '진행중',
                    completed: '완료'
                };
                return texts[status] || texts.pending;
            }

            // 할 일 상태 업데이트 (연결 상태에 따라 분기)
            async updateTodoStatus(todoId, newStatus) {
                try {
                    if (!isSupabaseConnected) {
                        // 데모 모드: 로컬 데이터 업데이트
                        const todoIndex = this.todos.findIndex(todo => todo.id === todoId);
                        if (todoIndex !== -1) {
                            this.todos[todoIndex].status = newStatus;
                            this.todos[todoIndex].completed_at = newStatus === 'completed' ? new Date().toISOString() : null;
                            localStorage.setItem('demo_todos', JSON.stringify(this.todos));
                        }
                    } else {
                        const { error } = await supabase
                            .from('todos')
                            .update({ 
                                status: newStatus,
                                completed_at: newStatus === 'completed' ? new Date().toISOString() : null
                            })
                            .eq('id', todoId);

                        if (error) throw error;
                    }

                    this.loadTodos();
                } catch (error) {
                    console.error('할 일 상태 업데이트 실패:', error);
                    alert('상태 변경 중 오류가 발생했습니다');
                }
            }

            // 할 일 삭제 (연결 상태에 따라 분기)
            async deleteTodo(todoId) {
                if (!confirm('정말로 이 할 일을 삭제하시겠습니까?')) return;

                try {
                    if (!isSupabaseConnected) {
                        // 데모 모드: 로컬 데이터에서 삭제
                        this.todos = this.todos.filter(todo => todo.id !== todoId);
                        localStorage.setItem('demo_todos', JSON.stringify(this.todos));
                    } else {
                        const { error } = await supabase
                            .from('todos')
                            .delete()
                            .eq('id', todoId);

                        if (error) throw error;
                    }

                    this.loadTodos();
                } catch (error) {
                    console.error('할 일 삭제 실패:', error);
                    alert('삭제 중 오류가 발생했습니다');
                }
            }

            // 로그아웃 처리
            async handleLogout() {
                try {
                    if (isSupabaseConnected) {
                        await supabase.auth.signOut();
                    }
                    this.currentUser = null;
                    this.showAuthScreen();
                } catch (error) {
                    console.error('로그아웃 실패:', error);
                }
            }

            // 화면 전환
            showAuthScreen() {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // 사용자 정보 표시
                const userInfoElement = document.getElementById('userInfo');
                if (userInfoElement) {
                    const userName = this.currentUser.user_metadata?.full_name || this.currentUser.email || '사용자';
                    userInfoElement.textContent = `${userName}님 환영합니다!`;
                }
            }
        }

        // 전역 변수 선언
        let validationSystem = null;
        let uiController = null;

        // 페이지 로드 시 시스템 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            // UI 컨트롤러 초기화
            uiController = new UIController();
            
            // 시스템 초기화 시작
            const initializer = new SystemInitializer();
            await initializer.initialize();

            // Supabase 인증 상태 변화 리스너 (연결되어 있는 경우만)
            if (isSupabaseConnected && supabase) {
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('인증 상태 변화:', event, session?.user?.email);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        // 로그인 성공
                        await uiController.handleAuthenticatedUser(session.user);
                    } else if (event === 'SIGNED_OUT') {
                        // 로그아웃
                        uiController.currentUser = null;
                        uiController.showAuthScreen();
                    } else if (event === 'TOKEN_REFRESHED') {
                        // 토큰 갱신 - 현재 사용자 정보 업데이트
                        if (session?.user && uiController.currentUser) {
                            uiController.currentUser = session.user;
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>