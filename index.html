<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamTodo - 협업용 할 일 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onload="console.log('Supabase 라이브러리 로드 완료')" onerror="console.error('Supabase 라이브러리 로드 실패')"></script>
    <!-- Flatpickr 달력 라이브러리 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* 로딩 스피너 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            flex-direction: column;
            color: white;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 로그인 화면 */
        .landing-page {
            background: #0f172a;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 히어로 섹션 */
        .hero-section {
            min-height: 100vh;
            position: relative;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }
        
        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            opacity: 0.9;
        }
        
        .hero-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }
        
        .shape-1 {
            width: 200px;
            height: 200px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .shape-2 {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }
        
        .shape-3 {
            width: 100px;
            height: 100px;
            bottom: 20%;
            left: 60%;
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
        }
        
        .hero-text {
            color: white;
        }
        
        .brand-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .brand-icon {
            font-size: 48px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        
        .brand-title {
            font-size: 36px;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero-headline {
            font-size: 48px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hero-description {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .hero-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #fbbf24;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .hero-cta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* 구글 로그인 섹션 스타일 */
        .google-login-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 32px;
            margin-top: 32px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 8px 0;
            text-align: center;
        }

        .login-subtitle {
            color: #6b7280;
            font-size: 14px;
            text-align: center;
            margin: 0 0 24px 0;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .google-login-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .divider {
            position: relative;
            text-align: center;
            margin: 8px 0;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }

        .divider span {
            background: rgba(255, 255, 255, 0.95);
            padding: 0 16px;
            color: #9ca3af;
            font-size: 14px;
        }

        .demo-btn {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: #1f2937;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }

        .demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
        }

        /* 모바일 반응형 스타일 */
        @media (max-width: 768px) {
            .google-login-section {
                margin-top: 24px;
                padding: 24px;
                max-width: 100%;
            }

            .login-title {
                font-size: 20px;
            }

            .google-login-btn, 
            .demo-btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }
        
        .cta-primary {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: #1f2937;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
        }
        
        .cta-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.4);
        }
        
        .cta-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 14px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .cta-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* 대시보드 미리보기 */
        .hero-visual {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .dashboard-preview {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 20px;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
            animation: previewFloat 4s ease-in-out infinite;
        }
        
        @keyframes previewFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .preview-dots {
            display: flex;
            gap: 6px;
        }
        
        .preview-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
        }
        
        .preview-dots span:first-child { background: #ef4444; }
        .preview-dots span:nth-child(2) { background: #f59e0b; }
        .preview-dots span:third-child { background: #10b981; }
        
        .preview-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
        }
        
        .preview-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mini-stat {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .mini-number {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .mini-label {
            font-size: 11px;
            color: #6b7280;
        }
        
        .preview-todos {
            space-y: 8px;
        }
        
        .mini-todo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .todo-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3b82f6;
        }
        
        .todo-indicator.completed {
            background: #10b981;
        }
        
        .todo-text {
            flex: 1;
            font-size: 12px;
            color: #374151;
        }
        
        .todo-comment, .todo-status {
            font-size: 10px;
            color: #6b7280;
        }
        
        /* 기능 섹션 */
        .features-section {
            padding: 100px 20px;
            background: #1e293b;
        }
        
        .features-container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        
        .features-title {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 16px;
        }
        
        .features-subtitle {
            font-size: 18px;
            color: #94a3b8;
            margin-bottom: 60px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .feature-card:hover {
            transform: translateY(-8px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .feature-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .feature-card h3 {
            font-size: 20px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
        }
        
        .feature-card p {
            color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .feature-highlight {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: #1f2937;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        /* 로그인 모달 */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            pointer-events: auto;
        }
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            position: relative;
            z-index: 1001;
            pointer-events: auto;
        }
        .login-title {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .login-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        .login-input {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .login-btn {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .login-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        .login-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .login-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        .login-btn.secondary:hover {
            background: #e5e7eb;
        }
        .login-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #9ca3af;
        }
        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e7eb;
        }
        .login-divider span {
            padding: 0 15px;
            font-size: 14px;
        }
        .login-modes {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1;
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* 메인 앱 레이아웃 */
        .app-container {
            display: none;
            min-height: 100vh;
            background: #f8fafc;
        }
        .app-container.show { display: block; }
        
        /* 헤더 */
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .logout-btn {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .logout-btn:hover { background: #fecaca; }
        
        .reset-data-btn {
            background: #fef9c3;
            color: #b45309;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        .reset-data-btn:hover { background: #fef08a; }
        
        /* 네비게이션 */
        .nav-container {
            background: white;
            padding: 20px 30px;
            margin: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 20px;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        .nav-tab:hover:not(.active) {
            background: #f3f4f6;
        }
        
        /* 컨텐츠 영역 */
        .content-container {
            margin: 0 30px 30px;
        }
        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .content-section.active { display: block; }
        .section-title {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .section-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
        }
        
        /* 할 일 목록 */
        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .add-todo-form {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .add-todo-form input, .add-todo-form select {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        .add-todo-form input[type="text"] {
            flex: 1;
            min-width: 200px;
        }
        .add-todo-form input[type="date"] {
            min-width: 150px;
        }
        .add-todo-form select {
            min-width: 120px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            color: #6b7280;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-secondary:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }
        
        /* 승인 상태 관련 스타일 */
        .approval-status-box {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 480px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .approval-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        
        .approval-icon.pending {
            background-color: rgba(246, 173, 85, 0.2);
            color: #f6ad55;
        }
        
        .approval-icon.rejected {
            background-color: rgba(245, 101, 101, 0.2);
            color: #f56565;
        }
        
        .approval-icon.suspended {
            background-color: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }
        
        .approval-message {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 16px 0;
            color: #2d3748;
        }
        
        .approval-desc {
            color: #718096;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .approval-actions {
            margin-top: 24px;
        }
        
        /* 관리자 섹션 스타일 */
        .admin-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
        }
        
        .admin-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .admin-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background-color: white;
            font-size: 14px;
            color: #4a5568;
        }
        
        .btn-refresh {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background-color: white;
            color: #4a5568;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-refresh:hover {
            background-color: #f8fafc;
            border-color: #cbd5e0;
        }
        
        .admin-tabs {
            display: flex;
            gap: 5px;
            margin: 20px 0;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0;
            flex-wrap: wrap;
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .admin-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .admin-tab {
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            border: none;
            background-color: #f8fafc;
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            margin-bottom: -2px;
            border: 1px solid transparent;
            border-bottom: none;
            min-width: auto;
            white-space: nowrap;
        }
        
        .admin-tab.active {
            background-color: #fff;
            color: #667eea;
            border-color: #e2e8f0;
            border-bottom: 2px solid #fff;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            z-index: 1;
        }
        
        .admin-tab.active .admin-tab-icon {
            color: #667eea;
        }
        
        .admin-tab:hover:not(.active) {
            background-color: #f1f5f9;
            color: #334155;
        }
        
        .admin-tab-icon {
            font-size: 16px;
            color: #94a3b8;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        /* 관리자 탭 반응형 디자인 */
        @media (max-width: 768px) {
            .admin-tabs {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                padding-bottom: 10px;
            }
            
            .admin-tab {
                padding: 10px;
                flex-direction: column;
                text-align: center;
                border-radius: 8px;
                height: auto;
                margin-bottom: 0;
                font-size: 12px;
            }
            
            .admin-tab-icon {
                margin: 0 auto 5px;
                font-size: 18px;
            }
            
            .admin-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .users-table th,
            .users-table td {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .admin-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-card {
                border-radius: 10px;
            }
            
            .admin-card-header {
                padding: 16px;
            }
            
            .users-table-container {
                margin: 5px 0;
            }
        }
        
        /* 역할 탭 */
        .role-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .role-tab {
            padding: 8px 15px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .role-tab:hover {
            color: #667eea;
        }
        
        .role-tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        /* 역할 설명 */
        .role-description {
            display: none;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .role-description.active {
            display: block;
        }
        
        .role-description h4 {
            margin-top: 0;
            color: #4b5563;
        }
        
        /* 권한 목록 */
        .permissions-list-container {
            margin-top: 20px;
        }
        
        .permissions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .permission-item {
            background-color: #f3f4f6;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            border-left: 3px solid #667eea;
        }
        
        .permission-category {
            margin-top: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #4b5563;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 5px;
        }
        
        .admin-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(to right, #f8fafc, #ffffff);
            border-bottom: 1px solid #f1f5f9;
        }
        
        .admin-card-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .admin-card-header .subtitle {
            color: #64748b;
            font-size: 14px;
            margin: 4px 0 0 0;
            font-weight: normal;
        }
        
        .users-table-container {
            overflow-x: auto;
            padding: 0 10px;
            margin: 10px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .users-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .users-table th,
        .users-table td {
            padding: 14px 20px;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .users-table th {
            font-weight: 600;
            color: #475569;
            background-color: #f1f5f9;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .users-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .users-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .users-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .users-table td {
            font-size: 14px;
            color: #334155;
        }
        
        .user-count-badge,
        .pending-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 30px;
            height: 28px;
            padding: 0 10px;
            border-radius: 14px;
            background-color: #e0f2fe;
            color: #0284c7;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .pending-count-badge {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .user-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .user-status.pending {
            background-color: #fff7ed;
            color: #f59e0b;
        }
        
        .user-status.approved {
            background-color: #ecfdf5;
            color: #10b981;
        }
        
        .user-status.rejected {
            background-color: #fef2f2;
            color: #ef4444;
        }
        
        .user-status.suspended {
            background-color: #eff6ff;
            color: #3b82f6;
        }
        
        .user-role {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .user-role.super_admin {
            background-color: #fdf2f8;
            color: #ec4899;
        }
        
        .user-role.admin {
            background-color: #eef2ff;
            color: #667eea;
        }
        
        .user-role.user {
            background-color: #f8fafc;
            color: #64748b;
        }
        
        .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .user-action-btn,
        .action-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .user-action-btn::before,
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s ease;
        }
        
        .user-action-btn:hover::before,
        .action-btn:hover::before {
            left: 100%;
        }
        
        .user-action-btn:active,
        .action-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .approve-btn {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            border: 1px solid #059669;
            box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2);
        }
        
        .approve-btn:hover {
            background: linear-gradient(135deg, #059669, #10b981);
            box-shadow: 0 6px 8px rgba(5, 150, 105, 0.25);
            transform: translateY(-1px);
        }
        
        .approve-btn:active {
            background: linear-gradient(135deg, #047857, #059669);
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
            transform: translateY(1px);
        }
        
        .reject-btn {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            border: 1px solid #dc2626;
            box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2);
        }
        
        .reject-btn:hover {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 6px 8px rgba(220, 38, 38, 0.25);
            transform: translateY(-1px);
        }
        
        .reject-btn:active {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
            transform: translateY(1px);
        }
        
        .promote-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: 1px solid #5a67d8;
            box-shadow: 0 4px 6px rgba(90, 103, 216, 0.2);
        }
        
        .promote-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            box-shadow: 0 6px 8px rgba(90, 103, 216, 0.25);
            transform: translateY(-1px);
        }
        
        .promote-btn:active {
            background: linear-gradient(135deg, #4c51bf, #5a67d8);
            box-shadow: 0 2px 4px rgba(90, 103, 216, 0.3);
            transform: translateY(1px);
        }
        
        .suspend-btn {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
            border: 1px solid #2563eb;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }
        
        .suspend-btn:hover {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            box-shadow: 0 6px 8px rgba(37, 99, 235, 0.25);
            transform: translateY(-1px);
        }
        
        .suspend-btn:active {
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
            transform: translateY(1px);
        }
        
        .approval-requests-container {
            max-height: 500px;
            overflow-y: auto;
            padding: 16px;
        }
        
        .approval-requests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .approval-request-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .approval-request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .approval-request-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .approval-request-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #667eea;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .approval-request-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .approval-request-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .approval-request-email {
            font-size: 14px;
            color: #64748b;
        }
        
        .approval-request-date {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .approval-request-actions {
            display: flex;
            gap: 8px;
        }
        
        .admin-logs-container {
            max-height: 500px;
            overflow-y: auto;
            padding: 16px;
        }
        
        .admin-logs-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .admin-log-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        
        .admin-log-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #eef2ff;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .admin-log-content {
            flex: 1;
        }
        
        .admin-log-message {
            font-size: 14px;
            color: #334155;
            margin-bottom: 4px;
        }
        
        .admin-log-date {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* 워크스페이스 스타일 */
        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }
        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .workspace-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .workspace-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .workspace-card.active {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        /* 달력 스타일 */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .current-month {
            font-weight: 600;
            font-size: 18px;
            color: #2d3748;
            min-width: 150px;
            text-align: center;
        }
        .calendar-view {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .weekday {
            padding: 12px 10px;
            text-align: center;
            font-weight: 600;
            color: #64748b;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .weekday:first-child, .weekday:last-child {
            color: #ef4444;
            background: #fef2f2;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            background: white;
            padding: 10px;
            border-radius: 12px;
        }
        
        .calendar-day {
            background: #f8fafc;
            min-height: 90px;
            padding: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .calendar-day:hover {
            background: #f1f5f9;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-color: #d1d5db;
        }
        
        .calendar-day.other-month {
            color: #94a3b8;
            background: #f1f5f9;
            opacity: 0.7;
        }
        
        .calendar-day.today {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
        }
        
        .calendar-day.has-todos {
            background: linear-gradient(to bottom, #f8fafc, #f0f9ff);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 15px;
            color: #1e293b;
            text-align: center;
        }
        
        .calendar-day.today .day-number {
            color: #667eea;
            font-weight: 700;
        }
        .day-todos {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
        }
        
        .day-todo {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .day-todo:hover {
            transform: scale(1.3);
        }
        .day-todo.high { background: #ef4444; }
        .day-todo.medium { background: #f59e0b; }
        .day-todo.low { background: #10b981; }
        .day-todo.completed { background: #a0aec0; }
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.high { background: #ef4444; }
        .legend-dot.medium { background: #f59e0b; }
        .legend-dot.low { background: #10b981; }
        .legend-dot.completed { background: #a0aec0; }
        
        /* 달력 클릭 안전장치 스타일 */
        .calendar-day.click-disabled,
        .week-day.click-disabled {
            pointer-events: none;
            opacity: 0.7;
            cursor: not-allowed !important;
        }
        
        .calendar-day.click-processing,
        .week-day.click-processing {
            background: #e2e8f0 !important;
            pointer-events: none;
        }
        
        /* 날짜 모달 중복 방지 */
        .modal-opening {
            pointer-events: none;
        }

        
        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            color: #2d3748;
        }
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
        }
        .modal-close:hover { color: #718096; }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .member-list {
            margin-top: 10px;
        }
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .member-remove {
            color: #e53e3e;
            cursor: pointer;
        }
        
        /* 새로운 할 일 관리 스타일 */
        .todos-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }
        .todos-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .project-select {
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }
        .todos-stats {
            display: flex;
            gap: 15px;
        }
        
        /* 향상된 폼 스타일 */
        .add-todo-form {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: end;
        }
        .form-input, .form-textarea {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-textarea {
            resize: vertical;
            min-height: 60px;
            grid-column: span 3;
        }
        .date-inputs {
            grid-column: span 3;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .date-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .date-group label {
            font-size: 12px;
            font-weight: 600;
            color: #718096;
        }
        
        /* 프로젝트 색상 선택기 */
        .color-picker {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #2d3748;
            transform: scale(1.1);
        }
        
        /* 향상된 달력 UI */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            position: relative;
        }
        
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        /* 월/주 전환 버튼 스타일 */
        .view-toggles {
            display: flex;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 14px;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid #e5e7eb;
        }
        
        .view-btn {
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #64748b;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .view-btn:hover {
            color: #4b5563;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }
        
        /* 달력 네비게이션 컨트롤 */
        .navigation-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        
        .btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #667eea;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .btn-icon:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .current-period {
            font-weight: 700;
            font-size: 16px;
            color: #1e293b;
            min-width: 180px;
            text-align: center;
            padding: 0 10px;
            letter-spacing: -0.3px;
        }
        
        /* 오늘 버튼 스타일 */
        .btn-today {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 2px solid #667eea;
            background: linear-gradient(135deg, #f0f5ff 0%, #e0e7ff 100%);
            color: #667eea;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        
        .btn-today:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-today:active {
            transform: translateY(0);
        }
        
        .btn-today svg {
            transition: all 0.3s ease;
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .calendar-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .calendar-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .navigation-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .current-period {
                min-width: 140px;
            }
        }
        .calendar-container {
            min-height: 400px;
        }
        
        /* 주간 달력 스타일 */
        .week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
        }
        .week-day {
            background: white;
            min-height: 120px;
            padding: 12px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .week-day:hover {
            background: #f7fafc;
        }
        .week-day.today {
            background: #ebf8ff;
            border: 2px solid #3182ce;
        }
        .week-day-number {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .week-day-todos {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .week-todo-item {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .week-todo-item.high { background: #ef4444; }
        .week-todo-item.medium { background: #f59e0b; }
        .week-todo-item.low { background: #10b981; }
        .week-todo-item.completed { 
            background: #9ca3af; 
            text-decoration: line-through;
        }
        
        /* 날짜 모달 스타일 */
        .date-todos-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .date-todo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8fafc;
        }
        .date-todo-info {
            flex: 1;
        }
        .date-todo-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }
        .date-todo-project {
            font-size: 12px;
            color: #718096;
        }
        .date-todo-priority {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .modal-actions {
            margin-top: 20px;
            text-align: center;
        }
        
        /* 프로젝트 관련 스타일 */
        .project-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-left: 8px;
        }
        .todo-item-enhanced {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .todo-item-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .todo-content {
            flex: 1;
        }
        .todo-title-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .todo-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }
        .todo-dates {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }
        .todo-description {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.4;
        }
        .todo-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        

        .project-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 2px solid transparent;
            border-radius: 20px;
            background: #f7fafc;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .project-tab:hover {
            background: #edf2f7;
        }
        .project-tab.active {
            border-color: currentColor;
            background: #f0fff4;
            color: #38a169;
        }
        .project-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .project-tab-all {
            background: #e2e8f0;
            color: #2d3748;
        }
        .project-tab-all.active {
            background: #bee3f8;
            color: #2b6cb0;
        }
        
        /* 향상된 날짜 모달 스타일 */
        .date-modal-content {
            max-width: 600px;
            width: 90%;
        }
        .date-todos-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .enhanced-date-todo-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .enhanced-date-todo-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .todo-color-indicator {
            width: 4px;
            height: 100%;
            border-radius: 2px;
            margin-right: 16px;
            flex-shrink: 0;
        }
        .todo-main-info {
            flex: 1;
        }
        .todo-title-enhanced {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
            font-size: 16px;
        }
        .todo-meta-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .todo-project-name {
            background: #f7fafc;
            color: #4a5568;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .todo-dates-info {
            font-size: 12px;
            color: #718096;
        }
        .todo-description-preview {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.4;
        }
        .todo-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }
        .todo-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        
        /* 할 일 상세보기 모달 스타일 */
        .todo-detail-content-large {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
        }
        .todo-detail-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            height: 100%;
        }
        .todo-detail-info {
            overflow-y: auto;
        }
        .todo-detail-section {
            margin-bottom: 20px;
        }
        .todo-detail-section h4 {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .todo-detail-value {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.5;
        }
        .todo-dates-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.2);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:active {
            transform: translateY(0);
        }
        
        /* 댓글 섹션 스타일 */
        .todo-comments-section {
            border-left: 1px solid #e2e8f0;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .comments-header h4 {
            margin: 0;
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }
        .comment-count-badge {
            background: #f1f5f9;
            color: #475569;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .comments-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        .comment-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }
        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .comment-author {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        .comment-time {
            font-size: 11px;
            color: #a0aec0;
        }
        .comment-content {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .comment-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .comment-action-btn {
            background: none;
            border: none;
            color: #718096;
            font-size: 11px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .comment-action-btn:hover {
            background: #e2e8f0;
            color: #4a5568;
        }
        .comment-form {
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }
        .comment-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .comment-textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 120px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .comment-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-add-comment {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            align-self: flex-start;
            transition: background 0.2s;
        }
        .btn-add-comment:hover {
            background: #5a67d8;
        }
        .btn-add-comment:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        .comment-count {
            font-size: 12px;
            color: #718096;
            margin-left: 8px;
        }
        
        /* 댓글 편집 모드 */
        .comment-edit-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        .comment-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-comment-save, .btn-comment-cancel {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-comment-save {
            background: #10b981;
            color: white;
        }
        .btn-comment-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        /* 향상된 대시보드 스타일 */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }
        .dashboard-filters {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .dashboard-select {
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .dashboard-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .dashboard-stat-card.active {
            border-color: #667eea;
            background: #f0f9ff;
        }
        .stat-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #0f172a;
        }
        .dashboard-todos-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .todos-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .todos-section-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
        }
        .dashboard-todos-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* 대시보드 필터 상태 */
        .dashboard-filter-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-clear {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
        }
        
        /* 프로젝트 관리 스타일 개선 */
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }
        
        .projects-title-area h2 {
            margin-bottom: 8px;
        }
        
        .btn-create-project {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-create-project:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .project-tabs-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .project-tabs {
            display: flex;
            gap: 8px;
            min-width: max-content;
        }
        
        .project-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
        }
        
        .project-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .project-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .project-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .project-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .project-stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
        }

        /* 현대적인 모달 스타일 */
        .modern-modal {
            max-width: 520px;
            width: 90vw;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modern-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 28px;
            border: none;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .modal-title-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .modal-subtitle {
            font-size: 14px;
            margin: 0;
            opacity: 0.9;
            font-weight: 400;
        }

        .close-btn-modern {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .close-btn-modern:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .modern-form {
            padding: 28px;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section:last-of-type {
            margin-bottom: 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
        }

        .label-text {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }

        .label-required {
            color: #ef4444;
            margin-left: 4px;
        }

        .label-optional {
            color: #6b7280;
            font-size: 12px;
            font-weight: 400;
            margin-left: 8px;
        }

        .label-description {
            display: block;
            font-size: 12px;
            color: #6b7280;
            font-weight: 400;
            margin-top: 2px;
        }

        .modern-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #fafafa;
        }

        .modern-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modern-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #fafafa;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .modern-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .character-count {
            text-align: right;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .color-option-modern {
            cursor: pointer;
        }

        .color-option-modern input[type="radio"] {
            display: none;
        }

        .color-swatch {
            height: 80px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .color-swatch:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .color-option-modern input[type="radio"]:checked + .color-swatch {
            border-color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .color-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .color-option-modern input[type="radio"]:checked + .color-swatch .color-check {
            opacity: 1;
        }

        .color-label {
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            margin-top: 4px;
        }

        .modern-footer {
            padding: 0;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px 28px;
        }

        .btn-secondary-modern {
            padding: 12px 24px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #6b7280;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary-modern:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .btn-primary-modern {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }

        .btn-primary-modern:active {
            transform: translateY(0);
        }

        /* 삭제 버튼이 있는 푸터 스타일 */
        .modern-footer-with-delete {
            justify-content: space-between;
            align-items: center;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn-delete-modern {
            padding: 12px 20px;
            border: 2px solid #fee2e2;
            background: #fef2f2;
            color: #dc2626;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-delete-modern:hover {
            border-color: #fecaca;
            background: #fee2e2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        }

        /* 할 일 상세보기 모달 특별 스타일 */
        .todo-detail-modal {
            max-width: 900px;
            width: 95vw;
            max-height: 90vh;
        }

        .todo-detail-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .todo-detail-body {
            padding: 0;
            max-height: calc(90vh - 120px);
            overflow: hidden;
        }

        .todo-detail-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            min-height: 500px;
            max-height: calc(90vh - 120px);
        }

        .todo-detail-info {
            padding: 28px;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .todo-detail-content {
            flex: 1;
            margin-bottom: 24px;
        }

        .todo-action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .todo-comments-section {
            padding: 28px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            max-height: calc(90vh - 120px);
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .comments-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .comment-count-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .comments-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 4px;
        }

        .comment-form {
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }

        .comment-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .comment-textarea {
            flex: 1;
            min-height: 60px;
            resize: vertical;
        }

        .btn-add-comment {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-add-comment:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }

        /* 반응형 할 일 상세 모달 */
        @media (max-width: 768px) {
            .todo-detail-modal {
                max-width: 95vw;
                width: 95vw;
                max-height: 95vh;
            }

            .todo-detail-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .todo-detail-info {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                max-height: 300px;
                overflow-y: auto;
            }

            .todo-comments-section {
                max-height: calc(95vh - 420px);
            }

            .todo-action-buttons {
                flex-direction: column;
            }

            .comment-input-container {
                flex-direction: column;
                gap: 8px;
            }

            .btn-add-comment {
                width: 100%;
                justify-content: center;
            }
        }

        /* 날짜 모달 특별 스타일 */
        .date-modal {
            max-width: 600px;
        }

        .date-todos-list {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 16px 0;
        }

        .date-todos-list:empty::before {
            content: "이 날짜에 등록된 할 일이 없습니다.";
            display: block;
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 40px 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #e5e7eb;
        }

        /* 모바일 대응 */
        @media (max-width: 480px) {
            .date-modal {
                max-width: 95vw;
            }
        }

        /* 모달 애니메이션 */
        .modal {
            animation: modalFadeIn 0.3s ease-out;
        }

        .modern-modal {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .modern-modal {
                max-width: 95vw;
                margin: 20px;
            }

            .modern-header {
                padding: 20px 24px;
            }

            .modal-title-wrapper {
                gap: 12px;
            }

            .modal-icon {
                width: 40px;
                height: 40px;
            }

            .modal-title {
                font-size: 20px;
            }

            .modal-subtitle {
                font-size: 13px;
            }

            .modern-form {
                padding: 24px;
            }

            .color-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .color-swatch {
                height: 70px;
            }

            .modern-footer {
                padding: 16px 24px;
                flex-direction: column-reverse;
                gap: 8px;
            }

            .btn-secondary-modern,
            .btn-primary-modern {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .modern-modal {
                max-width: 100vw;
                margin: 10px;
                border-radius: 16px;
            }

            .color-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .color-swatch {
                height: 60px;
            }

            .color-label {
                font-size: 11px;
            }
        }
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }
        
        .project-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .project-todos-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 24px;
        }
        
        .project-todos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .project-todos-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
        }
        
        .project-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-add-todo {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-add-todo:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .project-todos-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .project-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .project-empty-state .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .project-empty-state h3 {
            margin-bottom: 8px;
            color: #6b7280;
        }
        
        .project-empty-state p {
            margin-bottom: 20px;
        }
        
        /* 반응형 */
        @media (max-width: 768px) {

            .workspace-grid {
                grid-template-columns: 1fr;
            }
            .calendar-day {
                min-height: 60px;
            }
            .add-todo-form {
                grid-template-columns: 1fr;
            }
            .date-inputs {
                grid-column: span 1;
            }
            .todos-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            .todos-controls {
                flex-wrap: wrap;
            }
            .calendar-controls {
                flex-direction: column;
                gap: 15px;
            }
            .week-day {
                min-height: 80px;
                padding: 8px;
            }
            .projects-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .todo-dates-grid {
                grid-template-columns: 1fr;
            }
            .todo-detail-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .todo-comments-section {
                border-left: none;
                border-top: 1px solid #e2e8f0;
                padding-left: 0;
                padding-top: 20px;
                height: auto;
                max-height: 400px;
            }
        }

        /* 실시간 알림 애니메이션 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .realtime-notification {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: #2d3748;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-icon {
            font-size: 18px;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #a0aec0;
            padding: 0;
            margin-left: 10px;
        }
        
        .notification-close:hover {
            color: #2d3748;
        }
        
        /* 실시간 상태 표시 */
        .realtime-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #10b981;
            margin-left: 10px;
        }
        
        .realtime-status.connected::before {
            content: '●';
            color: #10b981;
            animation: pulse 2s infinite;
        }
        
        .realtime-status.disconnected::before {
            content: '●';
            color: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===========================================
           🎨 MODERN UI/UX UPGRADE STYLES
           =========================================== */

        /* 현대적인 페이지 헤더 */
        .modern-page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .modern-page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .modern-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-icon {
            font-size: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .modern-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 8px 0 0 0;
            font-weight: 400;
        }

        .header-actions {
            position: relative;
        }

        .btn-modern-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .btn-modern-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* 컨트롤 패널 */
        .control-panel {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
        }

        .filter-section {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .modern-select {
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
        }

        .modern-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .status-filters {
            display: flex;
            gap: 8px;
        }

        .status-filter {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .status-filter.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .status-filter:hover:not(.active) {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        /* 통계 그리드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 2px solid #f1f5f9;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-color);
        }

        .stat-card.primary { --accent-color: #667eea; }
        .stat-card.success { --accent-color: #10b981; }
        .stat-card.warning { --accent-color: #f59e0b; }
        .stat-card.info { --accent-color: #06b6d4; }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
        }

        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .stat-content {
            display: flex;
            flex-direction: column;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-top: 4px;
        }

        /* 현대적인 폼 스타일 */
        .modern-todo-form {
            margin-bottom: 32px;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
        }

        .form-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .form-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 4px 0 0 0;
        }

        .form-grid {
            padding: 32px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-wrapper.full-width {
            grid-column: 1 / -1;
        }

        .modern-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .label-required {
            color: #ef4444;
            font-weight: 700;
        }

        .modern-input, .modern-textarea {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .modern-input:focus, .modern-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modern-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-actions {
            padding: 24px 32px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }

        .btn-add-todo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-add-todo:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* 할일 목록 컨테이너 */
        .todos-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            overflow: hidden;
        }

        .todos-list-header {
            padding: 24px 32px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .view-options {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            padding: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .view-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .view-btn:hover:not(.active) {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .modern-todo-list {
            padding: 32px;
            min-height: 300px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .error-state {
            color: #e53e3e;
            padding: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        .retry-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .retry-btn:hover {
            background-color: #2563eb;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            color: #374151;
            margin: 0 0 8px 0;
        }

        .empty-state p {
            font-size: 0.875rem;
            margin: 0;
            opacity: 0.8;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .modern-page-header {
                padding: 24px;
                margin-bottom: 24px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .modern-title {
                font-size: 2rem;
            }
            
            .filter-section {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
            
            .form-grid {
                padding: 24px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .todos-list-header {
                padding: 20px 24px;
            }
            
            .modern-todo-list {
                padding: 24px;
            }
        }

        /* 현대적인 할일 카드 스타일 */
        .modern-todo-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid #f1f5f9;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .modern-todo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--priority-color);
            transition: width 0.3s ease;
        }

        .modern-todo-card.status-pending { --priority-color: #f59e0b; }
        .modern-todo-card.status-progress { --priority-color: #3b82f6; }
        .modern-todo-card.status-completed { 
            --priority-color: #10b981;
            opacity: 0.8;
        }

        .modern-todo-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--priority-color);
        }

        .modern-todo-card:hover::before {
            width: 8px;
        }

        .todo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .todo-priority {
            font-size: 1.2rem;
        }

        .todo-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .todo-status-badge.status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .todo-status-badge.status-progress {
            background: #dbeafe;
            color: #2563eb;
        }

        .todo-status-badge.status-completed {
            background: #d1fae5;
            color: #059669;
        }

        .todo-card-content {
            margin-bottom: 16px;
        }

        .todo-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
            line-height: 1.4;
        }

        .todo-card-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0 0 12px 0;
            line-height: 1.5;
        }

        .todo-card-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .todo-project-tag, .todo-date-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .todo-project-tag {
            border: 1px solid currentColor;
        }

        .project-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .todo-date-tag {
            background: #f3f4f6;
            color: #6b7280;
        }

        .todo-card-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .todo-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-action-btn.complete {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .todo-action-btn.complete:hover {
            background: #16a34a;
            color: white;
            transform: scale(1.1);
        }

        .todo-action-btn.delete {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .todo-action-btn.delete:hover {
            background: #dc2626;
            color: white;
            transform: scale(1.1);
        }

        /* 카드 뷰와 리스트 뷰 전환 */
        .modern-todo-list.list-view .modern-todo-card {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            margin-bottom: 8px;
        }

        .modern-todo-list.list-view .todo-card-header {
            margin-bottom: 0;
            margin-right: 16px;
        }

        .modern-todo-list.list-view .todo-card-content {
            flex: 1;
            margin-bottom: 0;
            margin-right: 16px;
        }

        .modern-todo-list.list-view .todo-card-title {
            margin-bottom: 4px;
        }

        .modern-todo-list.list-view .todo-card-description {
            margin-bottom: 0;
        }

        /* 완료된 할일 스타일 */
        .modern-todo-card.status-completed .todo-card-title {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .modern-todo-card.status-completed .todo-card-description {
            opacity: 0.6;
        }

        /* 할 일 아이템 */
        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .todo-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .todo-item.high { border-left-color: #ef4444; }
        .todo-item.medium { border-left-color: #f59e0b; }
        .todo-item.low { border-left-color: #10b981; }
        .todo-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }
        .todo-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }
        .todo-info { flex: 1; }
        .todo-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
        }
        .todo-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .todo-description {
            color: #4b5563;
            line-height: 1.5;
        }
        .todo-actions {
            display: flex;
            gap: 8px;
        }
        .btn-sm {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-complete {
            background: #dcfce7;
            color: #16a34a;
        }
        .btn-complete:hover { background: #bbf7d0; }
        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }
        .btn-delete:hover { background: #fecaca; }
        
        /* 워크스페이스 관리 */
        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .workspace-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .workspace-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .workspace-card.active {
            border-color: #667eea;
            background: #eef2ff;
        }
        .workspace-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1f2937;
        }
        .workspace-desc {
            color: #6b7280;
            margin-bottom: 15px;
        }
        .workspace-meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #9ca3af;
        }
        
        /* 알림 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
            z-index: 1000;
            max-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            border-left-color: #ef4444;
        }
        
        /* 반응형 */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            .nav-container, .content-container {
                margin-left: 20px;
                margin-right: 20px;
            }
            .content-section {
                padding: 20px;
            }
            .add-todo-form {
                flex-direction: column;
            }
            .todo-content {
                flex-direction: column;
                gap: 15px;
            }
            .workspace-grid {
                grid-template-columns: 1fr;
            }
        }
        /* 프로젝트 모달 스타일 */
        .color-picker {
            margin-top: 10px;
        }
        
        .color-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .color-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .color-option:hover {
            background: #f8fafc;
        }
        
        .color-option input[type="radio"] {
            display: none;
        }
        
        .color-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option input[type="radio"]:checked + .color-circle {
            border-color: #374151;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px currentColor;
        }
        
        .color-name {
            font-size: 14px;
            color: #4a5568;
        }
        
        .modal-footer-right {
            display: flex;
            gap: 12px;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        /* 프로젝트 탭 컨텍스트 메뉴 */
        .project-tab-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .project-context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            z-index: 1000;
            min-width: 120px;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .context-menu-item:hover {
            background: #f8fafc;
        }
        
        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        /* 탭 권한 관리 스타일 */
        .tab-permissions-container {
            margin-top: 20px;
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 15px;
        }
        
        .permission-info {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .tab-permissions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tab-permission-item {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tab-permission-label {
            flex: 1;
            font-weight: 500;
        }
        
        .tab-permission-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .tab-permission-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .tab-permission-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .4s;
            border-radius: 24px;
        }
        
        .tab-permission-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .tab-permission-slider {
            background-color: #667eea;
        }
        
        input:checked + .tab-permission-slider:before {
            transform: translateX(26px);
        }
        
        .tab-permission-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        /* 역할 관리 스타일 */
        .roles-container {
            padding: 10px 0;
        }
        
        .roles-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .roles-list-container {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 15px;
        }
        
        .roles-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        .role-item {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .role-info {
            flex: 1;
        }
        
        .role-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .role-desc {
            font-size: 14px;
            color: #6b7280;
        }
        
        .role-actions {
            display: flex;
            gap: 10px;
        }
        
        .system-badge {
            display: inline-block;
            background-color: #e0e7ff;
            color: #4f46e5;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .mt-4 {
            margin-top: 20px;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .warning {
            color: #b91c1c;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .highlight {
            font-weight: bold;
            color: #111827;
        }
        
        .delete-btn {
            background-color: #e53e3e;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #c53030;
        }
        
        /* 작업 요청 관리 스타일 */
        .action-requests-container {
            margin-top: 20px;
        }
        
        .action-requests-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .action-request-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .action-request-item.status-pending {
            border-left: 4px solid #f59e0b;
        }
        
        .action-request-item.status-approved {
            border-left: 4px solid #10b981;
        }
        
        .action-request-item.status-rejected {
            border-left: 4px solid #ef4444;
        }
        
        .action-request-info {
            flex: 1;
        }
        
        .action-request-header {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .action-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .action-type-badge.approve { background-color: #10b981; }
        .action-type-badge.reject { background-color: #ef4444; }
        .action-type-badge.suspend { background-color: #f59e0b; }
        .action-type-badge.promote { background-color: #8b5cf6; }
        .action-type-badge.demote { background-color: #6b7280; }
        .action-type-badge.change_role { background-color: #3b82f6; }
        
        .action-status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .action-status-badge.pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .action-status-badge.approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .action-status-badge.rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .action-request-details {
            font-size: 14px;
            color: #4b5563;
        }
        
        .action-request-details > div {
            margin-bottom: 5px;
        }
        
        .action-request-actions {
            display: flex;
            gap: 10px;
        }
        
        .review-details {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .review-details h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .review-details p {
            margin-bottom: 8px;
            color: #6b7280;
        }
        
        .count-badge {
            background-color: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <h2>TeamTodo 로딩 중...</h2>
        <p>잠시만 기다려주세요</p>
    </div>

    <!-- 현대적인 랜딩 페이지 -->
    <div id="loginContainer" class="landing-page" style="display: flex;">
        <!-- 히어로 섹션 -->
        <section class="hero-section">
            <div class="hero-background">
                <div class="hero-shapes">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
            </div>
            
            <div class="hero-content">
                <div class="hero-text">
                    <div class="brand-header">
                        <div class="brand-icon">📋</div>
                        <h1 class="brand-title">TeamTodo</h1>
                    </div>
                    
                    <h2 class="hero-headline">
                        팀과 함께하는<br>
                        <span class="gradient-text">스마트한 할 일 관리</span>
                    </h2>
                    
                    <p class="hero-description">
                        실시간 협업, 댓글 시스템, 프로젝트 관리까지.<br>
                        소규모 팀을 위한 올인원 할 일 관리 플랫폼
                    </p>
                    
                    <div class="hero-stats">
                        <div class="stat-item">
                            <div class="stat-number">10</div>
                            <div class="stat-label">팀원</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">∞</div>
                            <div class="stat-label">프로젝트</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">실시간</div>
                            <div class="stat-label">협업</div>
                        </div>
                    </div>
                    
                    <!-- 구글 로그인 섹션 -->
                    <div class="google-login-section">
                        <h3 class="login-title">로그인하여 시작하기</h3>
                        <p class="login-subtitle">구글 계정으로 간편하게 로그인하세요</p>
                        
                        <div class="login-form">
                            <button class="google-login-btn" onclick="signInWithGoogle()">
                                <svg width="18" height="18" viewBox="0 0 24 24">
                                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                구글로 로그인
                            </button>
                            
                            <div class="divider">
                                <span>또는</span>
                            </div>
                            
                            <button class="demo-btn" onclick="loginAsTestUser()">
                                ✨ 데모 체험하기
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="hero-visual">
                    <div class="dashboard-preview">
                        <div class="preview-header">
                            <div class="preview-dots">
                                <span></span><span></span><span></span>
                            </div>
                            <div class="preview-title">TeamTodo Dashboard</div>
                        </div>
                        <div class="preview-content">
                            <div class="preview-stats">
                                <div class="mini-stat">
                                    <div class="mini-number">12</div>
                                    <div class="mini-label">전체</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-number">8</div>
                                    <div class="mini-label">진행중</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="mini-number">4</div>
                                    <div class="mini-label">완료</div>
                                </div>
                            </div>
                            <div class="preview-todos">
                                <div class="mini-todo">
                                    <div class="todo-indicator"></div>
                                    <div class="todo-text">UI 디자인 개선</div>
                                    <div class="todo-comment">💬 3</div>
                                </div>
                                <div class="mini-todo">
                                    <div class="todo-indicator completed"></div>
                                    <div class="todo-text">데이터베이스 설계</div>
                                    <div class="todo-status">✅</div>
                                </div>
                                <div class="mini-todo">
                                    <div class="todo-indicator"></div>
                                    <div class="todo-text">API 개발</div>
                                    <div class="todo-comment">💬 1</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 핵심 기능 섹션 -->
        <section class="features-section">
            <div class="features-container">
                <h2 class="features-title">팀 협업의 새로운 기준</h2>
                <p class="features-subtitle">TeamTodo로 팀의 생산성을 극대화하세요</p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <h3>실시간 대시보드</h3>
                        <p>팀의 진행 상황을 한눈에 파악하고 병목 구간을 즉시 발견하세요</p>
                        <div class="feature-highlight">클릭 한 번으로 필터링</div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">💬</div>
                        <h3>할 일별 댓글</h3>
                        <p>각 할 일에서 팀원들과 실시간으로 소통하고 진행 상황을 공유하세요</p>
                        <div class="feature-highlight">실시간 알림</div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">📁</div>
                        <h3>프로젝트 관리</h3>
                        <p>다양한 프로젝트를 색상별로 구분하고 체계적으로 관리하세요</p>
                        <div class="feature-highlight">시각적 구분</div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">📅</div>
                        <h3>스마트 캘린더</h3>
                        <p>월별/주별 뷰로 할 일을 확인하고 마감일을 놓치지 마세요</p>
                        <div class="feature-highlight">직관적 인터페이스</div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 로그인 모달 -->
        <div id="loginModal" class="login-modal" style="display: none;">
            <div class="modal-backdrop" onclick="hideLoginModal()"></div>
            <div class="login-card">
                <div class="login-header">
                    <h2>TeamTodo 시작하기</h2>
                    <button class="close-btn" onclick="hideLoginModal()">×</button>
                </div>
                
                <!-- 로그인 모드 선택 -->
                <div class="login-modes">
                    <button class="mode-btn active" onclick="switchLoginMode('email')">로그인</button>
                    <button class="mode-btn" onclick="switchLoginMode('signup')">회원가입</button>
                </div>
                
                <!-- 이메일/패스워드 로그인 폼 -->
                <div id="emailLoginForm" class="login-form">
                    <input type="email" id="loginEmail" class="login-input" placeholder="이메일 주소" required>
                    <input type="password" id="loginPassword" class="login-input" placeholder="비밀번호" required>
                    <button id="emailLoginBtn" class="login-btn" onclick="loginWithEmail()">로그인</button>
                </div>
                
                <!-- 회원가입 폼 -->
                <div id="signupForm" class="login-form" style="display: none;">
                    <input type="text" id="signupName" class="login-input" placeholder="이름" required>
                    <input type="email" id="signupEmail" class="login-input" placeholder="이메일 주소" required>
                    <input type="password" id="signupPassword" class="login-input" placeholder="비밀번호 (6자 이상)" required>
                    <input type="password" id="signupPasswordConfirm" class="login-input" placeholder="비밀번호 확인" required>
                    <button id="signupBtn" class="login-btn" onclick="signupWithEmail()">회원가입</button>
                </div>
                
                <div class="login-divider">
                    <span>또는</span>
                </div>
                
                <!-- Google 로그인 -->
                <button id="googleLoginBtn" class="login-btn secondary" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Google로 계속하기
                </button>
            </div>
        </div>
    </div>
    
    <!-- 승인 대기 화면 -->
    <div id="approvalPendingContainer" class="landing-page" style="display: none;">
        <section class="hero-section">
            <div class="hero-background">
                <div class="hero-shapes">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
            </div>
            <div class="container">
                <div class="approval-status-box">
                    <div class="approval-icon pending">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2>승인 대기 중</h2>
                    <p class="approval-message">
                        <span id="pendingUserEmail">사용자</span> 계정이 관리자 승인을 기다리고 있습니다.
                    </p>
                    <p class="approval-desc">
                        승인이 완료되면 서비스를 이용하실 수 있습니다.<br>
                        관리자에게 승인 요청 메시지를 보내셨다면, 잠시 기다려 주세요.
                    </p>
                    <div class="approval-actions">
                        <button onclick="handleLogout()" class="btn-secondary">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- 승인 거부 화면 -->
    <div id="approvalRejectedContainer" class="landing-page" style="display: none;">
        <section class="hero-section">
            <div class="hero-background">
                <div class="hero-shapes">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
            </div>
            <div class="container">
                <div class="approval-status-box">
                    <div class="approval-icon rejected">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M15 9L9 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2>승인 거부됨</h2>
                    <p class="approval-message">
                        <span id="rejectedUserEmail">사용자</span> 계정의 가입 요청이 거부되었습니다.
                    </p>
                    <p class="approval-desc">
                        자세한 내용은 관리자에게 문의해 주세요.<br>
                        다른 계정으로 로그인하시려면 로그아웃 후 다시 시도해 주세요.
                    </p>
                    <div class="approval-actions">
                        <button onclick="handleLogout()" class="btn-secondary">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- 계정 정지 화면 -->
    <div id="accountSuspendedContainer" class="landing-page" style="display: none;">
        <section class="hero-section">
            <div class="hero-background">
                <div class="hero-shapes">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
            </div>
            <div class="container">
                <div class="approval-status-box">
                    <div class="approval-icon suspended">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M12 16V16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2>계정 정지됨</h2>
                    <p class="approval-message">
                        <span id="suspendedUserEmail">사용자</span> 계정이 현재 정지 상태입니다.
                    </p>
                    <p class="approval-desc">
                        계정 정지 사유에 대해서는 관리자에게 문의해 주세요.<br>
                        정지가 해제되면 다시 서비스를 이용하실 수 있습니다.
                    </p>
                    <div class="approval-actions">
                        <button onclick="handleLogout()" class="btn-secondary">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 메인 앱 -->
    <div id="appContainer" class="app-container">
        <!-- 헤더 -->
        <div class="header">
            <div class="logo">
                📋 TeamTodo
                <span id="realtimeStatusIndicator" class="realtime-status connected" style="display: none;">
                    실시간 연결됨
                </span>
            </div>
            <div class="user-info">
                <div id="userAvatar" class="user-avatar"></div>
                <span id="userName"></span>
                <button id="resetDataBtn" class="reset-data-btn" title="데모 데이터 초기화">🔄 데이터 초기화</button>
                <button id="logoutBtn" class="logout-btn">로그아웃</button>
            </div>
        </div>



        <!-- 네비게이션 -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboard')" style="opacity: 0.5; pointer-events: none;" title="승인된 사용자만 사용 가능합니다">대시보드</button>
                <button class="nav-tab" onclick="showSection('projects')" style="opacity: 0.5; pointer-events: none;" title="승인된 사용자만 사용 가능합니다">프로젝트</button>
                <button class="nav-tab" onclick="showSection('todos')" style="opacity: 0.5; pointer-events: none;" title="승인된 사용자만 사용 가능합니다">할 일 관리</button>
                <button class="nav-tab" onclick="showSection('calendar')" style="opacity: 0.5; pointer-events: none;" title="승인된 사용자만 사용 가능합니다">달력</button>
                <button id="adminNavTab" class="nav-tab" onclick="showSection('admin')" style="display: none;">👑 관리자</button>
            </div>
        </div>

        <!-- 컨텐츠 영역 -->
        <div class="content-container">
            <!-- 대시보드 -->
            <div id="dashboard" class="content-section active">
                <div class="dashboard-header">
                    <div>
                        <h2 class="section-title">📊 대시보드</h2>
                        <p class="section-subtitle">프로젝트 현황과 할 일을 한눈에 확인하세요</p>
                    </div>
                    <div class="dashboard-filters">
                        <select id="dashboardProjectFilter" onchange="filterDashboardByProject()" class="dashboard-select">
                            <option value="">모든 프로젝트</option>
                        </select>
                    </div>
                </div>
                
                <div id="dashboardStats" class="dashboard-stats">
                    <!-- 통계가 동적으로 추가됨 -->
                </div>
                
                <div class="dashboard-todos-section">
                    <div class="todos-section-header">
                        <h3>📋 할 일 목록</h3>
                        <span id="dashboardTodoCount" class="todo-count-badge">0개</span>
                    </div>
                    <div id="dashboardTodosList" class="dashboard-todos-list">
                        <!-- 할 일이 동적으로 추가됨 -->
                    </div>
                </div>
            </div>

            <!-- 프로젝트 관리 -->
            <div id="projects" class="content-section">
                <div class="projects-header">
                    <div class="projects-title-area">
                        <h2 class="section-title">📁 프로젝트</h2>
                        <p class="section-subtitle">프로젝트별로 할 일을 체계적으로 관리하세요</p>
                    </div>
                    <button onclick="showCreateProjectModal()" class="btn-create-project">
                        + 새 프로젝트
                    </button>
                </div>
                
                <!-- 프로젝트 탭 영역 -->
                <div class="project-tabs-container">
                    <div class="project-tabs" id="projectsTabs">
                        <button class="project-tab active" onclick="selectProjectTab('all')">
                            📂 전체 프로젝트
                        </button>
                        <!-- 프로젝트 탭들이 동적으로 추가됨 -->
                    </div>
                </div>
                
                <!-- 선택된 프로젝트 내용 -->
                <div class="project-content" id="projectContent">
                    <div class="project-overview">
                        <div class="project-stats-grid">
                            <div class="project-stat-card">
                                <div class="stat-icon">📊</div>
                                <div class="stat-info">
                                    <div class="stat-number" id="projectTotalTodos">0</div>
                                    <div class="stat-label">전체 할 일</div>
                                </div>
                            </div>
                            <div class="project-stat-card">
                                <div class="stat-icon">⏳</div>
                                <div class="stat-info">
                                    <div class="stat-number" id="projectInProgressTodos">0</div>
                                    <div class="stat-label">진행 중</div>
                                </div>
                            </div>
                            <div class="project-stat-card">
                                <div class="stat-icon">✅</div>
                                <div class="stat-info">
                                    <div class="stat-number" id="projectCompletedTodos">0</div>
                                    <div class="stat-label">완료됨</div>
                                </div>
                            </div>
                            <div class="project-stat-card">
                                <div class="stat-icon">🎯</div>
                                <div class="stat-info">
                                    <div class="stat-number" id="projectProgress">0%</div>
                                    <div class="stat-label">진행률</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 할 일 관리 -->
            <div id="todos" class="content-section">
                <div class="todos-header">
                    <div>
                        <h2 class="section-title">✅ 할 일 관리</h2>
                        <p class="section-subtitle">프로젝트별로 할 일을 체계적으로 관리하세요</p>
                    </div>
                    <div class="todos-controls">
                        <button onclick="showCreateProjectModal()" class="btn-secondary-modern">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 1.5V16.5M1.5 9H16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            새 프로젝트
                        </button>
                        <select id="projectFilter" onchange="filterTodosByProject()" class="project-select">
                            <option value="">모든 프로젝트</option>
                        </select>
                        <div class="todos-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="totalTodos">0</span>
                                <span class="stat-label">전체</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="completedTodos">0</span>
                                <span class="stat-label">완료</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="completionRate">0%</span>
                                <span class="stat-label">완료율</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="add-todo-form-container">
                    <div class="add-todo-form">
                        <div class="form-header">
                            <h3>새 할일 추가</h3>
                        </div>
                        <div class="form-body">
                            <div class="form-group">
                                <label for="todoProject" class="form-label">프로젝트 <span class="required">*</span></label>
                                <select id="todoProject" class="form-input enhanced-select">
                                    <option value="">프로젝트를 선택하세요</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="todoTitle" class="form-label">할일 제목 <span class="required">*</span></label>
                                <input type="text" id="todoTitle" placeholder="할 일 제목을 입력하세요" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="todoDesc" class="form-label">상세 설명</label>
                                <textarea id="todoDesc" placeholder="상세 설명 (선택사항)" class="form-textarea" rows="3"></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="todoStartDate" class="form-label">시작일</label>
                                    <div class="date-input-wrapper">
                                        <input type="text" id="todoStartDate" placeholder="시작일 선택" class="form-input date-picker">
                                        <span class="date-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 2V6M16 2V6M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span>
                                    </div>
                                </div>
                                <div class="form-group half">
                                    <label for="todoDueDate" class="form-label">마감일</label>
                                    <div class="date-input-wrapper">
                                        <input type="text" id="todoDueDate" placeholder="마감일 선택" class="form-input date-picker">
                                        <span class="date-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 2V6M16 2V6M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="todoPriority" class="form-label">우선순위</label>
                                <select id="todoPriority" class="form-input enhanced-select">
                                    <option value="low">🟢 낮은 우선순위</option>
                                    <option value="medium" selected>🟡 보통 우선순위</option>
                                    <option value="high">🔴 높은 우선순위</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button onclick="addTodo()" class="btn-primary-modern add-todo-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 6V18M6 12H18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    할일 추가
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="todoList" class="todo-list">
                    <!-- 할 일 목록이 동적으로 추가됨 -->
                </div>
                

            </div>



            <!-- 달력 -->
            <div id="calendar" class="content-section">
                <div class="calendar-header">
                    <div>
                        <h2 class="section-title">📅 달력</h2>
                        <p class="section-subtitle">일정과 마감일을 달력에서 확인하세요</p>
                    </div>
                    <div class="calendar-controls">
                        <div class="view-toggles">
                            <button id="monthViewBtn" onclick="switchCalendarView('month')" class="view-btn active">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px;">
                                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M3 10H21" stroke="currentColor" stroke-width="2"/>
                                    <path d="M9 3V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M15 3V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                월간
                            </button>
                            <button id="weekViewBtn" onclick="switchCalendarView('week')" class="view-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px;">
                                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M3 10H21" stroke="currentColor" stroke-width="2"/>
                                    <path d="M8 14H10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M14 14H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M8 18H10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M14 18H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                주간
                            </button>
                        </div>
                        <div class="navigation-controls">
                            <button onclick="previousPeriod()" class="btn-icon" title="이전">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <span id="currentPeriod" class="current-period"></span>
                            <button onclick="nextPeriod()" class="btn-icon" title="다음">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button onclick="goToToday()" class="btn-today">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 7V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                오늘
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="calendar-view">
                    <div class="calendar-weekdays">
                        <div class="weekday">일</div>
                        <div class="weekday">월</div>
                        <div class="weekday">화</div>
                        <div class="weekday">수</div>
                        <div class="weekday">목</div>
                        <div class="weekday">금</div>
                        <div class="weekday">토</div>
                    </div>
                    <div id="calendarContainer" class="calendar-container">
                        <!-- 달력이 동적으로 추가됨 -->
                    </div>
                </div>
                
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-dot high"></span>
                        <span>높은 우선순위</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot medium"></span>
                        <span>보통 우선순위</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot low"></span>
                        <span>낮은 우선순위</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot completed"></span>
                        <span>완료됨</span>
                    </div>
                </div>
                
                <!-- 할 일 편집 모달 -->
                <div id="editTodoModal" class="modal" style="display: none;">
                    <div class="modal-content modern-modal">
                        <div class="modal-header modern-header">
                            <div class="modal-title-wrapper">
                                <div class="modal-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M14 3.5C14.8284 2.67157 16.1716 2.67157 17 3.5C17.8284 4.32843 17.8284 5.67157 17 6.5L6.5 17L3 18L4 14.5L14 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <h3 class="modal-title">할 일 편집</h3>
                            </div>
                            <div class="modal-close" onclick="closeEditTodoModal()">×</div>
                        </div>
                        <div class="modal-body">
                            <form id="editTodoForm">
                                <input type="hidden" id="editTodoId">
                                <div class="form-group">
                                    <label for="editTodoTitle">제목</label>
                                    <input type="text" id="editTodoTitle" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTodoDesc">설명</label>
                                    <textarea id="editTodoDesc" class="form-textarea"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editTodoDueDate">마감일</label>
                                    <input type="text" id="editTodoDueDate" class="form-input date-picker">
                                </div>
                                <div class="form-group">
                                    <label for="editTodoPriority">우선순위</label>
                                    <select id="editTodoPriority" class="form-input">
                                        <option value="low">낮음</option>
                                        <option value="medium">중간</option>
                                        <option value="high">높음</option>
                                    </select>
                                </div>
                                <div class="modal-footer modern-footer">
                                    <button type="button" class="btn-secondary-modern" onclick="closeEditTodoModal()">
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        취소
                                    </button>
                                    <button type="button" class="btn-primary-modern" onclick="updateTodo(event)">
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        저장
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 날짜 클릭 시 표시되는 할 일 목록 모달 -->
                <div id="dateModal" class="modal" style="display: none;">
                    <div class="modal-content modern-modal date-modal">
                        <div class="modal-header modern-header">
                            <div class="modal-title-wrapper">
                                <div class="modal-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M16 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <path d="M3 10H21" stroke="currentColor" stroke-width="2"/>
                                        <path d="M8 14H8.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M12 14H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M16 14H16.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M8 18H8.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M12 18H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="modal-title" id="dateModalTitle">2025년 6월 23일 할 일</h3>
                                    <p class="modal-subtitle">선택한 날짜의 할 일을 확인하고 관리하세요</p>
                                </div>
                            </div>
                            <button class="close-btn-modern" onclick="closeDateModal()">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M5 5L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body modern-form">
                            <div class="form-section">
                                <div id="dateModalTodos" class="date-todos-list">
                                    <!-- 해당 날짜의 할 일들이 표시됨 -->
                                </div>
                            </div>
                            <div class="modal-footer modern-footer">
                                <button onclick="addTodoForDate()" class="btn-primary-modern">
                                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 1.5V16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M1.5 9H16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    이 날짜에 할 일 추가
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 할 일 상세보기 모달 -->
                <div id="todoDetailModal" class="modal" style="display: none;">
                    <div class="modal-content modern-modal todo-detail-modal">
                        <div class="modal-header modern-header todo-detail-header">
                            <div class="modal-title-wrapper">
                                <div class="modal-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="modal-title" id="todoDetailTitle">할 일 상세보기</h3>
                                    <p class="modal-subtitle">할 일의 상세 정보와 댓글을 확인하세요</p>
                                </div>
                            </div>
                            <button class="close-btn-modern" onclick="closeTodoDetailModal()">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M5 5L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body todo-detail-body">
                            <div class="todo-detail-layout">
                                <!-- 왼쪽: 할 일 정보 -->
                                <div class="todo-detail-info">
                                    <div id="todoDetailContent" class="todo-detail-content">
                                        <!-- 할 일 상세 정보가 표시됨 -->
                                    </div>
                                    <div class="todo-action-buttons">
                                        <button id="todoStatusBtn" onclick="toggleTodoStatusFromDetail()" class="btn-primary-modern">
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M14.25 4.5L6.75 12L3.75 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            상태 변경
                                        </button>
                                        <button onclick="editTodoFromDetail()" class="btn-secondary-modern">
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M10.5 2.25C10.8978 1.85218 11.4374 1.62868 12 1.62868C12.2786 1.62868 12.5544 1.68355 12.8118 1.79022C13.0692 1.89689 13.303 2.05301 13.5 2.25C13.697 2.44699 13.8531 2.6808 13.9598 2.93819C14.0665 3.19558 14.1213 3.47142 14.1213 3.75C14.1213 4.02858 14.0665 4.30442 13.9598 4.56181C13.8531 4.8192 13.697 5.05301 13.5 5.25L5.25 13.5L1.5 14.25L2.25 10.5L10.5 2.25Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            편집
                                        </button>
                                        <button onclick="deleteTodoFromDetail()" class="btn-delete-modern">
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2.25 4.5H15.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                                <path d="M7.5 1.5H10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                                <path d="M14.25 4.5V15C14.25 15.75 13.5 16.5 12.75 16.5H5.25C4.5 16.5 3.75 15.75 3.75 15V4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                            </svg>
                                            삭제
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 오른쪽: 댓글 섹션 -->
                                <div class="todo-comments-section">
                                    <div class="comments-header">
                                        <h4 class="comments-title">
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 10C18 14.4183 14.4183 18 10 18L4 18L10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            댓글
                                        </h4>
                                        <span id="commentCount" class="comment-count-badge">0</span>
                                    </div>
                                    
                                    <!-- 댓글 목록 -->
                                    <div id="commentsList" class="comments-list">
                                        <!-- 댓글들이 동적으로 추가됨 -->
                                    </div>
                                    
                                    <!-- 댓글 작성 폼 -->
                                    <div class="comment-form">
                                        <div class="comment-input-container">
                                            <textarea id="commentInput" placeholder="댓글을 입력하세요..." class="comment-textarea modern-textarea"></textarea>
                                            <button onclick="addComment()" class="btn-add-comment">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M14.5 1.5L6.5 9.5L3.5 6.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                                댓글 추가
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 관리자 -->
            <div id="admin" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">👑 관리자 대시보드</h2>
                        <p class="section-subtitle">사용자 승인 및 관리를 위한 도구</p>
                    </div>
                    <div class="admin-controls">
                        <div class="admin-filters">
                            <select id="userStatusFilter" onchange="filterUsersByStatus()" class="admin-select">
                                <option value="all">모든 상태</option>
                                <option value="pending">승인 대기</option>
                                <option value="approved">승인됨</option>
                                <option value="rejected">거부됨</option>
                                <option value="suspended">정지됨</option>
                            </select>
                            <select id="userRoleFilter" onchange="filterUsersByRole()" class="admin-select">
                                <option value="all">모든 역할</option>
                                <option value="super_admin">슈퍼 관리자</option>
                                <option value="admin">관리자</option>
                                <option value="user">일반 사용자</option>
                            </select>
                            <button onclick="loadUsers()" class="btn-refresh">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M20.49 9C19.9828 7.56678 19.1209 6.2854 17.9845 5.27542C16.8482 4.26543 15.4745 3.55976 13.9917 3.22426C12.5089 2.88875 10.9652 2.93434 9.50481 3.35677C8.04437 3.77921 6.71475 4.56471 5.64 5.64L1 10M23 14L18.36 18.36C17.2853 19.4353 15.9556 20.2208 14.4952 20.6432C13.0348 21.0657 11.4911 21.1112 10.0083 20.7757C8.52547 20.4402 7.1518 19.7346 6.01547 18.7246C4.87913 17.7146 4.01717 16.4332 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                새로고침
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="showAdminTab('users')">
                        <span class="admin-tab-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        사용자 관리
                    </button>
                    <button class="admin-tab" onclick="showAdminTab('approvals')">
                        <span class="admin-tab-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        승인 요청
                    </button>
                    <button class="admin-tab" onclick="showAdminTab('action-requests')">
                        <span class="admin-tab-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 4L12 14.01l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        작업 요청
                    </button>
                    <button class="admin-tab" onclick="showAdminTab('logs')">
                        <span class="admin-tab-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14 3v4a1 1 0 0 0 1 1h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M9 9h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M9 13h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M9 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        활동 로그
                    </button>
                    <button class="admin-tab" onclick="showAdminTab('permissions')">
                        <span class="admin-tab-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="11" width="18" height="11" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="16" r="1" fill="currentColor"/>
                            </svg>
                        </span>
                        권한 관리
                    </button>
                    <button class="admin-tab" onclick="showAdminTab('roles')">
                        <span class="admin-tab-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        역할 관리
                    </button>
                </div>
                
                <div id="usersTab" class="admin-tab-content active">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3>사용자 목록</h3>
                            <span id="userCount" class="user-count-badge">0명</span>
                        </div>
                        <div class="users-table-container">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>이름</th>
                                        <th>이메일</th>
                                        <th>역할</th>
                                        <th>상태</th>
                                        <th>가입일</th>
                                        <th>승인일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- 사용자 목록이 동적으로 추가됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="approvalsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3>승인 대기 목록</h3>
                            <span id="pendingCount" class="pending-count-badge">0명</span>
                        </div>
                        <div class="approval-requests-container">
                            <div id="pendingRequests" class="approval-requests-list">
                                <!-- 승인 요청이 동적으로 추가됨 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="logsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3>관리자 활동 로그</h3>
                        </div>
                        <div class="admin-logs-container">
                            <div id="adminLogsList" class="admin-logs-list">
                                <!-- 관리자 활동 로그가 동적으로 추가됨 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="permissionsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3>네비게이션 탭 권한 관리</h3>
                            <p class="subtitle">각 역할이 접근할 수 있는 네비게이션 탭을 관리합니다.</p>
                        </div>
                        <div class="permissions-container">
                            <div class="role-tabs" id="permRoleTabs">
                                <button class="role-tab active" onclick="showTabPermissions('super_admin')">슈퍼관리자</button>
                                <button class="role-tab" onclick="showTabPermissions('admin')">관리자</button>
                                <button class="role-tab" onclick="showTabPermissions('user')">일반사용자</button>
                                <!-- 커스텀 역할 탭이 여기에 동적으로 추가됩니다 -->
                            </div>
                            
                            <div class="role-description-container">
                                <div id="super_admin_desc" class="role-description active">
                                    <h4>슈퍼관리자 역할</h4>
                                    <p>시스템 내 최고 권한을 가진 역할로, 모든 기능과 데이터에 접근할 수 있습니다.</p>
                                    <p>슈퍼관리자는 다른 사용자의 역할을 변경할 수 있으며, 시스템 설정을 관리할 수 있습니다.</p>
                                </div>
                                <div id="admin_desc" class="role-description">
                                    <h4>관리자 역할</h4>
                                    <p>일반 관리 기능을 수행할 수 있는 역할로, 사용자 관리 및 컨텐츠 관리 권한을 가집니다.</p>
                                    <p>관리자는 사용자 승인 및 워크스페이스 관리 등의 권한을 가지지만, 시스템 설정 변경은 제한됩니다.</p>
                                </div>
                                <div id="user_desc" class="role-description">
                                    <h4>일반사용자 역할</h4>
                                    <p>기본적인 서비스 이용 권한을 가진 역할입니다.</p>
                                    <p>자신의 할일과 프로젝트를 관리할 수 있으며, 워크스페이스 생성 권한을 가집니다.</p>
                                </div>
                                <!-- 커스텀 역할 설명이 여기에 동적으로 추가됩니다 -->
                            </div>
                            
                            <div class="tab-permissions-container">
                                <h4>네비게이션 탭 접근 권한</h4>
                                <p class="permission-info">역할에 따라 접근 가능한 네비게이션 탭을 설정합니다. 체크된 항목만 사용할 수 있습니다.</p>
                                
                                <div class="tab-permissions-list" id="tabPermissionsList">
                                    <!-- 탭 권한 목록이 동적으로 추가됩니다 -->
                                    <div class="loading-spinner">권한 정보를 불러오는 중...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 작업 요청 관리 탭 추가 -->
                <div id="action-requestsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3>작업 요청 관리</h3>
                            <p class="subtitle">사용자 관리 작업의 요청, 검토, 승인을 관리합니다.</p>
                        </div>
                        
                        <!-- 작업 요청 필터 -->
                        <div class="admin-filters">
                            <div class="filter-group">
                                <label for="actionRequestStatusFilter">상태:</label>
                                <select id="actionRequestStatusFilter" onchange="loadActionRequests()">
                                    <option value="all">전체</option>
                                    <option value="pending" selected>대기 중</option>
                                    <option value="approved">승인됨</option>
                                    <option value="rejected">거부됨</option>
                                    <option value="cancelled">취소됨</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="actionTypeFilter">작업 유형:</label>
                                <select id="actionTypeFilter" onchange="loadActionRequests()">
                                    <option value="all">전체</option>
                                    <option value="approve">사용자 승인</option>
                                    <option value="reject">사용자 거부</option>
                                    <option value="suspend">계정 정지</option>
                                    <option value="promote">관리자 승격</option>
                                    <option value="demote">관리자 해제</option>
                                    <option value="change_role">역할 변경</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 작업 요청 목록 -->
                        <div class="action-requests-container">
                            <h4>작업 요청 목록 <span id="actionRequestsCount" class="count-badge">0개</span></h4>
                            <div id="actionRequestsList" class="action-requests-list">
                                <div class="loading-spinner">작업 요청을 불러오는 중...</div>
                            </div>
                        </div>
                        
                        <!-- 작업 요청 검토 모달 -->
                        <div id="reviewActionModal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>작업 요청 검토</h3>
                                    <span class="close" onclick="closeReviewActionModal()">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <div id="reviewActionDetails">
                                        <!-- 작업 요청 상세 정보가 여기에 표시됩니다 -->
                                    </div>
                                    <div class="form-group">
                                        <label for="reviewNotes">검토 의견:</label>
                                        <textarea id="reviewNotes" class="form-control" rows="3" placeholder="승인/거부 사유를 입력하세요"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn-secondary-modern" onclick="closeReviewActionModal()">
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        취소
                                    </button>
                                    <button class="btn-danger" onclick="reviewAction('rejected')">
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        거부
                                    </button>
                                    <button class="btn-primary-modern" onclick="reviewAction('approved')">
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        승인
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 역할 관리 탭 추가 -->
                <div id="rolesTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3>역할 관리</h3>
                            <p class="subtitle">시스템의 모든 역할을 관리하고 새로운 커스텀 역할을 생성합니다.</p>
                        </div>
                        <div class="roles-container">
                            <div class="roles-actions">
                                <button class="action-btn add-btn" onclick="openCreateRoleModal()">
                                    <i class="fas fa-plus"></i> 새 역할 생성
                                </button>
                            </div>
                            
                            <div class="roles-list-container">
                                <h4>시스템 역할</h4>
                                <div class="roles-list" id="systemRolesList">
                                    <div class="loading-spinner">역할 정보를 불러오는 중...</div>
                                </div>
                                
                                <h4 class="mt-4">커스텀 역할</h4>
                                <div class="roles-list" id="customRolesList">
                                    <!-- 커스텀 역할 목록이 동적으로 추가됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 역할 삭제 확인 모달 -->
                <div id="deleteRoleModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>역할 삭제</h3>
                            <span class="close" onclick="closeDeleteRoleModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <p>정말로 <span id="deleteRoleName" class="highlight"></span> 역할을 삭제하시겠습니까?</p>
                            <p class="warning">이 작업은 되돌릴 수 없으며, 해당 역할을 사용 중인 사용자가 있으면 삭제할 수 없습니다.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary-modern" onclick="closeDeleteRoleModal()">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                취소
                            </button>
                            <button class="btn-danger" onclick="confirmDeleteRole()">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2.5 5h13M7 8.5v3M11 8.5v3M3.5 5l.5 9.5c0 .5.5 1 1 1h7c.5 0 1-.5 1-1L13.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                삭제
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 새 역할 생성 모달 -->
                <div id="createRoleModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>새 역할 생성</h3>
                            <span class="close" onclick="closeCreateRoleModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="roleNameInput">역할 이름:</label>
                                <input type="text" id="roleNameInput" class="form-control" placeholder="영문 소문자, 숫자, 언더스코어(_)만 사용 가능">
                                <small class="form-text">예: custom_manager, support_staff</small>
                            </div>
                            <div class="form-group">
                                <label for="roleDescInput">역할 설명:</label>
                                <textarea id="roleDescInput" class="form-control" rows="3" placeholder="역할에 대한 설명을 입력하세요"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary-modern" onclick="closeCreateRoleModal()">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                취소
                            </button>
                            <button class="btn-primary-modern" onclick="createNewRole()">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 1.5V16.5M1.5 9H16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                역할 생성
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>관리자 활동 로그</h3>
                    </div>
                    <div class="admin-logs-container">
                        <div id="adminLogs" class="admin-logs-list">
                            <!-- 활동 로그가 동적으로 추가됨 -->
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- 알림 -->
            <div id="notifications" class="content-section">
                <h2 class="section-title">🔔 알림</h2>
                <p class="section-subtitle">중요한 업데이트를 놓치지 마세요</p>
                <div id="notificationList">
                    <!-- 알림 목록이 동적으로 추가됨 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 토스트 -->
    <div id="notification" class="notification"></div>

    <!-- 프로젝트 생성 모달 -->
    <div id="createProjectModal" class="modal" style="display: none;">
        <div class="modal-content modern-modal">
            <div class="modal-header modern-header">
                <div class="modal-title-wrapper">
                    <div class="modal-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="modal-title">새 프로젝트 만들기</h3>
                        <p class="modal-subtitle">팀과 함께할 새로운 프로젝트를 시작하세요</p>
                    </div>
                </div>
                <button class="close-btn-modern" onclick="hideCreateProjectModal()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M5 5L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <form onsubmit="createProject(event)" class="modern-form" style="display: flex; flex-direction: column; height: 100%;">
                <div style="flex: 1; overflow-y: auto; padding: 0 4px;">
                    <div class="form-section">
                        <div class="input-group">
                            <label for="projectName" class="input-label">
                                <span class="label-text">프로젝트 이름</span>
                                <span class="label-required">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="projectName" 
                                name="name" 
                                placeholder="예: 웹사이트 리뉴얼, 모바일 앱 개발"
                                required 
                                maxlength="50"
                                class="modern-input"
                            >
                        </div>
                        
                        <div class="input-group">
                            <label for="projectDescription" class="input-label">
                                <span class="label-text">프로젝트 설명</span>
                                <span class="label-optional">선택사항</span>
                            </label>
                            <textarea 
                                id="projectDescription" 
                                name="description" 
                                placeholder="프로젝트의 목표와 주요 내용을 간단히 설명해주세요"
                                rows="3"
                                maxlength="200"
                                class="modern-textarea"
                            ></textarea>
                            <div class="character-count">
                                <span id="descriptionCount">0</span>/200
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <label class="input-label">
                            <span class="label-text">프로젝트 색상</span>
                            <span class="label-description">프로젝트를 구분하기 위한 색상을 선택하세요</span>
                        </label>
                        <div class="color-grid">
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#3b82f6" checked>
                            <div class="color-swatch" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">블루</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#10b981">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #10b981, #047857);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">그린</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#f59e0b">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">오렌지</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#ef4444">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">레드</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#8b5cf6">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">퍼플</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#06b6d4">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">시안</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#84cc16">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #84cc16, #65a30d);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">라임</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#ec4899">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">핑크</span>
                            </div>
                        </label>
                    </div>
                </div>
                </div>
                
                <div class="modal-footer modern-footer" style="flex-shrink: 0; margin-top: auto;">
                    <button type="button" class="btn-secondary-modern" onclick="hideCreateProjectModal()">
                        취소
                    </button>
                    <button type="submit" class="btn-primary-modern">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 1.5V16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M1.5 9H16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        프로젝트 만들기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 프로젝트 수정 모달 -->
    <div id="editProjectModal" class="modal" style="display: none;">
        <div class="modal-content modern-modal">
            <div class="modal-header modern-header">
                <div class="modal-title-wrapper">
                    <div class="modal-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 20H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16.5 3.5C16.8978 3.10218 17.4374 2.87868 18 2.87868C18.2786 2.87868 18.5544 2.93355 18.8118 3.04022C19.0692 3.14689 19.303 3.30301 19.5 3.5C19.697 3.69699 19.8531 3.9308 19.9598 4.18819C20.0665 4.44558 20.1213 4.72142 20.1213 5C20.1213 5.27858 20.0665 5.55442 19.9598 5.81181C19.8531 6.0692 19.697 6.30301 19.5 6.5L7 19L3 20L4 16L16.5 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="modal-title">프로젝트 수정</h3>
                        <p class="modal-subtitle">프로젝트 정보를 업데이트하세요</p>
                    </div>
                </div>
                <button class="close-btn-modern" onclick="hideEditProjectModal()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M5 5L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <form onsubmit="updateProject(event)" class="modern-form">
                <input type="hidden" id="editProjectId" name="id">
                
                <div class="form-section">
                    <div class="input-group">
                        <label for="editProjectName" class="input-label">
                            <span class="label-text">프로젝트 이름</span>
                            <span class="label-required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="editProjectName" 
                            name="name" 
                            required 
                            maxlength="50"
                            class="modern-input"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="editProjectDescription" class="input-label">
                            <span class="label-text">프로젝트 설명</span>
                            <span class="label-optional">선택사항</span>
                        </label>
                        <textarea 
                            id="editProjectDescription" 
                            name="description" 
                            rows="3"
                            maxlength="200"
                            class="modern-textarea"
                            placeholder="프로젝트의 목표와 주요 내용을 간단히 설명해주세요"
                        ></textarea>
                        <div class="character-count">
                            <span id="editDescriptionCount">0</span>/200
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <label class="input-label">
                        <span class="label-text">프로젝트 색상</span>
                        <span class="label-description">프로젝트를 구분하기 위한 색상을 선택하세요</span>
                    </label>
                    <div class="color-grid">
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#3b82f6">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">블루</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#10b981">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #10b981, #047857);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">그린</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#f59e0b">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">오렌지</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#ef4444">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">레드</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#8b5cf6">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">퍼플</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#06b6d4">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">시안</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#84cc16">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #84cc16, #65a30d);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">라임</span>
                            </div>
                        </label>
                        
                        <label class="color-option-modern">
                            <input type="radio" name="color" value="#ec4899">
                            <div class="color-swatch" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                                <div class="color-check">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M13.5 4.5L6 12L2.5 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <span class="color-label">핑크</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer modern-footer modern-footer-with-delete">
                    <button type="button" class="btn-delete-modern" onclick="confirmDeleteProject()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.25 4.5H15.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M7.5 1.5H10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M14.25 4.5V15C14.25 15.75 13.5 16.5 12.75 16.5H5.25C4.5 16.5 3.75 15.75 3.75 15V4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        삭제
                    </button>
                    <div class="button-group">
                        <button type="button" class="btn-secondary-modern" onclick="hideEditProjectModal()">
                            취소
                        </button>
                        <button type="submit" class="btn-primary-modern">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            수정 완료
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase 설정 - 환경 변수 또는 기본값 사용
        const SUPABASE_URL = typeof process !== 'undefined' && process.env.SUPABASE_URL 
            ? process.env.SUPABASE_URL 
            : 'https://nlywtmsbkvaggfvezonj.supabase.co';
        const SUPABASE_ANON_KEY = typeof process !== 'undefined' && process.env.SUPABASE_ANON_KEY 
            ? process.env.SUPABASE_ANON_KEY 
            : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5seXd0bXNia3ZhZ2dmdmV6b25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzOTAzMDEsImV4cCI6MjA2NTk2NjMwMX0.FMyZENGZkUHJEp6YFe-VdYT-L3b49si1yu6EvWun01Y';
        
        // API 호출 통합 관리자
        const APIManager = {
            client: null,
            retryCount: 0,
            maxRetries: 3,
            requestQueue: [],
            isProcessingQueue: false,
            
            // Supabase 클라이언트 초기화
            initializeClient: function() {
                try {
                    console.log('=== Supabase 초기화 시작 ===');
                    console.log('1. 라이브러리 확인 - typeof supabase:', typeof supabase);
                    console.log('2. 전역 supabase 객체:', window.supabase ? ' 존재' : '없음');
                    
                    // Supabase 라이브러리 로드 확인
                    if (typeof supabase === 'undefined') {
                        throw new Error('Supabase 라이브러리가 로드되지 않았습니다.');
                    }
                    
                    console.log('3. createClient 함수 확인:', typeof supabase.createClient);
                    if (typeof supabase.createClient !== 'function') {
                        throw new Error('supabase.createClient가 함수가 아닙니다.');
                    }
                    
                    console.log('4. 설정 확인 - URL:', SUPABASE_URL ? '존재' : '없음');
                    console.log('5. 설정 확인 - KEY:', SUPABASE_ANON_KEY ? '존재' : '없음');
                    
                    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                        throw new Error('Supabase 설정이 없습니다.');
                    }
                    
                    console.log('6. 클라이언트 생성 중...');
                    
                    this.client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true
                    });
                    
                    if (!this.client) {
                        throw new Error('Supabase 클라이언트 생성 실패');
                    }
                    
                    console.log('7. 클라이언트 생성 성공:', this.client);
                    console.log('=== API 클라이언트 초기화 완료 ===');
                    return true;
                } catch (error) {
                    console.error('=== Supabase 초기화 실패 ===');
                    console.error('오류 상세:', error);
                    console.error('스택 트레이스:', error.stack);
                    ErrorManager.handle(error, '데이터베이스 연결 초기화 실패', 'APIManager.initializeClient');
                    return false;
                }
            },
            
            // 통합 API 요청 메서드
            async request(operation, options = {}) {
                const {
                    table,
                    action, // 'select', 'insert', 'update', 'delete', 'rpc'
                    data,
                    filters = {},
                    select = '*',
                    single = false,
                    upsert = false,
                    orderBy,
                    limit,
                    rpcName,
                    rpcParams,
                    retries = this.maxRetries,
                    timeout = 10000,
                    errorMessage = '데이터베이스 작업 실패'
                } = options;
                
                if (!this.client) {
                    if (!this.initializeClient()) {
                        throw new Error('데이터베이스 연결을 초기화할 수 없습니다.');
                    }
                }
                
                try {
                    let query;
                    
                    switch (action) {
                        case 'select':
                            query = this.client.from(table).select(select);
                            this.applyFilters(query, filters);
                            if (orderBy) query = query.order(orderBy.column, { ascending: orderBy.ascending });
                            if (limit) query = query.limit(limit);
                            if (single) query = query.single();
                            break;
                            
                        case 'insert':
                            query = this.client.from(table).insert(data);
                            if (select && select !== '*') query = query.select(select);
                            if (single) query = query.single();
                            break;
                            
                        case 'update':
                            query = this.client.from(table).update(data);
                            this.applyFilters(query, filters);
                            if (select && select !== '*') query = query.select(select);
                            if (single) query = query.single();
                            break;
                            
                        case 'upsert':
                            query = this.client.from(table).upsert(data);
                            if (select && select !== '*') query = query.select(select);
                            if (single) query = query.single();
                            break;
                            
                        case 'delete':
                            query = this.client.from(table).delete();
                            this.applyFilters(query, filters);
                            break;
                            
                        case 'rpc':
                            query = this.client.rpc(rpcName, rpcParams);
                            break;
                            
                        default:
                            throw new Error(`지원하지 않는 작업: ${action}`);
                    }
                    
                    // 타임아웃 설정
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('요청 시간 초과')), timeout);
                    });
                    
                    const result = await Promise.race([query, timeoutPromise]);
                    
                    if (result.error) {
                        throw result.error;
                    }
                    
                    return result;
                    
                } catch (error) {
                    if (retries > 0 && this.shouldRetry(error)) {
                        console.warn(`API 요청 재시도 (남은 횟수: ${retries - 1}):`, operation);
                        await this.delay(1000);
                        return this.request(operation, { ...options, retries: retries - 1 });
                    }
                    
                    ErrorManager.handleApiError(error, operation, errorMessage);
                    throw error;
                }
            },
            
            // 필터 적용 헬퍼
            applyFilters: function(query, filters) {
                Object.entries(filters).forEach(([key, value]) => {
                    if (key.includes('__')) {
                        const [field, operator] = key.split('__');
                        switch (operator) {
                            case 'eq': query = query.eq(field, value); break;
                            case 'neq': query = query.neq(field, value); break;
                            case 'gt': query = query.gt(field, value); break;
                            case 'gte': query = query.gte(field, value); break;
                            case 'lt': query = query.lt(field, value); break;
                            case 'lte': query = query.lte(field, value); break;
                            case 'like': query = query.like(field, value); break;
                            case 'ilike': query = query.ilike(field, value); break;
                            case 'in': query = query.in(field, value); break;
                            case 'is': query = query.is(field, value); break;
                        }
                    } else {
                        query = query.eq(key, value);
                    }
                });
                return query;
            },
            
            // 재시도 가능한 오류인지 확인
            shouldRetry: function(error) {
                const retryableErrors = [
                    'NETWORK_ERROR',
                    'CONNECTION_ERROR', 
                    'TIMEOUT_ERROR',
                    'RATE_LIMIT_ERROR'
                ];
                return retryableErrors.some(err => error.message?.includes(err)) || 
                       error.status >= 500;
            },
            
            // 지연 함수
            delay: function(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },
            
            // 인증 관련 API
            auth: {
                async signIn(email, password) {
                    return APIManager.client.auth.signInWithPassword({ email, password });
                },
                
                async signUp(email, password, metadata = {}) {
                    return APIManager.client.auth.signUp({
                        email,
                        password,
                        options: { data: metadata }
                    });
                },
                
                async signInWithOAuth(provider, options = {}) {
                    return APIManager.client.auth.signInWithOAuth({ provider, options });
                },
                
                async signOut() {
                    return APIManager.client.auth.signOut();
                },
                
                async getSession() {
                    return APIManager.client.auth.getSession();
                },
                
                onAuthStateChange(callback) {
                    return APIManager.client.auth.onAuthStateChange(callback);
                },

                async getUser() {
                    return APIManager.client.auth.getUser();
                },

                async setSession(accessToken, refreshToken) {
                    return APIManager.client.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                },

                async refreshSession() {
                    return APIManager.client.auth.refreshSession();
                }
            },
            
            // 일반적인 CRUD 작업을 위한 편의 메서드들
            async select(table, options = {}) {
                return this.request(`select from ${table}`, {
                    table,
                    action: 'select',
                    ...options
                });
            },
            
            async insert(table, data, options = {}) {
                return this.request(`insert into ${table}`, {
                    table,
                    action: 'insert',
                    data,
                    ...options
                });
            },
            
            async update(table, data, filters, options = {}) {
                return this.request(`update ${table}`, {
                    table,
                    action: 'update',
                    data,
                    filters,
                    ...options
                });
            },
            
            async upsert(table, data, options = {}) {
                return this.request(`upsert into ${table}`, {
                    table,
                    action: 'upsert',
                    data,
                    ...options
                });
            },
            
            async delete(table, filters, options = {}) {
                return this.request(`delete from ${table}`, {
                    table,
                    action: 'delete',
                    filters,
                    ...options
                });
            },
            
            async rpc(functionName, params = {}, options = {}) {
                return this.request(`rpc ${functionName}`, {
                    action: 'rpc',
                    rpcName: functionName,
                    rpcParams: params,
                    ...options
                });
            }
        };
        
        // 기존 SupabaseManager 호환성을 위한 래퍼
        const SupabaseManager = {
            client: null,
            authSubscription: null,
            retryCount: 0,
            maxRetries: 3,
            
            initialize: function() {
                console.log('Supabase 초기화 시작...');
                const success = APIManager.initializeClient();
                
                if (!success) {
                    console.error('Supabase 초기화 실패');
                    isDemoMode = true;
                    UIManager.showNotification('백엔드 연결에 실패했습니다. 데모 모드로 실행됩니다.', 'warning');
                    return false;
                }
                
                this.client = APIManager.client;
                // 전역 supabase 변수도 설정
                window.supabase = APIManager.client;
                console.log('Supabase 초기화 성공');
                return true;
            },
            
            // 연결 상태 확인 및 재연결
            checkConnection: async function() {
                try {
                    if (!this.client) {
                        console.log('Supabase 클라이언트가 없습니다. 재초기화 시도...');
                        return this.initialize();
                    }
                    
                    // 현재 세션 확인으로 연결 상태 체크
                    const { data: session, error } = await this.client.auth.getSession();
                    
                    if (error && error.status === 400) {
                        console.warn('Supabase 세션 확인 중 오류:', error.message);
                        // 세션 오류는 일반적이므로 true 반환 (연결은 정상)
                        return true;
                    }
                    
                    console.log('Supabase 연결 상태 정상');
                    return true;
                } catch (error) {
                    console.error('Supabase 연결 확인 오류:', error);
                    // 오류 발생 시 재초기화 시도
                    return this.initialize();
                }
            },
            
            // 안정적인 요청 실행 헬퍼
            executeRequest: async function(requestFn, errorMessage = '데이터베이스 작업 중 오류가 발생했습니다', retries = 1) {
                try {
                    // 연결 상태 확인
                    await this.checkConnection();
                    
                    // 요청 실행
                    const result = await requestFn(this.client);
                    
                    // 오류 확인
                    if (result && result.error) {
                        throw result.error;
                    }
                    
                    return result;
                } catch (error) {
                    console.error(`Supabase 요청 오류 (${errorMessage}):`, error);
                    
                    // 인증 관련 오류인 경우 재시도
                    if (retries > 0 && (error.code === 'JWT_INVALID' || error.code === 'PGRST116' || error.status === 401)) {
                        console.warn('인증 오류로 인한 재시도...');
                        this.client = this.createClient();
                        return this.executeRequest(requestFn, errorMessage, retries - 1);
                    }
                    
                    // 재시도 불가능한 경우 오류 표시
                    showNotification(errorMessage + ': ' + error.message, 'error');
                    throw error;
                }
            }
        };
        
        // 초기 Supabase 클라이언트 생성
        let supabase = null;
        
        // 페이지 로드 시 Supabase 초기화
        if (typeof supabase !== 'undefined') {
            console.log('Supabase 라이브러리 로드됨, 초기화 시작');
            SupabaseManager.initialize();
            window.supabase = SupabaseManager.client; // 전역 변수 설정
        } else {
            console.log('Supabase 라이브러리 로딩 대기 중...');
            // 라이브러리 로드를 기다림
            let checkCount = 0;
            const checkInterval = setInterval(() => {
                checkCount++;
                if (typeof supabase !== 'undefined') {
                    clearInterval(checkInterval);
                    console.log('Supabase 라이브러리 로드 완료, 초기화 시작');
                    SupabaseManager.initialize();
                    window.supabase = SupabaseManager.client; // 전역 변수 설정
                } else if (checkCount > 50) { // 5초 대기
                    clearInterval(checkInterval);
                    console.error('Supabase 라이브러리 로딩 시간 초과');
                    isDemoMode = true;
                    showNotification('백엔드 라이브러리 로딩 실패. 데모 모드로 실행됩니다.', 'warning');
                }
            }, 100);
        }
        
        // 통합 인증 상태 관리 모듈
        const AuthManager = {
            listener: null,
            oauthCallback: null,
            authHandled: false,
            
            // OAuth 콜백 URL 확인
            isOAuthCallback: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                return urlParams.has('code') || 
                       hashParams.has('access_token') || 
                       urlParams.has('access_token') || 
                       urlParams.has('error');
            },
            
            // URL에서 OAuth 콜백 파라미터 정리
            cleanupCallbackUrl: function() {
                const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
                window.history.replaceState({}, '', cleanUrl);
            },
            
            // 통합 인증 상태 리스너 설정
            setupAuthListener: function() {
                if (!supabase) {
                    console.log('Supabase 클라이언트가 없어 Auth State Listener 설정 불가');
                    return;
                }
                
                try {
                    // 이미 설정된 리스너가 있다면 해제
                    if (this.listener && this.listener.unsubscribe) {
                        this.listener.unsubscribe();
                    }
                    
                    // OAuth 콜백 여부 확인
                    const isOAuth = this.isOAuthCallback();
                    console.log('Auth 리스너 설정 중... (OAuth 콜백:', isOAuth, ')');
                    
                    const { data: authListener } = supabase.auth.onAuthStateChange(async (event, session) => {
                        // OAuth 콜백 처리와 일반 인증 상태 변화 구분
                        if (isOAuth) {
                            this.handleOAuthCallback(event, session);
                        } else {
                            this.handleNormalAuthChange(event, session);
                        }
                    });
                    
                    this.listener = authListener;
                    console.log('Auth State Listener 설정 완료');
                    
                    // OAuth 콜백인 경우 타임아웃 설정
                    if (isOAuth) {
                        this.setupOAuthTimeout();
                    }
                    
                } catch (error) {
                    console.error('Auth State Change 설정 오류:', error);
                }
            },
            
            // 일반 인증 상태 변경 처리
            handleNormalAuthChange: async function(event, session) {
                console.log('일반 Auth 상태 변화:', event);
                
                if (event === 'SIGNED_IN' && session) {
                    console.log('일반 로그인 성공, 앱 초기화 중...');
                    currentUser = session.user;
                    
                    // 강제로 정식 모드 설정
                    isDemoMode = false;
                    console.log('Auth State Change - 강제로 정식 모드 설정됨: isDemoMode =', isDemoMode);
                    
                    // 사용자 프로필 설정 및 앱 표시
                    try {
                        const isApproved = await setupUserProfile();
                        if (isApproved) {
                            showApp();
                            await checkUserPermissions(true);
                            await updateNavigationTabs();
                        }
                    } catch (error) {
                        console.error('로그인 후 설정 오류:', error);
                    }
                } else if (event === 'SIGNED_OUT') {
                    console.log('로그아웃됨, 로그인 화면으로 이동');
                    currentUser = null;
                    showLogin();
                }
            },
            
            // OAuth 콜백 처리
            handleOAuthCallback: async function(event, session) {
                console.log('OAuth 콜백 중 Auth 상태 변화:', event);
                
                if (this.authHandled) return; // 중복 처리 방지
                
                if (event === 'SIGNED_IN' && session) {
                    this.authHandled = true;
                    console.log('OAuth 로그인 성공!');
                    
                    currentUser = session.user;
                    isDemoMode = false;
                    
                    // URL 정리
                    this.cleanupCallbackUrl();
                    
                    try {
                        // 사용자 프로필 설정
                        await setupUserProfile();
                        
                        // 앱 표시
                        showApp();
                        
                        // 권한 확인 및 업데이트
                        await checkUserPermissions(true);
                        await updateNavigationTabs();
                        
                        console.log('OAuth 로그인 완료 - 앱 진입');
                    } catch (error) {
                        console.error('OAuth 로그인 후 설정 오류:', error);
                        showNotification('로그인 후 설정 중 오류가 발생했습니다.', 'error');
                        showLogin();
                    }
                } else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
                    if (!this.authHandled) {
                        console.log('OAuth 로그인 실패 - 로그인 화면으로');
                        showLogin();
                    }
                }
            },
            
            // OAuth 콜백 타임아웃 설정
            setupOAuthTimeout: function() {
                setTimeout(() => {
                    if (!this.authHandled) {
                        console.log('OAuth 콜백 타임아웃 - 로그인 화면으로');
                        showNotification('로그인 처리 시간이 초과되었습니다. 다시 시도해주세요.', 'error');
                        showLogin();
                    }
                }, 10000); // 10초 대기
            },
            
            // 인증 리스너 해제
            cleanup: function() {
                if (this.listener && this.listener.unsubscribe) {
                    this.listener.unsubscribe();
                    this.listener = null;
                }
            }
        };
        
        // Supabase 초기화 후 Auth State Listener 설정
        setTimeout(() => {
            if (supabase) {
                AuthManager.setupAuthListener();
            }
        }, 1000);
        
        // 이 함수들은 SupabaseManager로 통합되었습니다.
        // checkSupabaseConnection() -> SupabaseManager.checkConnection()
        // executeSupabaseRequest() -> SupabaseManager.executeRequest()
        
        // 이전 코드와의 호환성을 위한 레거시 래퍼 함수들
        async function checkSupabaseConnection() {
            return SupabaseManager.checkConnection();
        }
        
        async function executeSupabaseRequest(requestFn, errorMessage = '데이터베이스 작업 중 오류가 발생했습니다', retries = 1) {
            return SupabaseManager.executeRequest(requestFn, errorMessage, retries);
        }
        
        // 전역 변수
        let currentUser = null;
        let currentWorkspace = null;
        let currentProject = null;
        let todos = [];
        let workspaces = [];
        let projects = [];
        let activities = [];
        let todoComments = []; // 할 일 댓글 데이터
        let currentDate = new Date();
        let calendarView = 'month'; // 'month', 'week'
        
        // 달력 모달 안전장치 변수들
        let isDateModalOpen = false;
        let lastClickTime = 0;
        let clickDebounceDelay = 300; // 300ms 디바운스
        
        // 실시간 구독 관리
        let realtimeSubscriptions = [];
        let isDemoMode = false;
        let demoUsers = [];
        let adminLogs = [];
        
        // XSS 방지 - HTML 이스케이프 함수
        function escapeHTML(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // 안전하게 DOM에 텍스트 삽입하는 헬퍼 함수
        function setTextContent(element, text) {
            if (!element) return;
            element.textContent = text;
        }
        
        // 안전하게 DOM에 HTML 삽입하는 헬퍼 함수
        function setInnerHTML(element, html) {
            if (!element) return;
            // html 파라미터가 이미 이스케이프된 경우에만 사용하세요
            element.innerHTML = html;
        }
        
        // OAuth 콜백 처리 및 사용자 세션 관리
        async function handleAuthCallback() {
            try {
                // URL에서 OAuth 콜백 매개변수 확인
                const urlParams = new URLSearchParams(window.location.search);
                const accessToken = urlParams.get('access_token');
                const refreshToken = urlParams.get('refresh_token');
                
                if (accessToken) {
                    console.log('OAuth 콜백 감지됨, 사용자 세션 처리 중...');
                    
                    // URL 정리 (토큰 제거)
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // 현재 사용자 정보 가져오기
                    const { data: authUser, error: authError } = await APIManager.auth.getUser();
                    
                    if (authError || !authUser) {
                        console.error('사용자 정보 가져오기 실패:', authError);
                        return;
                    }
                    
                    // 데이터베이스에 사용자 정보 저장/업데이트
                    await ensureUserInDatabase(authUser.user);
                    
                    // 현재 사용자 정보 설정
                    currentUser = authUser.user;
                    console.log('현재 사용자 설정됨:', currentUser.email);
                    
                    // 대시보드로 이동
                    UIManager.showScreen('app');
                    return true;
                }
                
                // 기존 세션 확인
                const { data: authUser, error } = await APIManager.auth.getUser();
                if (authUser && !error) {
                    console.log('기존 로그인 세션 발견됨');
                    await ensureUserInDatabase(authUser.user);
                    
                    // 현재 사용자 정보 설정
                    currentUser = authUser.user;
                    console.log('현재 사용자 설정됨:', currentUser.email);
                    
                    UIManager.showScreen('app');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('인증 콜백 처리 중 오류:', error);
                return false;
            }
        }

        // 사용자 정보를 데이터베이스에 저장/업데이트
        async function ensureUserInDatabase(authUser) {
            try {
                // 기존 사용자 확인
                const { data: existingUser, error: fetchError } = await APIManager.select('users', {
                    filters: { id: { eq: authUser.id } }
                });
                
                if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116: no rows returned
                    console.error('사용자 조회 오류:', fetchError);
                    return;
                }
                
                if (existingUser && existingUser.length > 0) {
                    // 기존 사용자 업데이트
                    const { error: updateError } = await APIManager.update('users', 
                        {
                            email: authUser.email,
                            full_name: authUser.user_metadata?.full_name || authUser.user_metadata?.name,
                            avatar_url: authUser.user_metadata?.avatar_url,
                            updated_at: new Date().toISOString()
                        },
                        { id: { eq: authUser.id } }
                    );
                    
                    if (updateError) {
                        console.error('사용자 정보 업데이트 오류:', updateError);
                    } else {
                        console.log('사용자 정보 업데이트 완료');
                    }
                } else {
                    // 새 사용자 생성
                    const { error: insertError } = await APIManager.insert('users', {
                        id: authUser.id,
                        email: authUser.email,
                        full_name: authUser.user_metadata?.full_name || authUser.user_metadata?.name,
                        avatar_url: authUser.user_metadata?.avatar_url,
                        account_status: 'approved', // 구글 로그인 사용자는 자동 승인
                        global_role: 'user'
                    });
                    
                    if (insertError) {
                        console.error('새 사용자 생성 오류:', insertError);
                    } else {
                        console.log('새 사용자 생성 완료');
                        
                        // 기본 워크스페이스 생성
                        await createDefaultWorkspace(authUser.id);
                    }
                }
            } catch (error) {
                console.error('사용자 데이터베이스 처리 오류:', error);
            }
        }

        // Supabase 라이브러리 로드 대기
        async function waitForSupabaseLibrary() {
            return new Promise((resolve) => {
                // 즉시 확인
                if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                    console.log('Supabase 라이브러리 이미 로드됨');
                    resolve();
                    return;
                }
                
                console.log('Supabase 라이브러리 로딩 대기 중...');
                let checkCount = 0;
                const checkInterval = setInterval(() => {
                    checkCount++;
                    console.log(`Supabase 로드 확인 ${checkCount}/50: typeof supabase =`, typeof supabase);
                    
                    if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                        clearInterval(checkInterval);
                        console.log('Supabase 라이브러리 로드 완료');
                        resolve();
                    } else if (checkCount > 50) { // 5초 대기
                        clearInterval(checkInterval);
                        console.error('Supabase 라이브러리 로딩 시간 초과');
                        console.error('현재 supabase 상태:', {
                            exists: typeof supabase !== 'undefined',
                            hasCreateClient: typeof supabase !== 'undefined' && typeof supabase.createClient === 'function',
                            type: typeof supabase
                        });
                        isDemoMode = true;
                        resolve(); // 타임아웃되어도 진행
                    }
                }, 100);
            });
        }

        // 기본 워크스페이스 생성
        async function createDefaultWorkspace(userId) {
            try {
                const { data: workspace, error: workspaceError } = await APIManager.insert('workspaces', {
                    name: '내 워크스페이스',
                    description: '기본 개인 워크스페이스',
                    created_by: userId
                });
                
                if (workspaceError) {
                    console.error('기본 워크스페이스 생성 오류:', workspaceError);
                    return;
                }
                
                const workspaceId = workspace[0]?.id;
                if (workspaceId) {
                    // 워크스페이스 멤버로 추가
                    const { error: memberError } = await APIManager.insert('workspace_members', {
                        workspace_id: workspaceId,
                        user_id: userId,
                        role: 'admin'
                    });
                    
                    if (memberError) {
                        console.error('워크스페이스 멤버 추가 오류:', memberError);
                    } else {
                        console.log('기본 워크스페이스 설정 완료');
                    }
                }
            } catch (error) {
                console.error('기본 워크스페이스 생성 중 오류:', error);
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('DOMContentLoaded 이벤트 발생');
            initializeSafetyVariables();
            
            // Supabase 라이브러리 로드 대기 및 초기화
            console.log('=== 애플리케이션 초기화 시작 ===');
            console.log('1. Supabase 라이브러리 로드 확인...');
            await waitForSupabaseLibrary();
            
            if (isDemoMode) {
                console.log('데모 모드로 실행 - Supabase 라이브러리 로드 실패');
                showNotification('네트워크 문제로 인해 데모 모드로 실행됩니다. 새로고침 후 다시 시도해주세요.', 'warning');
                return;
            }
            
            console.log('2. Supabase 클라이언트 초기화...');
            const supabaseInitialized = SupabaseManager.initialize();
            
            if (supabaseInitialized) {
                console.log('3. 인증 상태 확인...');
                // OAuth 콜백 처리 (페이지 로드 시)
                const authHandled = await handleAuthCallback();
                
                // 인증이 처리되지 않았다면 랜딩페이지 유지
                if (!authHandled) {
                    console.log('인증되지 않은 사용자 - 랜딩페이지 표시');
                }
                console.log('=== 애플리케이션 초기화 완료 ===');
            } else {
                console.log('Supabase 초기화 실패 - 데모 모드로 실행');
                showNotification('백엔드 연결에 실패했습니다. 새로고침 후 다시 시도해주세요.', 'error');
            }
            
            // 편집 모달 날짜 선택기 초기화
            flatpickr("#editTodoDueDate", {
                dateFormat: "Y-m-d",
                locale: "ko",
                allowInput: true,
                altInput: true,
                altFormat: "Y년 m월 d일",
                minDate: "today"
            });
            
            // URL 파라미터 확인 (정식 모드 설정)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'production') {
                console.log('정식 버전 모드로 설정됨');
                isDemoMode = false;
                // URL에서 mode 파라미터 제거
                urlParams.delete('mode');
                const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                window.history.replaceState({}, '', newUrl);
            }

            // 앱 초기화 함수 (재시도 로직 포함)
            const initWithRetry = async () => {
                try {
                    // Supabase 연결 확인 (타임아웃 추가)
                    const connectionPromise = checkSupabaseConnection();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('연결 확인 타임아웃')), 2000)
                    );
                    
                    try {
                        await Promise.race([connectionPromise, timeoutPromise]);
                        console.log('Supabase 연결 확인 완료');
                    } catch (connError) {
                        console.warn('Supabase 연결 확인 실패, 로그인 화면으로 이동:', connError.message);
                    }
                    
                    // 앱 초기화
                    await initializeApp();
                    
                    debugLog('앱 초기화 성공');
                } catch (error) {
                    console.error('앱 초기화 실패:', error);
                    
                    if (initRetries > 0) {
                        initRetries--;
                        console.warn(`초기화 재시도 중... (남은 시도: ${initRetries})`);
                        
                        // 1초 후 재시도
                        setTimeout(initWithRetry, 1000);
                    } else {
                        console.log('모든 재시도 실패, 로그인 화면 표시');
                        showLogin();
                    }
                }
            };
            
            // 초기화 시작
            initWithRetry();
            
            // Failsafe: 5초 후에도 로딩 화면이 표시되면 강제로 로그인 화면 표시
            setTimeout(() => {
                const loadingElement = document.getElementById('loading');
                if (loadingElement && loadingElement.style.display !== 'none') {
                    console.warn('5초 후에도 로딩 중 - 강제로 로그인 화면 표시');
                    showLogin();
                }
            }, 5000);
            
            // 데이터 초기화 버튼 이벤트 리스너
            document.getElementById('resetDataBtn')?.addEventListener('click', function() {
                resetLocalStorage();
                showNotification('데모 데이터가 초기화되었습니다.', 'success');
                location.reload();
            });
            
            // 추가 데이터 로딩 보장
            setTimeout(() => {
                console.log('5초 후 데이터 확인 및 강제 로드');
                if (currentUser && todos.length === 0) {
                    console.log('데이터가 여전히 없음, 강제 로드 실행');
                    loadDemoData();
                    updateDashboard();
                }
            }, 5000);
        });
        
        // 로깅 유틸리티 함수 - 개발 환경에서만 로그 출력
        const DEBUG_MODE = false; // 배포 시 false로 설정
        
        function debugLog(...args) {
            if (DEBUG_MODE) {
                console.log(...args);
            }
        }
        
        // 안전장치 변수 초기화
        function initializeSafetyVariables() {
            try {
                // 달력 모달 안전장치 초기화
                isDateModalOpen = false;
                lastClickTime = 0;
                
                // 전역 변수 초기화
                window.selectedDate = null;
                window.currentDetailTodoId = null;
                
                // 모든 모달이 닫힌 상태인지 확인
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
                
                // 클릭 처리 중 클래스 정리
                document.querySelectorAll('.click-processing, .click-disabled').forEach(element => {
                    element.classList.remove('click-processing', 'click-disabled');
                });
                
                debugLog('안전장치 변수들이 초기화되었습니다.');
                
            } catch (error) {
                console.error('안전장치 변수 초기화 중 오류:', error);
            }
        }
        
        // 권한 정보 캐싱을 위한 전역 변수
        window.cachedPermissions = null;
        window.lastPermissionCheck = null;
        
        // 앱 초기화
        async function initializeApp() {
            try {
                console.log('앱 초기화 시작');
                
                // OAuth 콜백이 아니고 정식 모드가 아닌 경우에만 데모 사용자 확인
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const isOAuthCallback = urlParams.has('code') || hashParams.has('access_token') || urlParams.has('access_token');
                
                if (!isOAuthCallback && !window.location.search.includes('mode=production')) {
                    const savedDemoUser = localStorage.getItem('demo_user');
                    if (savedDemoUser && !isDemoMode === false) { // isDemoMode가 false로 설정되지 않은 경우에만
                        console.log('저장된 데모 사용자 발견, 데모 모드로 시작');
                        currentUser = JSON.parse(savedDemoUser);
                        isDemoMode = true;
                        await setupUserProfile();
                        showApp();
                        return;
                    }
                }
                
                // Supabase 세션 확인 (타임아웃 추가) - OAuth 콜백인 경우 더 긴 대기 시간
                const sessionPromise = supabase.auth.getSession();
                const timeoutDuration = isOAuthCallback ? 5000 : 3000; // OAuth 콜백인 경우 5초 대기
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Supabase 연결 타임아웃')), timeoutDuration)
                );
                
                console.log('세션 확인 중... (타임아웃:', timeoutDuration + 'ms)');
                const { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
                
                if (session) {
                    console.log('세션 발견됨:', session);
                    currentUser = session.user;
                    
                    // 강제로 정식 모드 설정
                    isDemoMode = false;
                    console.log('강제로 정식 모드 설정됨: isDemoMode =', isDemoMode);
                    
                    // OAuth 콜백 URL 정리
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('code') || urlParams.has('access_token')) {
                        const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
                        window.history.replaceState({}, '', cleanUrl);
                    }
                    
                    // 사용자 프로필 설정 및 승인 상태 확인
                    const isApproved = await setupUserProfile();
                    
                    // 승인된 사용자만 앱 사용 가능
                    if (isApproved) {
                        showApp();
                        
                        // 서버 측 권한 정보 가져오기 및 네비게이션 업데이트
                        try {
                            await checkUserPermissions(true);  // 서버 측 권한 강제 확인
                            await updateNavigationTabs();     // 네비게이션 탭 업데이트
                        } catch (permError) {
                            console.error('권한 정보 로드 오류:', permError);
                            // 오류가 발생해도 계속 진행 (클라이언트 측 권한으로 폴백)
                        }
                    }
                    // 나머지 상태(pending, rejected, suspended)는 각각의 화면이 setupUserProfile에서 표시됨
                } else {
                    console.log('세션 없음, 로그인 화면 표시');
                    showLogin();
                }
            } catch (error) {
                console.error('초기화 오류:', error);
                console.log('오류로 인해 로그인 화면 표시');
                showLogin();
            }
        }
        
        // 화면 전환 함수들 (UIManager로 통합)
        function showLogin() {
            UIManager.showScreen('login');
        }
        
        function showApp() {
            UIManager.showScreen('app');
            
            // 앱 데이터 로드 및 권한 확인
            loadAppData();
            
            // 권한에 따른 네비게이션 업데이트 (비동기)
            setTimeout(async () => {
                try {
                    // 서버 측 권한 확인 (오류 시 클라이언트 측으로 폴백)
                    await updateNavigationTabs();
                } catch (error) {
                    console.error('권한 업데이트 오류:', error);
                }
            }, 200);
        }
        
        function showApprovalPendingScreen() {
            UIManager.showScreen('approvalPending');
        }
        
        function showApprovalRejectedScreen() {
            UIManager.showScreen('approvalRejected');
        }
        
        function showAccountSuspendedScreen() {
            UIManager.showScreen('accountSuspended');
        }
        
        // 사용자 프로필 설정 및 승인 상태 확인 (통합 버전)
        async function setupUserProfile() {
            try {
                if (!currentUser) return false;
                
                // 데모 사용자 확인
                const isDemoUser = currentUser.id.includes('demo-user-') || currentUser.email === 'demo@teamtodo.test';
                
                // 데모 모드 처리
                if (isDemoUser || isDemoMode) {
                    console.log('데모 사용자 프로필 설정');
                    // 데모 모드에서는 사용자에게 관리자 권한 부여
                    currentUser.app_metadata = {
                        ...currentUser.app_metadata,
                        account_status: 'approved',
                        global_role: 'super_admin'
                    };
                    
                    // 관리자 탭 표시
                    const adminTab = document.getElementById('adminNavTab');
                    if (adminTab) {
                        adminTab.style.display = 'block';
                    }
                    
                    // UI 업데이트
                    const userName = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
                    if (document.getElementById('userName')) {
                        document.getElementById('userName').textContent = userName;
                    }
                    if (document.getElementById('userAvatar')) {
                        document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
                    }
                    
                    return true; // 데모 모드에서는 항상 승인됨
                }
                
                // 실제 모드 처리 - Supabase 데이터베이스 사용
                if (supabase) {
                    // 사용자 정보 확인
                    const { data: existingUser } = await APIManager.select('users', {
                        select: '*, approved_by(*)',
                        filters: { id: currentUser.id },
                        single: true,
                        errorMessage: '사용자 정보 조회 실패'
                    });
                    
                    if (!existingUser) {
                        console.log('새 사용자 생성');
                        // 새 사용자 생성 - 기본적으로 승인 대기 상태
                        const { error } = await APIManager.insert('users', {
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata.full_name || currentUser.email.split('@')[0],
                            avatar_url: currentUser.user_metadata.avatar_url,
                            display_name: currentUser.user_metadata.full_name || currentUser.email.split('@')[0],
                            account_status: 'pending',
                            global_role: 'user'
                        }, {
                            errorMessage: '새 사용자 생성 실패'
                        });
                        
                        if (error) throw error;
                        
                        // 새로 생성된 사용자 정보 가져오기
                        const { data: newUser } = await APIManager.select('users', {
                            select: '*, approved_by(*)',
                            filters: { id: currentUser.id },
                            single: true,
                            errorMessage: '새 사용자 정보 조회 실패'
                        });
                            
                        currentUser.app_metadata = {
                            ...currentUser.app_metadata,
                            account_status: 'pending',
                            global_role: 'user'
                        };
                        
                        return await checkApprovalStatus(newUser);
                    }
                    
                    console.log('기존 사용자 프로필 업데이트');
                    // 기존 사용자 - 메타데이터 업데이트
                    currentUser.app_metadata = {
                        ...currentUser.app_metadata,
                        account_status: existingUser.account_status,
                        global_role: existingUser.global_role
                    };
                    
                    // 사용자 승인 상태 확인
                    return await checkApprovalStatus(existingUser);
                }
                
                // Supabase 연결 실패 시 폴백
                console.error('Supabase 연결 없음, 사용자 프로필 설정 불가');
                return false;
                
            } catch (error) {
                console.error('사용자 프로필 설정 오류:', error);
                showNotification('사용자 프로필 설정 중 오류가 발생했습니다.', 'error');
                return false;
            }
        }
        
        // 사용자 승인 상태 확인
        async function checkApprovalStatus(user) {
            if (!user) return false;
            
            // UI 업데이트
            // 사용자 정보 UI 업데이트 (UIManager 사용)
            UIManager.updateUserInfo(user);
            
            // 네비게이션 탭 권한 업데이트
            setTimeout(() => {
                updateNavigationTabs();
            }, 100);
            
            // 승인 상태에 따른 처리
            switch (user.account_status) {
                case 'approved':
                    // 승인된 사용자는 앱 사용 가능
                    return true;
                    
                case 'pending':
                    // 승인 대기 중인 사용자는 대기 화면 표시
                    showApprovalPendingScreen();
                    return false;
                    
                case 'rejected':
                    // 거부된 사용자는 거부 화면 표시
                    showApprovalRejectedScreen();
                    return false;
                    
                case 'suspended':
                    // 정지된 사용자는 정지 화면 표시
                    showAccountSuspendedScreen();
                    return false;
                    
                default:
                    // 알 수 없는 상태는 오류 처리
                    console.error('알 수 없는 계정 상태:', user.account_status);
                    showNotification('계정 상태 확인 중 오류가 발생했습니다.', 'error');
                    return false;
            }
        }
        
        // 앱 데이터 로드 - 통합 버전
        async function loadAppData() {
            try {
                // 사용자 인증 상태 확인
                if (!currentUser) {
                    console.log('사용자 정보가 없어 데이터 로드를 건너뜁니다.');
                    return;
                }
                
                // 데이터 로딩 상태 표시
                UIManager.showLoading('데이터를 로드하는 중...');
                
                // 데모 모드 여부 확인 (현재 설정 또는 사용자 ID 기반)
                const isInDemoMode = isDemoMode || (currentUser && (
                    currentUser.id.includes('demo-user-') || 
                    currentUser.email === 'demo@teamtodo.test'
                ));
                
                console.log('데이터 로드 시작 (데모 모드:', isInDemoMode, ')', '사용자:', currentUser?.email);
                
                if (isInDemoMode) {
                    // 데모 모드: localStorage 기반
                    console.log('데모 모드에서 데이터 로드');
                    loadDemoData();
                    
                    // 로딩 상태 숨김
                    setTimeout(() => {
                        UIManager.hideLoading();
                    }, 500);
                } else {
                    // 실제 모드: Supabase 기반
                    console.log('정식 모드에서 Supabase 데이터 로드');
                    
                    // 연결 상태 확인
                    const isConnected = await SupabaseManager.checkConnection();
                    if (!isConnected) {
                        throw new Error('Supabase 연결 실패');
                    }
                    
                    // 데이터 로드 (병렬 처리)
                    await loadWorkspaces(); // 워크스페이스 로드 (내부에서 첫 워크스페이스 선택)
                    
                    // 나머지 데이터 병렬 로드
                    await Promise.all([
                        loadTodos(),
                        loadNotifications(),
                        updateDashboard()
                    ]);
                    
                    // 로딩 상태 숨김
                    UIManager.hideLoading();
                }
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                
                // 로딩 상태 업데이트
                UIManager.showLoading('데이터 로드 중 오류 발생');
                
                // 실제 모드에서 오류 시 데모 모드로 전환하지 않고 오류 표시만
                showNotification('데이터 로드 중 오류가 발생했습니다: ' + error.message, 'error');
                
                // 로딩 상태 숨김
                setTimeout(() => {
                    UIManager.hideLoading();
                }, 1000);
            }
        }
        
        // localStorage 초기화 함수
        function resetLocalStorage() {
            // 데모 데이터 관련 키만 초기화
            const demoKeys = [
                'demo_users', 
                'demo_admin_logs', 
                'demo_workspaces', 
                'demo_projects', 
                'demo_todos', 
                'demo_activities', 
                'demo_comments'
            ];
            
            demoKeys.forEach(key => localStorage.removeItem(key));
            console.log('localStorage의 데모 데이터가 초기화되었습니다.');
            
            // 데모 데이터 다시 로드
            loadDemoData();
            
            // 알림 표시
            showNotification('데모 데이터가 초기화되었습니다.', 'success');
            
            // 현재 페이지 새로고침
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
        
        // 데모 데이터 로드
        function loadDemoData() {
            console.log('데모 데이터 로드 시작...');
            
            // 실제 로그인 사용자인 경우 데모 데이터 로드 차단
            if (currentUser && !currentUser.id.includes('demo-user-') && currentUser.email !== 'demo@teamtodo.test') {
                console.log('실제 사용자 감지 - 데모 데이터 로드 차단');
                return;
            }
            
            // 데모 모드에서는 사용자에게 관리자 권한 부여 (중복 확인)
            if (currentUser) {
                currentUser.app_metadata = {
                    ...currentUser.app_metadata,
                    account_status: 'approved',
                    global_role: 'super_admin'
                };
                
                // 관리자 탭 표시
                const adminTab = document.getElementById('adminNavTab');
                if (adminTab) {
                    adminTab.style.display = 'block';
                }
                
                // 네비게이션 탭 권한 업데이트
                setTimeout(() => {
                    updateNavigationTabs();
                }, 200);
            }
            
            // 다양한 상태의 테스트 사용자 데이터 생성
            demoUsers = [
                {
                    id: 'demo-user-1',
                    email: 'demo@teamtodo.com',
                    full_name: '데모 관리자',
                    display_name: '데모 관리자',
                    avatar_url: null,
                    global_role: 'super_admin',
                    account_status: 'approved',
                    created_at: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(), // 30일 전
                    approved_at: new Date(Date.now() - 29 * 24 * 60 * 60 * 1000).toISOString(), // 29일 전
                    approved_by: {
                        full_name: '시스템 관리자'
                    },
                    rejected_at: null,
                    rejected_by: null
                },
                {
                    id: 'demo-user-2',
                    email: 'user1@example.com',
                    full_name: '김사용자',
                    display_name: '김사용자',
                    avatar_url: null,
                    global_role: 'user',
                    account_status: 'pending',
                    created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2일 전
                    approved_at: null,
                    approved_by: null,
                    rejected_at: null,
                    rejected_by: null
                },
                {
                    id: 'demo-user-3',
                    email: 'user2@example.com',
                    full_name: '이승인',
                    display_name: '이승인',
                    avatar_url: null,
                    global_role: 'user',
                    account_status: 'approved',
                    created_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), // 10일 전
                    approved_at: new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toISOString(), // 9일 전
                    approved_by: {
                        full_name: '데모 관리자'
                    },
                    rejected_at: null,
                    rejected_by: null
                },
                {
                    id: 'demo-user-4',
                    email: 'user3@example.com',
                    full_name: '박거부',
                    display_name: '박거부',
                    avatar_url: null,
                    global_role: 'user',
                    account_status: 'rejected',
                    created_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // 5일 전
                    approved_at: null,
                    approved_by: null,
                    rejected_at: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(), // 4일 전
                    rejected_by: {
                        full_name: '데모 관리자'
                    }
                },
                {
                    id: 'demo-user-5',
                    email: 'user4@example.com',
                    full_name: '최정지',
                    display_name: '최정지',
                    avatar_url: null,
                    global_role: 'user',
                    account_status: 'suspended',
                    created_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), // 15일 전
                    approved_at: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(), // 14일 전
                    approved_by: {
                        full_name: '데모 관리자'
                    },
                    rejected_at: null,
                    rejected_by: null
                },
                {
                    id: 'demo-user-6',
                    email: 'admin@example.com',
                    full_name: '정관리',
                    display_name: '정관리',
                    avatar_url: null,
                    global_role: 'admin',
                    account_status: 'approved',
                    created_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), // 20일 전
                    approved_at: new Date(Date.now() - 19 * 24 * 60 * 60 * 1000).toISOString(), // 19일 전
                    approved_by: {
                        full_name: '데모 관리자'
                    },
                    rejected_at: null,
                    rejected_by: null
                }
            ];
            
            // 활동 로그 생성
            adminLogs = [
                {
                    id: 'log-1',
                    action: 'approve_user',
                    admin_id: 'demo-user-1',
                    admin_name: '데모 관리자',
                    target_id: 'demo-user-3',
                    target_name: '이승인',
                    details: '사용자 계정 승인',
                    created_at: new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toISOString() // 9일 전
                },
                {
                    id: 'log-2',
                    action: 'reject_user',
                    admin_id: 'demo-user-1',
                    admin_name: '데모 관리자',
                    target_id: 'demo-user-4',
                    target_name: '박거부',
                    details: '사용자 계정 거부',
                    created_at: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString() // 4일 전
                },
                {
                    id: 'log-3',
                    action: 'suspend_user',
                    admin_id: 'demo-user-1',
                    admin_name: '데모 관리자',
                    target_id: 'demo-user-5',
                    target_name: '최정지',
                    details: '사용자 계정 정지 - 규칙 위반',
                    created_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString() // 3일 전
                },
                {
                    id: 'log-4',
                    action: 'promote_user',
                    admin_id: 'demo-user-1',
                    admin_name: '데모 관리자',
                    target_id: 'demo-user-6',
                    target_name: '정관리',
                    details: '사용자 역할 변경: user → admin',
                    created_at: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString() // 18일 전
                }
            ];
            
            // localStorage에 저장
            localStorage.setItem('demo_users', JSON.stringify(demoUsers));
            localStorage.setItem('demo_admin_logs', JSON.stringify(adminLogs));
            
            // 기본 워크스페이스 생성
            workspaces = [
                {
                    id: 'demo-workspace-1',
                    name: '데모 프로젝트',
                    description: 'TeamTodo 기능을 체험해볼 수 있는 데모 워크스페이스입니다.',
                    created_at: new Date().toISOString(),
                    created_by: currentUser.id,
                    members: [currentUser.id],
                    member_count: 4,
                    online_count: 2
                },
                {
                    id: 'demo-workspace-2',
                    name: '마케팅 팀',
                    description: '마케팅 캠페인 및 프로모션 관련 작업들을 관리합니다.',
                    created_at: new Date(Date.now() - 86400000).toISOString(),
                    created_by: currentUser.id,
                    members: [currentUser.id],
                    member_count: 6,
                    online_count: 3
                }
            ];
            
            currentWorkspace = workspaces[0];
            
            // 기본 프로젝트 생성
            projects = [
                {
                    id: 'demo-project-1',
                    workspace_id: 'demo-workspace-1',
                    name: '웹사이트 리뉴얼',
                    description: 'TeamTodo 웹사이트의 UI/UX를 개선하는 프로젝트입니다.',
                    color: '#667eea',
                    start_date: new Date().toISOString().split('T')[0],
                    end_date: new Date(Date.now() + 2592000000).toISOString().split('T')[0], // 30일 후
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'demo-project-2',
                    workspace_id: 'demo-workspace-1',
                    name: '모바일 앱 개발',
                    description: 'TeamTodo의 모바일 애플리케이션을 개발하는 프로젝트입니다.',
                    color: '#10b981',
                    start_date: new Date(Date.now() + 604800000).toISOString().split('T')[0], // 7일 후
                    end_date: new Date(Date.now() + 5184000000).toISOString().split('T')[0], // 60일 후
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'demo-project-3',
                    workspace_id: 'demo-workspace-1',
                    name: '마케팅 캠페인',
                    description: '새로운 기능 출시를 위한 마케팅 활동을 계획합니다.',
                    color: '#f59e0b',
                    start_date: new Date(Date.now() - 86400000).toISOString().split('T')[0], // 어제
                    end_date: new Date(Date.now() + 1209600000).toISOString().split('T')[0], // 14일 후
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                }
            ];
            
            currentProject = projects[0];
            
            // 기본 할 일 생성 (프로젝트 연결)
            todos = [
                {
                    id: 'demo-todo-1',
                    workspace_id: 'demo-workspace-1',
                    project_id: 'demo-project-1',
                    title: 'UI 디자인 시안 작성',
                    description: '새로운 웹사이트의 메인 페이지 디자인 시안을 작성합니다.',
                    priority: 'high',
                    status: 'pending',
                    start_date: new Date().toISOString().split('T')[0],
                    due_date: new Date(Date.now() + 172800000).toISOString().split('T')[0], // 2일 후
                    created_by: currentUser.id,
                    assigned_to: currentUser.id,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'demo-todo-2',
                    workspace_id: 'demo-workspace-1',
                    project_id: 'demo-project-1',
                    title: '프론트엔드 개발 환경 설정',
                    description: 'React, Webpack, 각종 개발 도구들을 설정합니다.',
                    priority: 'medium',
                    status: 'in_progress',
                    start_date: new Date(Date.now() - 86400000).toISOString().split('T')[0], // 어제
                    due_date: new Date(Date.now() + 86400000).toISOString().split('T')[0], // 내일
                    created_by: currentUser.id,
                    assigned_to: currentUser.id,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'demo-todo-3',
                    workspace_id: 'demo-workspace-1',
                    project_id: 'demo-project-2',
                    title: '모바일 앱 기획서 작성',
                    description: '모바일 앱의 주요 기능과 화면 구성을 기획합니다.',
                    priority: 'high',
                    status: 'completed',
                    start_date: new Date(Date.now() - 172800000).toISOString().split('T')[0], // 2일 전
                    due_date: new Date(Date.now() - 86400000).toISOString().split('T')[0], // 어제
                    completed_at: new Date(Date.now() - 86400000).toISOString(),
                    created_by: currentUser.id,
                    assigned_to: currentUser.id,
                    created_at: new Date(Date.now() - 259200000).toISOString()
                },
                {
                    id: 'demo-todo-4',
                    workspace_id: 'demo-workspace-1',
                    project_id: 'demo-project-3',
                    title: '소셜미디어 콘텐츠 제작',
                    description: 'Instagram, Facebook용 마케팅 콘텐츠를 제작합니다.',
                    priority: 'medium',
                    status: 'pending',
                    start_date: new Date(Date.now() + 86400000).toISOString().split('T')[0], // 내일
                    due_date: new Date(Date.now() + 432000000).toISOString().split('T')[0], // 5일 후
                    created_by: currentUser.id,
                    assigned_to: currentUser.id,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'demo-todo-5',
                    workspace_id: 'demo-workspace-1',
                    project_id: 'demo-project-1',
                    title: '사용자 테스트 진행',
                    description: '새로운 UI에 대한 사용자 피드백을 수집합니다.',
                    priority: 'low',
                    status: 'pending',
                    start_date: new Date(Date.now() + 259200000).toISOString().split('T')[0], // 3일 후
                    due_date: new Date(Date.now() + 604800000).toISOString().split('T')[0], // 7일 후
                    created_by: currentUser.id,
                    assigned_to: currentUser.id,
                    created_at: new Date().toISOString()
                }
            ];
            

            
            // 데모 활동 피드 생성
            activities = [
                {
                    id: 'activity-1',
                    type: 'todo_completed',
                    user: '김철수',
                    text: '할 일을 완료했습니다: "프로젝트 기획서 작성"',
                    timestamp: new Date(Date.now() - 600000).toISOString() // 10분 전
                },
                {
                    id: 'activity-2',
                    type: 'todo_created',
                    user: '박영희',
                    text: '새 할 일을 추가했습니다: "디자인 시안 검토"',
                    timestamp: new Date(Date.now() - 1800000).toISOString() // 30분 전
                },
                {
                    id: 'activity-3',
                    type: 'member_joined',
                    user: '이민수',
                    text: '워크스페이스에 참여했습니다',
                    timestamp: new Date(Date.now() - 7200000).toISOString() // 2시간 전
                }
            ];
            

            
            // 댓글 데모 데이터 생성
            let commentData = [
                {
                    id: 'comment-1',
                    todo_id: 'demo-todo-1',
                    author: '김디자이너',
                    author_id: 'user-designer',
                    content: '디자인 시안 초안을 완성했습니다. 피드백 부탁드려요!',
                    created_at: new Date(Date.now() - 3600000).toISOString(), // 1시간 전
                    updated_at: new Date(Date.now() - 3600000).toISOString()
                },
                {
                    id: 'comment-2',
                    todo_id: 'demo-todo-1',
                    author: '박개발자',
                    author_id: 'user-developer',
                    content: '디자인 좋네요! 컬러 팔레트가 특히 마음에 듭니다. 개발 시 고려할 점이 있다면 알려주세요.',
                    created_at: new Date(Date.now() - 1800000).toISOString(), // 30분 전
                    updated_at: new Date(Date.now() - 1800000).toISOString()
                },
                {
                    id: 'comment-3',
                    todo_id: 'demo-todo-2',
                    author: '이팀장',
                    author_id: 'user-manager',
                    content: 'Webpack 설정 관련해서 최신 버전으로 업데이트해주세요. 성능 개선에 도움이 될 것 같습니다.',
                    created_at: new Date(Date.now() - 7200000).toISOString(), // 2시간 전
                    updated_at: new Date(Date.now() - 7200000).toISOString()
                },
                {
                    id: 'comment-4',
                    todo_id: 'demo-todo-4',
                    author: '최마케터',
                    author_id: 'user-marketer',
                    content: '인스타그램 콘텐츠는 준비되었고, 페이스북용 콘텐츠도 곧 완성 예정입니다.',
                    created_at: new Date(Date.now() - 900000).toISOString(), // 15분 전
                    updated_at: new Date(Date.now() - 900000).toISOString()
                },
                {
                    id: 'comment-5',
                    todo_id: 'demo-todo-4',
                    author: currentUser.user_metadata?.full_name || '데모 사용자',
                    author_id: currentUser.id,
                    content: '좋습니다! 해시태그 전략도 함께 검토해보면 좋을 것 같아요.',
                    created_at: new Date(Date.now() - 300000).toISOString(), // 5분 전
                    updated_at: new Date(Date.now() - 300000).toISOString()
                }
            ];
            
            // todoComments 변수에 할당
            todoComments = commentData;
            
            // localStorage에 저장 (안전하게 처리)
            try {
                localStorage.setItem('demo_workspaces', JSON.stringify(workspaces));
                localStorage.setItem('demo_projects', JSON.stringify(projects));
                localStorage.setItem('demo_todos', JSON.stringify(todos));
                localStorage.setItem('demo_activities', JSON.stringify(activities));
                localStorage.setItem('demo_comments', JSON.stringify(todoComments));
                console.log('localStorage 저장 완료');
            } catch (error) {
                console.error('localStorage 저장 오류:', error);
            }
            
            console.log('모든 데모 데이터가 성공적으로 저장되었습니다.');
            console.log('워크스페이스:', workspaces.length);
            console.log('프로젝트:', projects.length);
            console.log('할일:', todos.length);
            console.log('댓글:', todoComments.length);
            console.log('사용자:', demoUsers.length);
            
            // 워크스페이스 설정 및 관련 함수 호출
            if (workspaces.length > 0) {
                currentWorkspace = workspaces[0];
                console.log('워크스페이스 설정 완료:', currentWorkspace);
                console.log('로드된 할일 개수:', todos.length);
                
                // 데모 모드에서도 실제 앱과 동일한 데이터 로드 과정 따르기
                renderWorkspaces();
                renderProjects();
                renderTodos();
                renderCalendar();
                updateDashboard();
                updateProjectsPage();
                
                console.log('모든 렌더링 함수 호출 완료');
            }
            
            console.log('데모 데이터 로드 완료, 최종 todos 개수:', todos.length);
            
            // 데모 모드 표시 (실제 사용자인 경우 차단)
            if (currentUser && !currentUser.id.includes('demo-user-') && currentUser.email !== 'demo@teamtodo.test') {
                console.log('실제 사용자 감지 - 데모 모드 표시 차단');
                return;
            }
            
            isDemoMode = true;
            showDemoModeIndicator();
            
            // 추가 안전장치: 데이터 로드 후 대시보드 재업데이트
            setTimeout(() => {
                console.log('데모 데이터 로드 후 지연된 대시보드 업데이트');
                updateDashboard();
            }, 500);
        }
        
        // 데모 모드 표시기
        function showDemoModeIndicator() {
            // 기존 표시기 제거
            const existingIndicator = document.querySelector('.demo-mode-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const indicator = document.createElement('div');
            indicator.className = 'demo-mode-indicator';
            indicator.innerHTML = `
                <span>🎮 데모 모드</span>
                <span class="realtime-status disconnected">실시간 기능 비활성</span>
            `;
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #fef3c7;
                color: #92400e;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 10000;
                border: 1px solid #fcd34d;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            document.body.appendChild(indicator);
        }
        
        // 정식 모드 표시기
        function showProductionModeIndicator() {
            // 기존 표시기 제거
            const existingIndicator = document.querySelector('.demo-mode-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const indicator = document.createElement('div');
            indicator.className = 'production-mode-indicator';
            indicator.innerHTML = `
                <span>🚀 정식 버전</span>
                <span class="realtime-status connected">실시간 연동</span>
            `;
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #d1fae5;
                color: #065f46;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 10000;
                border: 1px solid #34d399;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            document.body.appendChild(indicator);
            
            // 3초 후 자동 숨기기
            setTimeout(() => {
                indicator.style.opacity = '0';
                indicator.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    indicator.remove();
                }, 500);
            }, 3000);
        }
        
        // OAuth 콜백 전용 처리 함수
        async function handleOAuthCallback() {
            console.log('OAuth 콜백 전용 처리 시작');
            
            // 로딩 표시
            UIManager.showLoading();
            UIManager.setDisplay('loginContainer', 'none');
            
            // OAuth 콜백 처리 - AuthManager 사용
            if (AuthManager && AuthManager.isOAuthCallback()) {
                AuthManager.setupAuthListener();
            } else {
                showNotification('로그인 처리를 시작합니다...', 'info');
                setTimeout(() => {
                    if (AuthManager) {
                        AuthManager.setupAuthListener();
                    } else {
                        console.error('AuthManager가 초기화되지 않았습니다.');
                        showNotification('로그인 시스템 초기화 오류', 'error');
                        showLogin();
                    }
                }, 500);
            }
        }
        
        // 브라우저 알림 권한 요청
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('브라우저 알림 권한이 허용되었습니다.');
                    }
                });
            }
        }
        
        // 실시간 연결 상태 업데이트
        function updateRealtimeStatus(connected) {
            const indicator = document.getElementById('realtimeStatusIndicator');
            if (indicator) {
                indicator.style.display = connected && !isDemoMode ? 'inline-flex' : 'none';
                indicator.className = `realtime-status ${connected ? 'connected' : 'disconnected'}`;
                indicator.textContent = connected ? '실시간 연결됨' : '연결 끊김';
            }
        }
        
        // 모든 모달 닫기 (ESC 키 지원)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                try {
                    // 각 모달별로 적절한 닫기 함수 호출
                    const dateModal = document.getElementById('dateModal');
                    const todoDetailModal = document.getElementById('todoDetailModal');
                    const createProjectModal = document.getElementById('createProjectModal');
                    const editProjectModal = document.getElementById('editProjectModal');
                    
                    if (dateModal && dateModal.style.display === 'flex') {
                        closeDateModal();
                    } else if (todoDetailModal && todoDetailModal.style.display === 'flex') {
                        closeTodoDetailModal();
                    } else if (createProjectModal && createProjectModal.style.display === 'flex') {
                        hideCreateProjectModal();
                    } else if (editProjectModal && editProjectModal.style.display === 'flex') {
                        hideEditProjectModal();
                    } else if (document.getElementById('editTodoModal') && document.getElementById('editTodoModal').style.display === 'flex') {
                        closeEditTodoModal();
                    } else {
                        // 기본 모달 닫기 (백업용)
                        document.querySelectorAll('.modal').forEach(modal => {
                            if (modal.style.display === 'flex') {
                                modal.style.display = 'none';
                            }
                        });
                        
                        // 안전장치 변수들 초기화
                        isDateModalOpen = false;
                        window.selectedDate = null;
                        window.currentDetailTodoId = null;
                    }
                    
                    console.log('ESC 키로 모달이 닫혔습니다.');
                    
                } catch (error) {
                    console.error('ESC 키 모달 닫기 중 오류:', error);
                    
                    // 오류 발생 시 강제로 모든 상태 초기화
                    isDateModalOpen = false;
                    window.selectedDate = null;
                    window.currentDetailTodoId = null;
                }
            }
        });
        
        // 워크스페이스 로드
        async function loadWorkspaces() {
            try {
                if (!currentUser) {
                    console.warn('현재 사용자가 없어서 워크스페이스를 로드할 수 없습니다.');
                    return;
                }
                
                const { data, error } = await APIManager.select('workspaces', {
                    select: `
                        *,
                        workspace_members!inner(user_id)
                    `,
                    filters: { 'workspace_members.user_id': currentUser.id },
                    errorMessage: '워크스페이스 목록 로드 실패'
                });
                
                if (error) throw error;
                
                workspaces = data || [];
                renderWorkspaces();
                
                // 첫 번째 워크스페이스를 기본으로 선택
                if (workspaces.length > 0 && !currentWorkspace) {
                    currentWorkspace = workspaces[0];
                    // 워크스페이스에 해당하는 프로젝트 로드
                    await loadProjects();
                    // 실시간 구독 초기화
                    initializeRealtimeSubscriptions();
                }
                
            } catch (error) {
                console.error('워크스페이스 로드 오류:', error);
            }
        }
        
        // 프로젝트 로드
        async function loadProjects() {
            if (!currentWorkspace) return;
            
            try {
                const { data, error } = await APIManager.select('projects', {
                    filters: { workspace_id: currentWorkspace.id },
                    orderBy: { column: 'created_at', ascending: false },
                    errorMessage: '프로젝트 로드 중 오류가 발생했습니다'
                });
                
                if (error) throw error;
                
                projects = data || [];
                renderProjects();
                
            } catch (error) {
                console.error('프로젝트 로드 오류:', error);
                // 오류 시 빈 배열로 초기화하여 UI 오류 방지
                projects = [];
                renderProjects();
            }
        }
        
        // 할 일 로드
        async function loadTodos() {
            if (!currentUser || !currentWorkspace) {
                console.warn('사용자 또는 워크스페이스 정보가 없어서 할 일을 로드할 수 없습니다.');
                return;
            }
            
            try {
                const { data, error } = await APIManager.select('todos', {
                    select: `
                        *,
                        assigned_user:assigned_to(full_name),
                        created_user:created_by(full_name)
                    `,
                    filters: { workspace_id: currentWorkspace.id },
                    orderBy: { column: 'created_at', ascending: false },
                    errorMessage: '할 일 목록 로드 실패'
                });
                
                if (error) throw error;
                
                todos = data || [];
                renderTodos();
                
            } catch (error) {
                console.error('할 일 로드 오류:', error);
            }
        }
        
        // 알림 로드
        async function loadNotifications() {
            try {
                if (!currentUser) {
                    console.warn('현재 사용자가 없어서 알림을 로드할 수 없습니다.');
                    return;
                }
                const { data, error } = await APIManager.select('notifications', {
                    filters: { user_id: currentUser.id },
                    orderBy: { column: 'created_at', ascending: false },
                    limit: 10,
                    errorMessage: '알림 목록 로드 실패'
                });
                
                if (error) throw error;
                
                renderNotifications(data || []);
                
            } catch (error) {
                console.error('알림 로드 오류:', error);
            }
        }
        
        // 대시보드 전역 변수
        let dashboardFilter = {
            project: null,
            status: null
        };
        
        // 향상된 대시보드 업데이트
        async function updateDashboard() {
            try {
                debugLog('updateDashboard 호출됨');
                debugLog('현재 todos 배열 상태:', todos);
                debugLog('현재 사용자:', currentUser);
                debugLog('현재 워크스페이스:', currentWorkspace);
                
                // 만약 todos가 비어있고 사용자가 있다면 데이터 로드
                if (todos.length === 0 && currentUser) {
                    debugLog('대시보드 업데이트 중 데이터 없음 감지, 강제 로드');
                    
                    // 데모 모드인 경우 데모 데이터 로드
                    if (currentUser.id.indexOf('demo-user-') === 0) {
                        loadDemoData();
                    } else {
                        // 실제 데이터 로드
                        await loadAppData();
                    }
                }
                
                // 안전 검사: 워크스페이스가 없으면 첫 번째 워크스페이스로 설정
                if (!currentWorkspace && workspaces.length > 0) {
                    currentWorkspace = workspaces[0];
                }
                
                // 필터링된 할 일 가져오기 (안전하게 처리)
                let filteredTodos = [];
                if (todos && todos.length > 0 && currentWorkspace) {
                    filteredTodos = todos.filter(todo => todo.workspace_id === currentWorkspace.id);
                }
                
                // 프로젝트 필터 적용 (안전하게 처리)
                if (dashboardFilter.project && filteredTodos.length > 0) {
                    filteredTodos = filteredTodos.filter(todo => todo.project_id === dashboardFilter.project);
                }
                
                // 상태 필터 적용 (안전하게 처리)
                if (dashboardFilter.status && filteredTodos.length > 0) {
                    filteredTodos = filteredTodos.filter(todo => todo.status === dashboardFilter.status);
                }
                
                // 필터링 후에도 할일이 없으면 로그 남기기
                if (filteredTodos.length === 0) {
                    debugLog('필터링 후 표시할 할일이 없습니다. 필터 설정:', dashboardFilter);
                }
                
                const totalTodos = filteredTodos.length;
                const completedTodos = filteredTodos.filter(todo => todo.status === 'completed').length;
                const pendingTodos = filteredTodos.filter(todo => todo.status === 'pending').length;
                const inProgressTodos = filteredTodos.filter(todo => todo.status === 'in_progress').length;
                
                // 클릭 가능한 통계 카드 렌더링
                const dashboardHTML = `
                    <div class="dashboard-stat-card ${dashboardFilter.status === null ? 'active' : ''}" 
                         onclick="filterDashboardByStatus(null)" 
                         style="background: ${dashboardFilter.status === null ? '#f0f9ff' : '#f8fafc'};">
                        <div class="stat-title" style="color: #0369a1;">전체 할 일</div>
                        <div class="stat-number">${totalTodos}</div>
                    </div>
                    <div class="dashboard-stat-card ${dashboardFilter.status === 'completed' ? 'active' : ''}" 
                         onclick="filterDashboardByStatus('completed')" 
                         style="background: ${dashboardFilter.status === 'completed' ? '#f0fdf4' : '#f8fafc'};">
                        <div class="stat-title" style="color: #15803d;">완료됨</div>
                        <div class="stat-number">${completedTodos}</div>
                    </div>
                    <div class="dashboard-stat-card ${dashboardFilter.status === 'in_progress' ? 'active' : ''}" 
                         onclick="filterDashboardByStatus('in_progress')" 
                         style="background: ${dashboardFilter.status === 'in_progress' ? '#eff6ff' : '#f8fafc'};">
                        <div class="stat-title" style="color: #2563eb;">진행 중</div>
                        <div class="stat-number">${inProgressTodos}</div>
                    </div>
                    <div class="dashboard-stat-card ${dashboardFilter.status === 'pending' ? 'active' : ''}" 
                         onclick="filterDashboardByStatus('pending')" 
                         style="background: ${dashboardFilter.status === 'pending' ? '#fef2f2' : '#f8fafc'};">
                        <div class="stat-title" style="color: #dc2626;">대기 중</div>
                        <div class="stat-number">${pendingTodos}</div>
                    </div>
                `;
                
                const dashboardStatsElement = document.getElementById('dashboardStats');
                if (dashboardStatsElement) {
                    dashboardStatsElement.innerHTML = dashboardHTML;
                } else {
                    console.warn('dashboardStats 요소를 찾을 수 없습니다.');
                }
                
                // 프로젝트 필터 드롭다운 업데이트
                updateDashboardProjectFilter();
                
                // 할 일 목록 렌더링
                renderDashboardTodos(filteredTodos);
                
            } catch (error) {
                console.error('대시보드 업데이트 오류:', error);
            }
        }
        
        // 대시보드 프로젝트 필터 업데이트
        function updateDashboardProjectFilter() {
            const filterSelect = document.getElementById('dashboardProjectFilter');
            if (!filterSelect) return;
            
            filterSelect.innerHTML = '<option value="">모든 프로젝트</option>';
            
            const workspaceProjects = projects.filter(p => p.workspace_id === currentWorkspace?.id);
            workspaceProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                option.selected = dashboardFilter.project === project.id;
                filterSelect.appendChild(option);
            });
        }
        
        // 대시보드 할 일 목록 렌더링
        function renderDashboardTodos(filteredTodos) {
            debugLog('renderDashboardTodos 호출됨, 할일 개수:', filteredTodos?.length || 0);
            debugLog('필터링된 할일들:', filteredTodos);
            debugLog('현재 todos 전체 배열:', todos);
            debugLog('현재 사용자:', currentUser);
            debugLog('현재 워크스페이스:', currentWorkspace);
            
            // 안전하게 처리: filteredTodos가 undefined나 null인 경우 빈 배열로 초기화
            if (!filteredTodos) {
                filteredTodos = [];
            }
            
            // 만약 todos 배열이 비어있다면 데모 데이터 강제 로드
            if ((todos.length === 0 || filteredTodos.length === 0) && currentUser && isDemoMode) {
                debugLog('todos 배열이 비어있거나 필터링된 할일이 없음, 데모 데이터 강제 로드');
                loadDemoData();
                // 잠시 기다린 후 다시 필터링
                setTimeout(() => {
                    if (currentWorkspace) {
                        filteredTodos = todos.filter(todo => todo.workspace_id === currentWorkspace.id);
                    } else {
                        filteredTodos = todos.slice(0); // 전체 복사
                    }
                    debugLog('데모 데이터 로드 후 필터링된 할일들:', filteredTodos);
                    
                    // UI 재렌더링
                    const container = document.getElementById('dashboardTodosList');
                    const countBadge = document.getElementById('dashboardTodoCount');
                    
                    if (container && countBadge) {
                        countBadge.textContent = `${filteredTodos.length}개`;
                        
                        if (filteredTodos.length === 0) {
                            container.innerHTML = '<div class="empty-state">할 일이 없습니다. 새로운 할 일을 추가해보세요!</div>';
                        } else {
                            let html = '';
                            filteredTodos.forEach(todo => {
                                const project = projects.find(p => p.id === todo.project_id);
                                const priorityClass = todo.priority === 'high' ? 'priority-high' : 
                                                   todo.priority === 'medium' ? 'priority-medium' : 'priority-low';
                                
                                html += `
                                    <div class="dashboard-todo-item ${todo.status === 'completed' ? 'completed' : ''}">
                                        <div class="todo-info">
                                            <h4>${todo.title}</h4>
                                            <p>${project ? project.name : '프로젝트 없음'} • ${todo.priority} 우선순위</p>
                                        </div>
                                        <div class="todo-status ${priorityClass}">${todo.status === 'completed' ? '완료' : '진행중'}</div>
                                    </div>
                                `;
                            });
                            container.innerHTML = html;
                        }
                    }
                }, 100);
                return; // 함수 조기 종료
            }
            
            const container = document.getElementById('dashboardTodosList');
            const countBadge = document.getElementById('dashboardTodoCount');
            
            if (!container) {
                console.error('dashboardTodosList 요소를 찾을 수 없습니다');
                return;
            }
            
            if (countBadge) {
                countBadge.textContent = `${filteredTodos.length}개`;
            } else {
                console.warn('dashboardTodoCount 요소를 찾을 수 없습니다');
            }
            
            // 필터 상태 표시
            const filterStatus = [];
            if (dashboardFilter.project) {
                const project = projects.find(p => p.id === dashboardFilter.project);
                filterStatus.push(`프로젝트: ${escapeHTML(project?.name)}`);
            }
            if (dashboardFilter.status) {
                const statusText = {
                    'pending': '대기중',
                    'in_progress': '진행중',
                    'completed': '완료'
                };
                filterStatus.push(`상태: ${statusText[dashboardFilter.status]}`);
            }
            
            let filterHTML = '';
            if (filterStatus.length > 0) {
                filterHTML = `
                    <div class="dashboard-filter-status">
                        ${filterStatus.map(status => `
                            <div class="filter-tag">
                                ${status}
                                <button class="filter-clear" onclick="clearDashboardFilters()">×</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (filteredTodos.length === 0) {
                container.innerHTML = filterHTML + `
                    <div style="text-align: center; padding: 50px; color: #a0aec0;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                        <p>조건에 맞는 할 일이 없습니다.</p>
                        ${dashboardFilter.project || dashboardFilter.status ? '<p>필터를 조정해보세요.</p>' : ''}
                    </div>
                `;
                return;
            }
            
            // 상태별 정렬 (진행중 > 대기중 > 완료)
            filteredTodos.sort((a, b) => {
                const statusOrder = { 'in_progress': 0, 'pending': 1, 'completed': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            
            const todosHTML = filteredTodos.map(todo => {
                const project = projects.find(p => p.id === todo.project_id);
                const statusText = {
                    'pending': '대기중',
                    'in_progress': '진행중',
                    'completed': '완료'
                };
                const statusColor = {
                    'pending': '#f59e0b',
                    'in_progress': '#3b82f6',
                    'completed': '#10b981'
                };
                const dateInfo = [];
                if (todo.start_date) {
                    dateInfo.push(`시작: ${new Date(todo.start_date).toLocaleDateString()}`);
                }
                if (todo.due_date) {
                    dateInfo.push(`마감: ${new Date(todo.due_date).toLocaleDateString()}`);
                }
                const commentCount = getCommentCount(todo.id);
                
                return `
                    <div class="enhanced-date-todo-item" onclick="showTodoDetailModal('${todo.id}')" style="margin-bottom: 12px; cursor: pointer;">
                        <div class="todo-color-indicator" style="background: ${project?.color || '#6b7280'}"></div>
                        <div class="todo-main-info">
                            <div class="todo-title-enhanced">${escapeHTML(todo.title)}</div>
                            <div class="todo-meta-info">
                                <span class="todo-project-name" style="background: ${project?.color}20; color: ${project?.color || '#4a5568'}">
                                    ${escapeHTML(project?.name || '프로젝트 없음')}
                                </span>
                                ${dateInfo.length > 0 ? `<span class="todo-dates-info">${dateInfo.join(' • ')}</span>` : ''}
                                ${commentCount > 0 ? `<span class="comment-count">💬 ${commentCount}</span>` : ''}
                            </div>
                            ${todo.description ? `
                                <div class="todo-description-preview">
                                    ${escapeHTML(todo.description.length > 80 ? todo.description.substring(0, 80) + '...' : todo.description)}
                                </div>
                            ` : ''}
                        </div>
                        <div class="todo-status-indicator">
                            <span class="todo-status-badge" style="background: ${statusColor[todo.status]}">
                                ${statusText[todo.status]}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = filterHTML + todosHTML;
            
            // 클릭 이벤트 리스너 추가 (대안 방법)
            const todoItems = container.querySelectorAll('.enhanced-date-todo-item');
            todoItems.forEach((item, index) => {
                const todoId = filteredTodos[index].id;
                item.addEventListener('click', function(e) {
                    console.log('할일 클릭됨 (addEventListener):', todoId);
                    showTodoDetailModal(todoId);
                });
            });
            
            console.log('대시보드 할일 목록 렌더링 완료, 클릭 이벤트 추가됨');
        }
        
        // 대시보드 프로젝트별 필터링
        function filterDashboardByProject() {
            const selectedProjectId = document.getElementById('dashboardProjectFilter').value;
            dashboardFilter.project = selectedProjectId || null;
            
            updateDashboard();
            
            if (dashboardFilter.project) {
                const project = projects.find(p => p.id === dashboardFilter.project);
                showNotification(`"${project?.name}" 프로젝트로 필터링했습니다.`);
            } else {
                showNotification('모든 프로젝트를 표시합니다.');
            }
        }
        
        // 대시보드 상태별 필터링
        function filterDashboardByStatus(status) {
            dashboardFilter.status = status;
            
            updateDashboard();
            
            const statusText = {
                'pending': '대기중',
                'in_progress': '진행중',
                'completed': '완료'
            };
            
            if (status) {
                showNotification(`"${statusText[status]}" 할 일만 표시합니다.`);
            } else {
                showNotification('모든 상태의 할 일을 표시합니다.');
            }
        }
        
        // 대시보드 필터 초기화
        function clearDashboardFilters() {
            dashboardFilter = {
                project: null,
                status: null
            };
            
            // 드롭다운 초기화
            const projectFilter = document.getElementById('dashboardProjectFilter');
            if (projectFilter) {
                projectFilter.value = '';
            }
            
            updateDashboard();
            showNotification('모든 필터가 초기화되었습니다.');
        }
        
        // ==================== 프로젝트 관리 ====================
        
        let selectedProjectId = 'all';
        
        // 프로젝트 탭 선택
        function selectProjectTab(projectId) {
            selectedProjectId = projectId;
            
            // 탭 활성화 상태 업데이트
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="selectProjectTab('${projectId}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // 프로젝트 내용 업데이트
            updateProjectContent();
        }
        
        // 프로젝트 탭 렌더링
        function renderProjectTabs() {
            const tabsContainer = document.getElementById('projectTabs');
            if (!tabsContainer) return;
            
            const workspaceProjects = projects.filter(p => p.workspace_id === currentWorkspace?.id);
            
            let tabsHTML = `
                <button class="project-tab ${selectedProjectId === 'all' ? 'active' : ''}" onclick="selectProjectTab('all')">
                    📂 전체 프로젝트
                </button>
            `;
            
            workspaceProjects.forEach(project => {
                tabsHTML += `
                    <button class="project-tab ${selectedProjectId === project.id ? 'active' : ''}" 
                            onclick="selectProjectTab('${project.id}')"
                            oncontextmenu="showProjectContextMenu(event, '${project.id}')"
                            style="border-left: 4px solid ${project.color};">
                        ${project.name}
                    </button>
                `;
            });
            
            tabsContainer.innerHTML = tabsHTML;
        }
        
        // 프로젝트 내용 업데이트
        function updateProjectContent() {
            let projectTodos = todos.filter(todo => todo.workspace_id === currentWorkspace?.id);
            
            // 선택된 프로젝트로 필터링
            if (selectedProjectId !== 'all') {
                projectTodos = projectTodos.filter(todo => todo.project_id === selectedProjectId);
            }
            
            // 통계 계산
            const totalTodos = projectTodos.length;
            const inProgressTodos = projectTodos.filter(todo => todo.status === 'in_progress').length;
            const completedTodos = projectTodos.filter(todo => todo.status === 'completed').length;
            const progress = totalTodos > 0 ? Math.round((completedTodos / totalTodos) * 100) : 0;
            
            // 통계 업데이트
            UIManager.updateStats({
                'projectTotalTodos': totalTodos,
                'projectInProgressTodos': inProgressTodos,
                'projectCompletedTodos': completedTodos,
                'projectProgress': progress + '%'
            });
            
            // 프로젝트 할 일 목록 렌더링 부분은 제거됨
        }
        
        // 프로젝트 할 일 목록 렌더링 함수는 제거됨
        function renderProjectTodos(projectTodos) {
            // 이 함수는 더 이상 필요하지 않으므로 제거됨
            // 빈 함수로 대체 (호출되는 곳이 있을 수 있음)
            return;
        }
        
        // 프로젝트 할 일 필터링 함수는 제거됨
        
        // 프로젝트에서 할 일 추가 함수는 제거됨
        
        // 프로젝트 관리 페이지 업데이트
        function updateProjectsPage() {
            renderProjectTabs();
            updateProjectContent();
        }
        
        // ==================== 프로젝트 생성/수정 모달 관리 ====================
        
        let currentEditingProjectId = null;
        
        // 프로젝트 생성 모달 표시
        function showCreateProjectModal() {
            try {
                console.log('프로젝트 생성 모달 열기 시도');
                
                // 워크스페이스 확인
                if (!currentWorkspace && !isDemoMode) {
                    showNotification('먼저 워크스페이스를 선택하거나 생성해주세요.', 'warning');
                    return;
                }
                
                // 폼 초기화
                const projectNameField = document.getElementById('projectName');
                const projectDescField = document.getElementById('projectDescription');
                const colorOption = document.querySelector('input[name="color"][value="#3b82f6"]');
                const modal = document.getElementById('createProjectModal');
                const descriptionCount = document.getElementById('descriptionCount');
                
                if (projectNameField) projectNameField.value = '';
                if (projectDescField) {
                    projectDescField.value = '';
                    // 글자 수 카운터 초기화
                    if (descriptionCount) descriptionCount.textContent = '0';
                }
                if (colorOption) colorOption.checked = true;
                
                // 글자 수 카운터 이벤트 추가
                if (projectDescField && descriptionCount) {
                    projectDescField.addEventListener('input', function() {
                        const count = this.value.length;
                        descriptionCount.textContent = count;
                        
                        // 글자 수에 따른 색상 변경
                        if (count > 180) {
                            descriptionCount.style.color = '#ef4444';
                        } else if (count > 150) {
                            descriptionCount.style.color = '#f59e0b';
                        } else {
                            descriptionCount.style.color = '#6b7280';
                        }
                    });
                }
                
                if (modal) {
                    modal.style.display = 'flex';
                    console.log('프로젝트 생성 모달이 열렸습니다.');
                    
                    // 키보드 이벤트 리스너 추가
                    const handleKeyDown = (e) => {
                        if (e.key === 'Escape') {
                            hideCreateProjectModal();
                            document.removeEventListener('keydown', handleKeyDown);
                        }
                    };
                    document.addEventListener('keydown', handleKeyDown);
                    
                    // 첫 번째 입력 필드에 포커스
                    setTimeout(() => {
                        if (projectNameField) projectNameField.focus();
                    }, 100);
                } else {
                    console.error('createProjectModal을 찾을 수 없습니다.');
                }
                
            } catch (error) {
                console.error('프로젝트 모달 열기 오류:', error);
                showNotification('프로젝트 모달을 열 수 없습니다. 페이지를 새로고침해주세요.', 'error');
            }
        }
        
        // 프로젝트 생성 모달 숨기기
        function hideCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            if (modal) {
                modal.style.display = 'none';
                
                // 폼 초기화
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // 글자 수 카운터 초기화
                const descriptionCount = document.getElementById('descriptionCount');
                if (descriptionCount) {
                    descriptionCount.textContent = '0';
                    descriptionCount.style.color = '#6b7280';
                }
                
                // 기본 색상 선택
                const defaultColor = modal.querySelector('input[name="color"][value="#3b82f6"]');
                if (defaultColor) defaultColor.checked = true;
                
                console.log('프로젝트 생성 모달이 닫혔습니다.');
            }
        }
        
        // 프로젝트 수정 모달 표시
        function showEditProjectModal(projectId) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) {
                    showNotification('프로젝트를 찾을 수 없습니다.', 'error');
                    return;
                }
                
                currentEditingProjectId = projectId;
                
                // 폼에 기존 데이터 채우기
                const projectIdField = document.getElementById('editProjectId');
                const projectNameField = document.getElementById('editProjectName');
                const projectDescField = document.getElementById('editProjectDescription');
                const descriptionCount = document.getElementById('editDescriptionCount');
                const modal = document.getElementById('editProjectModal');
                
                if (projectIdField) projectIdField.value = projectId;
                if (projectNameField) projectNameField.value = project.name;
                if (projectDescField) {
                    projectDescField.value = project.description || '';
                    // 글자 수 카운터 업데이트
                    if (descriptionCount) {
                        const count = (project.description || '').length;
                        descriptionCount.textContent = count;
                        
                        // 색상 업데이트
                        if (count > 180) {
                            descriptionCount.style.color = '#ef4444';
                        } else if (count > 150) {
                            descriptionCount.style.color = '#f59e0b';
                        } else {
                            descriptionCount.style.color = '#6b7280';
                        }
                    }
                }
                
                // 색상 선택
                const colorRadio = document.querySelector(`#editProjectModal input[name="color"][value="${project.color}"]`);
                if (colorRadio) {
                    colorRadio.checked = true;
                }
                
                // 글자 수 카운터 이벤트 추가
                if (projectDescField && descriptionCount) {
                    // 기존 이벤트 리스너 제거
                    projectDescField.removeEventListener('input', handleDescriptionInput);
                    
                    // 새 이벤트 리스너 추가
                    const handleDescriptionInput = function() {
                        const count = this.value.length;
                        descriptionCount.textContent = count;
                        
                        if (count > 180) {
                            descriptionCount.style.color = '#ef4444';
                        } else if (count > 150) {
                            descriptionCount.style.color = '#f59e0b';
                        } else {
                            descriptionCount.style.color = '#6b7280';
                        }
                    };
                    
                    projectDescField.addEventListener('input', handleDescriptionInput);
                }
                
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // 키보드 이벤트 리스너 추가
                    const handleKeyDown = (e) => {
                        if (e.key === 'Escape') {
                            hideEditProjectModal();
                            document.removeEventListener('keydown', handleKeyDown);
                        }
                    };
                    document.addEventListener('keydown', handleKeyDown);
                    
                    // 첫 번째 입력 필드에 포커스
                    setTimeout(() => {
                        if (projectNameField) projectNameField.focus();
                    }, 100);
                }
                
            } catch (error) {
                console.error('프로젝트 수정 모달 열기 오류:', error);
                showNotification('프로젝트 수정 모달을 열 수 없습니다.', 'error');
            }
        }
        
        // 프로젝트 수정 모달 숨기기
        function hideEditProjectModal() {
            const modal = document.getElementById('editProjectModal');
            if (modal) {
                modal.style.display = 'none';
                
                // 글자 수 카운터 초기화
                const descriptionCount = document.getElementById('editDescriptionCount');
                if (descriptionCount) {
                    descriptionCount.textContent = '0';
                    descriptionCount.style.color = '#6b7280';
                }
                
                currentEditingProjectId = null;
                console.log('프로젝트 수정 모달이 닫혔습니다.');
            }
        }
        
        // ==================== 프로젝트 CRUD 기능 ====================
        
        // 프로젝트 생성
        async function createProject(event) {
            event.preventDefault();
            
            try {
                console.log('프로젝트 생성 시작');
                
                const formData = new FormData(event.target);
                const name = formData.get('name')?.trim();
                
                if (!name) {
                    showNotification('프로젝트 이름을 입력해주세요.', 'error');
                    return;
                }
                
                const projectData = {
                    id: 'project-' + Date.now(),
                    workspace_id: currentWorkspace?.id || 'demo-workspace',
                    name: name,
                    description: formData.get('description')?.trim() || '',
                    color: formData.get('color') || '#3b82f6',
                    created_by: currentUser?.id || 'demo-user',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                console.log('생성할 프로젝트 데이터:', projectData);
            
                if (typeof supabase !== 'undefined' && !isDemoMode) {
                    const { data, error } = await APIManager.insert('projects', projectData, {
                        select: '*',
                        errorMessage: '프로젝트 생성 실패'
                    });
                    
                    if (error) throw error;
                    
                    // 로컬 배열에 추가
                    projects.push(data[0]);
                    console.log('Supabase에 프로젝트 저장 완료');
                } else {
                    // 데모 모드: localStorage에 저장
                    projects.push(projectData);
                    localStorage.setItem('demo_projects', JSON.stringify(projects));
                    console.log('localStorage에 프로젝트 저장 완료');
                }
                
                // UI 업데이트
                if (typeof renderProjects === 'function') renderProjects();
                if (typeof updateProjectsPage === 'function') updateProjectsPage();
                if (typeof updateDashboard === 'function') updateDashboard();
                
                // 모달 닫기
                hideCreateProjectModal();
                
                ErrorManager.success(`프로젝트 "${projectData.name}"이 생성되었습니다.`);
                
            } catch (error) {
                ErrorManager.handleApiError(error, '프로젝트 생성');
            }
        }
        
        // 프로젝트 수정
        async function updateProject(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const projectId = formData.get('id');
            const projectIndex = projects.findIndex(p => p.id === projectId);
            
            if (projectIndex === -1) return;
            
            const updatedProject = {
                ...projects[projectIndex],
                name: formData.get('name').trim(),
                description: formData.get('description').trim(),
                color: formData.get('color'),
                updated_at: new Date().toISOString()
            };
            
            try {
                // Supabase 사용 시
                if (typeof supabase !== 'undefined' && !isDemoMode) {
                    const { error } = await APIManager.update('projects', updatedProject, 
                        { id: projectId }, 
                        { errorMessage: '프로젝트 수정 실패' }
                    );
                    
                    if (error) throw error;
                }
                
                // 로컬 데이터 업데이트
                projects[projectIndex] = updatedProject;
                localStorage.setItem('demo_projects', JSON.stringify(projects));
                
                // UI 업데이트
                renderProjects();
                updateProjectsPage();
                updateDashboard();
                
                // 모달 닫기
                hideEditProjectModal();
                
                showNotification(`프로젝트 "${updatedProject.name}"이 수정되었습니다.`);
                
            } catch (error) {
                ErrorManager.handleApiError(error, '프로젝트 수정');
            }
        }
        
        // 프로젝트 삭제 확인
        function confirmDeleteProject() {
            const project = projects.find(p => p.id === currentEditingProjectId);
            if (!project) return;
            
            const relatedTodos = todos.filter(t => t.project_id === currentEditingProjectId);
            const message = relatedTodos.length > 0 
                ? `정말로 "${project.name}" 프로젝트를 삭제하시겠습니까?\n관련된 ${relatedTodos.length}개의 할 일도 함께 삭제됩니다.`
                : `정말로 "${project.name}" 프로젝트를 삭제하시겠습니까?`;
            
            if (confirm(message)) {
                deleteProject(currentEditingProjectId);
            }
        }
        
        // 프로젝트 삭제
        async function deleteProject(projectId) {
            try {
                // Supabase 사용 시
                if (typeof supabase !== 'undefined' && !isDemoMode) {
                    // 관련 할 일들 먼저 삭제
                    const { error: todosError } = await APIManager.delete('todos', 
                        { project_id: projectId },
                        { errorMessage: '관련 할 일 삭제 실패' }
                    );
                    
                    if (todosError) throw todosError;
                    
                    // 프로젝트 삭제
                    const { error } = await APIManager.delete('projects', 
                        { id: projectId },
                        { errorMessage: '프로젝트 삭제 실패' }
                    );
                    
                    if (error) throw error;
                }
                
                // 로컬 데이터 업데이트
                const projectName = projects.find(p => p.id === projectId)?.name;
                projects = projects.filter(p => p.id !== projectId);
                todos = todos.filter(t => t.project_id !== projectId);
                
                localStorage.setItem('demo_projects', JSON.stringify(projects));
                localStorage.setItem('demo_todos', JSON.stringify(todos));
                
                // 선택된 프로젝트가 삭제된 경우 전체로 변경
                if (selectedProjectId === projectId) {
                    selectedProjectId = 'all';
                }
                
                // UI 업데이트
                renderProjects();
                renderTodos();
                updateProjectsPage();
                updateDashboard();
                
                // 모달 닫기
                hideEditProjectModal();
                
                showNotification(`프로젝트 "${projectName}"이 삭제되었습니다.`);
                
            } catch (error) {
                ErrorManager.handleApiError(error, '프로젝트 삭제');
            }
        }
        
        // ==================== 프로젝트 컨텍스트 메뉴 ====================
        
        // 프로젝트 우클릭 메뉴 표시
        function showProjectContextMenu(event, projectId) {
            event.preventDefault();
            
            // 기존 메뉴 제거
            const existingMenu = document.querySelector('.project-context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // 전체 프로젝트 탭은 메뉴 표시 안함
            if (projectId === 'all') return;
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // 메뉴 생성
            const menu = document.createElement('div');
            menu.className = 'project-context-menu';
            menu.innerHTML = `
                <div class="context-menu-item" onclick="showEditProjectModal('${projectId}'); hideProjectContextMenu()">
                    ✏️ 수정
                </div>
                <div class="context-menu-item" onclick="confirmDeleteProject('${projectId}'); hideProjectContextMenu()">
                    🗑️ 삭제
                </div>
            `;
            
            // 위치 계산
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.display = 'block';
            
            document.body.appendChild(menu);
            
            // 외부 클릭 시 메뉴 닫기
            setTimeout(() => {
                document.addEventListener('click', hideProjectContextMenu, { once: true });
            }, 100);
        }
        
        // 프로젝트 컨텍스트 메뉴 숨기기
        function hideProjectContextMenu() {
            const menu = document.querySelector('.project-context-menu');
            if (menu) {
                menu.remove();
            }
        }
        
        // 프로젝트 삭제 확인 (컨텍스트 메뉴용)
        function confirmDeleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const relatedTodos = todos.filter(t => t.project_id === projectId);
            const message = relatedTodos.length > 0 
                ? `정말로 "${project.name}" 프로젝트를 삭제하시겠습니까?\n관련된 ${relatedTodos.length}개의 할 일도 함께 삭제됩니다.`
                : `정말로 "${project.name}" 프로젝트를 삭제하시겠습니까?`;
            
            if (confirm(message)) {
                deleteProject(projectId);
            }
        }
        
        // 워크스페이스 렌더링
        function renderWorkspaces() {
            const workspaceList = document.getElementById('workspaceList');
            
            // DOM 요소 존재 확인
            if (!workspaceList) {
                console.warn('workspaceList 요소를 찾을 수 없습니다.');
                return;
            }
            
            if (workspaces.length === 0) {
                workspaceList.innerHTML = '<div style="text-align: center; color: #9ca3af; grid-column: 1/-1; padding: 50px;">워크스페이스가 없습니다. 새로 만들어보세요!</div>';
                return;
            }
            
            const workspacesHTML = workspaces.map(workspace => `
                <div class="workspace-card ${currentWorkspace?.id === workspace.id ? 'active' : ''}" onclick="selectWorkspace('${workspace.id}')">
                    <div class="workspace-name">${escapeHTML(workspace.name)}</div>
                    <div class="workspace-desc">${escapeHTML(workspace.description || '설명이 없습니다.')}</div>
                    <div class="workspace-meta">
                        <span>생성일: ${new Date(workspace.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
            
            workspaceList.innerHTML = workspacesHTML;
        }
        
        // 할 일 렌더링
        function renderTodos() {
            const todoList = document.getElementById('todoList');
            
            // DOM 요소 존재 확인
            if (!todoList) {
                console.warn('todoList 요소를 찾을 수 없습니다.');
                return;
            }
            
            if (todos.length === 0) {
                todoList.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 50px;">할 일이 없습니다. 새로 추가해보세요!</div>';
                return;
            }
            
            const todosHTML = todos.map(todo => `
                <div class="todo-item ${todo.priority} ${todo.status === 'completed' ? 'completed' : ''}">
                    <div class="todo-content">
                        <div class="todo-info">
                            <div class="todo-title">${escapeHTML(todo.title)}</div>
                            <div class="todo-meta">
                                <span>우선순위: ${getPriorityText(todo.priority)}</span>
                                <span>상태: ${getStatusText(todo.status)}</span>
                                ${todo.due_date ? `<span>마감일: ${new Date(todo.due_date).toLocaleDateString()}</span>` : ''}
                                <span>담당자: ${escapeHTML(todo.assigned_user?.full_name || '미지정')}</span>
                            </div>
                            ${todo.description ? `<div class="todo-description">${escapeHTML(todo.description)}</div>` : ''}
                        </div>
                        <div class="todo-actions">
                            ${todo.status !== 'completed' ? `<button class="btn-sm btn-complete" onclick="completeTodo('${todo.id}')">완료</button>` : ''}
                            <button class="btn-sm btn-delete" onclick="deleteTodo('${todo.id}')">삭제</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            todoList.innerHTML = todosHTML;
            
            // 통계 업데이트
            const totalTodos = todos.length;
            const completedTodos = todos.filter(t => t.status === 'completed').length;
            const completionRate = totalTodos > 0 ? Math.round((completedTodos / totalTodos) * 100) : 0;
            
            UIManager.updateStats({
                'totalTodos': totalTodos,
                'completedTodos': completedTodos,
                'completionRate': completionRate + '%'
            });
        }
        
        // 알림 렌더링
        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 50px;">알림이 없습니다.</div>';
                return;
            }
            
            const notificationsHTML = notifications.map(notif => `
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 8px;">${notif.title}</div>
                            <div style="color: #6b7280; margin-bottom: 10px;">${notif.message}</div>
                            <div style="font-size: 12px; color: #9ca3af;">${new Date(notif.created_at).toLocaleString()}</div>
                        </div>
                        ${!notif.is_read ? '<div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>' : ''}
                    </div>
                </div>
            `).join('');
            
            notificationList.innerHTML = notificationsHTML;
        }
        
        // ==================== 역할 및 탭 권한 관리 ====================
        
        // 역할 목록 로드
        async function loadRoles() {
            try {
                const systemRolesList = document.getElementById('systemRolesList');
                const customRolesList = document.getElementById('customRolesList');
                
                if (!systemRolesList || !customRolesList) return;
                
                systemRolesList.innerHTML = '<div class="loading-spinner">역할 정보를 불러오는 중...</div>';
                customRolesList.innerHTML = '';
                
                // 새 역할 생성 모달이 열려있다면 닫기
                closeCreateRoleModal();
                
                if (isDemoMode) {
                    // 데모 모드에서 샘플 역할 데이터 표시
                    setTimeout(() => {
                        renderRoles(getDemoRoles());
                    }, 500);
                } else {
                    // Supabase에서 역할 목록 가져오기
                    const { data, error } = await APIManager.rpc('get_all_roles', {}, {
                        errorMessage: '역할 목록 조회 실패'
                    });
                    if (error) throw error;
                    renderRoles(data);
                }
            } catch (error) {
                console.error('역할 목록 로드 오류:', error);
                const systemRolesList = document.getElementById('systemRolesList');
                if (systemRolesList) {
                    systemRolesList.innerHTML = `<div class="error-message">역할 정보를 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
                }
            }
        }
        
        // 역할 목록 렌더링
        function renderRoles(roles) {
            const systemRolesList = document.getElementById('systemRolesList');
            const customRolesList = document.getElementById('customRolesList');
            
            if (!systemRolesList || !customRolesList) return;
            
            systemRolesList.innerHTML = '';
            customRolesList.innerHTML = '';
            
            if (!roles || roles.length === 0) {
                systemRolesList.innerHTML = '<div class="empty-state">역할 정보가 없습니다.</div>';
                return;
            }
            
            // 시스템 역할과 커스텀 역할 분리
            const systemRoles = roles.filter(role => role.is_system);
            const customRoles = roles.filter(role => !role.is_system);
            
            // 시스템 역할 렌더링
            if (systemRoles.length === 0) {
                systemRolesList.innerHTML = '<div class="empty-state">시스템 역할 정보가 없습니다.</div>';
            } else {
                systemRoles.forEach(role => {
                    const roleItem = document.createElement('div');
                    roleItem.className = 'role-item';
                    roleItem.innerHTML = `
                        <div class="role-info">
                            <div class="role-name">${role.name}<span class="system-badge">시스템</span></div>
                            <div class="role-desc">${role.description || '설명 없음'}</div>
                        </div>
                        <div class="role-actions">
                            <button class="action-btn" onclick="showTabPermissions('${role.name}')" title="권한 관리">
                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    `;
                    systemRolesList.appendChild(roleItem);
                });
            }
            
            // 커스텀 역할 렌더링
            if (customRoles.length === 0) {
                customRolesList.innerHTML = '<div class="empty-state">생성된 커스텀 역할이 없습니다.</div>';
            } else {
                customRoles.forEach(role => {
                    const roleItem = document.createElement('div');
                    roleItem.className = 'role-item';
                    roleItem.innerHTML = `
                        <div class="role-info">
                            <div class="role-name">${role.name}</div>
                            <div class="role-desc">${role.description || '설명 없음'}</div>
                        </div>
                        <div class="role-actions">
                            <button class="action-btn" onclick="showTabPermissions('${role.name}')" title="권한 관리">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="openDeleteRoleModal('${role.name}')" title="역할 삭제">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    customRolesList.appendChild(roleItem);
                });
            }
        }
        
        // 데모용 역할 데이터
        function getDemoRoles() {
            return [
                {
                    id: 1,
                    name: 'super_admin',
                    description: '시스템 내 최고 권한을 가진 역할로, 모든 기능과 데이터에 접근할 수 있습니다.',
                    is_system: true
                },
                {
                    id: 2,
                    name: 'admin',
                    description: '일반 관리 기능을 수행할 수 있는 역할로, 사용자 관리 및 컨텐츠 관리 권한을 가집니다.',
                    is_system: true
                },
                {
                    id: 3,
                    name: 'user',
                    description: '기본적인 서비스 이용 권한을 가진 역할입니다.',
                    is_system: true
                },
                {
                    id: 4,
                    name: 'project_manager',
                    description: '프로젝트 및 팀 관리를 위한 특별 권한을 가진 역할입니다.',
                    is_system: false
                }
            ];
        }
        
        // 새 역할 생성 모달 표시
        function openCreateRoleModal() {
            const modal = document.getElementById('createRoleModal');
            if (modal) {
                // 입력 필드 초기화
                document.getElementById('roleNameInput').value = '';
                document.getElementById('roleDescInput').value = '';
                
                modal.style.display = 'flex';
            }
        }
        
        // 새 역할 생성 모달 닫기
        function closeCreateRoleModal() {
            const modal = document.getElementById('createRoleModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 새 커스텀 역할 생성
        async function createNewRole() {
            const roleName = document.getElementById('roleNameInput').value.trim();
            const roleDesc = document.getElementById('roleDescInput').value.trim();
            
            // 유효성 검사
            if (!roleName) {
                showNotification('역할 이름을 입력해주세요.', 'error');
                return;
            }
            
            // 영문 소문자, 숫자, 언더스코어만 허용
            if (!/^[a-z0-9_]+$/.test(roleName)) {
                showNotification('역할 이름은 영문 소문자, 숫자, 언더스코어(_)만 사용할 수 있습니다.', 'error');
                return;
            }
            
            try {
                showLoading();
                
                if (isDemoMode) {
                    // 데모 모드에서는 로컬 처리
                    setTimeout(() => {
                        // 이미 존재하는 역할인지 확인
                        const existingRoles = getDemoRoles();
                        if (existingRoles.some(r => r.name === roleName)) {
                            showNotification('이미 존재하는 역할 이름입니다.', 'error');
                            hideLoading();
                            return;
                        }
                        
                        // 새 역할 추가 (데모 데이터)
                        const newRole = {
                            id: Math.floor(Math.random() * 1000) + 10,
                            name: roleName,
                            description: roleDesc,
                            is_system: false
                        };
                        
                        // 데모 역할 목록에 추가
                        window.demoRoles = [...(window.demoRoles || getDemoRoles()), newRole];
                        
                        showNotification('새 역할이 생성되었습니다.', 'success');
                        closeCreateRoleModal();
                        loadRoles();
                        
                        // 권한 관리 탭에도 새 역할 추가
                        addRoleTabToPermissions(roleName);
                        
                        hideLoading();
                    }, 800);
                } else {
                    // Supabase API 호출
                    const { data, error } = await APIManager.rpc('create_custom_role', {
                        role_name: roleName,
                        role_description: roleDesc
                    }, {
                        errorMessage: '사용자 정의 역할 생성 실패'
                    });
                    
                    if (error) throw error;
                    
                    showNotification('새 역할이 생성되었습니다.', 'success');
                    closeCreateRoleModal();
                    loadRoles();
                    
                    // 권한 관리 탭에도 새 역할 추가
                    addRoleTabToPermissions(roleName);
                }
            } catch (error) {
                console.error('역할 생성 오류:', error);
                showNotification('역할 생성 중 오류가 발생했습니다: ' + error.message, 'error');
                hideLoading();
            }
        }
        
        // 권한 관리 탭에 새 역할 탭 추가
        function addRoleTabToPermissions(roleName) {
            const permRoleTabs = document.getElementById('permRoleTabs');
            if (!permRoleTabs) return;
            
            // 이미 있는지 확인
            if (document.querySelector(`.role-tab[onclick="showTabPermissions('${roleName}')"]`)) {
                return;
            }
            
            // 새 탭 버튼 생성
            const newTab = document.createElement('button');
            newTab.className = 'role-tab';
            newTab.setAttribute('onclick', `showTabPermissions('${roleName}')`);
            newTab.textContent = roleName;
            
            // 역할 설명 추가
            const roleDescContainer = document.querySelector('.role-description-container');
            if (roleDescContainer) {
                const roleDesc = document.createElement('div');
                roleDesc.id = `${roleName}_desc`;
                roleDesc.className = 'role-description';
                roleDesc.innerHTML = `
                    <h4>${roleName} 역할</h4>
                    <p>커스텀 역할입니다.</p>
                `;
                roleDescContainer.appendChild(roleDesc);
            }
            
            // 탭 영역에 추가
            permRoleTabs.appendChild(newTab);
        }
        
        // 역할 삭제 모달 표시
        function openDeleteRoleModal(roleName) {
            const modal = document.getElementById('deleteRoleModal');
            const roleNameSpan = document.getElementById('deleteRoleName');
            
            if (modal && roleNameSpan) {
                roleNameSpan.textContent = roleName;
                modal.setAttribute('data-role', roleName);
                modal.style.display = 'flex';
            }
        }
        
        // 역할 삭제 모달 닫기
        function closeDeleteRoleModal() {
            const modal = document.getElementById('deleteRoleModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 역할 삭제 확인
        async function confirmDeleteRole() {
            const modal = document.getElementById('deleteRoleModal');
            const roleName = modal.getAttribute('data-role');
            
            if (!roleName) {
                showNotification('삭제할 역할을 찾을 수 없습니다.', 'error');
                closeDeleteRoleModal();
                return;
            }
            
            try {
                showLoading();
                
                if (isDemoMode) {
                    // 데모 모드에서는 로컬 처리
                    setTimeout(() => {
                        // 사용자 중에 해당 역할을 가진 사용자가 있는지 확인
                        const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                        const usersWithRole = demoUsers.filter(user => user.global_role === roleName);
                        
                        if (usersWithRole.length > 0) {
                            showNotification(`현재 ${usersWithRole.length}명의 사용자가 이 역할을 사용 중입니다. 먼저 사용자 역할을 변경한 후 삭제해주세요.`, 'error');
                            hideLoading();
                            closeDeleteRoleModal();
                            return;
                        }
                        
                        // 데모 역할 목록에서 제거
                        window.demoRoles = (window.demoRoles || getDemoRoles()).filter(r => r.name !== roleName);
                        
                        // 로컬 스토리지에서 커스텀 권한 정보 제거
                        const storedCustomPermissions = localStorage.getItem('demo_custom_permissions');
                        if (storedCustomPermissions) {
                            try {
                                const customPermissions = JSON.parse(storedCustomPermissions);
                                if (customPermissions[roleName]) {
                                    delete customPermissions[roleName];
                                    localStorage.setItem('demo_custom_permissions', JSON.stringify(customPermissions));
                                }
                            } catch (e) {
                                console.error('커스텀 권한 정보 파싱 오류:', e);
                            }
                        }
                        
                        showNotification(`${roleName} 역할이 삭제되었습니다.`, 'success');
                        closeDeleteRoleModal();
                        loadRoles();
                        
                        // 권한 관리 탭에서도 제거
                        const roleTab = document.querySelector(`.role-tab[onclick="showTabPermissions('${roleName}')"]`);
                        if (roleTab) {
                            roleTab.remove();
                        }
                        
                        const roleDesc = document.getElementById(`${roleName}_desc`);
                        if (roleDesc) {
                            roleDesc.remove();
                        }
                        
                        // 기본 탭으로 돌아가기
                        showTabPermissions('super_admin');
                        
                        hideLoading();
                    }, 800);
                } else {
                    try {
                        // 먼저 해당 역할을 사용하는 사용자가 있는지 확인
                        const { data: usersWithRole, error: userCheckError } = await supabase
                            .from('users')
                            .select('id, full_name')
                            .eq('global_role', roleName);
                            
                        if (userCheckError) throw userCheckError;
                        
                        if (usersWithRole && usersWithRole.length > 0) {
                            showNotification(`현재 ${usersWithRole.length}명의 사용자가 이 역할을 사용 중입니다. 먼저 사용자 역할을 변경한 후 삭제해주세요.`, 'error');
                            hideLoading();
                            closeDeleteRoleModal();
                            return;
                        }
                        
                        // Supabase API 호출
                        const { data, error } = await APIManager.rpc('delete_custom_role', {
                            role_name: roleName
                        }, {
                            errorMessage: '사용자 정의 역할 삭제 실패'
                        });
                        
                        if (error) throw error;
                        
                        showNotification(`${roleName} 역할이 삭제되었습니다.`, 'success');
                        closeDeleteRoleModal();
                        loadRoles();
                        
                        // 권한 관리 탭에서도 제거
                        const roleTab = document.querySelector(`.role-tab[onclick="showTabPermissions('${roleName}')"]`);
                        if (roleTab) {
                            roleTab.remove();
                        }
                        
                        const roleDesc = document.getElementById(`${roleName}_desc`);
                        if (roleDesc) {
                            roleDesc.remove();
                        }
                        
                        // 기본 탭으로 돌아가기
                        showTabPermissions('super_admin');
                    } catch (apiError) {
                        console.error('역할 삭제 API 오류:', apiError);
                        if (apiError.message.includes('사용자에게 할당된 역할은 삭제할 수 없습니다')) {
                            showNotification('현재 사용자에게 할당된 역할은 삭제할 수 없습니다. 먼저 사용자 역할을 변경한 후 삭제해주세요.', 'error');
                        } else {
                            showNotification('역할 삭제 중 오류가 발생했습니다: ' + apiError.message, 'error');
                        }
                        closeDeleteRoleModal();
                    }
                }
            } catch (error) {
                console.error('역할 삭제 오류:', error);
                showNotification('역할 삭제 중 오류가 발생했습니다: ' + error.message, 'error');
                hideLoading();
            }
        }
        
        // 역할별 탭 권한 표시
        async function showTabPermissions(roleName) {
            try {
                // 역할 탭 활성화
                const roleTabs = document.querySelectorAll('.role-tab');
                roleTabs.forEach(tab => tab.classList.remove('active'));
                const activeRoleTab = document.querySelector(`.role-tab[onclick="showTabPermissions('${roleName}')"]`);
                if (activeRoleTab) activeRoleTab.classList.add('active');
                
                // 역할 설명 표시
                const roleDescriptions = document.querySelectorAll('.role-description');
                roleDescriptions.forEach(desc => desc.classList.remove('active'));
                const roleDesc = document.getElementById(`${roleName}_desc`);
                if (roleDesc) roleDesc.classList.add('active');
                
                // 탭 권한 목록 표시
                const tabPermissionsList = document.getElementById('tabPermissionsList');
                if (!tabPermissionsList) return;
                
                tabPermissionsList.innerHTML = '<div class="loading-spinner">권한 정보를 불러오는 중...</div>';
                
                if (isDemoMode) {
                    // 데모 모드에서는 샘플 데이터 표시
                    setTimeout(() => {
                        renderTabPermissions(roleName, getDemoTabPermissions(roleName));
                    }, 500);
                } else {
                    // Supabase에서 탭 권한 정보 가져오기
                    const { data, error } = await APIManager.rpc('get_role_tab_permissions', {
                        role_name: roleName
                    }, {
                        errorMessage: '역할 탭 권한 조회 실패'
                    });
                    
                    if (error) throw error;
                    renderTabPermissions(roleName, data);
                }
            } catch (error) {
                console.error('탭 권한 정보 로드 오류:', error);
                const tabPermissionsList = document.getElementById('tabPermissionsList');
                if (tabPermissionsList) {
                    tabPermissionsList.innerHTML = `<div class="error-message">권한 정보를 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
                }
            }
        }
        
        // 탭 권한 정보 렌더링
        function renderTabPermissions(roleName, permissions) {
            const tabPermissionsList = document.getElementById('tabPermissionsList');
            if (!tabPermissionsList) return;
            
            tabPermissionsList.innerHTML = '';
            
            if (!permissions || permissions.length === 0) {
                tabPermissionsList.innerHTML = '<div class="empty-state">탭 권한 정보가 없습니다.</div>';
                return;
            }
            
            // 탭 이름 매핑
            const tabNames = {
                'dashboard': '대시보드',
                'projects': '프로젝트',
                'todos': '할 일 관리',
                'calendar': '달력',
                'admin': '관리자'
            };
            
            // 권한 정보 정렬
            permissions.sort((a, b) => {
                // admin 탭은 항상 마지막에
                if (a.tab_id === 'admin') return 1;
                if (b.tab_id === 'admin') return -1;
                return tabNames[a.tab_id]?.localeCompare(tabNames[b.tab_id] || a.tab_id) || 0;
            });
            
            // 각 탭 권한 렌더링
            permissions.forEach(perm => {
                const tabName = tabNames[perm.tab_id] || perm.tab_id;
                const isDisabled = roleName === 'super_admin' && perm.tab_id === 'admin';
                
                const permItem = document.createElement('div');
                permItem.className = 'tab-permission-item';
                permItem.innerHTML = `
                    <div class="tab-permission-label">
                        ${tabName}
                        ${perm.tab_id === 'admin' ? '<small class="tab-permission-info">(관리자 기능)</small>' : ''}
                    </div>
                    <label class="tab-permission-toggle" ${isDisabled ? 'title="슈퍼관리자의 관리자 탭 권한은 변경할 수 없습니다"' : ''}>
                        <input type="checkbox" 
                               ${perm.can_access ? 'checked' : ''} 
                               onchange="updateTabPermission('${roleName}', '${perm.tab_id}', this.checked)"
                               ${isDisabled ? 'disabled' : ''}>
                        <span class="tab-permission-slider"></span>
                    </label>
                `;
                
                tabPermissionsList.appendChild(permItem);
            });
        }
        
        // 데모용 탭 권한 데이터
        function getDemoTabPermissions(roleName) {
            // 로컬 스토리지에서 저장된 커스텀 역할의 권한 정보 확인
            const storedCustomPermissions = localStorage.getItem('demo_custom_permissions');
            let customPermissions = {};
            
            if (storedCustomPermissions) {
                try {
                    customPermissions = JSON.parse(storedCustomPermissions);
                } catch (e) {
                    console.error('커스텀 권한 정보 파싱 오류:', e);
                }
            }
            
            // 기본 역할 권한 설정
            const defaultPermissions = {
                'super_admin': [
                    { tab_id: 'dashboard', can_access: true },
                    { tab_id: 'projects', can_access: true },
                    { tab_id: 'todos', can_access: true },
                    { tab_id: 'calendar', can_access: true },
                    { tab_id: 'admin', can_access: true }
                ],
                'admin': [
                    { tab_id: 'dashboard', can_access: true },
                    { tab_id: 'projects', can_access: true },
                    { tab_id: 'todos', can_access: true },
                    { tab_id: 'calendar', can_access: true },
                    { tab_id: 'admin', can_access: true }
                ],
                'user': [
                    { tab_id: 'dashboard', can_access: true },
                    { tab_id: 'projects', can_access: true },
                    { tab_id: 'todos', can_access: true },
                    { tab_id: 'calendar', can_access: true },
                    { tab_id: 'admin', can_access: false }
                ],
                'project_manager': [
                    { tab_id: 'dashboard', can_access: true },
                    { tab_id: 'projects', can_access: true },
                    { tab_id: 'todos', can_access: true },
                    { tab_id: 'calendar', can_access: true },
                    { tab_id: 'admin', can_access: false }
                ]
            };
            
            // 기본 설정과 커스텀 설정 병합
            const allPermissions = { ...defaultPermissions, ...customPermissions };
            
            // 해당 역할의 권한이 없는 경우 기본 권한 생성
            if (!allPermissions[roleName]) {
                allPermissions[roleName] = [
                    { tab_id: 'dashboard', can_access: true },
                    { tab_id: 'projects', can_access: true },
                    { tab_id: 'todos', can_access: true },
                    { tab_id: 'calendar', can_access: true },
                    { tab_id: 'admin', can_access: false }
                ];
                
                // 새 권한 정보 저장
                customPermissions[roleName] = allPermissions[roleName];
                localStorage.setItem('demo_custom_permissions', JSON.stringify(customPermissions));
            }
            
            return allPermissions[roleName] || [];
        }
        
        // 특정 탭의 접근 권한 설정
        async function updateTabPermission(roleName, tabId, canAccess) {
            try {
                showLoading();
                
                if (isDemoMode) {
                    // 데모 모드에서는 로컬에서 처리
                    setTimeout(() => {
                        // 특수 케이스: 슈퍼관리자의 관리자 탭 권한은 변경 불가
                        if (roleName === 'super_admin' && tabId === 'admin' && !canAccess) {
                            showNotification('슈퍼관리자의 관리자 탭 권한은 변경할 수 없습니다.', 'error');
                            showTabPermissions(roleName); // 원래 상태로 복구
                            hideLoading();
                            return;
                        }
                        
                        // 역할별 탭 권한 업데이트 (데모 데이터)
                        const permissions = getDemoTabPermissions(roleName);
                        const permIndex = permissions.findIndex(p => p.tab_id === tabId);
                        
                        if (permIndex !== -1) {
                            permissions[permIndex].can_access = canAccess;
                            
                            // 로컬 스토리지에 커스텀 권한 정보 저장
                            const storedCustomPermissions = localStorage.getItem('demo_custom_permissions');
                            let customPermissions = {};
                            
                            if (storedCustomPermissions) {
                                try {
                                    customPermissions = JSON.parse(storedCustomPermissions);
                                } catch (e) {
                                    console.error('커스텀 권한 정보 파싱 오류:', e);
                                }
                            }
                            
                            // 권한 정보 업데이트
                            customPermissions[roleName] = permissions;
                            localStorage.setItem('demo_custom_permissions', JSON.stringify(customPermissions));
                        }
                        
                        showNotification(`${roleName} 역할의 ${tabId} 탭 접근 권한이 ${canAccess ? '허용' : '차단'}되었습니다.`, 'success');
                        hideLoading();
                    }, 500);
                } else {
                    // Supabase API 호출
                    const { data, error } = await APIManager.rpc('update_role_tab_permission', {
                        role_name: roleName,
                        tab_id: tabId,
                        can_access: canAccess
                    }, {
                        errorMessage: '역할 탭 권한 업데이트 실패'
                    });
                    
                    if (error) throw error;
                    
                    showNotification(`${roleName} 역할의 ${tabId} 탭 접근 권한이 ${canAccess ? '허용' : '차단'}되었습니다.`, 'success');
                }
            } catch (error) {
                console.error('탭 권한 업데이트 오류:', error);
                showNotification('탭 권한 업데이트 중 오류가 발생했습니다: ' + error.message, 'error');
                // 오류 발생 시 원래 상태로 복구
                showTabPermissions(roleName);
            } finally {
                hideLoading();
            }
        }
        
        // ==================== 작업 요청 관리 시스템 ====================
        
        let currentReviewRequestId = null;
        
        // 작업 요청 목록 로드 (최적화된 버전)
        async function loadActionRequests() {
            const actionRequestsList = document.getElementById('actionRequestsList');
            const actionRequestsCount = document.getElementById('actionRequestsCount');
            
            if (!actionRequestsList || !actionRequestsCount) return;
            
            actionRequestsList.innerHTML = '<div class="loading-spinner">작업 요청을 불러오는 중...</div>';
            
            const statusFilter = document.getElementById('actionRequestStatusFilter').value;
            const typeFilter = document.getElementById('actionTypeFilter').value;
            
            try {
                if (isDemoMode) {
                    // 데모 모드에서는 샘플 작업 요청 데이터 표시
                    setTimeout(() => {
                        const demoRequests = getDemoActionRequests();
                        const filteredRequests = demoRequests.filter(req => {
                            const statusMatch = statusFilter === 'all' || req.status === statusFilter;
                            const typeMatch = typeFilter === 'all' || req.action_type === typeFilter;
                            return statusMatch && typeMatch;
                        });
                        renderActionRequests(filteredRequests);
                        actionRequestsCount.textContent = `${filteredRequests.length}개`;
                    }, 500);
                } else {
                    // 안정적인 Supabase 요청 사용
                    await executeSupabaseRequest(async (supabase) => {
                        // 데이터베이스에서 요청 정보 가져오기
                        let { data, error } = await APIManager.rpc('get_pending_action_requests', {}, {
                            errorMessage: '대기 중인 작업 요청 조회 실패'
                        });
                        
                        if (error) throw error;
                        
                        let filteredRequests = data || [];
                        
                        // 클라이언트 측 필터링 적용
                        if (statusFilter !== 'all' || typeFilter !== 'all') {
                            filteredRequests = filteredRequests.filter(req => {
                                const statusMatch = statusFilter === 'all' || req.status === statusFilter;
                                const typeMatch = typeFilter === 'all' || req.action_type === typeFilter;
                                return statusMatch && typeMatch;
                            });
                        }
                        
                        renderActionRequests(filteredRequests);
                        actionRequestsCount.textContent = `${filteredRequests.length}개`;
                        
                        return { data: filteredRequests };
                    }, '작업 요청 목록을 로드하는 중 오류가 발생했습니다');
                }
            } catch (error) {
                console.error('작업 요청 목록 로드 오류:', error);
                // 사용자에게 더 명확한 오류 메시지 제공
                actionRequestsList.innerHTML = `
                    <div class="error-message">
                        <p>작업 요청을 불러오는 중 오류가 발생했습니다.</p>
                        <p>오류 내용: ${error.message || '알 수 없는 오류'}</p>
                        <button class="retry-btn" onclick="loadActionRequests()">다시 시도</button>
                    </div>
                `;
                actionRequestsCount.textContent = '0개';
            }
        }
        
        // 작업 요청 목록 렌더링
        function renderActionRequests(requests) {
            const actionRequestsList = document.getElementById('actionRequestsList');
            if (!actionRequestsList) return;
            
            actionRequestsList.innerHTML = '';
            
            if (!requests || requests.length === 0) {
                actionRequestsList.innerHTML = '<div class="empty-state">표시할 작업 요청이 없습니다.</div>';
                return;
            }
            
            const actionTypeNames = {
                'approve': '사용자 승인',
                'reject': '사용자 거부', 
                'suspend': '계정 정지',
                'promote': '관리자 승격',
                'demote': '관리자 해제',
                'change_role': '역할 변경'
            };
            
            const statusNames = {
                'pending': '대기 중',
                'approved': '승인됨',
                'rejected': '거부됨',
                'cancelled': '취소됨'
            };
            
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('ko-KR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            requests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = `action-request-item status-${request.status}`;
                
                let actionDetails = '';
                if (request.action_type === 'change_role' && request.action_details?.new_role) {
                    actionDetails = ` → ${request.action_details.new_role}`;
                }
                
                requestItem.innerHTML = `
                    <div class="action-request-info">
                        <div class="action-request-header">
                            <span class="action-type-badge ${request.action_type}">${actionTypeNames[request.action_type] || request.action_type}${actionDetails}</span>
                            <span class="action-status-badge ${request.status}">${statusNames[request.status]}</span>
                        </div>
                        <div class="action-request-details">
                            <div class="target-user">
                                <strong>대상 사용자:</strong> ${request.target_user_name} (${request.target_user_email})
                            </div>
                            <div class="requested-by">
                                <strong>요청자:</strong> ${request.requested_by_name}
                            </div>
                            <div class="requested-at">
                                <strong>요청 시간:</strong> ${formatDate(request.requested_at)}
                            </div>
                            ${request.reason ? `<div class="request-reason"><strong>사유:</strong> ${request.reason}</div>` : ''}
                        </div>
                    </div>
                    <div class="action-request-actions">
                        ${request.status === 'pending' && (currentUser.app_metadata?.global_role === 'super_admin') ? 
                            `<button class="action-btn" onclick="openReviewActionModal(${request.request_id})">검토</button>` : 
                            '<span class="muted-text">-</span>'
                        }
                    </div>
                `;
                
                actionRequestsList.appendChild(requestItem);
            });
        }
        
        // 데모용 작업 요청 데이터 - 로컬 스토리지 지원 추가
        function getDemoActionRequests() {
            // 로컬 스토리지에서 저장된 요청이 있는지 확인
            const storedRequests = localStorage.getItem('demo_action_requests');
            
            // 기본 데모 요청 데이터
            const defaultRequests = [
                {
                    request_id: 1,
                    target_user_id: 'demo-user-2',
                    target_user_name: '김사용자',
                    target_user_email: 'user1@example.com',
                    requested_by_name: '정관리',
                    action_type: 'promote',
                    reason: '프로젝트 관리 업무를 위해 관리자 권한이 필요합니다.',
                    status: 'pending',
                    requested_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
                },
                {
                    request_id: 2,
                    target_user_id: 'demo-user-3',
                    target_user_name: '이승인',
                    target_user_email: 'user2@example.com',
                    requested_by_name: '정관리',
                    action_type: 'suspend',
                    reason: '부적절한 활동으로 인한 임시 정지 요청',
                    status: 'pending',
                    requested_at: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString()
                },
                {
                    request_id: 3,
                    target_user_id: 'demo-user-4',
                    target_user_name: '박거부',
                    target_user_email: 'user3@example.com',
                    requested_by_name: '정관리',
                    action_type: 'change_role',
                    action_details: { new_role: 'project_manager' },
                    reason: '프로젝트 매니저 역할 변경 요청',
                    status: 'approved',
                    requested_at: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
                }
            ];
            
            try {
                // 로컬 스토리지에 저장된 데이터가 있으면 사용
                if (storedRequests) {
                    const parsedRequests = JSON.parse(storedRequests);
                    
                    // 유효성 검사
                    if (Array.isArray(parsedRequests) && parsedRequests.length > 0) {
                        // 최신 5개 항목으로 제한하여 로컬 스토리지 크기 관리
                        const sortedRequests = parsedRequests.sort((a, b) => 
                            new Date(b.requested_at) - new Date(a.requested_at)
                        ).slice(0, 20);
                        
                        // 기본 요청과 병합
                        return [...defaultRequests, ...sortedRequests];
                    }
                }
            } catch (error) {
                console.error('데모 작업 요청 데이터 로드 오류:', error);
                // 오류 발생 시 기본 데이터 사용
            }
            
            return defaultRequests;
        }
        
        // 사용자 작업 요청 생성 (일반 관리자용) - 최적화 버전
        async function requestUserAction(userId, actionType, reason = '') {
            // 입력 유효성 검사 추가
            if (!userId || !actionType) {
                showNotification('필수 정보가 누락되었습니다: 사용자 ID와 작업 유형이 필요합니다.', 'error');
                return;
            }
            
            try {
                showLoading();
                
                if (isDemoMode) {
                    // 데모 모드에서는 로컬 처리
                    setTimeout(() => {
                        try {
                            // 데모 모드에서도 유효성 검사 추가
                            const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                            const targetUser = demoUsers.find(user => user.id === userId);
                            
                            if (!targetUser) {
                                throw new Error('대상 사용자를 찾을 수 없습니다.');
                            }
                            
                            // 데모 작업 요청 생성
                            const demoRequests = getDemoActionRequests();
                            const newRequest = {
                                request_id: Math.floor(Math.random() * 1000) + 100,
                                target_user_id: userId,
                                target_user_name: targetUser.full_name || '사용자',
                                target_user_email: targetUser.email || 'user@example.com',
                                requested_by_name: currentUser.app_metadata?.full_name || '관리자',
                                action_type: actionType,
                                reason: reason,
                                status: 'pending',
                                requested_at: new Date().toISOString()
                            };
                            
                            // 로컬 스토리지에 저장
                            const storedRequests = JSON.parse(localStorage.getItem('demo_action_requests') || '[]');
                            storedRequests.push(newRequest);
                            localStorage.setItem('demo_action_requests', JSON.stringify(storedRequests));
                            
                            showNotification('작업 요청이 생성되었습니다. 슈퍼관리자의 승인을 기다리고 있습니다.', 'success');
                            
                            // 작업 요청 목록 새로고침
                            loadActionRequests();
                        } catch (demoError) {
                            console.error('데모 모드 작업 요청 생성 오류:', demoError);
                            showNotification('작업 요청 생성 중 오류가 발생했습니다: ' + demoError.message, 'error');
                        }
                        hideLoading();
                    }, 800);
                } else {
                    // 안정적인 Supabase 요청 사용
                    await executeSupabaseRequest(async (supabase) => {
                        // 먼저 대상 사용자가 존재하는지 확인
                        const { data: userData, error: userError } = await supabase
                            .from('users')
                            .select('id, full_name, email')
                            .eq('id', userId)
                            .single();
                            
                        if (userError) throw userError;
                        
                        if (!userData) {
                            throw new Error('대상 사용자를 찾을 수 없습니다.');
                        }
                        
                        // 중복 요청 확인 (같은 사용자에 대해 같은 유형의 대기 중인 요청이 있는지)
                        const { data: existingRequests, error: checkError } = await supabase
                            .from('user_action_requests')
                            .select('id')
                            .eq('target_user_id', userId)
                            .eq('action_type', actionType)
                            .eq('status', 'pending');
                            
                        if (checkError) throw checkError;
                        
                        if (existingRequests && existingRequests.length > 0) {
                            throw new Error('동일한 사용자에 대한 같은 유형의 작업 요청이 이미 대기 중입니다.');
                        }
                        
                        // 작업 요청 생성
                        const { data, error } = await APIManager.rpc('create_user_action_request', {
                            p_target_user_id: userId,
                            p_action_type: actionType,
                            p_action_details: {},
                            p_reason: reason
                        }, {
                            errorMessage: '사용자 작업 요청 생성 실패'
                        });
                        
                        if (error) throw error;
                        
                        showNotification('작업 요청이 생성되었습니다. 슈퍼관리자의 승인을 기다리고 있습니다.', 'success');
                        
                        // 작업 요청 목록 새로고침
                        loadActionRequests();
                        
                        return { data };
                    }, '작업 요청 생성 중 오류가 발생했습니다');
                }
            } catch (error) {
                console.error('작업 요청 생성 오류:', error);
                // 사용자에게 더 자세한 오류 정보 제공
                showNotification(
                    '작업 요청 생성 중 오류가 발생했습니다: ' + 
                    (error.details || error.message || '알 수 없는 오류'), 
                    'error'
                );
            } finally {
                hideLoading();
            }
        }
        
        // 사용자 작업 직접 실행 (슈퍼관리자용)
        async function executeUserAction(userId, actionType) {
            try {
                showLoading();
                
                // 기존 함수들 호출 (즉시 실행)
                switch(actionType) {
                    case 'approve':
                        await approveUser(userId);
                        break;
                    case 'reject':
                        await rejectUser(userId);
                        break;
                    case 'suspend':
                        await suspendUser(userId);
                        break;
                    case 'promote':
                        await promoteUser(userId);
                        break;
                    case 'demote':
                        await demoteUser(userId);
                        break;
                }
            } catch (error) {
                console.error('작업 실행 오류:', error);
                showNotification('작업 실행 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // 작업 요청 검토 모달 열기
        function openReviewActionModal(requestId) {
            currentReviewRequestId = requestId;
            const modal = document.getElementById('reviewActionModal');
            const detailsDiv = document.getElementById('reviewActionDetails');
            
            if (!modal || !detailsDiv) return;
            
            // 요청 상세 정보 표시
            const requests = getDemoActionRequests();
            const request = requests.find(r => r.request_id === requestId);
            
            if (request) {
                const actionTypeNames = {
                    'approve': '사용자 승인',
                    'reject': '사용자 거부',
                    'suspend': '계정 정지',
                    'promote': '관리자 승격',
                    'demote': '관리자 해제',
                    'change_role': '역할 변경'
                };
                
                detailsDiv.innerHTML = `
                    <div class="review-details">
                        <h4>요청 정보</h4>
                        <p><strong>작업 유형:</strong> ${actionTypeNames[request.action_type]}</p>
                        <p><strong>대상 사용자:</strong> ${request.target_user_name} (${request.target_user_email})</p>
                        <p><strong>요청자:</strong> ${request.requested_by_name}</p>
                        <p><strong>요청 시간:</strong> ${new Date(request.requested_at).toLocaleString('ko-KR')}</p>
                        ${request.reason ? `<p><strong>요청 사유:</strong> ${request.reason}</p>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('reviewNotes').value = '';
            modal.style.display = 'flex';
        }
        
        // 작업 요청 검토 모달 닫기
        function closeReviewActionModal() {
            const modal = document.getElementById('reviewActionModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentReviewRequestId = null;
        }
        
        // 작업 요청 검토 (승인/거부) - 최적화 및 오류 처리 개선
        async function reviewAction(decision) {
            if (!currentReviewRequestId) {
                showNotification('검토할 요청을 찾을 수 없습니다.', 'error');
                return;
            }
            
            const reviewNotes = document.getElementById('reviewNotes').value.trim();
            
            try {
                showLoading();
                
                if (isDemoMode) {
                    // 데모 모드에서는 로컬 처리
                    setTimeout(() => {
                        try {
                            // 데모 모드에서도 오류 처리 추가
                            const demoRequests = getDemoActionRequests();
                            const targetRequest = demoRequests.find(req => req.request_id === currentReviewRequestId);
                            
                            if (!targetRequest) {
                                throw new Error('요청을 찾을 수 없습니다.');
                            }
                            
                            // 요청 상태 업데이트 (로컬 스토리지)
                            targetRequest.status = decision;
                            targetRequest.review_notes = reviewNotes;
                            
                            const message = decision === 'approved' ? '요청이 승인되고 작업이 완료되었습니다.' : '요청이 거부되었습니다.';
                            showNotification(message, decision === 'approved' ? 'success' : 'info');
                            closeReviewActionModal();
                            loadActionRequests();
                        } catch (demoError) {
                            console.error('데모 모드 작업 요청 검토 오류:', demoError);
                            showNotification('요청 처리 중 오류가 발생했습니다: ' + demoError.message, 'error');
                        }
                        hideLoading();
                    }, 800);
                } else {
                    // 안정적인 Supabase 요청 사용
                    await executeSupabaseRequest(async (supabase) => {
                        // 먼저 요청이 여전히 존재하고 대기 상태인지 확인
                        const { data: checkData, error: checkError } = await supabase
                            .from('user_action_requests')
                            .select('id, status')
                            .eq('id', currentReviewRequestId)
                            .single();
                            
                        if (checkError) throw checkError;
                        
                        if (!checkData) {
                            throw new Error('요청을 찾을 수 없습니다.');
                        }
                        
                        if (checkData.status !== 'pending') {
                            throw new Error('이미 처리된 요청입니다.');
                        }
                        
                        // 요청 검토 API 호출
                        const { data, error } = await APIManager.rpc('review_user_action_request', {
                            p_request_id: currentReviewRequestId,
                            p_decision: decision,
                            p_review_notes: reviewNotes
                        }, {
                            errorMessage: '사용자 작업 요청 검토 실패'
                        });
                        
                        if (error) throw error;
                        
                        const successMessage = data?.[0]?.message || 
                            (decision === 'approved' ? '요청이 승인되었습니다.' : '요청이 거부되었습니다.');
                            
                        showNotification(successMessage, decision === 'approved' ? 'success' : 'info');
                        
                        // 성공적인 검토 후 UI 업데이트
                        closeReviewActionModal();
                        
                        // 데이터 새로고침
                        await Promise.all([
                            loadActionRequests(),
                            loadUsers() // 사용자 목록도 새로고침
                        ]);
                        
                        return { data };
                    }, '작업 요청 검토 중 오류가 발생했습니다');
                }
            } catch (error) {
                console.error('작업 요청 검토 오류:', error);
                // 추가 오류 세부 정보 표시
                showNotification(
                    '작업 요청 검토 중 오류가 발생했습니다: ' + 
                    (error.details || error.message || '알 수 없는 오류'),
                    'error'
                );
            } finally {
                hideLoading();
            }
        }
        
        // 역할 변경 모달 (추후 구현)
        function openChangeRoleModal(userId, currentRole) {
            // TODO: 역할 변경 모달 구현
            showNotification('역할 변경 기능은 개발 중입니다.', 'info');
        }
        
        // ==================== 관리자 기능 ====================
        
        // 관리자 탭 변경
        function showAdminTab(tabName) {
            // 모든 모달 닫기 (특히 역할 생성 모달)
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // 모든 탭 내용 숨기기
            const tabContents = document.querySelectorAll('.admin-tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // 모든 탭 버튼 비활성화
            const tabButtons = document.querySelectorAll('.admin-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // 선택한 탭 내용 표시
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 선택한 탭 버튼 활성화
            const activeButton = document.querySelector(`.admin-tab[onclick="showAdminTab('${tabName}')"]`);
            if (activeButton) activeButton.classList.add('active');
            
            // 특정 탭에 따른 추가 작업
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'approvals') {
                loadApprovals();
            } else if (tabName === 'logs') {
                loadAdminLogs();
            } else if (tabName === 'action-requests') {
                // 작업 요청 목록 로드
                loadActionRequests();
            } else if (tabName === 'permissions') {
                // 기본적으로 슈퍼관리자 탭 권한 표시
                showTabPermissions('super_admin');
            } else if (tabName === 'roles') {
                // 역할 목록 로드
                loadRoles();
            }
        }
        
        // 사용자 목록 로드 (Supabase 연동)
        async function loadUsers() {
            try {
                showLoading();
                
                const tableBody = document.getElementById('usersTableBody');
                if (!tableBody) return;
                
                // 테이블 초기화
                tableBody.innerHTML = '';
                
                // 현재 필터 상태 가져오기
                const statusFilter = document.getElementById('userStatusFilter').value;
                const roleFilter = document.getElementById('userRoleFilter').value;
                
                // 데모 사용자 데이터 로드
                let users = [];
                
                if (isDemoMode) {
                    users = JSON.parse(localStorage.getItem('demo_users') || '[]');
                    
                    // 필터링
                    const filteredUsers = users.filter(user => {
                        const statusMatch = statusFilter === 'all' || user.account_status === statusFilter;
                        const roleMatch = roleFilter === 'all' || user.global_role === roleFilter;
                        return statusMatch && roleMatch;
                    });
                    
                    renderUserTable(filteredUsers, tableBody);
                } else {
                    // Supabase에서 사용자 데이터 로드 - 안정적인 요청 함수 사용
                    await executeSupabaseRequest(async (supabase) => {
                        let query = supabase.from('users')
                            .select(`
                                id, 
                                email, 
                                full_name,
                                display_name,
                                avatar_url,
                                created_at,
                                account_status,
                                global_role,
                                approved_at,
                                approved_by (
                                    id,
                                    full_name,
                                    email
                                )
                            `);
                        
                        // 필터 적용
                        if (statusFilter !== 'all') {
                            query = query.eq('account_status', statusFilter);
                        }
                        
                        if (roleFilter !== 'all') {
                            query = query.eq('global_role', roleFilter);
                        }
                        
                        // 데이터 가져오기
                        const { data, error } = await query;
                        
                        if (error) throw error;
                        
                        if (data && data.length > 0) {
                            renderUserTable(data, tableBody);
                        } else {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="7" class="empty-state">표시할 사용자가 없습니다.</td>
                                </tr>
                            `;
                        }
                        
                        return { data, error };
                    }, '사용자 목록을 로드하는 중 오류가 발생했습니다');
                }
            } catch (error) {
                console.error('사용자 목록 로드 오류:', error);
                // 오류 알림은 이미 executeSupabaseRequest 내에서 처리됨
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="error-state">사용자 목록을 불러오는 중 오류가 발생했습니다. 새로고침 후 다시 시도해주세요.</td>
                    </tr>
                `;
            } finally {
                hideLoading();
            }
        }
        
        // 사용자 테이블 렌더링 (공통 함수)
        function renderUserTable(users, tableBody) {
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">표시할 사용자가 없습니다.</td>
                    </tr>
                `;
                return;
            }
            
            // 날짜 포맷팅 함수
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('ko-KR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit'
                });
            };
            
            // 사용자 상태에 따른 클래스 및 텍스트
            const getStatusBadge = (status) => {
                const statusMap = {
                    'pending': '승인 대기',
                    'approved': '승인됨',
                    'rejected': '거부됨',
                    'suspended': '정지됨'
                };
                
                return `<span class="user-status ${status}">${statusMap[status] || status}</span>`;
            };
            
            // 사용자 역할에 따른 클래스 및 텍스트
            const getRoleBadge = (role) => {
                const roleMap = {
                    'super_admin': '슈퍼 관리자',
                    'admin': '관리자',
                    'user': '일반 사용자'
                };
                
                return `<span class="user-role ${role}">${roleMap[role] || role}</span>`;
            };
            
            // 작업 버튼 생성 (요청 기반 시스템)
            const getActionButtons = (user) => {
                if (user.id === currentUser.id) {
                    return '<span class="muted-text">현재 사용자</span>';
                }
                
                const currentUserRole = currentUser.app_metadata?.global_role || 'user';
                let buttons = '';
                
                // 슈퍼관리자는 직접 작업 실행, 일반 관리자는 요청 생성
                const isDirectAction = currentUserRole === 'super_admin';
                const actionPrefix = isDirectAction ? 'execute' : 'request';
                
                switch(user.account_status) {
                    case 'pending':
                        buttons += `<button class="action-btn approve-btn" onclick="${actionPrefix}UserAction('${user.id}', 'approve')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12l2 2 4-4M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            승인${isDirectAction ? '' : ' 요청'}
                        </button>`;
                        buttons += `<button class="action-btn reject-btn" onclick="${actionPrefix}UserAction('${user.id}', 'reject')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            거부${isDirectAction ? '' : ' 요청'}
                        </button>`;
                        break;
                    case 'approved':
                        if (user.global_role === 'user') {
                            buttons += `<button class="action-btn promote-btn" onclick="${actionPrefix}UserAction('${user.id}', 'promote')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                관리자로 승격${isDirectAction ? '' : ' 요청'}
                            </button>`;
                        } else if (user.global_role === 'admin') {
                            buttons += `<button class="action-btn" onclick="${actionPrefix}UserAction('${user.id}', 'demote')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                관리자 해제${isDirectAction ? '' : ' 요청'}
                            </button>`;
                        }
                        buttons += `<button class="action-btn suspend-btn" onclick="${actionPrefix}UserAction('${user.id}', 'suspend')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15V12M12 9h.01M3 12a9 9 0 1 0 18 0 9 9 0 0 0-18 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            계정 정지${isDirectAction ? '' : ' 요청'}
                        </button>`;
                        break;
                    case 'rejected':
                        buttons += `<button class="action-btn approve-btn" onclick="${actionPrefix}UserAction('${user.id}', 'approve')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12l2 2 4-4M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            승인으로 변경${isDirectAction ? '' : ' 요청'}
                        </button>`;
                        break;
                    case 'suspended':
                        buttons += `<button class="action-btn approve-btn" onclick="${actionPrefix}UserAction('${user.id}', 'approve')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            정지 해제${isDirectAction ? '' : ' 요청'}
                        </button>`;
                        break;
                }
                
                // 역할 변경 버튼 (커스텀 역할 지원)
                if (user.account_status === 'approved') {
                    buttons += `<button class="action-btn" onclick="openChangeRoleModal('${user.id}', '${user.global_role}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        역할 변경${isDirectAction ? '' : ' 요청'}
                    </button>`;
                }
                
                return buttons;
            };
            
            // 사용자 목록 표시
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.display_name || user.full_name || user.email.split('@')[0]}</td>
                    <td>${user.email}</td>
                    <td>${getRoleBadge(user.global_role)}</td>
                    <td>${getStatusBadge(user.account_status)}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${user.approved_at ? formatDate(user.approved_at) : '-'}</td>
                    <td class="action-cell">${getActionButtons(user)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 승인 대기 목록 로드
        function loadApprovals() {
            const approvalsList = document.getElementById('pendingRequests');
            const pendingCountBadge = document.getElementById('pendingCount');
            
            if (!approvalsList || !pendingCountBadge) return;
            
            // 목록 초기화
            approvalsList.innerHTML = '';
            
            // 데모 사용자 데이터 로드
            let users = [];
            
            if (isDemoMode) {
                users = JSON.parse(localStorage.getItem('demo_users') || '[]');
            } else {
                // Supabase에서 사용자 데이터 로드 (실제 구현 시)
                console.log('실제 Supabase 사용자 로드 (미구현)');
                return;
            }
            
            // 승인 대기 중인 사용자만 필터링
            const pendingUsers = users.filter(user => user.account_status === 'pending');
            
            // 대기 중인 사용자 수 표시
            pendingCountBadge.textContent = `${pendingUsers.length}명`;
            
            if (pendingUsers.length === 0) {
                approvalsList.innerHTML = '<div class="empty-state">승인 대기 중인 요청이 없습니다.</div>';
                return;
            }
            
            // 승인 대기 목록 표시
            pendingUsers.forEach(user => {
                const requestItem = document.createElement('div');
                requestItem.className = 'approval-request-item';
                
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ko-KR', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                requestItem.innerHTML = `
                    <div class="approval-request-info">
                        <div class="approval-request-user">
                            <div class="approval-user-avatar">${user.full_name.charAt(0)}</div>
                            <div class="approval-user-details">
                                <div class="approval-user-name">${user.full_name}</div>
                                <div class="approval-user-email">${user.email}</div>
                            </div>
                        </div>
                        <div class="approval-request-time">요청일: ${formatDate(user.created_at)}</div>
                    </div>
                    <div class="approval-request-actions">
                        <button class="action-btn approve-btn" onclick="approveUser('${user.id}')">승인</button>
                        <button class="action-btn reject-btn" onclick="rejectUser('${user.id}')">거부</button>
                    </div>
                `;
                
                approvalsList.appendChild(requestItem);
            });
        }
        
        // 역할별 권한 표시
        async function showRolePermissions(roleName) {
            // 역할 탭 활성화
            const roleTabs = document.querySelectorAll('.role-tab');
            roleTabs.forEach(tab => tab.classList.remove('active'));
            const activeRoleTab = document.querySelector(`.role-tab[onclick="showRolePermissions('${roleName}')"]`);
            if (activeRoleTab) activeRoleTab.classList.add('active');
            
            // 역할 설명 표시
            const roleDescriptions = document.querySelectorAll('.role-description');
            roleDescriptions.forEach(desc => desc.classList.remove('active'));
            const roleDesc = document.getElementById(`${roleName}_desc`);
            if (roleDesc) roleDesc.classList.add('active');
            
            // 권한 목록 표시
            const permissionsList = document.getElementById('permissionsList');
            permissionsList.innerHTML = '<div class="loading-spinner">권한 정보를 불러오는 중...</div>';
            
            try {
                // 권한 정보 가져오기
                if (isDemoMode) {
                    // 데모 모드에서는 샘플 데이터 사용
                    showDemoPermissions(roleName);
                } else {
                    // Supabase에서 권한 정보 가져오기
                    const { data, error } = await APIManager.rpc('get_role_permissions', { 
                        role_name: roleName 
                    }, {
                        errorMessage: '역할 권한 조회 실패'
                    });
                    if (error) throw error;
                    renderPermissions(data);
                }
            } catch (error) {
                console.error('권한 정보 로드 오류:', error);
                permissionsList.innerHTML = `<div class="error-message">권한 정보를 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        }
        
        // 권한 정보 렌더링
        function renderPermissions(permissions) {
            const permissionsList = document.getElementById('permissionsList');
            permissionsList.innerHTML = '';
            
            if (!permissions || permissions.length === 0) {
                permissionsList.innerHTML = '<div class="empty-state">이 역할에 할당된 권한이 없습니다.</div>';
                return;
            }
            
            // 카테고리별로 그룹화
            const groupedPermissions = {};
            permissions.forEach(perm => {
                if (!groupedPermissions[perm.permission_category]) {
                    groupedPermissions[perm.permission_category] = [];
                }
                groupedPermissions[perm.permission_category].push(perm);
            });
            
            // 카테고리별 권한 렌더링
            Object.keys(groupedPermissions).sort().forEach(category => {
                const categoryTitle = document.createElement('h5');
                categoryTitle.className = 'permission-category';
                categoryTitle.textContent = category;
                permissionsList.appendChild(categoryTitle);
                
                const categoryPerms = groupedPermissions[category];
                categoryPerms.forEach(perm => {
                    const permItem = document.createElement('div');
                    permItem.className = 'permission-item';
                    permItem.title = perm.permission_description || perm.permission_name;
                    permItem.textContent = perm.permission_name;
                    permissionsList.appendChild(permItem);
                });
            });
        }
        
        // 데모 모드에서 권한 정보 표시
        function showDemoPermissions(roleName) {
            const demoPermissions = {
                'super_admin': [
                    // 사용자 관리 권한
                    {permission_code: 'user:view', permission_name: '사용자 조회', permission_description: '사용자 정보를 조회할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:create', permission_name: '사용자 생성', permission_description: '새로운 사용자를 생성할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:update', permission_name: '사용자 수정', permission_description: '사용자 정보를 수정할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:delete', permission_name: '사용자 삭제', permission_description: '사용자를 삭제할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:approve', permission_name: '사용자 승인', permission_description: '사용자 계정을 승인할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:reject', permission_name: '사용자 거부', permission_description: '사용자 가입 요청을 거부할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:suspend', permission_name: '사용자 정지', permission_description: '사용자 계정을 정지할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:promote', permission_name: '사용자 승격', permission_description: '사용자를 관리자로 승격할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:view_all', permission_name: '모든 사용자 조회', permission_description: '시스템의 모든 사용자를 조회할 수 있는 권한', permission_category: '사용자 관리'},
                    
                    // 워크스페이스 관리 권한
                    {permission_code: 'workspace:create', permission_name: '워크스페이스 생성', permission_description: '새로운 워크스페이스를 생성할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:update', permission_name: '워크스페이스 수정', permission_description: '워크스페이스 정보를 수정할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:delete', permission_name: '워크스페이스 삭제', permission_description: '워크스페이스를 삭제할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:invite', permission_name: '워크스페이스 초대', permission_description: '워크스페이스에 사용자를 초대할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:remove_member', permission_name: '워크스페이스 멤버 제거', permission_description: '워크스페이스에서 멤버를 제거할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:view_all', permission_name: '모든 워크스페이스 조회', permission_description: '시스템의 모든 워크스페이스를 조회할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    
                    // 시스템 관리 권한
                    {permission_code: 'system:settings', permission_name: '시스템 설정', permission_description: '시스템 설정을 변경할 수 있는 권한', permission_category: '시스템 관리'},
                    {permission_code: 'system:backup', permission_name: '시스템 백업', permission_description: '시스템 데이터를 백업할 수 있는 권한', permission_category: '시스템 관리'},
                    {permission_code: 'system:restore', permission_name: '시스템 복원', permission_description: '시스템 데이터를 복원할 수 있는 권한', permission_category: '시스템 관리'},
                    {permission_code: 'system:logs', permission_name: '시스템 로그', permission_description: '시스템 로그를 조회할 수 있는 권한', permission_category: '시스템 관리'},
                    {permission_code: 'system:maintenance', permission_name: '시스템 유지보수', permission_description: '시스템 유지보수 작업을 수행할 수 있는 권한', permission_category: '시스템 관리'}
                ],
                'admin': [
                    // 사용자 관리 권한 (일부)
                    {permission_code: 'user:view', permission_name: '사용자 조회', permission_description: '사용자 정보를 조회할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:update', permission_name: '사용자 수정', permission_description: '사용자 정보를 수정할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:approve', permission_name: '사용자 승인', permission_description: '사용자 계정을 승인할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:reject', permission_name: '사용자 거부', permission_description: '사용자 가입 요청을 거부할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:suspend', permission_name: '사용자 정지', permission_description: '사용자 계정을 정지할 수 있는 권한', permission_category: '사용자 관리'},
                    {permission_code: 'user:view_all', permission_name: '모든 사용자 조회', permission_description: '시스템의 모든 사용자를 조회할 수 있는 권한', permission_category: '사용자 관리'},
                    
                    // 워크스페이스 관리 권한
                    {permission_code: 'workspace:create', permission_name: '워크스페이스 생성', permission_description: '새로운 워크스페이스를 생성할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:update', permission_name: '워크스페이스 수정', permission_description: '워크스페이스 정보를 수정할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:invite', permission_name: '워크스페이스 초대', permission_description: '워크스페이스에 사용자를 초대할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:remove_member', permission_name: '워크스페이스 멤버 제거', permission_description: '워크스페이스에서 멤버를 제거할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    {permission_code: 'workspace:view_all', permission_name: '모든 워크스페이스 조회', permission_description: '시스템의 모든 워크스페이스를 조회할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    
                    // 시스템 관리 권한 (제한적)
                    {permission_code: 'system:logs', permission_name: '시스템 로그', permission_description: '시스템 로그를 조회할 수 있는 권한', permission_category: '시스템 관리'}
                ],
                'user': [
                    // 사용자 관리 권한 (매우 제한적)
                    {permission_code: 'user:view', permission_name: '사용자 조회', permission_description: '사용자 정보를 조회할 수 있는 권한', permission_category: '사용자 관리'},
                    
                    // 워크스페이스 관리 권한 (자신의 워크스페이스만)
                    {permission_code: 'workspace:create', permission_name: '워크스페이스 생성', permission_description: '새로운 워크스페이스를 생성할 수 있는 권한', permission_category: '워크스페이스 관리'},
                    
                    // 할일 관리 권한 (자신의 할일만)
                    {permission_code: 'todo:create', permission_name: '할일 생성', permission_description: '새로운 할일을 생성할 수 있는 권한', permission_category: '할일 관리'},
                    {permission_code: 'todo:update', permission_name: '할일 수정', permission_description: '할일 정보를 수정할 수 있는 권한', permission_category: '할일 관리'},
                    {permission_code: 'todo:complete', permission_name: '할일 완료', permission_description: '할일을 완료로 표시할 수 있는 권한', permission_category: '할일 관리'}
                ]
            };
            
            renderPermissions(demoPermissions[roleName] || []);
        }
        
        // 관리자 활동 로그 로드
        function loadAdminLogs() {
            const logsContainer = document.getElementById('adminLogs');
            if (!logsContainer) return;
            
            // 목록 초기화
            logsContainer.innerHTML = '';
            
            // 활동 로그 데이터 로드
            let logs = [];
            
            if (isDemoMode) {
                logs = JSON.parse(localStorage.getItem('demo_admin_logs') || '[]');
            } else {
                // Supabase에서 로그 데이터 로드 (실제 구현 시)
                console.log('실제 Supabase 로그 로드 (미구현)');
                return;
            }
            
            if (logs.length === 0) {
                logsContainer.innerHTML = '<div class="empty-state">관리자 활동 기록이 없습니다.</div>';
                return;
            }
            
            // 날짜순 정렬 (최신순)
            logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // 활동 로그 표시
            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'admin-log-item';
                
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ko-KR', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                // 작업 유형에 따른 아이콘
                const getActionIcon = (action) => {
                    switch(action) {
                        case 'approve_user':
                            return '<span class="log-icon approve-icon">✓</span>';
                        case 'reject_user':
                            return '<span class="log-icon reject-icon">✗</span>';
                        case 'suspend_user':
                            return '<span class="log-icon suspend-icon">⚠</span>';
                        case 'promote_user':
                            return '<span class="log-icon promote-icon">★</span>';
                        default:
                            return '<span class="log-icon">•</span>';
                    }
                };
                
                logItem.innerHTML = `
                    <div class="admin-log-info">
                        ${getActionIcon(log.action)}
                        <div class="admin-log-details">
                            <div class="admin-log-action">
                                <span class="admin-name">${log.admin_name}</span>님이 
                                <span class="target-name">${log.target_name}</span>님의 ${log.details}
                            </div>
                            <div class="admin-log-time">${formatDate(log.created_at)}</div>
                        </div>
                    </div>
                `;
                
                logsContainer.appendChild(logItem);
            });
        }
        
        // 상태별 사용자 필터링
        function filterUsersByStatus() {
            loadUsers();
        }
        
        // 역할별 사용자 필터링
        function filterUsersByRole() {
            loadUsers();
        }
        
        // 사용자 승인 (Supabase 연동)
        async function approveUser(userId) {
            // 권한 확인 및 작업 수행
            return await performActionWithPermissionCheck(
                async () => {
                    // 이 부분은 권한 확인 후 실행됩니다
                    try {
                        showLoading();
                
                if (isDemoMode) {
                    // 데모 모드에서 사용자 승인 처리
                    const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                    const userIndex = demoUsers.findIndex(u => u.id === userId);
                    
                    if (userIndex >= 0) {
                        const user = demoUsers[userIndex];
                        const prevStatus = user.account_status;
                        
                        // 사용자 상태 업데이트
                        demoUsers[userIndex].account_status = 'approved';
                        demoUsers[userIndex].approved_at = new Date().toISOString();
                        demoUsers[userIndex].approved_by = {
                            id: currentUser.id,
                            full_name: currentUser.user_metadata?.full_name || '데모 관리자'
                        };
                        
                        // 로그 추가
                        const adminLogs = JSON.parse(localStorage.getItem('demo_admin_logs') || '[]');
                        adminLogs.push({
                            id: 'log-' + Date.now(),
                            action: prevStatus === 'suspended' ? 'unsuspend_user' : 'approve_user',
                            admin_id: currentUser.id,
                            admin_name: currentUser.user_metadata?.full_name || '데모 관리자',
                            target_id: userId,
                            target_name: user.full_name,
                            details: prevStatus === 'suspended' ? '계정 정지 해제' : '사용자 계정 승인',
                            created_at: new Date().toISOString()
                        });
                        
                        // 저장
                        localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                        localStorage.setItem('demo_admin_logs', JSON.stringify(adminLogs));
                        
                        // UI 갱신
                        showNotification(
                            prevStatus === 'suspended' 
                                ? `${user.full_name} 사용자의 계정 정지가 해제되었습니다.` 
                                : `${user.full_name} 사용자가 승인되었습니다.`, 
                            'success'
                        );
                        
                        // 만약 현재 로그인한 사용자의 상태가 변경된 경우 네비게이션 업데이트
                        if (userId === currentUser.id) {
                            currentUser.app_metadata = {
                                ...currentUser.app_metadata,
                                account_status: 'approved'
                            };
                            await updateNavigationTabs();
                        }
                        
                        // 현재 탭에 따라 다시 로드
                        const activeTab = document.querySelector('.admin-tab.active');
                        if (activeTab) {
                            const tabName = activeTab.textContent.trim() === '사용자 관리' ? 'users' : 
                                           activeTab.textContent.trim() === '승인 요청' ? 'approvals' : 'logs';
                            showAdminTab(tabName);
                        } else {
                            loadUsers();
                            loadApprovals();
                        }
                    }
                } else {
                    // 실제 Supabase 구현
                    // 1. 사용자 정보 가져오기
                    const { data: user, error: userError } = await supabase
                        .from('users')
                        .select('account_status, full_name')
                        .eq('id', userId)
                        .single();
                    
                    if (userError) throw userError;
                    if (!user) throw new Error('사용자를 찾을 수 없습니다.');
                    
                    const prevStatus = user.account_status;
                    const actionType = prevStatus === 'suspended' ? 'unsuspend_user' : 'approve_user';
                    const actionDetails = prevStatus === 'suspended' ? '계정 정지 해제' : '사용자 계정 승인';
                    
                    // 2. 사용자 상태 업데이트
                    const { error: updateError } = await supabase
                        .from('users')
                        .update({
                            account_status: 'approved',
                            approved_at: new Date().toISOString(),
                            approved_by: currentUser.id
                        })
                        .eq('id', userId);
                    
                    if (updateError) throw updateError;
                    
                    // 3. 관리자 활동 로그 추가 (실제 테이블이 있다면)
                    try {
                        await supabase.from('admin_logs').insert({
                            action: actionType,
                            admin_id: currentUser.id,
                            admin_name: currentUser.user_metadata?.full_name || currentUser.email,
                            target_id: userId,
                            target_name: user.full_name,
                            details: actionDetails
                        });
                    } catch (logError) {
                        console.error('활동 로그 기록 실패:', logError);
                        // 로그 기록 실패는 치명적이지 않으므로 진행
                    }
                    
                    // 4. UI 갱신
                    showNotification(
                        prevStatus === 'suspended' 
                            ? `${user.full_name} 사용자의 계정 정지가 해제되었습니다.` 
                            : `${user.full_name} 사용자가 승인되었습니다.`, 
                        'success'
                    );
                    
                    // 5. 권한 캐시 초기화
                    window.cachedPermissions = null;
                    window.lastPermissionCheck = null;
                    
                    // 6. 현재 로그인한 사용자의 상태가 변경된 경우 네비게이션 업데이트
                    if (userId === currentUser.id) {
                        // 권한 강제 새로고침
                        await checkUserPermissions(true);
                        await updateNavigationTabs();
                    }
                    
                    // 7. 현재 탭에 따라 다시 로드
                    const activeTab = document.querySelector('.admin-tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.trim() === '사용자 관리' ? 'users' : 
                                       activeTab.textContent.trim() === '승인 요청' ? 'approvals' : 'logs';
                        showAdminTab(tabName);
                    } else {
                        loadUsers();
                        loadApprovals();
                    }
                }
                    } catch (error) {
                        console.error('사용자 승인 오류:', error);
                        showNotification('사용자 승인 중 오류가 발생했습니다: ' + error.message, 'error');
                    } finally {
                        hideLoading();
                    }
                },
                'user:approve', // 필요한 권한
                null, // 성공 콜백은 없음
                '사용자를 승인할 권한이 없습니다.' // 실패 메시지
            );
        }
        
        // 사용자 거부
        function rejectUser(userId) {
            if (isDemoMode) {
                // 데모 모드에서 사용자 거부 처리
                const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                const userIndex = demoUsers.findIndex(u => u.id === userId);
                
                if (userIndex >= 0) {
                    const user = demoUsers[userIndex];
                    
                    // 사용자 상태 업데이트
                    demoUsers[userIndex].account_status = 'rejected';
                    demoUsers[userIndex].rejected_at = new Date().toISOString();
                    demoUsers[userIndex].rejected_by = {
                        id: currentUser.id,
                        full_name: currentUser.user_metadata?.full_name || '데모 관리자'
                    };
                    
                    // 로그 추가
                    const adminLogs = JSON.parse(localStorage.getItem('demo_admin_logs') || '[]');
                    adminLogs.push({
                        id: 'log-' + Date.now(),
                        action: 'reject_user',
                        admin_id: currentUser.id,
                        admin_name: currentUser.user_metadata?.full_name || '데모 관리자',
                        target_id: userId,
                        target_name: user.full_name,
                        details: '사용자 계정 거부',
                        created_at: new Date().toISOString()
                    });
                    
                    // 저장
                    localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                    localStorage.setItem('demo_admin_logs', JSON.stringify(adminLogs));
                    
                    // UI 갱신
                    showNotification(`${user.full_name} 사용자가 거부되었습니다.`, 'info');
                    
                    // 만약 현재 로그인한 사용자의 상태가 변경된 경우 네비게이션 업데이트
                    if (userId === currentUser.id) {
                        currentUser.app_metadata = {
                            ...currentUser.app_metadata,
                            account_status: 'rejected'
                        };
                        updateNavigationTabs();
                    }
                    
                    // 현재 탭에 따라 다시 로드
                    const activeTab = document.querySelector('.admin-tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.trim() === '사용자 관리' ? 'users' : 
                                       activeTab.textContent.trim() === '승인 요청' ? 'approvals' : 'logs';
                        showAdminTab(tabName);
                    } else {
                        loadUsers();
                        loadApprovals();
                    }
                }
            } else {
                // 실제 Supabase 구현 (미구현)
                showNotification('데모 모드에서만 지원되는 기능입니다.', 'warning');
            }
        }
        
        // 사용자 정지
        function suspendUser(userId) {
            if (isDemoMode) {
                // 데모 모드에서 사용자 정지 처리
                const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                const userIndex = demoUsers.findIndex(u => u.id === userId);
                
                if (userIndex >= 0) {
                    const user = demoUsers[userIndex];
                    
                    // 사용자 상태 업데이트
                    demoUsers[userIndex].account_status = 'suspended';
                    demoUsers[userIndex].suspended_at = new Date().toISOString();
                    demoUsers[userIndex].suspended_by = {
                        id: currentUser.id,
                        full_name: currentUser.user_metadata?.full_name || '데모 관리자'
                    };
                    
                    // 로그 추가
                    const adminLogs = JSON.parse(localStorage.getItem('demo_admin_logs') || '[]');
                    adminLogs.push({
                        id: 'log-' + Date.now(),
                        action: 'suspend_user',
                        admin_id: currentUser.id,
                        admin_name: currentUser.user_metadata?.full_name || '데모 관리자',
                        target_id: userId,
                        target_name: user.full_name,
                        details: '사용자 계정 정지',
                        created_at: new Date().toISOString()
                    });
                    
                    // 저장
                    localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                    localStorage.setItem('demo_admin_logs', JSON.stringify(adminLogs));
                    
                    // UI 갱신
                    showNotification(`${user.full_name} 사용자의 계정이 정지되었습니다.`, 'warning');
                    
                    // 만약 현재 로그인한 사용자의 상태가 변경된 경우 네비게이션 업데이트
                    if (userId === currentUser.id) {
                        currentUser.app_metadata = {
                            ...currentUser.app_metadata,
                            account_status: 'suspended'
                        };
                        updateNavigationTabs();
                    }
                    
                    // 현재 탭에 따라 다시 로드
                    loadUsers();
                }
            } else {
                // 실제 Supabase 구현 (미구현)
                showNotification('데모 모드에서만 지원되는 기능입니다.', 'warning');
            }
        }
        
        // 사용자 관리자로 승격
        function promoteUser(userId) {
            if (isDemoMode) {
                // 데모 모드에서 사용자 승격 처리
                const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                const userIndex = demoUsers.findIndex(u => u.id === userId);
                
                if (userIndex >= 0) {
                    const user = demoUsers[userIndex];
                    const prevRole = user.global_role;
                    
                    // 사용자 역할 업데이트
                    demoUsers[userIndex].global_role = 'admin';
                    
                    // 로그 추가
                    const adminLogs = JSON.parse(localStorage.getItem('demo_admin_logs') || '[]');
                    adminLogs.push({
                        id: 'log-' + Date.now(),
                        action: 'promote_user',
                        admin_id: currentUser.id,
                        admin_name: currentUser.user_metadata?.full_name || '데모 관리자',
                        target_id: userId,
                        target_name: user.full_name,
                        details: `사용자 역할 변경: ${prevRole} → admin`,
                        created_at: new Date().toISOString()
                    });
                    
                    // 저장
                    localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                    localStorage.setItem('demo_admin_logs', JSON.stringify(adminLogs));
                    
                    // UI 갱신
                    showNotification(`${user.full_name} 사용자가 관리자로 승격되었습니다.`, 'success');
                    
                    // 만약 현재 로그인한 사용자의 역할이 변경된 경우 네비게이션 업데이트
                    if (userId === currentUser.id) {
                        currentUser.app_metadata = {
                            ...currentUser.app_metadata,
                            global_role: 'admin'
                        };
                        updateNavigationTabs();
                    }
                    
                    // 현재 탭에 따라 다시 로드
                    loadUsers();
                }
            } else {
                // 실제 Supabase 구현 (미구현)
                showNotification('데모 모드에서만 지원되는 기능입니다.', 'warning');
            }
        }
        
        // 관리자를 일반 사용자로 강등
        function demoteUser(userId) {
            if (isDemoMode) {
                // 데모 모드에서 사용자 강등 처리
                const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '[]');
                const userIndex = demoUsers.findIndex(u => u.id === userId);
                
                if (userIndex >= 0) {
                    const user = demoUsers[userIndex];
                    const prevRole = user.global_role;
                    
                    // 사용자 역할 업데이트
                    demoUsers[userIndex].global_role = 'user';
                    
                    // 로그 추가
                    const adminLogs = JSON.parse(localStorage.getItem('demo_admin_logs') || '[]');
                    adminLogs.push({
                        id: 'log-' + Date.now(),
                        action: 'demote_user',
                        admin_id: currentUser.id,
                        admin_name: currentUser.user_metadata?.full_name || '데모 관리자',
                        target_id: userId,
                        target_name: user.full_name,
                        details: `사용자 역할 변경: ${prevRole} → user`,
                        created_at: new Date().toISOString()
                    });
                    
                    // 저장
                    localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                    localStorage.setItem('demo_admin_logs', JSON.stringify(adminLogs));
                    
                    // UI 갱신
                    showNotification(`${user.full_name}의 관리자 권한이 해제되었습니다.`, 'info');
                    
                    // 만약 현재 로그인한 사용자의 역할이 변경된 경우 네비게이션 업데이트
                    if (userId === currentUser.id) {
                        currentUser.app_metadata = {
                            ...currentUser.app_metadata,
                            global_role: 'user'
                        };
                        updateNavigationTabs();
                    }
                    
                    // 현재 탭에 따라 다시 로드
                    loadUsers();
                }
            } else {
                // 실제 Supabase 구현 (미구현)
                showNotification('데모 모드에서만 지원되는 기능입니다.', 'warning');
            }
        }
        
        // 특정 권한이 있는지 확인하는 함수
        async function hasPermission(permissionCode) {
            try {
                if (isDemoMode) {
                    // 데모 모드에서는 슈퍼관리자로 모든 권한 가짐
                    if (currentUser.app_metadata?.global_role === 'super_admin') return true;
                    
                    // 역할별 권한 확인
                    const roleName = currentUser.app_metadata?.global_role || 'user';
                    const demoPermissions = {
                        'super_admin': ['user:view', 'user:create', 'user:update', 'user:delete', 'user:approve', 
                                        'user:reject', 'user:suspend', 'user:promote', 'user:view_all',
                                        'workspace:create', 'workspace:update', 'workspace:delete', 'workspace:invite',
                                        'workspace:remove_member', 'workspace:view_all', 'system:settings', 'system:backup',
                                        'system:restore', 'system:logs', 'system:maintenance'],
                        'admin': ['user:view', 'user:update', 'user:approve', 'user:reject', 'user:suspend', 'user:view_all',
                                  'workspace:create', 'workspace:update', 'workspace:invite', 'workspace:remove_member',
                                  'workspace:view_all', 'system:logs'],
                        'user': ['user:view', 'workspace:create', 'todo:create', 'todo:update', 'todo:complete']
                    };
                    
                    return demoPermissions[roleName]?.includes(permissionCode) || false;
                } else {
                    // Supabase에서 권한 확인
                    const { data, error } = await APIManager.rpc('has_permission', { 
                        permission_code: permissionCode 
                    }, {
                        errorMessage: '권한 확인 실패'
                    });
                    if (error) throw error;
                    return data;
                }
            } catch (error) {
                console.error(`권한 확인 오류 (${permissionCode}):`, error);
                return false; // 오류 시 권한 없음으로 처리
            }
        }
        
        // 권한 기반으로 액션 수행 예제
        async function performActionWithPermissionCheck(action, requiredPermission, successCallback, failureMessage = '이 작업을 수행할 권한이 없습니다.') {
            try {
                // 권한 확인
                const hasPermissionResult = await hasPermission(requiredPermission);
                
                if (hasPermissionResult) {
                    // 권한이 있는 경우 액션 수행
                    if (typeof action === 'function') {
                        await action();
                    }
                    
                    // 성공 콜백 실행
                    if (typeof successCallback === 'function') {
                        successCallback();
                    }
                    
                    return true;
                } else {
                    // 권한이 없는 경우 메시지 표시
                    showNotification(failureMessage, 'error');
                    return false;
                }
            } catch (error) {
                console.error('권한 확인 중 오류 발생:', error);
                showNotification('권한 확인 중 오류가 발생했습니다.', 'error');
                return false;
            }
        }
        
        // 권한 확인 함수 (서버 측 검증 연동)
        async function checkUserPermissions(forceServerCheck = false) {
            if (!currentUser) return null;
            
            // 데모 모드에서는 클라이언트 측 권한 체크만 수행
            if (isDemoMode) {
                const userStatus = 'approved';
                const userRole = currentUser.app_metadata?.global_role || 'super_admin';
                
                return {
                    status: userStatus,
                    role: userRole,
                    isApproved: userStatus === 'approved',
                    isAdmin: userRole === 'admin' || userRole === 'super_admin',
                    permissions: {
                        dashboard: true,
                        projects: true,
                        todos: true,
                        calendar: true,
                        admin: userRole === 'admin' || userRole === 'super_admin'
                    },
                    serverChecked: false
                };
            }
            
            // 서버 측 검증이 필요한 경우 또는 캐시된 권한이 없는 경우
            if (forceServerCheck || !window.cachedPermissions) {
                try {
                    // 서버 측 권한 검증 API 호출
                    const { data, error } = await APIManager.rpc('check_access_permission', {}, {
                        errorMessage: '접근 권한 확인 실패'
                    });
                    
                    if (error) throw error;
                    
                    // 서버 응답 캐싱
                    window.cachedPermissions = data;
                    window.lastPermissionCheck = Date.now();
                    
                    return {
                        status: data.account_status,
                        role: data.global_role,
                        isApproved: data.is_approved,
                        isAdmin: data.is_admin,
                        permissions: data.permissions,
                        serverChecked: true
                    };
                } catch (error) {
                    console.error('서버 측 권한 검증 오류:', error);
                    
                    // 오류 발생 시 클라이언트 측 검증으로 폴백
                    const userStatus = currentUser.app_metadata?.account_status || 'pending';
                    const userRole = currentUser.app_metadata?.global_role || 'user';
                    
                    return {
                        status: userStatus,
                        role: userRole,
                        isApproved: userStatus === 'approved',
                        isAdmin: userRole === 'admin' || userRole === 'super_admin',
                        permissions: {
                            dashboard: userStatus === 'approved',
                            projects: userStatus === 'approved',
                            todos: userStatus === 'approved',
                            calendar: userStatus === 'approved',
                            admin: userRole === 'admin' || userRole === 'super_admin'
                        },
                        serverChecked: false,
                        error: error.message
                    };
                }
            }
            
            // 캐시된 권한 반환 (5분 이내에 체크한 경우)
            if (window.cachedPermissions && window.lastPermissionCheck && (Date.now() - window.lastPermissionCheck < 5 * 60 * 1000)) {
                const data = window.cachedPermissions;
                
                return {
                    status: data.account_status,
                    role: data.global_role,
                    isApproved: data.is_approved,
                    isAdmin: data.is_admin,
                    permissions: data.permissions,
                    serverChecked: true,
                    cached: true
                };
            }
            
            // 캐시 만료된 경우 재조회
            return checkUserPermissions(true);
        }
        
        // 섹션별 접근 권한 정의 (서버 측 검증 연동)
        async function getSectionPermissions(sectionId) {
            // 데모 모드에서는 간소화된 권한 체크
            if (isDemoMode) {
                const permissions = await checkUserPermissions();
                if (!permissions) return false;
                
                const basicSections = ['dashboard', 'projects', 'todos', 'calendar'];
                
                if (basicSections.includes(sectionId)) {
                    if (!permissions.isApproved) {
                        showNotification('승인된 사용자만 이 기능을 사용할 수 있습니다.', 'warning');
                        return false;
                    }
                    return true;
                }
                
                if (sectionId === 'admin') {
                    if (!permissions.isAdmin) {
                        showNotification('관리자만 접근할 수 있는 기능입니다.', 'error');
                        return false;
                    }
                    return true;
                }
                
                return permissions.isApproved;
            }
            
            try {
                // 특정 기능에 대한 서버 측 권한 검증
                const { data, error } = await APIManager.rpc('check_access_permission', {
                    feature: sectionId
                }, {
                    errorMessage: '섹션 접근 권한 확인 실패'
                });
                
                if (error) throw error;
                
                // 권한이 없는 경우 메시지 표시
                if (!data.allowed) {
                    showNotification(data.reason || '이 기능에 접근할 권한이 없습니다.', 'warning');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('서버 측 권한 검증 오류:', error);
                
                // 오류 발생 시 클라이언트 측 검증으로 폴백
                const permissions = await checkUserPermissions();
                if (!permissions) return false;
                
                const basicSections = ['dashboard', 'projects', 'todos', 'calendar'];
                
                if (basicSections.includes(sectionId)) {
                    if (!permissions.isApproved) {
                        showNotification('승인된 사용자만 이 기능을 사용할 수 있습니다.', 'warning');
                        return false;
                    }
                    return true;
                }
                
                if (sectionId === 'admin') {
                    if (!permissions.isAdmin) {
                        showNotification('관리자만 접근할 수 있는 기능입니다.', 'error');
                        return false;
                    }
                    return true;
                }
                
                // 기타 섹션 (알림 등)은 승인된 사용자만 접근 가능
                if (!permissions.isApproved) {
                    showNotification('승인된 사용자만 이 기능을 사용할 수 있습니다.', 'warning');
                    return false;
                }
                
                return true;
            }
        }
        
        // 네비게이션 탭 권한에 따른 표시/숨김 (서버 측 검증 연동)
        async function updateNavigationTabs() {
            const permissions = await checkUserPermissions();
            if (!permissions) return;
            
            // 기본 탭들
            const basicTabs = ['dashboard', 'projects', 'todos', 'calendar'];
            basicTabs.forEach(tabId => {
                const tab = document.querySelector(`[onclick="showSection('${tabId}')"]`);
                if (tab) {
                    // 서버 검증된 권한이나 캐시된 권한 확인 (단순화: 탭 권한 사용 여부만 확인)
                    const hasPermission = permissions.permissions ? 
                        permissions.permissions[tabId] : permissions.isApproved;
                    
                    if (hasPermission) {
                        tab.style.display = 'block';
                        tab.style.opacity = '1';
                        tab.style.pointerEvents = 'auto';
                        tab.title = '';
                    } else {
                        // 탭 접근 권한이 없는 경우 비활성화
                        tab.style.opacity = '0.5';
                        tab.style.pointerEvents = 'none';
                        tab.title = '이 기능에 접근할 수 있는 권한이 없습니다';
                    }
                }
            });
            
            // 관리자 탭
            const adminTab = document.getElementById('adminNavTab');
            if (adminTab) {
                // 서버 검증된 권한이나 캐시된 권한 확인 (단순화: 탭 권한 사용 여부만 확인)
                const hasAdminPermission = permissions.permissions ? 
                    permissions.permissions.admin : permissions.isAdmin;
                
                if (hasAdminPermission) {
                    adminTab.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                }
            }
            
            // 권한 정보 로그 (개발 중에만 활성화)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('권한 정보:', permissions);
            }
        }
        
        // 섹션 전환 (서버 측 권한 검증 연동)
        async function showSection(sectionId) {
            try {
                // 로딩 표시
                showLoading();
                
                // 권한 확인 (서버 측 검증)
                const hasPermission = await getSectionPermissions(sectionId);
                if (!hasPermission) {
                    hideLoading();
                    return; // 권한이 없으면 섹션 전환 중단
                }
                
                // 모든 섹션 숨기기
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // 모든 탭 비활성화
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // 선택된 섹션 표시
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // 해당 탭 활성화 (event.target이 존재하는 경우에만)
                if (typeof event !== 'undefined' && event.target) {
                    event.target.classList.add('active');
                } else {
                    // event.target이 없는 경우 해당 섹션의 탭을 찾아서 활성화
                    const correspondingTab = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
                    if (correspondingTab) {
                        correspondingTab.classList.add('active');
                    }
                }
                
                // 특정 섹션에 대한 추가 초기화
                if (sectionId === 'admin') {
                    // 관리자 탭의 경우 사용자 목록 로드
                    setTimeout(() => {
                        showAdminTab('users');
                    }, 100);
                } else if (sectionId === 'dashboard') {
                    // 대시보드의 경우 데이터 새로고침
                    console.log('대시보드 섹션 전환, 현재 todos 수:', todos.length);
                    console.log('현재 사용자:', currentUser);
                    console.log('데모 모드:', isDemoMode);
                    
                    // 데모 모드에서 todos가 비어있는 경우 강제로 데모 데이터 로드
                    if (isDemoMode && todos.length === 0 && currentUser) {
                        console.log('대시보드 전환 시 데모 데이터 강제 로드');
                        loadDemoData();
                        // 데모 데이터 로드 후 약간의 지연을 두고 대시보드 업데이트
                        setTimeout(() => {
                            updateDashboard();
                        }, 100);
                    } else {
                        updateDashboard();
                    }
                } else if (sectionId === 'projects') {
                    // 프로젝트 페이지의 경우 프로젝트 목록 새로고침
                    updateProjectsPage();
                } else if (sectionId === 'todos') {
                    // 할 일 페이지의 경우 할 일 목록 새로고침
                    renderTodos();
                } else if (sectionId === 'calendar') {
                    // 달력 페이지의 경우 달력 렌더링
                    renderCalendar();
                }
            } catch (error) {
                console.error('섹션 전환 오류:', error);
                showNotification('오류가 발생했습니다. 다시 시도해 주세요.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // 기존 함수들의 래퍼 (하위 호환성)
        function showLoading(message) {
            UIManager.showLoading(message);
        }
        
        function hideLoading() {
            UIManager.hideLoading();
        }
        
        // 할 일 추가
        async function addTodo() {
            if (!currentWorkspace) {
                showNotification('워크스페이스를 먼저 선택해주세요.', 'error');
                return;
            }
            
            const title = document.getElementById('todoTitle').value.trim();
            const description = document.getElementById('todoDesc').value.trim();
            const dueDate = document.getElementById('todoDueDate').value;
            const priority = document.getElementById('todoPriority').value;
            
            if (!title) {
                showNotification('할 일 제목을 입력해주세요.', 'error');
                return;
            }
            
            try {
                const newTodo = {
                    id: 'todo-' + Date.now(),
                    workspace_id: currentWorkspace.id,
                    title: title,
                    description: description || null,
                    due_date: dueDate || null,
                    priority: priority,
                    status: 'pending',
                    created_by: currentUser.id,
                    assigned_to: currentUser.id,
                    created_at: new Date().toISOString()
                };
                
                // 데모 모드인지 확인
                if (isDemoMode) {
                    // 데모 모드: localStorage에 저장
                    todos.push(newTodo);
                    localStorage.setItem('demo_todos', JSON.stringify(todos));
                } else {
                    // 실제 모드: Supabase에 저장 (실시간 동기화)
                    const { error } = await APIManager.insert('todos', {
                        workspace_id: currentWorkspace.id,
                        title: title,
                        description: description || null,
                        due_date: dueDate || null,
                        priority: priority,
                        created_by: currentUser.id,
                        assigned_to: currentUser.id
                    }, {
                        errorMessage: '할 일 생성 실패'
                    });
                    
                    if (error) throw error;
                    
                    // 실시간 구독을 통해 자동으로 업데이트됨
                }
                
                // 폼 초기화
                UIManager.resetForm({
                    'todoTitle': '',
                    'todoDesc': '',
                    'todoDueDate': '',
                    'todoPriority': 'medium'
                });
                
                // UI 업데이트
                if (currentUser && currentUser.id.indexOf('demo-user-') === 0) {
                    renderTodos();
                }
                updateDashboard();
                updateProjectsPage();
                
                ErrorManager.success('할 일이 추가되었습니다.');
                
            } catch (error) {
                ErrorManager.handleApiError(error, '할 일 추가');
            }
        }
        
        // 할 일 완료
        async function completeTodo(todoId) {
            try {
                // 데모 모드인지 확인
                if (isDemoMode) {
                    // 데모 모드: localStorage 업데이트
                    const todoIndex = todos.findIndex(t => t.id === todoId);
                    if (todoIndex !== -1) {
                        todos[todoIndex].status = 'completed';
                        todos[todoIndex].completed_at = new Date().toISOString();
                        localStorage.setItem('demo_todos', JSON.stringify(todos));
                        renderTodos();
                        updateDashboard();
                        updateProjectsPage();
                    }
                } else {
                    // 실제 모드: Supabase 업데이트 (실시간 동기화)
                    const { error } = await APIManager.update('todos', {
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    }, 
                    { id: todoId },
                    { errorMessage: '할 일 완료 처리 실패' }
                    );
                    
                    if (error) throw error;
                    
                    // 실시간 구독을 통해 자동으로 업데이트됨
                }
                
                showNotification('할 일이 완료되었습니다.', 'success');
                
            } catch (error) {
                ErrorManager.handleApiError(error, '할 일 완료');
            }
        }
        
        // 할 일 삭제
        async function deleteTodo(todoId) {
            if (!confirm('정말로 이 할 일을 삭제하시겠습니까?')) return;
            
            try {
                // 데모 모드인지 확인
                if (currentUser && currentUser.id.indexOf('demo-user-') === 0) {
                    // 데모 모드: localStorage에서 삭제
                    todos = todos.filter(t => t.id !== todoId);
                    localStorage.setItem('demo_todos', JSON.stringify(todos));
                    renderTodos();
                    updateDashboard();
                } else {
                    // 실제 모드: Supabase에서 삭제
                    const { error } = await APIManager.delete('todos',
                        { id: todoId },
                        { errorMessage: '할 일 삭제 실패' }
                    );
                    
                    if (error) throw error;
                    
                    await loadTodos();
                    await updateDashboard();
                }
                
                showNotification('할 일이 삭제되었습니다.');
                
            } catch (error) {
                ErrorManager.handleApiError(error, '할 일 삭제');
            }
        }
        
        // 워크스페이스 선택
        async function selectWorkspace(workspaceId) {
            currentWorkspace = workspaces.find(ws => ws.id === workspaceId);
            renderWorkspaces();
            
            // 워크스페이스 변경 시 관련 데이터 모두 로드
            await Promise.all([
                loadProjects(), // 프로젝트 데이터 로드 추가
                loadTodos(),
                updateDashboard()
            ]);
            
            // 실시간 구독 재설정
            initializeRealtimeSubscriptions();
            
            showNotification(`${currentWorkspace.name} 워크스페이스가 선택되었습니다.`);
        }
        
        // 워크스페이스 생성
        async function createWorkspace() {
            const name = prompt('워크스페이스 이름을 입력하세요:');
            if (!name || !name.trim()) return;
            
            const description = prompt('워크스페이스 설명을 입력하세요 (선택사항):');
            
            try {
                console.log('워크스페이스 생성 시작:', { name: name.trim(), description: description?.trim(), created_by: currentUser.id });
                
                const { data, error } = await APIManager.insert('workspaces', {
                    name: name.trim(),
                    description: description?.trim() || null,
                    created_by: currentUser.id
                }, {
                    select: '*',
                    single: true,
                    errorMessage: '워크스페이스 생성 실패'
                });
                
                if (error) {
                    console.error('워크스페이스 생성 Supabase 오류:', error);
                    throw error;
                }
                
                console.log('워크스페이스 생성 성공:', data);
                
                // 워크스페이스 멤버로 자신 추가
                const { error: memberError } = await APIManager.insert('workspace_members', {
                    workspace_id: data.id,
                    user_id: currentUser.id,
                    role: 'admin',
                    invited_by: currentUser.id
                }, {
                    errorMessage: '워크스페이스 멤버 추가 실패'
                });
                
                if (memberError) {
                    console.error('워크스페이스 멤버 추가 오류:', memberError);
                    // 멤버 추가 실패해도 계속 진행
                }
                
                await loadWorkspaces();
                
                // 새 워크스페이스로 전환
                currentWorkspace = data;
                
                // 새 워크스페이스의 프로젝트 로드
                await loadProjects();
                
                // 실시간 구독 초기화
                initializeRealtimeSubscriptions();
                
                ErrorManager.success('워크스페이스가 생성되었습니다.');
                
            } catch (error) {
                console.error('워크스페이스 생성 오류:', error);
                showNotification('워크스페이스 생성에 실패했습니다: ' + error.message, 'error');
            }
        }
        
        // 로그인 모드 전환
        function switchLoginMode(mode) {
            // 모든 모드 버튼 비활성화
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'email') {
                document.querySelector('.mode-btn[onclick="switchLoginMode(\'email\')"]').classList.add('active');
                document.getElementById('emailLoginForm').style.display = 'flex';
                document.getElementById('signupForm').style.display = 'none';
            } else if (mode === 'signup') {
                document.querySelector('.mode-btn[onclick="switchLoginMode(\'signup\')"]').classList.add('active');
                document.getElementById('emailLoginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'flex';
            }
        }
        
        // 이메일 로그인
        async function loginWithEmail() {
            // 모달이 있다면 닫기
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
            }
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                ErrorManager.validation('이메일과 비밀번호를 입력해주세요.');
                return;
            }
            
            const btn = document.getElementById('emailLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0;"></div> 로그인 중...';
            
            try {
                const { error } = await APIManager.auth.signIn(email, password);
                
                if (error) throw error;
                
                ErrorManager.success('로그인 성공!');
                
            } catch (error) {
                ErrorManager.handleApiError(error, '로그인');
                btn.disabled = false;
                btn.innerHTML = '로그인';
            }
        }
        
        // 회원가입
        async function signupWithEmail() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            
            if (!name || !email || !password || !passwordConfirm) {
                ErrorManager.validation('모든 필드를 입력해주세요.');
                return;
            }
            
            if (password !== passwordConfirm) {
                ErrorManager.validation('비밀번호가 일치하지 않습니다.');
                return;
            }
            
            if (password.length < 6) {
                ErrorManager.validation('비밀번호는 6자 이상이어야 합니다.');
                return;
            }
            
            const btn = document.getElementById('signupBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0;"></div> 가입 중...';
            
            try {
                const { error } = await APIManager.auth.signUp(email, password, {
                    full_name: name
                });
                
                if (error) throw error;
                
                ErrorManager.success('회원가입이 완료되었습니다! 로그인해주세요.');
                switchLoginMode('email');
                
            } catch (error) {
                ErrorManager.handleApiError(error, '회원가입');
                btn.disabled = false;
                btn.innerHTML = '회원가입';
            }
        }
        
        // Google 로그인 (정식 버전으로 직접 진입)
        async function loginWithGoogle() {
            const btn = document.getElementById('googleLoginBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0;"></div> Google 로그인 중...';
                
                console.log('Google OAuth 로그인 시작...');
                
                // 현재 URL을 기반으로 정확한 redirectTo 설정
                const currentUrl = window.location.origin + window.location.pathname;
                console.log('OAuth redirectTo URL:', currentUrl);
                
                const { data, error } = await APIManager.auth.signInWithOAuth('google', {
                    redirectTo: currentUrl,
                    queryParams: {
                        access_type: 'offline',
                        prompt: 'select_account'
                    }
                });
                
                if (error) {
                    console.error('Google OAuth 오류:', error);
                    
                    // 현재 도메인이 임시 환경인지 확인
                    if (window.location.hostname.includes('youware') || window.location.hostname.includes('localhost')) {
                        showNotification('🚀 Vercel 배포 후 Google 로그인이 정상 작동합니다!', 'error');
                        showVercelDeployGuide();
                    } else {
                        showNotification('Google OAuth 설정을 확인해주세요.', 'error');
                        showGoogleOAuthGuide();
                    }
                    
                    throw error;
                }
                
                console.log('✅ Google OAuth 요청 성공!', data);
                showNotification('Google 로그인이 진행됩니다...', 'success');
                
            } catch (error) {
                console.error('Google 로그인 전체 오류:', error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Google OAuth 설정 가이드 표시 (403 에러 지속 문제)
        function showGoogleOAuthGuide() {
            const currentDomain = window.location.origin;
            const guideHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; padding: 35px; border-radius: 20px; max-width: 850px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                        
                        <!-- 헤더 -->
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 60px; margin-bottom: 15px;">🚨</div>
                            <h2 style="color: #dc2626; margin: 0; font-size: 28px; font-weight: 700;">403 오류 지속 발생</h2>
                            <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 16px;">Google Cloud Console 추가 확인 필요</p>
                        </div>
                        
                        <!-- 긴급 알림 -->
                        <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); border: 2px solid #f87171; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="color: #dc2626; margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center;">
                                <span style="margin-right: 8px;">⚠️</span> 지속되는 403 오류
                            </h4>
                            <p style="margin: 0 0 10px 0; color: #7f1d1d; line-height: 1.6;">
                                Supabase 설정은 완료되었지만 Google Cloud Console에서 <strong>${currentDomain}</strong> 도메인이 아직 승인되지 않았습니다.
                            </p>
                            <p style="margin: 0; color: #7f1d1d; line-height: 1.6; font-weight: 600;">
                                🔍 아래 체크리스트를 다시 한 번 확인해주세요.
                            </p>
                        </div>
                        
                        <!-- 상세 체크리스트 -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px;">🔍 Google Cloud Console 재확인</h3>
                            
                            <!-- 체크리스트 -->
                            <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #60a5fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #1d4ed8; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center;">
                                    <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; font-size: 14px;">✓</span>
                                    필수 확인사항
                                </h4>
                                
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #1e40af; margin: 0 0 12px 0; font-weight: 600;">1️⃣ OAuth 2.0 클라이언트 ID 설정</h5>
                                    <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.6;">
                                        <li><strong>애플리케이션 유형:</strong> 웹 애플리케이션</li>
                                        <li><strong>이름:</strong> TeamTodo (또는 원하는 이름)</li>
                                        <li><strong>승인된 JavaScript 원본 확인:</strong>
                                            <div style="background: #f3f4f6; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 13px;">
                                                ${currentDomain}
                                            </div>
                                        </li>
                                        <li><strong>승인된 리디렉션 URI 확인:</strong>
                                            <div style="background: #f3f4f6; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 13px;">
                                                https://nlywtmsbkvaggfvezonj.supabase.co/auth/v1/callback
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #1e40af; margin: 0 0 12px 0; font-weight: 600;">2️⃣ 추가 확인 포인트</h5>
                                    <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.6;">
                                        <li><strong>OAuth 동의 화면:</strong> 외부 사용자 설정</li>
                                        <li><strong>앱 도메인:</strong> ${currentDomain.replace('https://', '')} 추가</li>
                                        <li><strong>승인된 도메인:</strong> ${currentDomain.replace('https://', '')} 포함</li>
                                        <li><strong>Google+ API:</strong> 활성화 (필요시)</li>
                                        <li><strong>설정 저장 후:</strong> 10-15분 대기</li>
                                    </ul>
                                </div>
                                
                                <!-- 빠른 복사 -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                                    <div>
                                        <p style="margin: 0 0 8px 0; color: #1e40af; font-weight: 600; font-size: 14px;">JavaScript 원본:</p>
                                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db; position: relative;">
                                            <code style="color: #059669; font-size: 12px; word-break: break-all;">${currentDomain}</code>
                                            <button onclick="navigator.clipboard.writeText('${currentDomain}'); this.innerHTML='✅'" style="position: absolute; right: 4px; top: 4px; background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">📋</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p style="margin: 0 0 8px 0; color: #1e40af; font-weight: 600; font-size: 14px;">리디렉션 URI:</p>
                                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db; position: relative;">
                                            <code style="color: #dc2626; font-size: 12px; word-break: break-all;">https://nlywtmsbkvaggfvezonj.supabase.co/auth/v1/callback</code>
                                            <button onclick="navigator.clipboard.writeText('https://nlywtmsbkvaggfvezonj.supabase.co/auth/v1/callback'); this.innerHTML='✅'" style="position: absolute; right: 4px; top: 4px; background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">📋</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 임시 해결책 강조 -->
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 3px solid #f59e0b; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                            <h4 style="color: #92400e; margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                                <span style="margin-right: 12px; font-size: 24px;">⚡</span> 지금 바로 TeamTodo 사용하기
                            </h4>
                            <p style="margin: 0 0 15px 0; color: #78350f; line-height: 1.6; font-size: 16px;">
                                Google OAuth 설정이 완료될 때까지 다른 로그인 방법을 사용해보세요:
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button onclick="this.parentElement.parentElement.parentElement.remove(); document.querySelector('button[onclick*=\"loginAsTestUser\"]').click()" style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                    🧪 테스트 계정으로 시작
                                </button>
                                <button onclick="this.parentElement.parentElement.parentElement.remove(); switchLoginMode('signup')" style="background: #3b82f6; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                    📧 이메일로 회원가입
                                </button>
                            </div>
                        </div>
                        
                        <!-- 액션 버튼들 -->
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6b7280; color: white; padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                닫기
                            </button>
                            <button onclick="window.open('https://console.cloud.google.com/apis/credentials', '_blank')" style="background: #3b82f6; color: white; padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                🔗 Google Cloud Console
                            </button>
                            <button onclick="window.open('https://console.cloud.google.com/apis/credentials/consent', '_blank')" style="background: #8b5cf6; color: white; padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                🔗 OAuth 동의화면
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', guideHtml);
        }
        
        // Vercel 배포 가이드 표시
        function showVercelDeployGuide() {
            const guideHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; padding: 35px; border-radius: 20px; max-width: 750px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                        
                        <!-- 헤더 -->
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 60px; margin-bottom: 15px;">🚀</div>
                            <h2 style="color: #059669; margin: 0; font-size: 28px; font-weight: 700;">Vercel 배포 준비!</h2>
                            <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 16px;">Google OAuth는 정식 도메인에서 작동합니다</p>
                        </div>
                        
                        <!-- 현재 상황 -->
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="color: #92400e; margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center;">
                                <span style="margin-right: 8px;">💡</span> 현재 상황
                            </h4>
                            <p style="margin: 0 0 10px 0; color: #78350f; line-height: 1.6;">
                                <strong>Youware 개발 환경</strong>에서는 Google OAuth가 작동하지 않습니다.
                            </p>
                            <p style="margin: 0; color: #78350f; line-height: 1.6;">
                                <strong>Vercel에 배포</strong>하면 정식 도메인이 생기고, Google OAuth가 정상 작동합니다!
                            </p>
                        </div>
                        
                        <!-- Vercel 배포 단계 -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px;">📋 Vercel 배포 단계</h3>
                            
                            <!-- 1단계 -->
                            <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); border: 2px solid #34d399; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                                <h4 style="color: #065f46; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center;">
                                    <span style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; font-size: 14px;">1</span>
                                    Youware에서 다운로드
                                </h4>
                                <ol style="margin: 0; padding-left: 20px; color: #064e3b; line-height: 1.6;">
                                    <li>Youware에서 <strong>"소스코드 다운로드"</strong> 클릭</li>
                                    <li>ZIP 파일을 컴퓨터에 저장</li>
                                    <li>ZIP 파일을 압축 해제</li>
                                </ol>
                            </div>
                            
                            <!-- 2단계 -->
                            <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #60a5fa; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                                <h4 style="color: #1d4ed8; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center;">
                                    <span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; font-size: 14px;">2</span>
                                    Vercel에 배포
                                </h4>
                                <ol style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.6;">
                                    <li><a href="https://vercel.com" target="_blank" style="color: #2563eb;">Vercel.com</a> 방문 후 GitHub 로그인</li>
                                    <li><strong>"New Project"</strong> 클릭</li>
                                    <li>압축 해제한 폴더를 업로드</li>
                                    <li><strong>"Deploy"</strong> 클릭 (자동 빌드)</li>
                                </ol>
                            </div>
                            
                            <!-- 3단계 -->
                            <div style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); border: 2px solid #f472b6; padding: 20px; border-radius: 12px;">
                                <h4 style="color: #be185d; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center;">
                                    <span style="background: #ec4899; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; font-size: 14px;">3</span>
                                    Google OAuth 설정
                                </h4>
                                <ol style="margin: 0; padding-left: 20px; color: #9d174d; line-height: 1.6;">
                                    <li>Vercel에서 생성된 도메인 복사 (예: teamtodo.vercel.app)</li>
                                    <li>Google Cloud Console에서 <strong>승인된 JavaScript 원본</strong>에 추가</li>
                                    <li>Google OAuth 즉시 작동! 🎉</li>
                                </ol>
                            </div>
                        </div>
                        
                        <!-- 현재 사용 가능한 기능 -->
                        <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #0ea5e9; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="color: #0c4a6e; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center;">
                                <span style="margin-right: 8px;">✨</span> 지금 바로 사용 가능
                            </h4>
                            <p style="margin: 0 0 10px 0; color: #0c4a6e; line-height: 1.6;">
                                Vercel 배포 전에도 TeamTodo의 모든 기능을 체험하실 수 있습니다:
                            </p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); document.querySelector('button[onclick*=\"loginAsTestUser\"]').click()" style="background: #10b981; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                    🧪 테스트 계정
                                </button>
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); switchLoginMode('signup')" style="background: #3b82f6; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                                    📧 이메일 회원가입
                                </button>
                            </div>
                        </div>
                        
                        <!-- 액션 버튼들 -->
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6b7280; color: white; padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                닫기
                            </button>
                            <button onclick="window.open('https://vercel.com', '_blank')" style="background: #000000; color: white; padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                🚀 Vercel로 이동
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', guideHtml);
        }
        
        // 구글 OAuth 로그인 함수
        async function signInWithGoogle() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0;"></div> 로그인 중...';
                
                // 현재 URL을 리다이렉트 URL로 사용
                const redirectTo = window.location.origin + window.location.pathname;
                
                const { data, error } = await APIManager.auth.signInWithOAuth('google', {
                    options: {
                        redirectTo: redirectTo
                    }
                });
                
                if (error) {
                    console.error('구글 로그인 에러:', error);
                    alert('로그인에 실패했습니다. 다시 시도해주세요.');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
                
                // 구글 로그인 성공 시 URL로 리다이렉트됨
            } catch (error) {
                console.error('구글 로그인 에러:', error);
                alert('로그인에 실패했습니다. 다시 시도해주세요.');
                const btn = event.target;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // 데모 모드로 직접 진입하는 간단한 함수
        async function loginAsTestUser() {
            // 모달이 있다면 닫기
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0;"></div> 데모 모드 시작 중...';
            
            try {
                console.log('데모 모드 직접 시작...');
                
                // 가짜 사용자 데이터 생성 (Supabase 호출 없이)
                currentUser = {
                    id: 'demo-user-' + Date.now(),
                    email: 'demo@teamtodo.test',
                    user_metadata: {
                        full_name: '데모 사용자'
                    },
                    app_metadata: {
                        account_status: 'approved',
                        global_role: 'super_admin'
                    }
                };
                
                // localStorage에 저장
                localStorage.setItem('demo_user', JSON.stringify(currentUser));
                
                // 데모 모드 플래그 설정
                isDemoMode = true;
                
                console.log('데모 사용자 생성 완료, setupUserProfile 호출');
                await setupUserProfile();
                
                console.log('showApp 호출');
                showApp();
                
                console.log('알림 표시');
                showNotification('🎉 데모 모드로 시작합니다! 모든 기능을 체험해보세요!', 'success');
                
                // 관리자 기능 초기화
                setTimeout(() => {
                    console.log('관리자 기능 초기화');
                    try {
                        // 관리자 탭 표시
                        const adminTab = document.getElementById('adminNavTab');
                        if (adminTab) {
                            adminTab.style.display = 'block';
                        }
                        
                        // 대시보드 강제 업데이트
                        updateDashboard();
                        
                        console.log('데모 모드 초기화 완료');
                    } catch (e) {
                        console.error('관리자 기능 초기화 오류:', e);
                    }
                }, 500);
                
            } catch (error) {
                console.error('데모 모드 시작 오류:', error);
                showNotification('데모 모드 시작 중 오류가 발생했습니다.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // 이 함수는 통합된 setupUserProfile()로 대체되었습니다.
        async function setupUserProfileLegacy() {
            try {
                if (!currentUser) return;
                
                // 데모 모드인지 먼저 확인
                const isDemoUser = currentUser.id.indexOf('demo-user-') === 0 || currentUser.email === 'demo@teamtodo.test';
                
                // 실제 Supabase 사용자인 경우에만 DB 작업 수행
                if (!isDemoUser) {
                    // 사용자 정보 확인/생성
                    const { data: existingUser, error: selectError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (!existingUser) {
                        // 전체 사용자 수 확인 (첫 번째 사용자인지 판단)
                        const { data: allUsers, error: countError } = await supabase
                            .from('users')
                            .select('id', { count: 'exact' });
                        
                        const isFirstUser = !countError && (!allUsers || allUsers.length === 0);
                        console.log('첫 번째 사용자 여부:', isFirstUser, '전체 사용자 수:', allUsers?.length || 0);
                        
                        // 새 사용자 생성 (UPSERT 사용)
                        const { error } = await supabase
                            .from('users')
                            .upsert({
                                id: currentUser.id,
                                email: currentUser.email,
                                full_name: currentUser.user_metadata.full_name || currentUser.email.split('@')[0],
                                avatar_url: currentUser.user_metadata.avatar_url,
                                account_status: 'approved', // 자동 승인
                                global_role: isFirstUser ? 'super_admin' : 'user', // 첫 번째 사용자는 슈퍼관리자
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'id'
                            });
                        
                        if (error && error.code !== '23505') { // 중복 키 오류 무시
                            console.error('사용자 생성 오류:', error);
                        } else {
                            console.log('새 사용자 생성 완료 또는 이미 존재함');
                            if (isFirstUser) {
                                console.log('🎉 첫 번째 사용자로 슈퍼관리자 권한 부여됨');
                                showNotification('🎉 첫 번째 사용자로 슈퍼관리자 권한이 부여되었습니다!', 'success');
                            }
                        }
                    }
                }
                
                // UI 업데이트 (DOM 요소 존재 확인)
                const userName = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
                const userNameElement = document.getElementById('userName');
                const userAvatarElement = document.getElementById('userAvatar');
                
                if (userNameElement) {
                    userNameElement.textContent = userName;
                } else {
                    console.warn('userName 요소를 찾을 수 없습니다');
                }
                
                if (userAvatarElement) {
                    userAvatarElement.textContent = userName.charAt(0).toUpperCase();
                } else {
                    console.warn('userAvatar 요소를 찾을 수 없습니다');
                }
                
                // 데모 모드 확인 및 설정
                if (isDemoUser) {
                    isDemoMode = true;
                    console.log('데모 모드 활성화됨');
                    
                    // 데모 모드에서는 사용자에게 관리자 권한 부여
                    currentUser.app_metadata = {
                        ...currentUser.app_metadata,
                        account_status: 'approved',
                        global_role: 'super_admin'
                    };
                    
                    // 관리자 탭 표시
                    const adminTab = document.getElementById('adminNavTab');
                    if (adminTab) {
                        adminTab.style.display = 'block';
                    }
                    
                    // 네비게이션 탭 권한 업데이트
                    setTimeout(() => {
                        updateNavigationTabs();
                    }, 100);
                    
                    // 데모 모드인 경우 데모 데이터 로드
                    console.log('데모 데이터 로드 시작');
                    loadDemoData();
                } else {
                    // 실제 사용자 - 정식 모드
                    isDemoMode = false;
                    console.log('정식 모드 활성화됨 - 실제 Supabase 데이터 사용');
                    
                    // 정식 모드 표시기 표시
                    showProductionModeIndicator();
                    
                    // 사용자 권한 정보 가져오기 및 UI 업데이트
                    try {
                        const { data: userProfile } = await supabase
                            .from('users')
                            .select('account_status, global_role, approved_by, approved_at')
                            .eq('id', currentUser.id)
                            .single();
                        
                        if (userProfile) {
                            // 사용자 메타데이터에 권한 정보 추가
                            currentUser.app_metadata = {
                                ...currentUser.app_metadata,
                                account_status: userProfile.account_status,
                                global_role: userProfile.global_role
                            };
                            
                            console.log('사용자 권한 정보:', userProfile);
                            
                            // 슈퍼관리자인 경우 관리자 탭 표시
                            if (userProfile.global_role === 'super_admin') {
                                const adminTab = document.getElementById('adminNavTab');
                                if (adminTab) {
                                    adminTab.style.display = 'block';
                                    console.log('슈퍼관리자 권한 확인 - 관리자 탭 표시');
                                }
                            }
                        }
                    } catch (error) {
                        console.error('사용자 권한 정보 로드 오류:', error);
                    }
                    
                    // 자동 승인으로 처리 (테스트 환경)
                    console.log('정식 모드: 자동 승인 처리');
                    await loadAppData();
                    return true;
                }
                
                return true; // 데모 모드에서는 항상 승인된 것으로 처리
                
            } catch (error) {
                console.error('사용자 프로필 설정 오류:', error);
                // 오류가 있어도 데모 모드로 계속 진행
                isDemoMode = true;
                console.log('오류 발생, 데모 모드로 전환');
                loadDemoData();
                return true; // 오류가 있어도 계속 진행
            }
        }
        
        // Enter 키 처리
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const activeForm = document.querySelector('.login-form[style*="flex"]') || document.getElementById('emailLoginForm');
                if (activeForm === document.getElementById('emailLoginForm')) {
                    loginWithEmail();
                } else if (activeForm === document.getElementById('signupForm')) {
                    signupWithEmail();
                }
            }
        });
        
        // 로그아웃 처리
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                // 실시간 구독 정리
                cleanupRealtimeSubscriptions();
                
                const { error } = await APIManager.auth.signOut();
                if (error) throw error;
                
                // 전역 변수 초기화
                currentUser = null;
                currentWorkspace = null;
                todos = [];
                workspaces = [];
                isDemoMode = false;
                
                // 데모 모드 표시기 제거
                const demoIndicator = document.querySelector('.demo-mode-indicator');
                if (demoIndicator) {
                    demoIndicator.remove();
                }
                
                showLogin();
                
            } catch (error) {
                console.error('로그아웃 오류:', error);
                showNotification('로그아웃에 실패했습니다.', 'error');
            }
        });
        
        // 이 코드는 AuthManager로 통합되었습니다.
        
        // ==================== 실시간 기능 ====================
        
        // 실시간 구독 초기화
        function initializeRealtimeSubscriptions() {
            if (!currentUser || !currentWorkspace || isDemoMode) return;
            
            // 브라우저 알림 권한 요청
            requestNotificationPermission();
            
            // 기존 구독 정리
            cleanupRealtimeSubscriptions();
            
            // 할 일 실시간 구독
            const todosSubscription = supabase
                .channel('todos-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'todos',
                        filter: `workspace_id=eq.${currentWorkspace.id}`
                    }, 
                    handleTodoRealtimeChange
                )
                .subscribe();
            
            // 댓글 실시간 구독
            const commentsSubscription = supabase
                .channel('comments-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'comments'
                    }, 
                    handleCommentRealtimeChange
                )
                .subscribe();
            
            // 프로젝트 실시간 구독
            const projectsSubscription = supabase
                .channel('projects-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'projects',
                        filter: `workspace_id=eq.${currentWorkspace.id}`
                    }, 
                    handleProjectRealtimeChange
                )
                .subscribe();
            
            // 알림 실시간 구독
            const notificationsSubscription = supabase
                .channel('notifications-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'notifications',
                        filter: `user_id=eq.${currentUser.id}`
                    }, 
                    handleNotificationRealtimeChange
                )
                .subscribe();
            
            realtimeSubscriptions.push(
                todosSubscription, 
                commentsSubscription, 
                projectsSubscription, 
                notificationsSubscription
            );
            
            console.log('실시간 구독 초기화 완료');
            
            // 연결 상태 표시
            updateRealtimeStatus(true);
        }
        
        // 실시간 구독 정리
        function cleanupRealtimeSubscriptions() {
            realtimeSubscriptions.forEach(subscription => {
                if (subscription) {
                    supabase.removeChannel(subscription);
                }
            });
            realtimeSubscriptions = [];
            
            // 연결 상태 업데이트
            updateRealtimeStatus(false);
        }
        
        // 할 일 실시간 변경 처리
        function handleTodoRealtimeChange(payload) {
            console.log('실시간 할 일 변경:', payload);
            
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    // 새 할 일 추가
                    if (!todos.find(todo => todo.id === newRecord.id)) {
                        todos.push(newRecord);
                        renderTodos();
                        renderDashboard();
                        showRealtimeNotification('새로운 할 일이 추가되었습니다', 'info');
                    }
                    break;
                    
                case 'UPDATE':
                    // 할 일 업데이트
                    const todoIndex = todos.findIndex(todo => todo.id === newRecord.id);
                    if (todoIndex !== -1) {
                        todos[todoIndex] = newRecord;
                        renderTodos();
                        renderDashboard();
                        
                        // 상태 변경 알림
                        if (oldRecord.status !== newRecord.status) {
                            const statusText = {
                                'pending': '대기 중',
                                'in_progress': '진행 중',
                                'completed': '완료'
                            };
                            showRealtimeNotification(
                                `"${newRecord.title}" 상태가 ${statusText[newRecord.status]}로 변경되었습니다`, 
                                'success'
                            );
                        }
                    }
                    break;
                    
                case 'DELETE':
                    // 할 일 삭제
                    const deleteIndex = todos.findIndex(todo => todo.id === oldRecord.id);
                    if (deleteIndex !== -1) {
                        todos.splice(deleteIndex, 1);
                        renderTodos();
                        renderDashboard();
                        showRealtimeNotification('할 일이 삭제되었습니다', 'warning');
                    }
                    break;
            }
        }
        
        // 댓글 실시간 변경 처리
        function handleCommentRealtimeChange(payload) {
            console.log('실시간 댓글 변경:', payload);
            
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    // 새 댓글 추가
                    if (!todoComments.find(comment => comment.id === newRecord.id)) {
                        todoComments.push(newRecord);
                        
                        // 현재 보고 있는 할 일의 댓글이면 즉시 업데이트
                        if (window.currentDetailTodoId === newRecord.todo_id) {
                            renderComments(newRecord.todo_id);
                        }
                        
                        showRealtimeNotification('새로운 댓글이 추가되었습니다', 'info');
                    }
                    break;
                    
                case 'UPDATE':
                    // 댓글 업데이트
                    const commentIndex = todoComments.findIndex(comment => comment.id === newRecord.id);
                    if (commentIndex !== -1) {
                        todoComments[commentIndex] = newRecord;
                        
                        if (window.currentDetailTodoId === newRecord.todo_id) {
                            renderComments(newRecord.todo_id);
                        }
                    }
                    break;
                    
                case 'DELETE':
                    // 댓글 삭제
                    const deleteIndex = todoComments.findIndex(comment => comment.id === oldRecord.id);
                    if (deleteIndex !== -1) {
                        todoComments.splice(deleteIndex, 1);
                        
                        if (window.currentDetailTodoId === oldRecord.todo_id) {
                            renderComments(oldRecord.todo_id);
                        }
                    }
                    break;
            }
        }
        
        // 프로젝트 실시간 변경 처리
        function handleProjectRealtimeChange(payload) {
            console.log('실시간 프로젝트 변경:', payload);
            
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    if (!projects.find(project => project.id === newRecord.id)) {
                        projects.push(newRecord);
                        renderProjects(); // renderProjectsList를 renderProjects로 수정
                        updateDashboard(); // 대시보드도 업데이트
                        showRealtimeNotification('새로운 프로젝트가 추가되었습니다', 'info');
                    }
                    break;
                    
                case 'UPDATE':
                    const projectIndex = projects.findIndex(project => project.id === newRecord.id);
                    if (projectIndex !== -1) {
                        projects[projectIndex] = newRecord;
                        renderProjects(); // renderProjectsList를 renderProjects로 수정
                        updateDashboard(); // 프로젝트 변경 시 대시보드도 업데이트
                    }
                    break;
                    
                case 'DELETE':
                    const deleteIndex = projects.findIndex(project => project.id === oldRecord.id);
                    if (deleteIndex !== -1) {
                        projects.splice(deleteIndex, 1);
                        renderProjects(); // renderProjectsList를 renderProjects로 수정
                        updateDashboard(); // 프로젝트 삭제 시 대시보드도 업데이트
                        showRealtimeNotification('프로젝트가 삭제되었습니다', 'warning');
                    }
                    break;
            }
        }
        
        // 알림 실시간 변경 처리
        function handleNotificationRealtimeChange(payload) {
            console.log('실시간 알림 변경:', payload);
            
            const { eventType, new: newRecord } = payload;
            
            if (eventType === 'INSERT') {
                // 브라우저 알림 표시
                if (Notification.permission === 'granted') {
                    new Notification(newRecord.title, {
                        body: newRecord.message,
                        icon: '/favicon.ico'
                    });
                }
                
                // 인앱 알림 표시
                showRealtimeNotification(newRecord.message, 'info');
                
                // 알림 목록 업데이트
                loadNotifications();
            }
        }
        
        // 실시간 알림 표시
        function showRealtimeNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `realtime-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'info' ? '🔔' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌'}
                    </span>
                    <span class="notification-message">${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            // 스타일 추가
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                padding: 16px;
                margin-bottom: 10px;
                z-index: 10000;
                max-width: 350px;
                border-left: 4px solid ${type === 'info' ? '#667eea' : type === 'success' ? '#38b2ac' : type === 'warning' ? '#ed8936' : '#e53e3e'};
                animation: slideInRight 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // 5초 후 자동 제거
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // ==================== 랜딩 페이지 모달 관리 ====================
        
        // 로그인 모달 표시
        function showLoginModal() {
            UIManager.showModal('loginModal');
        }
        
        // 로그인 모달 숨기기
        function hideLoginModal() {
            UIManager.hideModal('loginModal');
        }
        
        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideLoginModal();
                hideCreateProjectModal();
                hideEditProjectModal();
                hideProjectContextMenu();
            }
        });
        
        // 유틸리티 함수들
        function getPriorityText(priority) {
            const priorityMap = {
                'high': '높음',
                'medium': '보통',
                'low': '낮음'
            };
            return priorityMap[priority] || priority;
        }
        
        function getPriorityColor(priority) {
            const colorMap = {
                'high': '#ef4444',
                'medium': '#f59e0b',
                'low': '#10b981'
            };
            return colorMap[priority] || '#9ca3af';
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': '대기중',
                'in_progress': '진행중',
                'completed': '완료됨'
            };
            return statusMap[status] || status;
        }
        
        // DOM 요소 및 UI 관리 통합 모듈
        const UIManager = {
            // 캐시된 DOM 요소들
            elements: new Map(),
            
            // DOM 요소 가져오기 및 캐싱
            getElement: function(id) {
                if (!this.elements.has(id)) {
                    const element = document.getElementById(id);
                    if (element) {
                        this.elements.set(id, element);
                    }
                }
                return this.elements.get(id);
            },
            
            // 여러 요소 한번에 가져오기
            getElements: function(ids) {
                const result = {};
                ids.forEach(id => {
                    result[id] = this.getElement(id);
                });
                return result;
            },
            
            // 요소 표시/숨김 (타입별)
            setDisplay: function(elementId, display) {
                const element = this.getElement(elementId);
                if (element) {
                    element.style.display = display;
                }
            },
            
            // 텍스트 설정
            setText: function(elementId, text) {
                const element = this.getElement(elementId);
                if (element) {
                    element.textContent = text;
                }
            },
            
            // 값 설정
            setValue: function(elementId, value) {
                const element = this.getElement(elementId);
                if (element) {
                    element.value = value;
                }
            },
            
            // 클래스 추가/제거
            toggleClass: function(elementId, className, add = true) {
                const element = this.getElement(elementId);
                if (element) {
                    if (add) {
                        element.classList.add(className);
                    } else {
                        element.classList.remove(className);
                    }
                }
            },
            
            // 알림 표시
            showNotification: function(message, type = 'success') {
                const notification = this.getElement('notification');
                if (notification) {
                    notification.textContent = message;
                    notification.className = `notification ${type}`;
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
            },
            
            // 로딩 상태 관리
            showLoading: function(message = '로딩 중...') {
                this.setText('loadingMessage', message);
                this.setDisplay('loading', 'flex');
            },
            
            hideLoading: function() {
                this.setDisplay('loading', 'none');
            },
            
            // 화면 전환 통합
            showScreen: function(screenType) {
                // 모든 화면 숨기기
                const screens = [
                    'loading', 'loginContainer', 'approvalPendingContainer',
                    'approvalRejectedContainer', 'accountSuspendedContainer'
                ];
                
                screens.forEach(screen => {
                    this.setDisplay(screen, 'none');
                });
                
                // 앱 컨테이너 클래스 제거
                this.toggleClass('appContainer', 'show', false);
                
                // 선택된 화면 표시
                switch (screenType) {
                    case 'login':
                        this.setDisplay('loginContainer', 'flex');
                        break;
                    case 'app':
                        this.toggleClass('appContainer', 'show', true);
                        break;
                    case 'approvalPending':
                        this.setDisplay('approvalPendingContainer', 'flex');
                        this.updateUserEmail('pendingUserEmail');
                        break;
                    case 'approvalRejected':
                        this.setDisplay('approvalRejectedContainer', 'flex');
                        this.updateUserEmail('rejectedUserEmail');
                        break;
                    case 'accountSuspended':
                        this.setDisplay('accountSuspendedContainer', 'flex');
                        this.updateUserEmail('suspendedUserEmail');
                        break;
                }
            },
            
            // 사용자 이메일 업데이트
            updateUserEmail: function(elementId) {
                if (currentUser && currentUser.email) {
                    this.setText(elementId, currentUser.email);
                }
            },
            
            // 사용자 정보 UI 업데이트
            updateUserInfo: function(user) {
                const userName = user.display_name || user.full_name || user.email.split('@')[0];
                this.setText('userName', userName);
                this.setText('userAvatar', userName.charAt(0).toUpperCase());
                
                // 관리자 탭 표시 여부
                const isAdmin = user.global_role === 'super_admin' || user.global_role === 'admin';
                this.setDisplay('adminNavTab', isAdmin ? 'block' : 'none');
            },
            
            // 모달 관리
            showModal: function(modalId) {
                this.setDisplay(modalId, 'flex');
            },
            
            hideModal: function(modalId) {
                this.setDisplay(modalId, 'none');
            },
            
            // 폼 초기화
            resetForm: function(formFields) {
                Object.entries(formFields).forEach(([fieldId, defaultValue]) => {
                    this.setValue(fieldId, defaultValue || '');
                });
            },
            
            // 통계 업데이트
            updateStats: function(stats) {
                Object.entries(stats).forEach(([elementId, value]) => {
                    this.setText(elementId, value);
                });
            }
        };
        
        // 에러 처리 통합 모듈
        const ErrorManager = {
            // 표준 에러 처리 (console.error + showNotification)
            handle: function(error, userMessage, context = '') {
                const contextPrefix = context ? `${context}: ` : '';
                console.error(contextPrefix + error.message || error);
                UIManager.showNotification(userMessage, 'error');
            },
            
            // 로그만 남기고 알림은 안함
            log: function(error, context = '') {
                const contextPrefix = context ? `${context}: ` : '';
                console.error(contextPrefix + (error.message || error));
            },
            
            // 성공 메시지 처리
            success: function(message) {
                UIManager.showNotification(message, 'success');
            },
            
            // 경고 메시지 처리
            warning: function(message) {
                UIManager.showNotification(message, 'warning');
            },
            
            // 정보 메시지 처리
            info: function(message) {
                UIManager.showNotification(message, 'info');
            },
            
            // API 에러 특별 처리
            handleApiError: function(error, operation) {
                let userMessage = `${operation} 중 오류가 발생했습니다`;
                
                // 특정 에러 타입에 따른 메시지 커스터마이징
                if (error.message) {
                    if (error.message.includes('network')) {
                        userMessage = '네트워크 연결을 확인해주세요';
                    } else if (error.message.includes('unauthorized')) {
                        userMessage = '권한이 없습니다';
                    } else if (error.message.includes('not found')) {
                        userMessage = '요청한 데이터를 찾을 수 없습니다';
                    } else {
                        userMessage += `: ${error.message}`;
                    }
                }
                
                this.handle(error, userMessage, operation);
            },
            
            // 폼 유효성 검사 에러
            validation: function(message) {
                UIManager.showNotification(message, 'error');
            }
        };
        
        // 기존 함수들의 래퍼 (하위 호환성)
        function showNotification(message, type = 'success') {
            UIManager.showNotification(message, type);
        }
        
        console.log('TeamTodo 앱이 초기화되었습니다.');
        

        
        // ==================== 달력 관리 ====================
        
        // 달력 뷰 전환
        function switchCalendarView(view) {
            calendarView = view;
            
            // 버튼 활성화 상태 변경
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + 'ViewBtn').classList.add('active');
            
            renderCalendar();
        }
        
        // 달력 렌더링 (월간/주간 지원)
        function renderCalendar() {
            if (calendarView === 'month') {
                renderMonthCalendar();
            } else {
                renderWeekCalendar();
            }
        }
        
        // 월간 달력 렌더링
        function renderMonthCalendar() {
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', 
                              '7월', '8월', '9월', '10월', '11월', '12월'];
            
            const currentPeriodElement = document.getElementById('currentPeriod');
            if (!currentPeriodElement) {
                console.warn('currentPeriod 요소를 찾을 수 없습니다.');
                return;
            }
            
            currentPeriodElement.textContent = 
                `${currentDate.getFullYear()}년 ${monthNames[currentDate.getMonth()]}`;
            
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '<div id="monthCalendar" class="calendar-days"></div>';
            
            const calendarDays = document.getElementById('monthCalendar');
            calendarDays.className = 'calendar-days';
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                const isToday = date.toDateString() === today.toDateString();
                
                // 해당 날짜의 할 일들 찾기 (한국 시간 기준)
                const dateStr = DateUtils.formatKST(date); // YYYY-MM-DD 형식 (KST)
                const dayTodos = todos.filter(todo => {
                    // 로그로 확인 (개발 시 디버깅용, 실제 배포 시 제거)
                    console.log('Calendar checking todo:', todo.title, 'due_date:', todo.due_date, 'start_date:', todo.start_date, 'dateStr:', dateStr);
                    
                    // 워크스페이스 검증 (먼저 확인)
                    if (todo.workspace_id !== currentWorkspace?.id) {
                        return false;
                    }
                    
                    // 날짜 정보가 모두 없는 경우
                    if (!todo.start_date && !todo.due_date) {
                        return false;
                    }
                    
                    // 표준화된 날짜 문자열로 변환 (일관성을 위해)
                    let startDateStr = todo.start_date;
                    let dueDateStr = todo.due_date;
                    
                    // 날짜 문자열이 YYYY-MM-DD 형식인지 확인
                    if (startDateStr && !startDateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        try {
                            startDateStr = new Date(startDateStr).toISOString().split('T')[0];
                        } catch (e) {
                            console.error('Invalid start date format:', startDateStr);
                            startDateStr = null;
                        }
                    }
                    
                    if (dueDateStr && !dueDateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        try {
                            dueDateStr = new Date(dueDateStr).toISOString().split('T')[0];
                        } catch (e) {
                            console.error('Invalid due date format:', dueDateStr);
                            dueDateStr = null;
                        }
                    }
                    
                    // 시작일과 마감일이 모두 있는 경우 (기간 설정)
                    if (startDateStr && dueDateStr) {
                        return startDateStr <= dateStr && dueDateStr >= dateStr;
                    }
                    // 마감일만 있는 경우
                    else if (dueDateStr) {
                        return dueDateStr === dateStr;
                    }
                    // 시작일만 있는 경우
                    else if (startDateStr) {
                        return startDateStr === dateStr;
                    }
                    
                    return false;
                });
                
                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${dayTodos.length > 0 ? 'has-todos' : ''}`;
                dayElement.onclick = (event) => handleDateClick(event, dateStr, dayTodos);
                
                const todoElements = dayTodos.slice(0, 5).map(todo => {
                    const project = projects.find(p => p.id === todo.project_id);
                    return `<div class="day-todo ${todo.priority} ${todo.status === 'completed' ? 'completed' : ''}" 
                                 title="${todo.title} (${project?.name || '프로젝트 없음'})" 
                                 style="background: ${project?.color || '#6b7280'}"></div>`;
                }).join('');
                
                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-todos">${todoElements}</div>
                    ${dayTodos.length > 5 ? `<div class="more-todos">+${dayTodos.length - 5}</div>` : ''}
                `;
                
                calendarDays.appendChild(dayElement);
            }
        }
        
        // 주간 달력 렌더링
        function renderWeekCalendar() {
            const startOfWeek = getStartOfWeek(currentDate);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            document.getElementById('currentPeriod').textContent = 
                `${startOfWeek.getFullYear()}년 ${startOfWeek.getMonth() + 1}월 ${startOfWeek.getDate()}일 - ${endOfWeek.getMonth() + 1}월 ${endOfWeek.getDate()}일`;
            
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '<div id="weekCalendar" class="week-view"></div>';
            
            const weekCalendar = document.getElementById('weekCalendar');
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const isToday = date.toDateString() === today.toDateString();
                const dateStr = DateUtils.formatKST(date);
                
                // 해당 날짜의 할 일들 찾기
                const dayTodos = todos.filter(todo => {
                    // 로그로 확인 (개발 시 디버깅용, 실제 배포 시 제거)
                    console.log('Week Calendar checking todo:', todo.title, 'due_date:', todo.due_date, 'start_date:', todo.start_date, 'dateStr:', dateStr);
                    
                    // 워크스페이스 검증 (먼저 확인)
                    if (todo.workspace_id !== currentWorkspace?.id) {
                        return false;
                    }
                    
                    // 날짜 정보가 모두 없는 경우
                    if (!todo.start_date && !todo.due_date) {
                        return false;
                    }
                    
                    // 표준화된 날짜 문자열로 변환 (일관성을 위해)
                    let startDateStr = todo.start_date;
                    let dueDateStr = todo.due_date;
                    
                    // 날짜 문자열이 YYYY-MM-DD 형식인지 확인
                    if (startDateStr && !startDateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        try {
                            startDateStr = new Date(startDateStr).toISOString().split('T')[0];
                        } catch (e) {
                            console.error('Invalid start date format:', startDateStr);
                            startDateStr = null;
                        }
                    }
                    
                    if (dueDateStr && !dueDateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        try {
                            dueDateStr = new Date(dueDateStr).toISOString().split('T')[0];
                        } catch (e) {
                            console.error('Invalid due date format:', dueDateStr);
                            dueDateStr = null;
                        }
                    }
                    
                    // 시작일과 마감일이 모두 있는 경우 (기간 설정)
                    if (startDateStr && dueDateStr) {
                        return startDateStr <= dateStr && dueDateStr >= dateStr;
                    }
                    // 마감일만 있는 경우
                    else if (dueDateStr) {
                        return dueDateStr === dateStr;
                    }
                    // 시작일만 있는 경우
                    else if (startDateStr) {
                        return startDateStr === dateStr;
                    }
                    
                    return false;
                });
                
                const dayElement = document.createElement('div');
                dayElement.className = `week-day ${isToday ? 'today' : ''}`;
                dayElement.onclick = (event) => handleDateClick(event, dateStr, dayTodos);
                
                const todoElements = dayTodos.slice(0, 8).map(todo => {
                    const project = projects.find(p => p.id === todo.project_id);
                    return `<div class="week-todo-item ${todo.priority} ${todo.status === 'completed' ? 'completed' : ''}" 
                                 title="${todo.title} (${project?.name || '프로젝트 없음'})"
                                 style="background: ${project?.color || '#6b7280'}">
                                ${todo.title}
                            </div>`;
                }).join('');
                
                dayElement.innerHTML = `
                    <div class="week-day-number">${date.getDate()}</div>
                    <div class="week-day-todos">${todoElements}</div>
                    ${dayTodos.length > 8 ? `<div class="more-todos">+${dayTodos.length - 8}개 더</div>` : ''}
                `;
                
                weekCalendar.appendChild(dayElement);
            }
        }
        
        // 주의 시작일 계산
        function getStartOfWeek(date) {
            const start = new Date(date);
            const day = start.getDay();
            const diff = start.getDate() - day;
            return new Date(start.setDate(diff));
        }
        
        // 달력 날짜 클릭 처리 (성능 최적화 및 안전장치 포함)
        function handleDateClick(event, dateStr, dayTodos) {
            // 이미 클릭 처리 중인지 확인하는 플래그
            let clickedElement = null;
            
            try {
                // 이벤트 전파 중단
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    clickedElement = event.currentTarget; // target 대신 currentTarget 사용하여 정확한 요소 선택
                }
                
                // 모달이 이미 열려있는지 빠르게 확인
                if (isDateModalOpen) {
                    console.log('모달이 이미 열려있음');
                    return;
                }
                
                // 클릭 방지 확인
                if (!clickedElement || 
                    clickedElement.classList.contains('click-disabled') || 
                    clickedElement.classList.contains('click-processing')) {
                    return;
                }
                
                // 디바운스 체크 (빠른 연속 클릭 방지) - 디바운스 시간 감소
                const currentTime = Date.now();
                if (currentTime - lastClickTime < 150) { // 300ms에서 150ms로 감소
                    return;
                }
                lastClickTime = currentTime;
                
                // 유효한 날짜인지 확인
                if (!dateStr || typeof dateStr !== 'string') {
                    console.error('유효하지 않은 날짜:', dateStr);
                    return;
                }
                
                // 클릭 처리 시작 표시 - CSS 클래스 즉시 추가
                if (clickedElement) {
                    clickedElement.classList.add('click-processing');
                }
                
                // 모달 상태 미리 설정
                isDateModalOpen = true;
                window.selectedDate = dateStr;
                
                // 모달 표시를 비동기로 처리하여 UI 차단 방지
                setTimeout(() => {
                    showDateModal(dateStr, dayTodos);
                    
                    // 처리 완료 후 클래스 제거
                    if (clickedElement) {
                        clickedElement.classList.remove('click-processing');
                    }
                }, 10); // 매우 짧은 지연으로 UI 스레드 차단 방지
                
            } catch (error) {
                console.error('날짜 클릭 처리 중 오류:', error);
                
                // 오류 발생 시 클래스 정리
                if (clickedElement) {
                    clickedElement.classList.remove('click-processing');
                }
                
                // 안전장치 변수 초기화
                isDateModalOpen = false;
                window.selectedDate = null;
            }
        }
        
        // 향상된 날짜 모달 표시 (성능 최적화)
        function showDateModal(dateStr, dayTodos) {
            try {
                // 모달 요소 캐싱 (DOM 접근 최소화)
                const modalTitleElement = document.getElementById('dateModalTitle');
                const modalElement = document.getElementById('dateModal');
                const container = document.getElementById('dateModalTodos');
                
                if (!modalTitleElement || !modalElement || !container) {
                    console.error('모달 요소를 찾을 수 없습니다.');
                    isDateModalOpen = false;
                    window.selectedDate = null;
                    return;
                }
                
                // 날짜 문자열 직접 파싱 (빠른 처리)
                let dateObj;
                try {
                    // 간단한 직접 파싱 시도 (YYYY-MM-DD 형식 가정)
                    const [year, month, day] = dateStr.split('-').map(num => parseInt(num, 10));
                    dateObj = new Date(year, month - 1, day, 12, 0, 0); // 정오로 설정하여 날짜 경계 문제 방지
                } catch (e) {
                    // 실패하면 DateUtils 사용 (더 안전하지만 느릴 수 있음)
                    dateObj = DateUtils.parseKST(dateStr);
                }
                
                const dateTitle = `${dateObj.getFullYear()}년 ${dateObj.getMonth() + 1}월 ${dateObj.getDate()}일 할 일`;
                
                // UI 업데이트
                modalTitleElement.textContent = dateTitle;
                modalElement.style.display = 'flex';
            
            // 이미 container DOM 요소는 위에서 캐싱됨
            container.innerHTML = '';
            
            // 할 일이 없는 경우 간단하게 처리
            if (!dayTodos || dayTodos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <div style="font-size: 32px; margin-bottom: 10px;">📅</div>
                        <p>이 날짜에는 할 일이 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            // 성능 최적화: DocumentFragment 사용으로 DOM 조작 최소화
            const fragment = document.createDocumentFragment();
            
            // 상태 텍스트와 색상 미리 정의
            const statusText = {
                'pending': '대기중',
                'in_progress': '진행중',
                'completed': '완료'
            };
            
            const statusColor = {
                'pending': '#f59e0b',
                'in_progress': '#3b82f6',
                'completed': '#10b981'
            };
            
            // 할 일 목록 렌더링
            dayTodos.forEach(todo => {
                const project = projects.find(p => p.id === todo.project_id);
                const todoElement = document.createElement('div');
                todoElement.className = 'enhanced-date-todo-item';
                
                // 이벤트 리스너 위임으로 메모리 사용 개선
                todoElement.dataset.todoId = todo.id;
                
                // 날짜 정보 구성 (포맷팅 최적화)
                const dateInfo = [];
                if (todo.start_date) {
                    const startDate = new Date(todo.start_date);
                    dateInfo.push(`시작: ${startDate.getMonth() + 1}/${startDate.getDate()}`);
                }
                if (todo.due_date) {
                    const dueDate = new Date(todo.due_date);
                    dateInfo.push(`마감: ${dueDate.getMonth() + 1}/${dueDate.getDate()}`);
                }
                
                // 최적화된 HTML 템플릿 (불필요한 공백 제거 및 템플릿 간소화)
                todoElement.innerHTML = `
                    <div class="todo-color-indicator" style="background:${project?.color || '#6b7280'}"></div>
                    <div class="todo-main-info">
                        <div class="todo-title-enhanced">${todo.title}</div>
                        <div class="todo-meta-info">
                            <span class="todo-project-name" style="background:${project?.color}20;color:${project?.color || '#4a5568'}">${project?.name || '프로젝트 없음'}</span>
                            ${dateInfo.length > 0 ? `<span class="todo-dates-info">${dateInfo.join(' • ')}</span>` : ''}
                        </div>
                        ${todo.description ? `<div class="todo-description-preview">${todo.description.length > 60 ? todo.description.substring(0, 60) + '...' : todo.description}</div>` : ''}
                    </div>
                    <div class="todo-status-indicator">
                        <span class="todo-status-badge" style="background:${statusColor[todo.status]}">${statusText[todo.status]}</span>
                    </div>
                `;
                
                // DocumentFragment에 추가하여 성능 개선
                fragment.appendChild(todoElement);
            });
            
            // 이벤트 위임으로 이벤트 리스너 등록 (개별 요소마다 등록하지 않음)
            container.addEventListener('click', (e) => {
                // 클릭된 할 일 요소 찾기
                const todoItem = e.target.closest('.enhanced-date-todo-item');
                if (todoItem && todoItem.dataset.todoId) {
                    showTodoDetailModal(todoItem.dataset.todoId);
                }
            }, { once: false }); // 이벤트 리스너는 계속 유지
            
            // 모든 할 일 요소를 한 번에 DOM에 추가 (성능 최적화)
            container.appendChild(fragment);
                
                console.log('날짜 모달이 성공적으로 열렸습니다:', dateTitle);
                
            } catch (error) {
                console.error('날짜 모달 표시 중 오류:', error);
                isDateModalOpen = false;
            }
        }
        
        // 할 일 상세보기 모달 표시
        function showTodoDetailModal(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo) return;
            
            const project = projects.find(p => p.id === todo.project_id);
            const modalElement = document.getElementById('todoDetailModal');
            
            if (!modalElement) return;
            
            document.getElementById('todoDetailTitle').textContent = todo.title;
            // 다른 모든 모달 먼저 닫기
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                if (modal.id !== 'todoDetailModal') {
                    modal.style.display = 'none';
                }
            });
            
            // 모달을 body 맨 끝으로 이동 (다른 요소의 간섭 방지)
            document.body.appendChild(modalElement);
            
            // 모달 강제 표시
            modalElement.style.setProperty('display', 'flex', 'important');
            modalElement.style.setProperty('visibility', 'visible', 'important');
            modalElement.style.setProperty('opacity', '1', 'important');
            modalElement.style.setProperty('z-index', '9999', 'important');
            modalElement.style.setProperty('position', 'fixed', 'important');
            modalElement.style.setProperty('top', '0', 'important');
            modalElement.style.setProperty('left', '0', 'important');
            modalElement.style.setProperty('width', '100%', 'important');
            modalElement.style.setProperty('height', '100%', 'important');
            modalElement.style.setProperty('background', 'rgba(0,0,0,0.5)', 'important');
            modalElement.style.setProperty('align-items', 'center', 'important');
            modalElement.style.setProperty('justify-content', 'center', 'important');
            
            const statusText = {
                'pending': '대기중',
                'in_progress': '진행중',
                'completed': '완료'
            };
            
            const priorityText = {
                'low': '낮음',
                'medium': '보통',
                'high': '높음'
            };
            
            const content = document.getElementById('todoDetailContent');
            if (!content) return;
            
            content.innerHTML = `
                <div class="todo-detail-section">
                    <h4>프로젝트</h4>
                    <div class="todo-detail-value" style="display: flex; align-items: center; gap: 8px;">
                        <div class="project-color" style="background: ${project?.color || '#6b7280'}"></div>
                        ${project?.name || '프로젝트 없음'}
                    </div>
                </div>
                
                <div class="todo-detail-section">
                    <h4>상태 및 우선순위</h4>
                    <div class="todo-detail-value">
                        상태: <strong>${statusText[todo.status]}</strong> • 
                        우선순위: <strong>${priorityText[todo.priority]}</strong>
                    </div>
                </div>
                
                ${todo.start_date || todo.due_date ? `
                    <div class="todo-detail-section">
                        <h4>일정</h4>
                        <div class="todo-dates-grid">
                            ${todo.start_date ? `
                                <div>
                                    <strong>시작일</strong><br>
                                    <span class="todo-detail-value">${new Date(todo.start_date).toLocaleDateString()}</span>
                                </div>
                            ` : ''}
                            ${todo.due_date ? `
                                <div>
                                    <strong>마감일</strong><br>
                                    <span class="todo-detail-value">${new Date(todo.due_date).toLocaleDateString()}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${todo.description ? `
                    <div class="todo-detail-section">
                        <h4>상세 설명</h4>
                        <div class="todo-detail-value">${escapeHTML(todo.description)}</div>
                    </div>
                ` : ''}
                
                <div class="todo-detail-section">
                    <h4>생성 정보</h4>
                    <div class="todo-detail-value">
                        생성일: ${new Date(todo.created_at).toLocaleString()}
                        ${todo.completed_at ? `<br>완료일: ${new Date(todo.completed_at).toLocaleString()}` : ''}
                    </div>
                </div>
            `;
            
            // 상태 변경 버튼 업데이트
            const statusBtn = document.getElementById('todoStatusBtn');
            if (todo.status === 'completed') {
                statusBtn.style.display = 'none';
            } else {
                statusBtn.style.display = 'inline-block';
                statusBtn.textContent = todo.status === 'pending' ? '시작하기' : '완료하기';
            }
            
            // 현재 할 일 ID 저장
            window.currentDetailTodoId = todoId;
            
            // 댓글 렌더링
            renderComments(todoId);

        }
        
        // 댓글 렌더링
        function renderComments(todoId) {
            const commentsList = document.getElementById('commentsList');
            const commentCountBadge = document.getElementById('commentCount');
            
            const comments = todoComments.filter(comment => comment.todo_id === todoId)
                .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            commentCountBadge.textContent = comments.length;
            commentsList.innerHTML = '';
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <div style="font-size: 24px; margin-bottom: 10px;">💬</div>
                        <p>아직 댓글이 없습니다.</p>
                        <p>첫 번째 댓글을 작성해보세요!</p>
                    </div>
                `;
                return;
            }
            
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-item';
                commentElement.dataset.commentId = comment.id;
                
                const isOwnComment = comment.author_id === currentUser.id;
                const timeAgo = getTimeAgo(new Date(comment.created_at));
                
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${escapeHTML(comment.author)}</span>
                        <span class="comment-time">${timeAgo}</span>
                    </div>
                    <div class="comment-content" id="commentContent-${comment.id}">${escapeHTML(comment.content)}</div>
                    ${isOwnComment ? `
                        <div class="comment-actions">
                            <button class="comment-action-btn" onclick="editComment('${comment.id}')">수정</button>
                            <button class="comment-action-btn" onclick="deleteComment('${comment.id}')" style="color: #e53e3e;">삭제</button>
                        </div>
                    ` : ''}
                `;
                
                commentsList.appendChild(commentElement);
            });
            
            // 스크롤을 맨 아래로
            commentsList.scrollTop = commentsList.scrollHeight;
        }
        
        // 댓글 추가
        async function addComment() {
            const commentInput = document.getElementById('commentInput');
            const content = commentInput.value.trim();
            
            if (!content) {
                showNotification('댓글 내용을 입력해주세요.', 'error');
                return;
            }
            
            if (!window.currentDetailTodoId) {
                showNotification('오류가 발생했습니다.', 'error');
                return;
            }
            
            try {
                if (isDemoMode) {
                    // 데모 모드: localStorage 사용
                    const newComment = {
                        id: 'comment-' + Date.now(),
                        todo_id: window.currentDetailTodoId,
                        author: currentUser.user_metadata?.full_name || '데모 사용자',
                        author_id: currentUser.id,
                        content: content,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    todoComments.push(newComment);
                    localStorage.setItem('demo_comments', JSON.stringify(todoComments));
                    renderComments(window.currentDetailTodoId);
                } else {
                    // 실제 모드: Supabase 사용 (실시간 동기화)
                    const { error } = await APIManager.insert('comments', {
                        todo_id: window.currentDetailTodoId,
                        user_id: currentUser.id,
                        content: content
                    }, {
                        errorMessage: '댓글 추가 실패'
                    });
                    
                    if (error) throw error;
                    
                    // 실시간 구독을 통해 자동으로 업데이트됨
                }
                
                // 입력 필드 초기화
                commentInput.value = '';
                showNotification('댓글이 추가되었습니다!', 'success');
                
            } catch (error) {
                console.error('댓글 추가 오류:', error);
                showNotification('댓글 추가 중 오류가 발생했습니다.', 'error');
            }
        }
        
        // 댓글 편집
        function editComment(commentId) {
            const comment = todoComments.find(c => c.id === commentId);
            if (!comment || comment.author_id !== currentUser.id) return;
            
            const contentElement = document.getElementById(`commentContent-${commentId}`);
            const originalContent = comment.content;
            
            contentElement.innerHTML = `
                <textarea class="comment-edit-textarea" id="editTextarea-${commentId}">${originalContent}</textarea>
                <div class="comment-edit-actions">
                    <button class="btn-comment-save" onclick="saveCommentEdit('${commentId}')">저장</button>
                    <button class="btn-comment-cancel" onclick="cancelCommentEdit('${commentId}', '${originalContent.replace(/'/g, "\\'")}')">취소</button>
                </div>
            `;
            
            document.getElementById(`editTextarea-${commentId}`).focus();
        }
        
        // 댓글 편집 저장
        function saveCommentEdit(commentId) {
            const textarea = document.getElementById(`editTextarea-${commentId}`);
            const newContent = textarea.value.trim();
            
            if (!newContent) {
                showNotification('댓글 내용을 입력해주세요.', 'error');
                return;
            }
            
            const commentIndex = todoComments.findIndex(c => c.id === commentId);
            if (commentIndex === -1) return;
            
            todoComments[commentIndex].content = newContent;
            todoComments[commentIndex].updated_at = new Date().toISOString();
            
            localStorage.setItem('demo_comments', JSON.stringify(todoComments));
            
            renderComments(window.currentDetailTodoId);
            showNotification('댓글이 수정되었습니다!');
        }
        
        // 댓글 편집 취소
        function cancelCommentEdit(commentId, originalContent) {
            const contentElement = document.getElementById(`commentContent-${commentId}`);
            contentElement.innerHTML = originalContent;
        }
        
        // 댓글 삭제
        function deleteComment(commentId) {
            if (!confirm('댓글을 삭제하시겠습니까?')) return;
            
            const commentIndex = todoComments.findIndex(c => c.id === commentId);
            if (commentIndex === -1) return;
            
            const comment = todoComments[commentIndex];
            if (comment.author_id !== currentUser.id) {
                showNotification('본인의 댓글만 삭제할 수 있습니다.', 'error');
                return;
            }
            
            todoComments.splice(commentIndex, 1);
            localStorage.setItem('demo_comments', JSON.stringify(todoComments));
            
            renderComments(window.currentDetailTodoId);
            renderTodos(); // 댓글 수 업데이트
            showNotification('댓글이 삭제되었습니다.');
        }
        
        // 할 일 상세보기 모달 닫기
        function closeTodoDetailModal() {
            document.getElementById('todoDetailModal').style.display = 'none';
            window.currentDetailTodoId = null;
        }
        
        // 상세보기에서 상태 변경
        function toggleTodoStatusFromDetail() {
            if (window.currentDetailTodoId) {
                toggleTodoStatus(window.currentDetailTodoId);
                closeTodoDetailModal();
            }
        }
        
        // 상세보기에서 편집
        function editTodoFromDetail() {
            const todoId = window.currentDetailTodoId;
            if (!todoId) return;
            
            const todo = todos.find(t => t.id === todoId);
            if (!todo) {
                showNotification('할 일을 찾을 수 없습니다.', 'error');
                return;
            }
            
            // 편집 모달 열기
            showEditTodoModal(todo);
        }
        
        // 할 일 편집 모달 표시
        function showEditTodoModal(todo) {
            // 할 일 상세 모달 닫기
            closeTodoDetailModal();
            
            // 폼 필드에 기존 데이터 채우기
            document.getElementById('editTodoId').value = todo.id;
            document.getElementById('editTodoTitle').value = todo.title || '';
            document.getElementById('editTodoDesc').value = todo.description || '';
            document.getElementById('editTodoPriority').value = todo.priority || 'medium';
            
            // 마감일 설정
            const datePickerElement = document.getElementById('editTodoDueDate');
            if (datePickerElement) {
                if (todo.due_date) {
                    datePickerElement.value = todo.due_date;
                } else {
                    datePickerElement.value = '';
                }
            }
            
            // Flatpickr 날짜 선택기 초기화
            if (!window.editTodoDatePicker) {
                window.editTodoDatePicker = flatpickr('#editTodoDueDate', {
                    dateFormat: 'Y-m-d',
                    locale: 'ko',
                    allowInput: true,
                    altInput: true,
                    altFormat: 'Y년 m월 d일',
                    minDate: 'today'
                });
            } else {
                window.editTodoDatePicker.setDate(todo.due_date || '', true);
            }
            
            // 모달 표시 (강화된 버전)
            const modalElement = document.getElementById('editTodoModal');
            if (modalElement) {
                console.log('편집 모달 표시 시작, 할 일 ID:', todo.id);
                
                // 모달을 body의 끝으로 이동하여 z-index 문제 해결
                document.body.appendChild(modalElement);
                
                // 강제 표시 스타일 적용
                modalElement.style.setProperty('display', 'flex', 'important');
                modalElement.style.setProperty('visibility', 'visible', 'important');
                modalElement.style.setProperty('opacity', '1', 'important');
                modalElement.style.setProperty('z-index', '9999', 'important');
                
                // 제목 필드에 포커스
                setTimeout(() => {
                    const titleField = document.getElementById('editTodoTitle');
                    if (titleField) {
                        titleField.focus();
                        console.log('편집 모달 제목 필드에 포커스 설정됨');
                    } else {
                        console.warn('편집 모달의 제목 필드를 찾을 수 없음');
                    }
                }, 100);
            } else {
                console.error('editTodoModal 요소를 찾을 수 없음');
            }
        }
        
        // 할 일 편집 모달 닫기 (강화된 버전)
        function closeEditTodoModal() {
            const modalElement = document.getElementById('editTodoModal');
            if (modalElement) {
                console.log('편집 모달 닫기');
                modalElement.style.display = 'none';
                
                // 모달 닫은 후 폼 초기화 (선택사항)
                const form = document.getElementById('editTodoForm');
                if (form) {
                    form.reset();
                }
            } else {
                console.error('편집 모달 요소를 찾을 수 없음');
            }
        }
        
        // 할 일 업데이트
        async function updateTodo(event) {
            event.preventDefault();
            console.log('할 일 업데이트 함수 호출됨');
            
            const todoId = document.getElementById('editTodoId').value;
            const title = document.getElementById('editTodoTitle').value.trim();
            const description = document.getElementById('editTodoDesc').value.trim();
            const dueDate = document.getElementById('editTodoDueDate').value;
            const priority = document.getElementById('editTodoPriority').value;
            
            console.log('업데이트할 할 일 정보:', {
                id: todoId,
                title: title,
                description: description,
                dueDate: dueDate,
                priority: priority
            });
            
            if (!title) {
                showNotification('할 일 제목을 입력해주세요.', 'error');
                return;
            }
            
            // 기존 할 일 찾기
            const todoIndex = todos.findIndex(t => t.id === todoId);
            if (todoIndex === -1) {
                showNotification('할 일을 찾을 수 없습니다.', 'error');
                return;
            }
            
            try {
                // 업데이트된 할 일 객체
                const updatedTodo = {
                    ...todos[todoIndex],
                    title: title,
                    description: description || null,
                    due_date: dueDate || null,
                    priority: priority,
                    updated_at: new Date().toISOString()
                };
                
                // 데모 모드인지 확인
                if (isDemoMode) {
                    // 데모 모드: 로컬에서 업데이트
                    todos[todoIndex] = updatedTodo;
                    localStorage.setItem('demo_todos', JSON.stringify(todos));
                    
                    // UI 업데이트
                    console.log('할 일이 업데이트됨, UI 갱신 시작');
                    renderTodos();
                    renderCalendar();
                    updateDashboard(); // 대시보드도 업데이트
                    showNotification('할 일이 성공적으로 업데이트되었습니다.');
                    console.log('UI 갱신 완료');
                } else {
                    // 실제 모드: Supabase에 저장
                    const { error } = await supabase
                        .from('todos')
                        .update({
                            title: title,
                            description: description || null,
                            due_date: dueDate || null,
                            priority: priority
                        })
                        .eq('id', todoId);
                    
                    if (error) throw error;
                    
                    // 로컬 상태 업데이트 (실시간 구독이 있더라도 UI를 빠르게 업데이트)
                    todos[todoIndex] = updatedTodo;
                    
                    showNotification('할 일이 성공적으로 업데이트되었습니다.');
                }
                
                // 모달 닫기
                closeEditTodoModal();
                
            } catch (error) {
                console.error('할 일 업데이트 중 오류 발생:', error);
                showNotification('할 일 업데이트 중 오류가 발생했습니다.', 'error');
            }
        }
        
        // 상세보기에서 삭제
        function deleteTodoFromDetail() {
            if (window.currentDetailTodoId) {
                deleteTodo(window.currentDetailTodoId);
                closeTodoDetailModal();
            }
        }
        
        // 날짜 모달 닫기
        function closeDateModal() {
            try {
                const modalElement = document.getElementById('dateModal');
                if (modalElement) {
                    modalElement.style.display = 'none';
                }
                
                // 안전장치 변수 초기화
                isDateModalOpen = false;
                window.selectedDate = null;
                
                console.log('날짜 모달이 닫혔습니다.');
                
            } catch (error) {
                console.error('날짜 모달 닫기 중 오류:', error);
                // 오류가 발생해도 상태는 초기화
                isDateModalOpen = false;
                window.selectedDate = null;
            }
        }
        
        // 선택된 날짜에 할 일 추가
        function addTodoForDate() {
            if (window.selectedDate) {
                // 할 일 탭으로 이동
                showSection('todos');
                
                // 한국 시간 기준으로 날짜 파싱
                console.log('Selected date for todo:', window.selectedDate);
                const dateObj = DateUtils.parseKST(window.selectedDate);
                
                // Flatpickr 달력 인스턴스 가져오기
                const dueDatePicker = document.getElementById('todoDueDate')._flatpickr;
                if (dueDatePicker) {
                    // Flatpickr에 설정
                    dueDatePicker.setDate(dateObj);
                    console.log('Date set to flatpickr:', dateObj);
                } else {
                    // Flatpickr가 없을 경우 대비 (기본 input)
                    document.getElementById('todoDueDate').value = window.selectedDate;
                }
                
                // 제목 입력란으로 포커스
                document.getElementById('todoTitle').focus();
                closeDateModal();
                showNotification('할 일 추가 폼으로 이동했습니다. 마감일이 자동으로 설정되었습니다.');
            }
        }
        
        // 이전 기간
        function previousPeriod() {
            if (calendarView === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setDate(currentDate.getDate() - 7);
            }
            renderCalendar();
        }
        
        // 다음 기간
        function nextPeriod() {
            if (calendarView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else {
                currentDate.setDate(currentDate.getDate() + 7);
            }
            renderCalendar();
        }
        
        // 오늘로 이동
        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }
        
        // ==================== 팀 협업 관리 ====================
        

        
        // 시간 차이 계산
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '방금 전';
            if (diffMins < 60) return `${diffMins}분 전`;
            if (diffHours < 24) return `${diffHours}시간 전`;
            return `${diffDays}일 전`;
        }
        
        // ==================== 프로젝트 관리 ====================
        

        
        // 색상 선택기 초기화
        function initColorPicker() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('projectColor').value = this.dataset.color;
                });
            });
        }
        
        // 프로젝트 생성
        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDesc').value.trim();
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const color = document.getElementById('projectColor').value;
            
            if (!name) {
                ErrorManager.validation('프로젝트 이름을 입력해주세요.');
                return;
            }
            
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showNotification('시작일이 완료일보다 늦을 수 없습니다.', 'error');
                return;
            }
            
            const newProject = {
                id: 'project-' + Date.now(),
                workspace_id: currentWorkspace.id,
                name: name,
                description: description || '',
                color: color,
                start_date: startDate || null,
                end_date: endDate || null,
                created_by: currentUser.id,
                created_at: new Date().toISOString()
            };
            
            projects.push(newProject);
            localStorage.setItem('demo_projects', JSON.stringify(projects));
            
            renderProjects();
            closeProjectModal();
            showNotification('프로젝트가 생성되었습니다!');
        }
        
        // 프로젝트 목록 렌더링
        function renderProjects() {
            const projectFilter = document.getElementById('projectFilter');
            const todoProject = document.getElementById('todoProject');
            const projectsTabs = document.getElementById('projectsTabs');
            
            // 필터 옵션 업데이트
            if (projectFilter) {
                projectFilter.innerHTML = '<option value="">모든 프로젝트</option>';
            }
            if (todoProject) {
                todoProject.innerHTML = '<option value="">프로젝트 선택</option>';
            }
            
            // 프로젝트 탭 영역 업데이트
            if (projectsTabs) {
                projectsTabs.innerHTML = '';
                
                // "전체" 탭 추가
                const allTab = document.createElement('div');
                allTab.className = `project-tab project-tab-all ${!currentProject ? 'active' : ''}`;
                allTab.onclick = () => selectProjectTab(null);
                allTab.innerHTML = '📁 전체 프로젝트';
                projectsTabs.appendChild(allTab);
            }
            
            const workspaceProjects = projects.filter(p => p.workspace_id === currentWorkspace?.id);
            
            workspaceProjects.forEach(project => {
                // 필터 옵션 추가
                if (projectFilter) {
                    const filterOption = document.createElement('option');
                    filterOption.value = project.id;
                    filterOption.textContent = escapeHTML(project.name);
                    projectFilter.appendChild(filterOption);
                }
                
                if (todoProject) {
                    const todoOption = document.createElement('option');
                    todoOption.value = project.id;
                    todoOption.textContent = escapeHTML(project.name);
                    todoProject.appendChild(todoOption);
                }
                
                // 프로젝트 탭 추가
                if (projectsTabs) {
                    const projectTab = document.createElement('div');
                    projectTab.className = `project-tab ${currentProject?.id === project.id ? 'active' : ''}`;
                    projectTab.onclick = () => selectProjectTab(project.id);
                    projectTab.innerHTML = `
                        <div class="project-color" style="background: ${project.color}"></div>
                        ${escapeHTML(project.name)}
                    `;
                    projectsTabs.appendChild(projectTab);
                }
            });
        }
        
        // 프로젝트 탭 선택
        function selectProjectTab(projectId) {
            currentProject = projectId ? projects.find(p => p.id === projectId) : null;
            
            // 탭 활성화 상태 업데이트
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (projectId) {
                document.querySelector(`.project-tab[onclick*="${projectId}"]`)?.classList.add('active');
            } else {
                document.querySelector('.project-tab-all')?.classList.add('active');
            }
            
            // 할 일 목록 업데이트
            renderTodos();
            
            // 필터 드롭다운도 동기화
            const projectFilter = document.getElementById('projectFilter');
            if (projectFilter) {
                projectFilter.value = projectId || '';
            }
            
            if (currentProject) {
                showNotification(`"${currentProject.name}" 프로젝트를 선택했습니다.`);
            } else {
                showNotification('전체 프로젝트를 선택했습니다.');
            }
        }
        
        // 프로젝트별 할 일 필터링
        function filterTodosByProject() {
            const selectedProjectId = document.getElementById('projectFilter').value;
            currentProject = selectedProjectId ? projects.find(p => p.id === selectedProjectId) : null;
            renderTodos();
        }
        
        // ==================== 향상된 할 일 관리 ====================
        
        // 할 일 추가 (개선된 버전)
        function addTodo() {
            const projectId = document.getElementById('todoProject').value;
            const title = document.getElementById('todoTitle').value.trim();
            const description = document.getElementById('todoDesc').value.trim();
            
            // flatpickr 날짜 가져오기 (한국 시간 기준)
            const startDatePicker = document.getElementById('todoStartDate')._flatpickr;
            const dueDatePicker = document.getElementById('todoDueDate')._flatpickr;
            
            // KST 기준으로 날짜 가져오기
            let startDate = '';
            let dueDate = '';
            
            if (startDatePicker.selectedDates[0]) {
                // 선택된 날짜를 KST 기준으로 변환
                const startDateObj = startDatePicker.selectedDates[0];
                console.log('Start date before KST conversion:', startDateObj);
                startDate = DateUtils.formatKST(startDateObj);
            }
            
            if (dueDatePicker.selectedDates[0]) {
                // 선택된 날짜를 KST 기준으로 변환
                const dueDateObj = dueDatePicker.selectedDates[0];
                console.log('Due date before KST conversion:', dueDateObj);
                dueDate = DateUtils.formatKST(dueDateObj);
            }
            
            console.log('Final KST dates - Start:', startDate, 'Due:', dueDate);
            
            const priority = document.getElementById('todoPriority').value;
            
            // 유효성 검사
            if (!title) {
                showNotification('할 일 제목을 입력해주세요.', 'error');
                document.getElementById('todoTitle').focus();
                return;
            }
            
            if (!projectId) {
                showNotification('프로젝트를 선택해주세요.', 'error');
                document.getElementById('todoProject').focus();
                return;
            }
            
            // 시작일과 마감일 검사는 이미 flatpickr에서 처리했지만 이중 안전장치로 다시 확인
            if (startDate && dueDate && new Date(startDate) > new Date(dueDate)) {
                showNotification('시작일이 마감일보다 늦을 수 없습니다.', 'error');
                dueDatePicker.open(); // 마감일 달력 열기
                return;
            }
            
            const newTodo = {
                id: 'todo-' + Date.now(),
                workspace_id: currentWorkspace.id,
                project_id: projectId,
                title: title,
                description: description || '',
                priority: priority,
                status: 'pending',
                start_date: startDate || null,
                due_date: dueDate || null,
                created_by: currentUser.id,
                assigned_to: currentUser.id,
                created_at: new Date().toISOString()
            };
            
            // 데모 모드인지 확인
            if (isDemoMode) {
                // 데모 모드: localStorage에 저장
                todos.push(newTodo);
                localStorage.setItem('demo_todos', JSON.stringify(todos));
                
                // 활동 피드에 추가
                const project = projects.find(p => p.id === projectId);
                const newActivity = {
                    id: 'activity-' + Date.now(),
                    type: 'todo_created',
                    user: currentUser.user_metadata?.full_name || '데모 사용자',
                    text: `새 할 일을 추가했습니다: "${title}" (${project?.name})`,
                    timestamp: new Date().toISOString()
                };
                
                activities.unshift(newActivity);
                localStorage.setItem('demo_activities', JSON.stringify(activities));
            } else {
                // 실제 모드: Supabase에 저장 (실시간 동기화)
                try {
                    console.log('Supabase에 할 일 저장 시도:', {
                        workspace_id: currentWorkspace.id,
                        project_id: projectId,
                        title: title,
                        description: description || '',
                        start_date: startDate || null,
                        due_date: dueDate || null,
                        priority: priority,
                        created_by: currentUser.id,
                        assigned_to: currentUser.id
                    });
                    
                    supabase
                        .from('todos')
                        .insert({
                            workspace_id: currentWorkspace.id,
                            project_id: projectId,
                            title: title,
                            description: description || '',
                            start_date: startDate || null,
                            due_date: dueDate || null,
                            priority: priority,
                            created_by: currentUser.id,
                            assigned_to: currentUser.id
                        })
                        .then(response => {
                            if (response.error) {
                                console.error('Supabase 할 일 저장 오류:', response.error);
                                showNotification('데이터베이스 저장 중 오류가 발생했습니다.', 'error');
                            } else {
                                console.log('Supabase 할 일 저장 성공:', response.data);
                            }
                        })
                        .catch(error => {
                            console.error('Supabase 할 일 저장 중 예외 발생:', error);
                            showNotification('데이터베이스 저장 중 오류가 발생했습니다.', 'error');
                        });
                    
                    // 실시간 구독을 통해 자동으로 업데이트됨
                } catch (error) {
                    console.error('Supabase 저장 시도 중 오류:', error);
                    showNotification('데이터베이스 저장 중 오류가 발생했습니다.', 'error');
                }
            }
            
            // 폼 초기화
            UIManager.resetForm({
                'todoProject': '',
                'todoTitle': '',
                'todoDesc': '',
                'todoPriority': 'medium'
            });
            
            // flatpickr 인스턴스 초기화
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            if (startDatePicker) {
                startDatePicker.setDate(today);
            }
            
            if (dueDatePicker) {
                dueDatePicker.setDate(nextWeek);
            }
            
            renderTodos();
            renderCalendar();
            updateDashboard();
            showNotification('할 일이 추가되었습니다!');
        }
        
        // 향상된 할 일 렌더링 (달력 팝업과 동일한 스타일)
        function renderTodos() {
            const container = document.getElementById('todoList');
            
            // DOM 요소 존재 확인
            if (!container) {
                console.warn('todoList 요소를 찾을 수 없습니다.');
                return;
            }
            
            container.innerHTML = '';
            
            let filteredTodos = todos.filter(todo => todo.workspace_id === currentWorkspace?.id);
            
            // 프로젝트 필터 적용
            if (currentProject) {
                filteredTodos = filteredTodos.filter(todo => todo.project_id === currentProject.id);
            }
            
            // 상태별 정렬 (진행중 > 대기중 > 완료)
            filteredTodos.sort((a, b) => {
                const statusOrder = { 'in_progress': 0, 'pending': 1, 'completed': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            
            if (filteredTodos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #a0aec0;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                        <p>아직 할 일이 없습니다.</p>
                        <p>새 프로젝트를 만들고 할 일을 추가해보세요!</p>
                    </div>
                `;
                return;
            }
            
            filteredTodos.forEach(todo => {
                const project = projects.find(p => p.id === todo.project_id);
                const todoElement = document.createElement('div');
                todoElement.className = 'enhanced-date-todo-item';
                todoElement.onclick = () => showTodoDetailModal(todo.id);
                
                const statusText = {
                    'pending': '대기중',
                    'in_progress': '진행중',
                    'completed': '완료'
                };
                
                const statusColor = {
                    'pending': '#f59e0b',
                    'in_progress': '#3b82f6',
                    'completed': '#10b981'
                };
                
                // 날짜 정보 구성
                const dateInfo = [];
                if (todo.start_date) {
                    dateInfo.push(`시작: ${new Date(todo.start_date).toLocaleDateString()}`);
                }
                if (todo.due_date) {
                    dateInfo.push(`마감: ${new Date(todo.due_date).toLocaleDateString()}`);
                }
                
                // 댓글 수 계산
                const commentCount = getCommentCount(todo.id);
                
                todoElement.innerHTML = `
                    <div class="todo-color-indicator" style="background: ${project?.color || '#6b7280'}"></div>
                    <div class="todo-main-info">
                        <div class="todo-title-enhanced">${escapeHTML(todo.title)}</div>
                        <div class="todo-meta-info">
                            <span class="todo-project-name" style="background: ${project?.color}20; color: ${project?.color || '#4a5568'}">
                                ${escapeHTML(project?.name || '프로젝트 없음')}
                            </span>
                            ${dateInfo.length > 0 ? `<span class="todo-dates-info">${dateInfo.join(' • ')}</span>` : ''}
                            ${commentCount > 0 ? `<span class="comment-count">💬 ${commentCount}</span>` : ''}
                        </div>
                        ${todo.description ? `
                            <div class="todo-description-preview">
                                ${escapeHTML(todo.description.length > 80 ? todo.description.substring(0, 80) + '...' : todo.description)}
                            </div>
                        ` : ''}
                    </div>
                    <div class="todo-status-indicator">
                        <span class="todo-status-badge" style="background: ${statusColor[todo.status]}">
                            ${statusText[todo.status]}
                        </span>
                        <span style="color: #a0aec0; font-size: 12px;">클릭하여 상세보기</span>
                    </div>
                `;
                
                container.appendChild(todoElement);
            });
            
            // 통계 업데이트
            updateTodoStats(filteredTodos);
        }
        
        // 댓글 수 계산
        function getCommentCount(todoId) {
            return todoComments.filter(comment => comment.todo_id === todoId).length;
        }
        
        // 할 일 상태 변경
        function toggleTodoStatus(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo) return;
            
            if (todo.status === 'pending') {
                todo.status = 'in_progress';
            } else if (todo.status === 'in_progress') {
                todo.status = 'completed';
                todo.completed_at = new Date().toISOString();
            }
            
            localStorage.setItem('demo_todos', JSON.stringify(todos));
            
            // 활동 피드에 추가
            const project = projects.find(p => p.id === todo.project_id);
            const newActivity = {
                id: 'activity-' + Date.now(),
                type: 'todo_completed',
                user: currentUser.user_metadata?.full_name || '데모 사용자',
                text: `할 일을 ${todo.status === 'completed' ? '완료' : '시작'}했습니다: "${todo.title}" (${project?.name})`,
                timestamp: new Date().toISOString()
            };
            
            activities.unshift(newActivity);
            localStorage.setItem('demo_activities', JSON.stringify(activities));
            
            renderTodos();
            renderCalendar();
            updateDashboard();
            showNotification(`할 일이 ${todo.status === 'completed' ? '완료' : '시작'}되었습니다!`);
        }
        
        // 할 일 통계 업데이트
        function updateTodoStats(filteredTodos) {
            const total = filteredTodos.length;
            const completed = filteredTodos.filter(t => t.status === 'completed').length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            UIManager.updateStats({
                'totalTodos': total,
                'completedTodos': completed,
                'completionRate': rate + '%'
            });
        }
        // 날짜 관련 유틸리티 함수 모음
        const DateUtils = {
            // 한국 시간으로 날짜 문자열 생성 (YYYY-MM-DD)
            formatKST: function(date) {
                if (!date) return '';
                
                // 한국 시간대(UTC+9) 기준으로 날짜 객체 생성
                const kstDate = new Date(date);
                
                // 한국 시간대로 년, 월, 일 추출
                const year = kstDate.getFullYear();
                const month = String(kstDate.getMonth() + 1).padStart(2, '0');
                const day = String(kstDate.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            },
            
            // 문자열 날짜를 KST Date 객체로 변환
            parseKST: function(dateStr) {
                if (!dateStr) return null;
                
                // YYYY-MM-DD 형식의 문자열을 한국 시간대 기준으로 파싱
                // 시간을 정오(12:00)로 설정하여 날짜 경계 문제 방지
                return new Date(`${dateStr}T12:00:00+09:00`);
            },
            
            // 오늘 날짜를 KST 기준으로 가져오기
            getTodayKST: function() {
                const now = new Date();
                
                // 한국 시간대 고려
                now.setHours(now.getHours() + 9);
                
                const year = now.getUTCFullYear();
                const month = String(now.getUTCMonth() + 1).padStart(2, '0');
                const day = String(now.getUTCDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
        };
        
        // flatpickr 달력 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 한국어 로컬라이제이션 적용
            flatpickr.localize(flatpickr.l10ns.ko);
            
            // 편집 모달 폼 제출 이벤트 리스너 추가
            const editTodoForm = document.getElementById('editTodoForm');
            if (editTodoForm) {
                editTodoForm.addEventListener('submit', function(event) {
                    updateTodo(event);
                });
            }
            
            // 시작일 설정
            const startDatePicker = flatpickr("#todoStartDate", {
                dateFormat: "Y-m-d",
                locale: "ko",
                disableMobile: true,
                nextArrow: '<svg width="10" height="10" viewBox="0 0 10 10"><path d="M3 1L7 5L3 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                prevArrow: '<svg width="10" height="10" viewBox="0 0 10 10"><path d="M7 1L3 5L7 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                onChange: function(selectedDates, dateStr) {
                    // 시작일이 변경되면 마감일의 최소 날짜를 설정
                    if (selectedDates.length > 0) {
                        dueDatePicker.set('minDate', dateStr);
                    }
                }
            });
            
            // 마감일 설정
            const dueDatePicker = flatpickr("#todoDueDate", {
                dateFormat: "Y-m-d",
                locale: "ko",
                disableMobile: true,
                nextArrow: '<svg width="10" height="10" viewBox="0 0 10 10"><path d="M3 1L7 5L3 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                prevArrow: '<svg width="10" height="10" viewBox="0 0 10 10"><path d="M7 1L3 5L7 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
            });
            
            // 현재 날짜를 한국 시간으로 가져옴
            const kstToday = DateUtils.parseKST(DateUtils.getTodayKST());
            console.log('Today in KST:', kstToday);
            
            // 기본값 설정 (오늘, 한국 시간 기준)
            startDatePicker.setDate(kstToday);
            
            // 마감일 기본값은 7일 후 (한국 시간 기준)
            const nextWeek = new Date(kstToday);
            nextWeek.setDate(kstToday.getDate() + 7);
            dueDatePicker.setDate(nextWeek);
            
            // 최소 날짜 설정 (시작일은 오늘 이후, 마감일은 시작일 이후)
            startDatePicker.set('minDate', kstToday);
            dueDatePicker.set('minDate', kstToday);
        });
    </script>
    
    <style>
        /* 향상된 할 일 추가 폼 */
        .add-todo-form-container {
            margin-bottom: 30px;
        }
        
        .add-todo-form {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .add-todo-form:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
        
        .form-header {
            padding: 18px 24px;
            background: linear-gradient(to right, #f8fafc, #f1f5f9);
            border-bottom: 1px solid #e5e7eb;
        }
        
        .form-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .form-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group.half {
            flex: 1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }
        
        .required {
            color: #ef4444;
            margin-left: 2px;
        }
        
        .enhanced-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .date-input-wrapper {
            position: relative;
        }
        
        .date-icon {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            color: #6b7280;
            pointer-events: none;
        }
        
        .date-picker {
            cursor: pointer;
            background-color: white;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .add-todo-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .add-todo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* Flatpickr 달력 커스텀 스타일 */
        .flatpickr-calendar {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border: none;
        }
        
        .flatpickr-day.selected {
            background: #667eea;
            border-color: #667eea;
        }
        
        .flatpickr-day.selected:hover {
            background: #5a6fe6;
            border-color: #5a6fe6;
        }
        
        .flatpickr-day:hover {
            background: #f1f5f9;
        }
        
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-weight: 600;
        }
        
        /* 모바일 대응 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-body {
                padding: 16px;
            }
        }
    </style>
</body>
</html>